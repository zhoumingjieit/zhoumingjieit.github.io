<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="http://yoursite.com">
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/page/7/index.html">
<meta property="og:site_name" content="Hexo">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">
  
    <link rel="alternative" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" type="text/css" href="/./main.f6a68c.css">
  <style type="text/css">
  
    #container.show {
      background: linear-gradient(200deg,#a0cfe4,#e8c37e);
    }
  </style>
  

  

</head>

<body>
  <div id="container" q-class="show:isCtnShow">
    <canvas id="anm-canvas" class="anm-canvas"></canvas>
    <div class="left-col" q-class="show:isShow">
      
<div class="overlay" style="background: #4d4d4d"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img src="/images/avatar.png" class="js-avatar">
		</a>
		<hgroup>
		  <h1 class="header-author"><a href="/">Jack_zhou</a></h1>
		</hgroup>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
				<li><a href="/tags/随笔/">随笔</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
    		
    			
    			<a q-on="click: openSlider(e, 'innerArchive')" href="javascript:void(0)">所有文章</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'friends')" href="javascript:void(0)">友链</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'aboutme')" href="javascript:void(0)">关于我</a>
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="#" title="github"><i class="icon-github"></i></a>
		        
					<a class="weibo" target="_blank" href="#" title="weibo"><i class="icon-weibo"></i></a>
		        
					<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
		        
					<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col" q-class="show:isShow,hide:isShow|isFalse">
      
<nav id="mobile-nav">
  	<div class="overlay js-overlay" style="background: #4d4d4d"></div>
	<div class="btnctn js-mobile-btnctn">
  		<div class="slider-trigger list" q-on="click: openSlider(e)"><i class="icon icon-sort"></i></div>
	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src="/images/avatar.png" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author js-header-author">Jack_zhou</h1>
			</hgroup>
			
			
			
				
			
				
			
			
			
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="#" title="github"><i class="icon-github"></i></a>
			        
						<a class="weibo" target="_blank" href="#" title="weibo"><i class="icon-weibo"></i></a>
			        
						<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
			        
						<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
			        
				</div>
			</nav>

			<nav class="header-menu js-header-menu">
				<ul style="width: 50%">
				
				
					<li style="width: 50%"><a href="/">主页</a></li>
		        
					<li style="width: 50%"><a href="/tags/随笔/">随笔</a></li>
		        
				</ul>
			</nav>
		</header>				
	</div>
	<div class="mobile-mask" style="display:none" q-show="isShow"></div>
</nav>

      <div id="wrapper" class="body-wrap">
        <div class="menu-l">
          <div class="canvas-wrap">
            <canvas data-colors="#eaeaea" data-sectionHeight="100" data-contentId="js-content" id="myCanvas1" class="anm-canvas"></canvas>
          </div>
          <div id="js-content" class="content-ll">
            
  
    <article id="post-web services之nginx(四)" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/29/web services之nginx(四)/">Nginx进阶四</a>
    </h1>
  

        
        <a href="/2017/08/29/web services之nginx(四)/" class="archive-article-date">
  	<time datetime="2017-08-29T01:00:22.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2017-08-29</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Nginx相关配置"><a href="#Nginx相关配置" class="headerlink" title="Nginx相关配置"></a>Nginx相关配置</h3><p>◆Web 架构扩展思路及相关概念（正反向代理、CDN、GLSB和缓存服务器）；<br>◆ngx_http_proxy_module模块；<br>&ensp;&ensp;&ensp;&ensp;·实验：nginx反向代理后端单台web服务器；<br>&ensp;&ensp;&ensp;&ensp;·proxy_set_header field value;<br>&ensp;&ensp;&ensp;&ensp;·proxy的缓存，及实验定制调用缓存机制；<br>◆ngx_http_upstream_module模块<br>&ensp;&ensp;&ensp;&ensp;·实验：定义使用nginx以负载均衡的方式进行响应。<br>&ensp;&ensp;&ensp;&ensp;·调度算法<br>◆ngx_stream_core_module模块<br>&ensp;&ensp;&ensp;&ensp;·实验：基于stream实现负载均衡SSH服务<br>◆nginx的其它的二次发行版：</p>
<h3 id="Web-架构扩展思路"><a href="#Web-架构扩展思路" class="headerlink" title="Web 架构扩展思路"></a>Web 架构扩展思路</h3><h4 id="正向代理和反向代理"><a href="#正向代理和反向代理" class="headerlink" title="正向代理和反向代理"></a>正向代理和反向代理</h4><p>★正向代理<br>☉定义：<br>&ensp;&ensp;&ensp;&ensp;是一个位于客户端和原始服务器(origin server)之间的服务器，为了从原始服务器取得内容，客户端向代理发送一个请求并指定目标(原始服务器)，然后代理向原始服务器转交请求并将获得的内容返回给客户端。客户端必须要进行一些特别的设置才能使用正向代理。<br>通俗理解：主要就是代理客户端去访问互联网上各种各样的服务，是用来隐藏客户端的。<br>正向代理：<br><img src="\images\nginx\proxy.jpg" alt="nginx"><br>★反向代理（Reverse Proxy）<br>☉定义：<br>&ensp;&ensp;&ensp;&ensp;指以代理服务器来接受internet上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给internet上请求连接的客户端，此时代理服务器对外就表现为一个反向代理服务器。<br>☉通俗的理解：<br>&ensp;&ensp;&ensp;&ensp;向外宣称自己监听在某个端口之上，拥有某个服务，但本身并不提供任何内容，而是把相关的请求转发至后端主机来进行提供服务，用来隐藏服务端<br>反向代理:<br><img src="\images\nginx\reverse proxy.jpg" alt="nginx"><br>★两者区别<br>☉从用途上来讲：<br>◆正向代理的典型用途是：<br>&ensp;&ensp;&ensp;&ensp;为在防火墙内的局域网客户端提供访问Internet的途径。正向理还可以使用缓冲特性减少网络使用率。<br>◆反向代理的典型用途是：<br>&ensp;&ensp;&ensp;&ensp;将防火墙后面的服务器提供给Internet用户访问。反向代理还可以为后端的多台服务器提供负载平衡，或为后端较慢的服务器提供缓冲服务。另外，反向代理还可以启用高级URL策略和管理技术，从而使处于不同web服务器系统的web页面同时存在于同一个URL空间下。<br>☉从安全性来讲：<br>&ensp;&ensp;&ensp;&ensp;正向代理允许客户端通过它访问任意网站并且隐藏客户端自身，因此你必须采取安全措施以确保仅为经过授权的客户端提供服务。<br>&ensp;&ensp;&ensp;&ensp;反向代理对外都是透明的，访问者并不知道自己访问的是一个代理。</p>
<h4 id="CDN和GSLB"><a href="#CDN和GSLB" class="headerlink" title="CDN和GSLB"></a>CDN和GSLB</h4><p>★CDN(Content Delivery Network)<br>☉定义：<br>&ensp;&ensp;&ensp;&ensp;CDN是构建在网络之上的内容分发网络，依靠部署在各地的边缘服务器，通过中心平台的负载均衡、内容分发、调度等功能模块，使用户就近获取所需内容，降低网络拥塞，提高用户访问响应速度和命中率。<br>☉CDN的关键技术：<br>&ensp;&ensp;&ensp;&ensp;内容存储和分发技术。<br>☉CDN的基本原理:<br>&ensp;&ensp;&ensp;&ensp;是广泛采用各种缓存服务器，将这些缓存服务器分布到用户访问相对集中的地区或网络中，在用户访问网站时，利用全局负载技术将用户的访问指向距离最近的工作正常的缓存服务器上，由缓存服务器直接响应用户请求。<br>☉目的：<br>&ensp;&ensp;&ensp;&ensp;是使用户可就近取得所需内容，解决 Internet网络拥挤的状况，提高用户访问网站的响应速度。<br>★GSLB：Global Service LB（全局负载均衡器）<br>☉作用：<br>&ensp;&ensp;&ensp;&ensp;实现在广域网（包括互联网）上不同地域间的服务器的流量调配，保证使用最佳的服务器服务离自己最近的客户，从而确保访问质量。<br><img src="\images\nginx\cdn.jpg" alt="nginx"><br>★SLB：Service LB<br>★应用程序发布：<br>&ensp;&ensp;&ensp;&ensp;灰度模型</p>
<h4 id="缓存服务器"><a href="#缓存服务器" class="headerlink" title="缓存服务器"></a>缓存服务器</h4><p>★定义：<br>&ensp;&ensp;&ensp;&ensp;缓存指的是将需要频繁访问的网络内容存放在离用户较近、访问速度更快的系统中，以提高内容访问速度的一种技术。缓存服务器就是存放频繁访问内容的服务器。<br>&ensp;&ensp;&ensp;&ensp;缓存提供了比将访问对象放在Internet Web服务器上更好的方法，它将需要频繁访问的Web页面和对象保存在离用户更近的系统中，当再次访问这些对象的时候加快了速度。<br>★缓存服务器原理及应用模式：<br>☉Web缓存服务器的应用模式主要是正向代理和反向代理。<br>☉正向代理(Proxy)模式<br>&ensp;&ensp;&ensp;&ensp;代理网络用户访问internet，客户端将本来要直接发送到internet上源服务器的连接请求发送给代理服务器处理。正向代理的目的是加速用户在使用浏览器访问Internet时的请求响应时间，并提高广域网线路的利用率。正向代理浏览器无需和该站点建立联系，只访问到Web缓存即可。通过正向代理，大大提高了后续用户的访问速度，使他们无需再穿越Internet，只要从本地Web缓存就可以获取所需要的信息，避免了带宽问题，同时可以大量减少重复请求在网络上的传输，从而降低网络流量，节省资费。<br>☉反向代理(Reverse Proxy)模式<br>&ensp;&ensp;&ensp;&ensp;针对Web服务器加速功能的，在该模式中，缓存服务器放置在web应用服务器的前面，当用户访问web应用服务器的时候，首先经过缓存服务器，并将用户的请求和应用服务器应答的内容写入缓存服务器中，从而为后续用户的访问提供更快的响应。</p>
<h3 id="ngx-http-proxy-module模块"><a href="#ngx-http-proxy-module模块" class="headerlink" title="ngx_http_proxy_module模块"></a>ngx_http_proxy_module模块</h3><h4 id="proxy-pass-URL"><a href="#proxy-pass-URL" class="headerlink" title="proxy_pass URL"></a>proxy_pass URL</h4><p>★作用：<br>&ensp;&ensp;&ensp;&ensp;将作为代理服务器，把客户端访问的资源的url映射到后端服务器；<br>★使用位置（Context）<br>&ensp;&ensp;&ensp;&ensp;location, if in location, limit_except<br>★三种使用情况：<br>☉proxy_pass后面的路径不带uri时，其会将location的uri传递给后端的主机；下面的示例会将/uri/传递给后端服务器；<br><img src="\images\nginx\proxy_pass1.png" alt="nginx"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">location  /uri/ &#123;</div><div class="line">		proxy_pass http://hostname;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>☉proxy_pass后面的路径是一个uri时，其会将location的uri替换为后端主机自己的uri；<br><img src="\images\nginx\proxy_pass2.png" alt="nginx"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">location  /uri/ &#123;</div><div class="line">		proxy_pass http://hostname/new_uri/;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>☉如果location定义其uri时使用了正则表达式的模式，则proxy_pass之后必须不能使用uri; 用户请求时传递的uri将直接附加代理到的服务的之后；<br><img src="\images\nginx\proxy_pass3.png" alt="nginx"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">location  ~*  \.(jpg|gif|jpeg)$  &#123;</div><div class="line">		proxy_pass  http://HOSTNAME;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="实验：验证nginx的反向代理："><a href="#实验：验证nginx的反向代理：" class="headerlink" title="实验：验证nginx的反向代理："></a>实验：验证nginx的反向代理：</h4><p>1.实验环境<br>&ensp;&ensp;&ensp;&ensp;准备两台虚拟主机，一台作为nginx反向代理服务器，另外一台作为后端web服务器；nginx代理服务器要有一个外网网卡保障和客户端通信，还要有一个内网网卡和后端主机通信；<br>2.实验环境搭建<br>1）首先部署好一台虚拟主机作为nginx反向代理服务器，外网网卡ip为10.1.252.128，内网ip为172.16.3.132.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># ifconfig</span></div><div class="line">eno16777736: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500           <span class="comment"># 内网网卡IP</span></div><div class="line">        inet 172.16.3.132  netmask 255.255.255.0  broadcast 172.16.3.255</div><div class="line">        inet6 fe80::20c:29ff:fed3:cf91  prefixlen 64  scopeid 0x20&lt;link&gt;</div><div class="line">        ether 00:0c:29:d3:cf:91  txqueuelen 1000  (Ethernet)</div><div class="line">        RX packets 846  bytes 74706 (72.9 KiB)</div><div class="line">        RX errors 0  dropped 0  overruns 0  frame 0</div><div class="line">        TX packets 593  bytes 86481 (84.4 KiB)</div><div class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</div><div class="line"></div><div class="line">eno33554984: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500           <span class="comment"># 外网网卡IP</span></div><div class="line">        inet 10.1.252.128  netmask 255.255.255.0  broadcast 10.1.252.255</div><div class="line">        inet6 fe80::20c:29ff:fed3:cf9b  prefixlen 64  scopeid 0x20&lt;link&gt;</div><div class="line">        ether 00:0c:29:d3:cf:9b  txqueuelen 1000  (Ethernet)</div><div class="line">        RX packets 43  bytes 6455 (6.3 KiB)</div><div class="line">        RX errors 0  dropped 0  overruns 0  frame 0</div><div class="line">        TX packets 20  bytes 3318 (3.2 KiB)</div><div class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</div></pre></td></tr></table></figure></p>
<p> 2）现在我们来部署后端web服务器，ip地址：172.16.3.67/24.并提供测试页面，这里为了实验，又创建了一个admin目录，并也提供了测试页<br> <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># ifconfig</span></div><div class="line">eno16777736: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500          <span class="comment"># 内网服务器IP</span></div><div class="line">        inet 172.16.3.67  netmask 255.255.255.0  broadcast 172.16.3.255</div><div class="line">        inet6 fe80::20c:29ff:fe7f:9cbe  prefixlen 64  scopeid 0x20&lt;link&gt;</div><div class="line">        ether 00:0c:29:7f:9c:be  txqueuelen 1000  (Ethernet)</div><div class="line">        RX packets 3793  bytes 345590 (337.4 KiB)</div><div class="line">        RX errors 0  dropped 0  overruns 0  frame 0</div><div class="line">        TX packets 2643  bytes 353057 (344.7 KiB)</div><div class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</div><div class="line"></div><div class="line">[root@centos7 html]<span class="comment"># echo "&lt;h1&gt;UpStream Server 1&lt;/h1&gt;" &gt; /usr/share/nginx/html/index.html </span></div><div class="line">[root@centos7 html]<span class="comment"># cat /usr/share/nginx/html/index.html</span></div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">[root@centos7 html]<span class="comment"># mkdir /usr/share/nginx/html/admin/</span></div><div class="line">[root@centos7 html]<span class="comment"># echo "&lt;h1&gt;Admin Area UpStream Server 1&lt;/h1&gt;" &gt; /usr/share/nginx/html/admin/index.html</span></div><div class="line">[root@centos7 html]<span class="comment"># cat /usr/share/nginx/html/admin/index.html</span></div><div class="line">&lt;h1&gt;Admin Area UpStream Server 1&lt;/h1&gt;</div></pre></td></tr></table></figure></p>
<p>3）如上，整个实验的环境就已经搭建完成，我们启动后端web服务器，然后现在代理服务器上请求后端服务器，可以正常返回结果，如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># curl http://172.16.3.67</span></div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">[root@centos7 ~]<span class="comment"># curl http://172.16.3.67/admin/</span></div><div class="line">&lt;h1&gt;Admin Area UpStream Server 1&lt;/h1&gt;</div></pre></td></tr></table></figure></p>
<p>3.实验操作<br>1）现在我们在nginx的代理服务器上去编辑其配置文件/etc/nginx/conf.d/defaut.conf，让其把所有内容代理至后端web服务器<br><img src="\images\nginx\proxy_pass4.png" alt="nginx"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">location / &#123;</div><div class="line">       <span class="comment">#root   /usr/share/nginx/html;</span></div><div class="line">        proxy_pass http://172.16.3.67/;</div><div class="line">        index  index.html index.htm;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>启动nginx代理服务器，在浏览器中访问代理服务器10.1.252.128，发现直接代理至后端web服务器，如下：<br><img src="\images\nginx\proxy_pass5.png" alt="nginx"><br>上面是把root注释掉了，如果不注释，两个都存在的话，同样也会代理至后端服务器，即:有proxy，root的存在就没有意义了<br>2）现在我们不代理整个根，我们只代理admin目录至后端服务器<br><img src="\images\nginx\proxy_pass6.png" alt="nginx"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">location / &#123;</div><div class="line">        root   /usr/share/nginx/html;</div><div class="line">        index  index.html index.htm;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    location /admin/ &#123;</div><div class="line">        proxy_pass http://172.16.3.67/;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>①首先不加admin用浏览器访问，则访问的是nginx代理服务器的默认测试页，如下：<br><img src="\images\nginx\proxy_pass7.png" alt="nginx"><br>②加上admin目录，因为proxy后面有uri所以，会将其替换掉location的uri，即访问的是后端服务器的默认测试页,如下：<br><img src="\images\nginx\proxy_pass8.png" alt="nginx"><br>③现在我们把proxy后面的uri去掉，这是会将location中的uri补到proxy的后面，即访问的是后端主机admin目录下的默认页面<br><img src="\images\nginx\proxy_pass9.png" alt="nginx"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">location / &#123;</div><div class="line">        root   /usr/share/nginx/html;</div><div class="line">        index  index.html index.htm;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    location /admin/ &#123;</div><div class="line">        proxy_pass http://172.16.3.67;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>访问如下：<br><img src="\images\nginx\proxy_pass10.png" alt="nginx"><br>3)我们也可以使用正则表达式匹配，把某些符合条件或者同一类资源的url，代理至后端服务器，假如，我这里只把图片类的资源代理至后端服务器<br><img src="\images\nginx\proxy_pass11.png" alt="nginx"><br>location / {<br>        root   /usr/share/nginx/html;<br>        index  index.html index.htm;<br>    }</p>
<pre><code>location /admin/ {
    proxy_pass http://172.16.3.67;
}

location ~*\.(jpg|jpeg|gif|png)$ {
    proxy_pass http://172.16.3.67;
}
</code></pre><p>访问如下：<br><img src="\images\nginx\proxy_pass12.png" alt="nginx"></p>
<p>4)现在我在后端主机上部署安装php并启动（ap基于模块），同样在客户端向调度器请求以.php结尾的动态资源，发现同样可以调度到后端服务器中，然后响应给客户端，如下;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># ll /usr/share/nginx/html/admin/</span></div><div class="line">total 8</div><div class="line">-rw-r--r-- 1 root root 38 Sep 15 15:29 index.html</div><div class="line">-rw-r--r-- 1 root root 27 Sep 13 11:18 phpinfo.php</div></pre></td></tr></table></figure></p>
<p>在浏览器中请求如下：<br><img src="\images\nginx\proxy_pass13.png" alt="nginx"><br>心得：<br>&ensp;&ensp;&ensp;&ensp;如此一来，我们就可以把不同的资源分发到不同的服务器上去运行了，如果我们把所有以.php结尾的动态资源代理到后端另外一台服务器，把根的静态资源代理至另外一台后端服务器，（location中正则表达式的优先级比不带符号的优先级高）这样我们就实现了动静分离;</p>
<h4 id="proxy-set-header-field-value"><a href="#proxy-set-header-field-value" class="headerlink" title="proxy_set_header field value"></a>proxy_set_header field value</h4><p>★作用：<br>&ensp;&ensp;&ensp;&ensp;设定发往后端主机的请求报文的请求首部的值；<br>★使用位置（Context）<br>&ensp;&ensp;&ensp;&ensp;http, server, location<br>☉proxy_set_header X-Real-IP  $remote_addr;<br>&ensp;&ensp;&ensp;&ensp;直接记录前端主机的ip地址（如果前端主机不是客户端而是二级代理，则记录的还是二级代理的值）<br>☉proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;<br>&ensp;&ensp;&ensp;&ensp;记录前端主机发请求时记录的proxy_add_x_forwarded_for的值<br>示例:<br>1.因为后端的web主机接受的都是来自于nginx的代理服务器发送过来的请求，所以记录的日志当中都是nginx代理服务器的ip地址，我们查看后端主机的访问日志，如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># tail /var/log/nginx/access.log</span></div><div class="line">172.16.3.132 - - [15/Sep/2017:16:38:35 +0800] <span class="string">"GET /admin/phpinfo.php HTTP/1.0"</span> 200 47970 <span class="string">"-"</span> <span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.84 Safari/537.36"</span> <span class="string">"-"</span></div><div class="line">172.16.3.132 - - [15/Sep/2017:16:38:35 +0800] <span class="string">"GET /admin/phpinfo.php?=PHPE9568F34-D428-11d2-A769-00AA001ACF42 HTTP/1.0"</span> 200 2524 <span class="string">"http://10.1.252.128/admin/phpinfo.php"</span> <span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.84 Safari/537.36"</span> <span class="string">"-"</span></div><div class="line">172.16.3.132 - - [15/Sep/2017:16:38:35 +0800] <span class="string">"GET /admin/phpinfo.php?=PHPE9568F35-D428-11d2-A769-00AA001ACF42 HTTP/1.0"</span> 200 2146 <span class="string">"http://10.1.252.128/admin/phpinfo.php"</span> <span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.84 Safari/537.36"</span> <span class="string">"-"</span></div></pre></td></tr></table></figure></p>
<p>2.我们要想让后端服务器能够记录来自客户端的请求的ip地址，就需要设定发往后端主机请求报文的首部信息了，如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">![nginx](\images\nginx\proxy_pass14.png)</div><div class="line">location / &#123;</div><div class="line">        root   /usr/share/nginx/html;</div><div class="line">        index  index.html index.htm;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</div><div class="line"></div><div class="line">    location /blog/ &#123;</div><div class="line">        proxy_pass http://172.16.3.67;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    location ~*\.(jpg|jpeg|gif|png)$ &#123;</div><div class="line">        proxy_pass http://172.16.3.67;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>然后我们修改后端web服务器的配置文件/etc/httpd/conf/httpd.conf,在日志项的配置中添加指定记录指定首部的值即可，如下：<br><img src="\images\nginx\proxy_pass15.png" alt="nginx"><br>如果后端web服务器是nginx服务器这里为做说明</p>
<h4 id="proxy的缓存"><a href="#proxy的缓存" class="headerlink" title="proxy的缓存"></a>proxy的缓存</h4><p>★proxy_cache_path<br>☉格式和适用位置：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Syntax:proxy_cache_path path [levels=levels] [use_temp_path=on|off] keys_zone=name:size [inactive=time] </div><div class="line">[max_size=size] [manager_files=number] [manager_sleep=time] [manager_threshold=time] [loader_files=number]</div><div class="line">[loader_sleep=time] [loader_threshold=time] [purger=on|off] [purger_files=number] [purger_sleep=time]</div><div class="line"> [purger_threshold=time];</div><div class="line">     </div><div class="line">Default:—    </div><div class="line">Context:http</div></pre></td></tr></table></figure></p>
<p>☉作用：<br>&ensp;&ensp;&ensp;&ensp;定义可用于proxy功能的缓存<br>☉参数：<br>◆levels=levels：<br>&ensp;&ensp;&ensp;&ensp;缓存目录的层级数量，以及每一级的目录数量；<br>&ensp;&ensp;&ensp;&ensp;levels=ONE:TWO:THREE  例如：leves=1:2:2（每一级为16进制数）<br>◆keys_zone=name:size<br>&ensp;&ensp;&ensp;&ensp;k/v映射的内存空间的名称及大小<br>&ensp;&ensp;&ensp;&ensp;缓存的组织方式：缓存是哈希值，而且对应的缓存文件名通常是文件内容的哈希内容，并且缓存层级是按照定义的多级结构去存放文件的；<br>◆inactive=time：<br>&ensp;&ensp;&ensp;&ensp;非活动时长；<br>◆max_size=size：<br>&ensp;&ensp;&ensp;&ensp;磁盘上用于缓存数据的缓存空间上限；<br>★proxy_cache zone | off;<br>&ensp;&ensp;&ensp;&ensp;作用：指明要调用的缓存，或关闭缓存机制；<br>&ensp;&ensp;&ensp;&ensp;适用位置：http, server, location<br>★proxy_cache_key string;<br>☉作用：<br>&ensp;&ensp;&ensp;&ensp;缓存中用于“键”的内容；<br>☉默认值：<br>&ensp;&ensp;&ensp;&ensp;proxy_cache_key $scheme$proxy_host$request_uri;（协议，代理的服务器，请求的uri）<br>★proxy_cache_valid [code …] time;<br>&ensp;&ensp;&ensp;&ensp;作用：定义对特定响应码的响应内容的缓存时长；<br>配置示例:<br><img src="\images\nginx\proxy_cache.png" alt="nginx"><br>★proxy_cache_use_stale<br>☉语法，默认值及使用上下文<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Syntax:proxy_cache_use_stale error | timeout | invalid_header | updating | http_500 | http_502 </div><div class="line">| http_503 |http_504 | http_403 | http_404 | off ...;</div><div class="line">     </div><div class="line">Default:proxy_cache_use_stale off;</div><div class="line">     </div><div class="line">Context:http, server, location</div></pre></td></tr></table></figure></p>
<p>☉作用：<br>&ensp;&ensp;&ensp;&ensp;当代理服务器与后端主机出现故障时，在后端服务器的相应结果为哪种情况下，可以直接用缓存中的缓存项（可能是过期的内容）来响应客户端；<br>★proxy_cache_methods GET | HEAD | POST …;<br>☉作用：为哪些请求方法去检测使用缓存；<br>&ensp;&ensp;&ensp;&ensp;If the client request method is listed in this directive then the response will be cached. “GET” and “HEAD” methods are always added to the list, though it is recommended to specify them explicitly.<br>★proxy_hide_header field;<br>☉作用：<br>&ensp;&ensp;&ensp;&ensp;指明要隐藏的后端主机响应报文的header，（即，指明哪些header不要传给客户端）；<br>&ensp;&ensp;&ensp;&ensp;默认情况下是nginx不传递header<br>★proxy_connect_timeout time;<br>☉作用：定义代理服务器与后端主机的连接超时时长；<br>&ensp;&ensp;&ensp;&ensp;默认为60s，最大不能超过75s<br>★buffer相关的配置；</p>
<h4 id="定义调用缓存机制"><a href="#定义调用缓存机制" class="headerlink" title="定义调用缓存机制"></a>定义调用缓存机制</h4><p>1）首先要创建一个缓存的文件目录，实际生产环境中可以放在固态磁盘上或者Raid0上，这样I/O能力很强；（注意文可能需要修改属主和属组为nginx）<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># mkdir /var/cache/nginx/proxy_cache</span></div><div class="line">[root@centos7 ~]<span class="comment"># ls /var/cache/nginx/</span></div><div class="line">client_temp  fastcgi_temp  proxy_cache  proxy_temp  scgi_temp  uwsgi_temp</div><div class="line">[root@centos7 ~]<span class="comment"># ll -d /var/cache/nginx/proxy_cache/</span></div><div class="line">drwxr-xr-x 2 root root 6 Sep 15 23:32 /var/cache/nginx/proxy_cache/</div><div class="line">[root@centos7 ~]<span class="comment"># chown -R nginx /var/cache/nginx/proxy_cache/</span></div><div class="line">[root@centos7 ~]<span class="comment"># ll -d /var/cache/nginx/proxy_cache/</span></div><div class="line">drwxr-xr-x 2 nginx root 6 Sep 15 23:32 /var/cache/nginx/proxy_cache/</div></pre></td></tr></table></figure></p>
<p>2）因为缓存只能定义在http配置段，所以编辑主配置文件/etc/nginx/nginx.conf<br><img src="\images\nginx\proxy_cache1.png" alt="nginx"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">    include       /etc/nginx/mime.types;</div><div class="line">    default_type  application/octet-stream;</div><div class="line"></div><div class="line">    log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></div><div class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></div><div class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</div><div class="line"></div><div class="line">    access_log  /var/<span class="built_in">log</span>/nginx/access.log  main;</div><div class="line"></div><div class="line">    proxy_cache_path /var/cache/nginx/proxy_cache levels=1:1:1 keys_zone=proxycache:20m max_size=1g;</div></pre></td></tr></table></figure></p>
<p>3）如上，已经定义好了，只需要在打算缓存的地方调用缓存即可，比如这里，我们对图片作缓存，编辑配置文件/etc/nginx/conf.d/default.conf<br><img src="\images\nginx\proxy_cache2.png" alt="nginx"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">location /admin/ &#123;</div><div class="line">        proxy_pass http://172.16.3.67;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    location ~*\.(jpg|jpeg|gif|png)$ &#123;</div><div class="line">        proxy_pass http://172.16.3.67;</div><div class="line">        proxy_cache proxycache;</div><div class="line">        proxy_cache_key <span class="variable">$request_uri</span>;</div><div class="line">        proxy_cache_valid 200 302 301 1h;</div><div class="line">        proxy_cache_valid any 1m;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>4）定义好之后保存退出，检测语法，重载；然后用浏览器访问morning.jpg，查看缓存目录，已经记录缓存，如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># tree /var/cache/nginx/proxy_cache/</span></div><div class="line">/var/cache/nginx/proxy_cache/</div><div class="line">├── 0</div><div class="line">│   └── 6</div><div class="line">│       └── 4</div><div class="line">│           └── 635450b5c68b27bfaa2e0065cb86c460</div><div class="line">└── e</div><div class="line">    └── 0</div><div class="line">        └── f</div><div class="line">            └── 9bf470d5057c3420d67aeaf320e6af0e</div><div class="line"></div><div class="line">6 directories, 2 files</div></pre></td></tr></table></figure></p>
<h3 id="ngx-http-headers-module模块"><a href="#ngx-http-headers-module模块" class="headerlink" title="ngx_http_headers_module模块"></a>ngx_http_headers_module模块</h3><p>★作用：<br>&ensp;&ensp;&ensp;&ensp;向由代理服务器响应给客户端的响应报文添加自定义首部，或修改指定首部的值；<br>★add_header name value [always];<br>☉作用：<br>&ensp;&ensp;&ensp;&ensp;添加自定义首部；<br>☉常用定义：<br>&ensp;&ensp;&ensp;&ensp;add_header X-Via  $server_addr;  代理服务器的地址<br>&ensp;&ensp;&ensp;&ensp;add_header X-Accel $server_name; 代理服务器的名称<br>★expires [modified] time;<br>&ensp;&ensp;&ensp;&ensp;expires epoch | max | off;<br>☉作用：<br>&ensp;&ensp;&ensp;&ensp;用于定义Expire或Cache-Control首部的值；即：设定响应报文的过期时长<br>示例：<br> 1）向响应报文中，指明客户端请求的内容是经由nginx代理服务器发送的（指明nginx代理服务器ip），编辑配置文件/etc/nginx/conf.d/default.conf<br> <img src="\images\nginx\nginx-http-header.png" alt="nginx"><br> <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">location /admin/ &#123;</div><div class="line">       proxy_pass http://172.16.3.67;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   add_header X-Via <span class="variable">$server_addr</span>;</div></pre></td></tr></table></figure></p>
<p>浏览器访问可以看到经由的nginxIP地址，如下：<br><img src="\images\nginx\nginx-http-header1.png" alt="nginx"></p>
<h4 id="注意："><a href="#注意：" class="headerlink" title="注意："></a>注意：</h4><p>&ensp;&ensp;&ensp;&ensp;nginx向后端代理时，具体要使用http_proxy模块，还是fastcgi模块，取决于后端服务器所支持的协议。如果后端主机为amp，则只能使用http_proxy模块，因为我们面向客户端提供服务的是httpd的http协议或者https协议。如果，后端主机为fpm server时，才能够使用fastcgi模块。</p>
<h3 id="ngx-http-upstream-module模块"><a href="#ngx-http-upstream-module模块" class="headerlink" title="ngx_http_upstream_module模块"></a>ngx_http_upstream_module模块</h3><p>功用：用于定义可以引用的服务器组，并定义这些服务器组的调度方法，从而完成能够将多台服务器，在面向前端的代理服务器请求时，可以以负载均衡的方式进行响应；<br>★upstream name { … }<br>☉作用：定义后端服务器组，会引入一个新的上下文；<br>☉Context（使用位置）: http<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">upstream backend &#123;</div><div class="line">    server backend1.example.com weight=5;</div><div class="line">    server 127.0.0.1:8080       max_fails=3 fail_timeout=30s;</div><div class="line">    server unix:/tmp/backend3;</div><div class="line"> </div><div class="line">    server backup1.example.com  backup;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>★server address [parameters];<br>☉作用：<br>&ensp;&ensp;&ensp;&ensp;在upstream上下文中server成员，以及相关的参数；<br>☉Context：upstream<br>☉address的表示格式：<br>◆unix:/PATH/TO/SOME_SOCK_FILE<br>&ensp;&ensp;&ensp;&ensp;某个套接字文件，要确保web服务器一定得是当前反代服务器上的web服务才可以；只能完成本地通信<br>◆IP[:PORT]<br>◆HOSTNAME[:PORT]<br>&ensp;&ensp;&ensp;&ensp;后端主机有基于主机名的虚拟主机，则向后端反代时会指向这个特定的虚拟主机，而不是默认虚拟主机<br>☉parameters：<br>◆weight=number<br>&ensp;&ensp;&ensp;&ensp;权重，默认为1；<br>◆max_fails=number<br>&ensp;&ensp;&ensp;&ensp;失败尝试最大次数；超出此处指定的次数时，server将被标记为不可用；<br>◆fail_timeout=time<br>&ensp;&ensp;&ensp;&ensp;设置将服务器标记为不可用状态的超时时长；<br>◆max_conns<br>◆backup<br>&ensp;&ensp;&ensp;&ensp;备用服务器，所有主服务器均故障时才启用此主机；<br>◆down<br>&ensp;&ensp;&ensp;&ensp;手动标记其不再处理任何用户请求；</p>
<h4 id="实验：定义使用nginx以负载均衡的方式进行响应。"><a href="#实验：定义使用nginx以负载均衡的方式进行响应。" class="headerlink" title="实验：定义使用nginx以负载均衡的方式进行响应。"></a>实验：定义使用nginx以负载均衡的方式进行响应。</h4><p><img src="\images\nginx\nginx-reverse.png" alt="nginx"><br>1.在上面实验nginx反代单台后端主机的基础上，我们再添加一台虚拟主机作为后端服务器web2，并提供默认测试页面如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># web1服务器</span></div><div class="line">[root@centos7 ~]<span class="comment"># ifconfig</span></div><div class="line">eno16777736: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</div><div class="line">        inet 172.16.3.67  netmask 255.255.255.0  broadcast 172.16.3.255</div><div class="line">        inet6 fe80::20c:29ff:fe7f:9cbe  prefixlen 64  scopeid 0x20&lt;link&gt;</div><div class="line">        ether 00:0c:29:7f:9c:be  txqueuelen 1000  (Ethernet)</div><div class="line">        RX packets 260  bytes 26275 (25.6 KiB)</div><div class="line">        RX errors 0  dropped 0  overruns 0  frame 0</div><div class="line">        TX packets 125  bytes 18400 (17.9 KiB)</div><div class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</div><div class="line">[root@centos7 ~]<span class="comment"># cat /usr/share/nginx/html/index.html</span></div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line"><span class="comment"># web2服务器</span></div><div class="line">[root@centos7 ~]<span class="comment"># ifconfig</span></div><div class="line">eno16777736: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</div><div class="line">        inet 172.16.3.133  netmask 255.255.255.0  broadcast 172.16.3.255</div><div class="line">        inet6 fe80::20c:29ff:fe43:3274  prefixlen 64  scopeid 0x20&lt;link&gt;</div><div class="line">        ether 00:0c:29:43:32:74  txqueuelen 1000  (Ethernet)</div><div class="line">        RX packets 1596  bytes 872167 (851.7 KiB)</div><div class="line">        RX errors 0  dropped 0  overruns 0  frame 0</div><div class="line">        TX packets 808  bytes 110143 (107.5 KiB)</div><div class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</div><div class="line">[root@centos7 ~]<span class="comment"># echo "&lt;h1&gt;UpStream Server 2&lt;/h1&gt;" &gt; /usr/share/nginx/html/index.html</span></div><div class="line">[root@centos7 ~]<span class="comment"># cat /usr/share/nginx/html/index.html</span></div><div class="line">&lt;h1&gt;UpStream Server 2&lt;/h1&gt;</div></pre></td></tr></table></figure></p>
<p>2.实验：实现将用户的请求代理至后端的服务器组<br>1）首先编辑主配置文件/etc/nginx/nginx.conf，在http段的上下文中定义upstream服务器组；<br> <img src="\images\nginx\nginx-upstream.png" alt="nginx"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">upstream webserv &#123;</div><div class="line">        server 172.16.3.67;</div><div class="line">        server 172.16.3.133;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>2）然后，编辑配置文件/etc/nginx/conf.d/default.conf(上例中的配置已经清空，这是原始配置文件)，使nginx反代至upstream组，如下：<br> <img src="\images\nginx\nginx-upstream1.png" alt="nginx"><br>配置好之后，保存，重载，使用浏览器访问，可以发现后端两台web服务器以轮询的方式响应<br><img src="\images\nginx\nginx-upstream2.png" alt="nginx"><br>刷新后变成web2<br><img src="\images\nginx\nginx-upstream3.png" alt="nginx"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@CentOS6 ~]<span class="comment"># for i in &#123;1..10&#125;;do curl http://10.1.252.128;done</span></div><div class="line">&lt;h1&gt;UpStream Server 2&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 2&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 2&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 2&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 2&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div></pre></td></tr></table></figure></p>
<p>3）现在我们再来编辑主配置文件/etc/nginx/nginx.conf,在web1上添加权重wegit 2<br><img src="\images\nginx\nginx-upstream4.png" alt="nginx"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">upstream webserv &#123;</div><div class="line">        server 172.16.3.67 weight=2;</div><div class="line">        server 172.16.3.133;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>再次测试，发现权重打的web1，响应的次数多<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@CentOS6 ~]<span class="comment"># for i in &#123;1..10&#125;;do curl http://10.1.252.128;done</span></div><div class="line">&lt;h1&gt;UpStream Server 2&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 2&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 2&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 2&lt;/h1&gt;</div></pre></td></tr></table></figure></p>
<p>4)现在我们来设置max_fails的值等于2，也就是说如果请求两次失败以后就标记为不可用，如下：<br><img src="\images\nginx\nginx-upstream5.png" alt="nginx"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">upstream webserv &#123;</div><div class="line">        server 172.16.3.67 weight=2 max_fails=2;</div><div class="line">        server 172.16.3.133 max_fails=2;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>我们现在把后端web2服务器httpd停掉，再去访问，发现停掉web2之后，nginx代理服务器只向web1服务器调度；<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@CentOS6 ~]<span class="comment"># for i in &#123;1..10&#125;;do curl http://10.1.252.128;done</span></div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div></pre></td></tr></table></figure></p>
<p>然后我们把停止服务的web2再启动起来，发现一段时间之后，又可以正常被调度至web2的服务之上了<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@CentOS6 ~]<span class="comment"># for i in &#123;1..10&#125;;do curl http://10.1.252.128;done</span></div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 2&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 2&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 2&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div></pre></td></tr></table></figure></p>
<p>5）如果在一个服务器后面添加backup参数，则表示这个服务器为备用服务器。只用当所有的后端服务器全都不能正常工作时，这台备用服务器才启用，开始工作；只要有一台后端服务器恢复工作，则备用服务器就停止工作。<br>6）如果在一个服务器的后面添加参数down，则表示这个服务器不可用，一般在应用程序发布，灰度模型时使用，如果服务器调试好要上线，只要把down去掉即可</p>
<h4 id="其他调度算法"><a href="#其他调度算法" class="headerlink" title="其他调度算法"></a>其他调度算法</h4><p>★least_conn;<br>&ensp;&ensp;&ensp;&ensp;最少连接调度算法，当server拥有不同的权重时其为wlc;<br>★ip_hash;<br>&ensp;&ensp;&ensp;&ensp;源地址hash调度方法；<br>★hash key [consistent];<br>&ensp;&ensp;&ensp;&ensp;基于指定的key的hash表来实现对请求的调度，此处的key可以直接文本、变量或二者的组合；<br>☉作用：将请求分类，同一类请求将发往同一个upstream server；<br>&ensp;&ensp;&ensp;&ensp;If the consistent parameter is specified the ketama consistent hashing method will be used instead.<br><img src="\images\nginx\nginx-upstream-hash.png" alt="nginx"><br>★keepalive connections;<br>&ensp;&ensp;&ensp;&ensp;为每个worker进程保留的空闲的长连接数量；<br>示例：<br>1.ip_hash算法：<br>在上例的基础上，我们采用ip_hash的调度方法，同样编辑配置文件如下：<br><img src="\images\nginx\nginx-upstream-hash1.png" alt="nginx"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">upstream webserv &#123;</div><div class="line">        server 172.16.3.67 max_fails=2;</div><div class="line">        server 172.16.3.133 max_fails=2;</div><div class="line">        ip_hash;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>使用curl命令访问可以发现第一次访问被调度的的后端服务器将始终为这个客户端提供服务，如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@CentOS6 ~]<span class="comment"># for i in &#123;1..10&#125;;do curl http://10.1.252.128;done</span></div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div><div class="line">&lt;h1&gt;UpStream Server 1&lt;/h1&gt;</div></pre></td></tr></table></figure></p>
<p>2.hash key算法<br>1)我们现在对客户请求的url做哈希算法，为了验证此算法，现在我们在后端的两台主机分别创建10个文件（url），url的名称都是相同的，内容不同，以此来判断到底是来自后端的哪个主机，如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># for i in &#123;0..9&#125;;do echo "Test Page $i ON Server 1" &gt; /usr/share/nginx/html/test$i.html;done</span></div><div class="line">[root@centos7 ~]<span class="comment"># ll /usr/share/nginx/html/</span></div><div class="line">total 1024</div><div class="line">-rw-r--r-- 1 root root    537 Jul 11 21:50 50x.html</div><div class="line">drwxr-xr-x 2 root root     41 Sep 15 16:31 admin</div><div class="line">drwxr-xr-x 2 root root     23 Sep 12 15:10 bbs</div><div class="line">drwxr-xr-x 5 root root   4096 Sep 13 12:39 blog</div><div class="line">drwxr-xr-x 2 root root     21 Sep 12 10:05 error_pages</div><div class="line">drwxr-xr-x 2 root root     23 Sep 12 15:31 forum</div><div class="line">-rw-r--r-- 1 root root     27 Sep 15 15:27 index.html</div><div class="line">-rw-r--r-- 1 root root    612 Sep 11 16:01 index.html.bak</div><div class="line">-rw-r--r-- 1 root root   4351 Sep 12 16:15 messages.html</div><div class="line">-rw-r--r-- 1 root root 980265 Sep 15 16:21 morning.jpg</div><div class="line">-rw-r--r-- 1 root root     24 Sep 16 14:43 <span class="built_in">test</span>0.html</div><div class="line">-rw-r--r-- 1 root root     24 Sep 16 14:43 <span class="built_in">test</span>1.html</div><div class="line">-rw-r--r-- 1 root root     24 Sep 16 14:43 <span class="built_in">test</span>2.html</div><div class="line">-rw-r--r-- 1 root root     24 Sep 16 14:43 <span class="built_in">test</span>3.html</div><div class="line">-rw-r--r-- 1 root root     24 Sep 16 14:43 <span class="built_in">test</span>4.html</div><div class="line">-rw-r--r-- 1 root root     24 Sep 16 14:43 <span class="built_in">test</span>5.html</div><div class="line">-rw-r--r-- 1 root root     24 Sep 16 14:43 <span class="built_in">test</span>6.html</div><div class="line">-rw-r--r-- 1 root root     24 Sep 16 14:43 <span class="built_in">test</span>7.html</div><div class="line">-rw-r--r-- 1 root root     24 Sep 16 14:43 <span class="built_in">test</span>8.html</div><div class="line">-rw-r--r-- 1 root root     24 Sep 16 14:43 <span class="built_in">test</span>9.html</div></pre></td></tr></table></figure></p>
<p>现在我们不添加调度算法，对test0.html请求，可以发现，在后端的两台服务器上做轮询，如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@CentOS6 ~]<span class="comment"># for i in &#123;1..10&#125;;do curl http://10.1.252.128/test0.html;done</span></div><div class="line">Test Page 0 ON Server 1</div><div class="line">Test Page 0 ON Server 2</div><div class="line">Test Page 0 ON Server 1</div><div class="line">Test Page 0 ON Server 2</div><div class="line">Test Page 0 ON Server 1</div><div class="line">Test Page 0 ON Server 2</div><div class="line">Test Page 0 ON Server 1</div><div class="line">Test Page 0 ON Server 2</div><div class="line">Test Page 0 ON Server 1</div><div class="line">Test Page 0 ON Server 2</div></pre></td></tr></table></figure></p>
<p>2）现在我们把用户请求的uri做哈希运算作为调度算法，编辑配置文件如下：<br><img src="\images\nginx\nginx-upstream-hash2.png" alt="nginx"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">upstream webserv &#123;</div><div class="line">        server 172.16.3.67 max_fails=2;</div><div class="line">        server 172.16.3.133 max_fails=2;</div><div class="line">        <span class="built_in">hash</span> <span class="variable">$request_uri</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>测试我们发现，只要第一次请求的uri调度到后端某台服务器，将会一直在此服务器之上，如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">[root@CentOS6 ~]<span class="comment"># for i in &#123;1..10&#125;;do curl http://10.1.252.128/test0.html;done</span></div><div class="line">Test Page 0 ON Server 2</div><div class="line">Test Page 0 ON Server 2</div><div class="line">Test Page 0 ON Server 2</div><div class="line">Test Page 0 ON Server 2</div><div class="line">Test Page 0 ON Server 2</div><div class="line">Test Page 0 ON Server 2</div><div class="line">Test Page 0 ON Server 2</div><div class="line">Test Page 0 ON Server 2</div><div class="line">Test Page 0 ON Server 2</div><div class="line">Test Page 0 ON Server 2</div><div class="line">[root@CentOS6 ~]<span class="comment"># for i in &#123;1..10&#125;;do curl http://10.1.252.128/test4.html;done</span></div><div class="line">Test Page 4 ON Server 1</div><div class="line">Test Page 4 ON Server 1</div><div class="line">Test Page 4 ON Server 1</div><div class="line">Test Page 4 ON Server 1</div><div class="line">Test Page 4 ON Server 1</div><div class="line">Test Page 4 ON Server 1</div><div class="line">Test Page 4 ON Server 1</div><div class="line">Test Page 4 ON Server 1</div><div class="line">Test Page 4 ON Server 1</div><div class="line">Test Page 4 ON Server 1</div><div class="line">[root@CentOS6 ~]<span class="comment"># for i in &#123;1..10&#125;;do curl http://10.1.252.128/test8.html;done</span></div><div class="line">Test Page 8 ON Server 1</div><div class="line">Test Page 8 ON Server 1</div><div class="line">Test Page 8 ON Server 1</div><div class="line">Test Page 8 ON Server 1</div><div class="line">Test Page 8 ON Server 1</div><div class="line">Test Page 8 ON Server 1</div><div class="line">Test Page 8 ON Server 1</div><div class="line">Test Page 8 ON Server 1</div><div class="line">Test Page 8 ON Server 1</div><div class="line">Test Page 8 ON Server 1</div><div class="line">[root@CentOS6 ~]<span class="comment"># for i in &#123;1..10&#125;;do curl http://10.1.252.128/test3.html;done</span></div><div class="line">Test Page 3 ON Server 2</div><div class="line">Test Page 3 ON Server 2</div><div class="line">Test Page 3 ON Server 2</div><div class="line">Test Page 3 ON Server 2</div><div class="line">Test Page 3 ON Server 2</div><div class="line">Test Page 3 ON Server 2</div><div class="line">Test Page 3 ON Server 2</div><div class="line">Test Page 3 ON Server 2</div><div class="line">Test Page 3 ON Server 2</div><div class="line">Test Page 3 ON Server 2</div></pre></td></tr></table></figure></p>
<h3 id="ngx-stream-core-module模块"><a href="#ngx-stream-core-module模块" class="headerlink" title="ngx_stream_core_module模块"></a>ngx_stream_core_module模块</h3><p>功用：模拟反代基于tcp或udp的服务连接，即工作于传输层的反代或调度器；<br>★stream { … }<br>&ensp;&ensp;&ensp;&ensp;作用：定义stream相关的服务；<br>&ensp;&ensp;&ensp;&ensp;Context：main<br>★listen<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Syntax:listen address:port [ssl] [udp] [proxy_protocol] [backlog=number] [<span class="built_in">bind</span>] [ipv6only=on|off] </div><div class="line">       [reuseport] [so_keepalive=on|off|[keepidle]:[keepintvl]:[keepcnt]];</div></pre></td></tr></table></figure></p>
<p><img src="\images\nginx\nginx-stream.png" alt="nginx"></p>
<h3 id="nginx的其它的二次发行版："><a href="#nginx的其它的二次发行版：" class="headerlink" title="nginx的其它的二次发行版："></a>nginx的其它的二次发行版：</h3><p>&ensp;&ensp;&ensp;&ensp;tengine<br>&ensp;&ensp;&ensp;&ensp;OpenResty</p>
<h4 id="思考："><a href="#思考：" class="headerlink" title="思考："></a>思考：</h4><p>&ensp;&ensp;&ensp;&ensp;动态资源存储一组服务器、图片资源存在一组服务器、静态的文本类资源存储在一组服务器；如何分别调度？<br>&ensp;&ensp;&ensp;&ensp;动态资源基于fastcgi（lnmp）或http协议（lnamp）?</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color1">Nginx</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2017/08/29/web services之nginx(四)/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>





  
    <article id="post-web services之nginx(三)" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/28/web services之nginx(三)/">Nginx进阶三</a>
    </h1>
  

        
        <a href="/2017/08/28/web services之nginx(三)/" class="archive-article-date">
  	<time datetime="2017-08-28T01:00:22.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2017-08-28</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Nginx相关配置"><a href="#Nginx相关配置" class="headerlink" title="Nginx相关配置"></a>Nginx相关配置</h3><p>内容主要包括：<br>◆ngx_http_fastcgi_module模块详解；<br>◆lnmp环境的部署；<br>◆定义fastcgi的缓存；<br>◆ngx_http_ssl_module模块：<br>◆配置nginx支持ssl的安全访问；<br>◆ngx_http_referer_module模块：防盗链功能</p>
<h3 id="ngx-http-fastcgi-module模块：构建lnmp"><a href="#ngx-http-fastcgi-module模块：构建lnmp" class="headerlink" title="ngx_http_fastcgi_module模块：构建lnmp"></a>ngx_http_fastcgi_module模块：构建lnmp</h3><p>The ngx_http_fastcgi_module module allows passing requests to a FastCGI server<br>★作用：<br>&ensp;&ensp;&ensp;&ensp;用于构建lnmp时，能够让nginx作为适配到fastcgi协议的客户端，从而能够连接至后端fpm的服务器，从而实现与fpm server进行通信<br><img src="\images\nginx\lnmp.png" alt="nginx"><br>★fastcgi_pass address;<br>&ensp;&ensp;&ensp;&ensp;address为fastcgi server的地址；<br>&ensp;&ensp;&ensp;&ensp;适用位置：location, if in location；<br>示例：<br>&ensp;&ensp;&ensp;&ensp;fastcgi_pass localhost:9000;<br>★fastcgi_index name;<br>&ensp;&ensp;&ensp;&ensp;fastcgi默认的主页资源;<br>★fastcgi_param parameter value [if_not_empty];<br>&ensp;&ensp;&ensp;&ensp;Sets a parameter that should be passed to the FastCGI server. The value can contain text, variables, and their combination.（传递给后端某一个服务器的变量的值，可以是字符串，也可以是变量，还可以是他们的组合）<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">[root@centos7 nginx]<span class="comment"># cat fastcgi_params </span></div><div class="line"></div><div class="line">fastcgi_param  QUERY_STRING       <span class="variable">$query_string</span>;</div><div class="line">fastcgi_param  REQUEST_METHOD     <span class="variable">$request_method</span>;</div><div class="line">fastcgi_param  CONTENT_TYPE       <span class="variable">$content_type</span>;</div><div class="line">fastcgi_param  CONTENT_LENGTH     <span class="variable">$content_length</span>;</div><div class="line"></div><div class="line">fastcgi_param  SCRIPT_NAME        <span class="variable">$fastcgi_script_name</span>;</div><div class="line">fastcgi_param  REQUEST_URI        <span class="variable">$request_uri</span>;</div><div class="line">fastcgi_param  DOCUMENT_URI       <span class="variable">$document_uri</span>;</div><div class="line">fastcgi_param  DOCUMENT_ROOT      <span class="variable">$document_root</span>;</div><div class="line">fastcgi_param  SERVER_PROTOCOL    <span class="variable">$server_protocol</span>;</div><div class="line">fastcgi_param  REQUEST_SCHEME     <span class="variable">$scheme</span>;</div><div class="line">fastcgi_param  HTTPS              <span class="variable">$https</span> if_not_empty;</div><div class="line"></div><div class="line">fastcgi_param  GATEWAY_INTERFACE  CGI/1.1;</div><div class="line">fastcgi_param  SERVER_SOFTWARE    nginx/<span class="variable">$nginx_version</span>;</div><div class="line"></div><div class="line">fastcgi_param  REMOTE_ADDR        <span class="variable">$remote_addr</span>;</div><div class="line">fastcgi_param  REMOTE_PORT        <span class="variable">$remote_port</span>;</div><div class="line">fastcgi_param  SERVER_ADDR        <span class="variable">$server_addr</span>;</div><div class="line">fastcgi_param  SERVER_PORT        <span class="variable">$server_port</span>;</div><div class="line">fastcgi_param  SERVER_NAME        <span class="variable">$server_name</span>;</div><div class="line"></div><div class="line"><span class="comment"># PHP only, required if PHP was built with --enable-force-cgi-redirect</span></div><div class="line">fastcgi_param  REDIRECT_STATUS    200;</div></pre></td></tr></table></figure></p>
<p>⊙配置lnmp示例1<br><img src="\images\nginx\lnmp1.png" alt="nginx"><br>⊙配置示例2：通过/pm_status和/ping来获取fpm server状态信息；<br><img src="\images\nginx\lnmp2.png" alt="nginx"></p>
<h3 id="部署lnmp环境"><a href="#部署lnmp环境" class="headerlink" title="部署lnmp环境"></a>部署lnmp环境</h3><p>1.首先安装相关的部署程序包<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># yum install php-fpm php-mysql php-gd php-mbstring php-mcrypt -y</span></div></pre></td></tr></table></figure></p>
<p>2.php-fpm默认系统用户和组为apache，因为这里要使nginx与php-fpm相结合，所以我们需要修改php-fpm的配置文件/etc/php-fpm.d/www.conf 修改用户和组为nginx<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@centos7 php-fpm.d]<span class="comment"># ls</span></div><div class="line">www.conf</div><div class="line">[root@centos7 php-fpm.d]<span class="comment"># vim www.conf         # 修改配置文件</span></div><div class="line">user = nginx</div><div class="line">group = nginx</div><div class="line"></div><div class="line">pm.status_path = /pm_status                    <span class="comment"># 启用状态页</span></div><div class="line">ping.path = /ping                              <span class="comment"># 启用ping和pong接口</span></div><div class="line">ping.response = pong</div></pre></td></tr></table></figure></p>
<p>3.创建/var/lib/php/session，并修改其属主和属组为nginx<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@centos7 php-fpm.d]<span class="comment"># mkdir /var/lib/php/session</span></div><div class="line">[root@centos7 php-fpm.d]<span class="comment"># chown -R nginx.nginx /var/lib/php/session/</span></div><div class="line">[root@centos7 php-fpm.d]<span class="comment"># ll -d /var/lib/php/session/</span></div><div class="line">drwxr-xr-x 2 nginx nginx 6 Sep 13 11:04 /var/lib/php/session/</div></pre></td></tr></table></figure></p>
<p>4.启动服务，并查看其对应端口，nginx/80,mairadb/3306,php-fpm/9000<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># systemctl start nginx</span></div><div class="line">[root@centos7 ~]<span class="comment"># systemctl start php-fpm</span></div><div class="line">[root@centos7 ~]<span class="comment"># ss -tnl</span></div><div class="line">State       Recv-Q Send-Q Local Address:Port               Peer Address:Port              </div><div class="line">LISTEN      0      128      127.0.0.1:9000                         *:*                  </div><div class="line">LISTEN      0      128              *:80                           *:*                  </div><div class="line">LISTEN      0      128              *:22                           *:*                  </div><div class="line">LISTEN      0      100      127.0.0.1:25                           *:*                  </div><div class="line">LISTEN      0      128             :::22                          :::*                  </div><div class="line">LISTEN      0      100            ::1:25                          :::*        </div><div class="line">在mariadb服务器上启动mariadb服务</div><div class="line">[root@centos7 ~]<span class="comment"># systemctl start mariadb</span></div><div class="line">[root@centos7 ~]<span class="comment"># ss -tnl</span></div><div class="line">State       Recv-Q Send-Q Local Address:Port               Peer Address:Port              </div><div class="line">LISTEN      0      50               *:3306                         *:*                  </div><div class="line">LISTEN      0      128              *:22                           *:*                  </div><div class="line">LISTEN      0      100      127.0.0.1:25                           *:*                  </div><div class="line">LISTEN      0      128             :::22                          :::*                  </div><div class="line">LISTEN      0      100            ::1:25                          :::*</div></pre></td></tr></table></figure></p>
<p>5.接下来我们就可以配置nginx使用php-fpm了，配置如下：<br>1）/etc/nginx/conf.d/default.conf中自带有fastcgi的定义，我们直接启用就可以，然后稍作修改<br><img src="\images\nginx\lnmp3.png" alt="nginx"><br>2）修改如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">location ~* \.php$ &#123;       <span class="comment"># 上图匹配所有以.php结尾的文件区分大小写，这里改为不区分大小写</span></div><div class="line">        root           /usr/share/nginx/html;          <span class="comment"># 默认为相对路径，这里最好改为绝对路径</span></div><div class="line">        fastcgi_pass   127.0.0.1:9000;</div><div class="line">        fastcgi_index  index.php;         <span class="comment"># 默认的主页面</span></div><div class="line">        <span class="comment"># 请求时传递的脚本参数到后端，这里我们要给它一个真正的root路径下的url</span></div><div class="line">        <span class="comment"># 这里的url一定要转换成对应的后端服务器的网页文件的位置</span></div><div class="line">        fastcgi_param  SCRIPT_FILENAME  /usr/share/nginx/html/<span class="variable">$fastcgi_script_name</span>;</div><div class="line">        include        fastcgi_params;    <span class="comment"># 包含的另外一个配置文件</span></div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>3）修改完成之后，检测语法，并重载nginx服务，然后提供页面文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># nginx -t</span></div><div class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</div><div class="line">nginx: configuration file /etc/nginx/nginx.conf <span class="built_in">test</span> is successful</div><div class="line">[root@centos7 ~]<span class="comment"># nginx -s reload</span></div><div class="line"></div><div class="line">[root@centos7 ~]<span class="comment"># cat &lt;&lt; EOF &gt;&gt; /usr/share/nginx/html/phpinfo.php</span></div><div class="line">&lt;?php</div><div class="line">       phpinfo();</div><div class="line">&gt; ?&gt;</div><div class="line">&gt; EOF</div><div class="line">[root@centos7 ~]<span class="comment"># cat /usr/share/nginx/html/phpinfo.php</span></div><div class="line">&lt;?php</div><div class="line">       phpinfo();</div><div class="line">?&gt;</div></pre></td></tr></table></figure></p>
<p>用浏览器访问如下：<br><img src="\images\nginx\lnmp4.png" alt="nginx"><br>6.接下来我们部署一个php的应用程序wordpress<br>1）下载wordpress并解压，创建blog目录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 解压wordpress用户程序</span></div><div class="line">[root@centos7 ~]<span class="comment"># tar xf wordpress-4.8.1.tar.gz </span></div><div class="line"><span class="comment"># 创建blog博客目录 ，移动解压的wordpress到创建 的blog目录下</span></div><div class="line">[root@centos7 ~]<span class="comment"># mkdir /usr/share/nginx/html/blog</span></div><div class="line">[root@centos7 ~]<span class="comment"># mv /root/wordpress/* /usr/share/nginx/html/blog/</span></div><div class="line">[root@centos7 ~]<span class="comment"># ls /usr/share/nginx/html/blog/</span></div><div class="line">index.php        wp-blog-header.php    wp-includes        wp-settings.php</div><div class="line">license.txt      wp-comments-post.php  wp-links-opml.php  wp-signup.php</div><div class="line">readme.html      wp-config-sample.php  wp-load.php        wp-trackback.php</div><div class="line">wp-activate.php  wp-content            wp-login.php       xmlrpc.php</div><div class="line">wp-admin         wp-cron.php           wp-mail.php</div></pre></td></tr></table></figure></p>
<p>2）测试wordpress<br><img src="\images\nginx\lnmp5.png" alt="nginx"><br>提示客户端错误，原因为我们这里的默认主页面index.php虽然已经在location中定义，但是没有在server中定义，所以再次修改nginx的配置文件如下：<br><img src="\images\nginx\lnmp6.png" alt="nginx"><br>修改好之后，保存退出，检测语法重载之后，再次刷新页面，可以正常访问，如下图：<br><img src="\images\nginx\lnmp7.png" alt="nginx"><br>3）配置mariadb，创建wp数据库并授权用户wp_user远程访问<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">MariaDB [(none)]&gt; create database wp;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line">MariaDB [(none)]&gt; grant all on wp.* to <span class="string">'wp_user'</span>@<span class="string">'172.16.3.%'</span> identified by <span class="string">'12345678'</span>;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line">MariaDB [(none)]&gt; flush privileges;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line">MariaDB [(none)]&gt; select user,host,password from mysql.user;</div><div class="line">+---------+------------+-------------------------------------------+</div><div class="line">| user    | host       | password                                  |</div><div class="line">+---------+------------+-------------------------------------------+</div><div class="line">| root    | localhost  | *6BB4837EB74329105EE4568DDA7DC67ED2CA2AD9 |</div><div class="line">| root    | centos7    | *6BB4837EB74329105EE4568DDA7DC67ED2CA2AD9 |</div><div class="line">| root    | 127.0.0.1  | *6BB4837EB74329105EE4568DDA7DC67ED2CA2AD9 |</div><div class="line">| root    | ::1        | *6BB4837EB74329105EE4568DDA7DC67ED2CA2AD9 |</div><div class="line">| wp_user | 172.16.3.% | *84AAC12F54AB666ECFC2A83C676908C8BBC381B1 |</div><div class="line">+---------+------------+-------------------------------------------+</div><div class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</div></pre></td></tr></table></figure></p>
<p>4）安装wordpress<br><img src="\images\nginx\lnmp8.png" alt="nginx"><br><img src="\images\nginx\lnmp9.png" alt="nginx"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line">[root@centos7 blog]<span class="comment"># vi wp-config.php</span></div><div class="line">&lt;?php</div><div class="line">/**</div><div class="line"> * The base configuration <span class="keyword">for</span> WordPress</div><div class="line"> *</div><div class="line"> * The wp-config.php creation script uses this file during the</div><div class="line"> * installation. You don<span class="string">'t have to use the web site, you can</span></div><div class="line"> * copy this file to "wp-config.php" and fill in the values.</div><div class="line"> *</div><div class="line"> * This file contains the following configurations:</div><div class="line"> *</div><div class="line"> * * MySQL settings</div><div class="line"> * * Secret keys</div><div class="line"> * * Database table prefix</div><div class="line"> * * ABSPATH</div><div class="line"> *</div><div class="line"> * @link https://codex.wordpress.org/Editing_wp-config.php</div><div class="line"> *</div><div class="line"> * @package WordPress</div><div class="line"> */</div><div class="line"></div><div class="line">// ** MySQL settings - You can get this info from your web host ** //</div><div class="line">/** The name of the database for WordPress */</div><div class="line">define('DB_NAME<span class="string">', '</span>wp<span class="string">');</span></div><div class="line"></div><div class="line">/** MySQL database username */</div><div class="line">define('DB_USER<span class="string">', '</span>wp_user<span class="string">');</span></div><div class="line"></div><div class="line">/** MySQL database password */</div><div class="line">define('DB_PASSWORD<span class="string">', '</span>12345678<span class="string">');</span></div><div class="line"></div><div class="line">/** MySQL hostname */</div><div class="line">define('DB_HOST<span class="string">', '</span>172.16.3.26<span class="string">');</span></div><div class="line"></div><div class="line">/** Database Charset to use in creating database tables. */</div><div class="line">define('DB_CHARSET<span class="string">', '</span>utf8mb4<span class="string">');</span></div><div class="line"></div><div class="line">/** The Database Collate type. Don't change this <span class="keyword">if</span> <span class="keyword">in</span> doubt. */</div><div class="line">define(<span class="string">'DB_COLLATE'</span>, <span class="string">''</span>);</div><div class="line"></div><div class="line">/**<span class="comment">#@+</span></div><div class="line"> * Authentication Unique Keys and Salts.</div><div class="line"> *</div><div class="line"> * Change these to different unique phrases!</div><div class="line"> * You can generate these using the &#123;@link https://api.wordpress.org/secret-key/1.1/salt/ WordPress.org secret-key service&#125;</div><div class="line"> * You can change these at any point <span class="keyword">in</span> time to invalidate all existing cookies. This will force all users to have to <span class="built_in">log</span> <span class="keyword">in</span> again.</div><div class="line"> *</div><div class="line"> * @since 2.6.0</div><div class="line"> */</div><div class="line">define(<span class="string">'AUTH_KEY'</span>,         <span class="string">'WJ!D.b$=-?p^rPDl=k6yjpW8^%7K&#123;nWnJ!4+%ZO/&#123;,VWyPhpkQS:^+$V9I2-42#k'</span>);</div><div class="line">define(<span class="string">'SECURE_AUTH_KEY'</span>,  <span class="string">'oqE?pMs=`~16NKhcoX.AhLJ|Q&gt;5p5_lRnJ+&lt;J$VV5^KPoBOgor^ibV]=QC!I2[EV'</span>);</div><div class="line">define(<span class="string">'LOGGED_IN_KEY'</span>,    <span class="string">'B&#125;6Dd$$(/yCF&amp;+%0i8@u@9ls^.7?8#r&gt;1?oNou)]RFrkF.$;LY* 5xW#g?Jp4g!i'</span>);</div><div class="line">define(<span class="string">'NONCE_KEY'</span>,        <span class="string">'!=Rm00QclZ0[~N&amp;H&lt;6519;1gIB+!O:em&lt;1:Rl$IC~ZIu&amp;TN2`e:ox_T7z[o#(LgW'</span>);</div><div class="line">define(<span class="string">'AUTH_SALT'</span>,        <span class="string">'0,r6tuW$&amp;t`I3.iJo:[;iq|C&amp; 2&amp;[tnn.fAz$=:#X[TSSHWK;6.d37Y(:aCjcl@p'</span>);</div><div class="line">define(<span class="string">'SECURE_AUTH_SALT'</span>, <span class="string">'=%i^n.q9q:A&gt;@t&#123;`keD,uySvy=P~x$!NN8oys[6WIhU-KmU4&#125;#dW* m&gt;NOKyGGEr'</span>);</div><div class="line">define(<span class="string">'LOGGED_IN_SALT'</span>,   <span class="string">':`&amp;5uJ[ugEKcS?Bd*7?yeaJn-&#123;vZ-nR:hEm+CLU]]S@ AV=yS-`b,X&#125;n]QD+Ox6/'</span>);</div><div class="line">define(<span class="string">'NONCE_SALT'</span>,       <span class="string">'a-5qR2zwX&#123;3&lt;ds&gt;u:%I7cQB,v+MdG.,LD&amp;?gjxUQ3=8@6a Jds2?,]`TP+JyYD/.'</span>);</div><div class="line"></div><div class="line">/**<span class="comment">#@-*/</span></div><div class="line"></div><div class="line">/**</div><div class="line"> * WordPress Database Table prefix.</div><div class="line"> *</div><div class="line"> * You can have multiple installations <span class="keyword">in</span> one database <span class="keyword">if</span> you give each</div><div class="line"> * a unique prefix. Only numbers, letters, and underscores please!</div><div class="line"> */</div><div class="line"><span class="variable">$table_prefix</span>  = <span class="string">'wp_'</span>;</div><div class="line"></div><div class="line">/**</div><div class="line"> * For developers: WordPress debugging mode.</div><div class="line"> *</div><div class="line"> * Change this to <span class="literal">true</span> to <span class="built_in">enable</span> the display of notices during development.</div><div class="line"> * It is strongly recommended that plugin and theme developers use WP_DEBUG</div><div class="line"> * <span class="keyword">in</span> their development environments.</div><div class="line"> *</div><div class="line"> * For information on other constants that can be used <span class="keyword">for</span> debugging,</div><div class="line"> * visit the Codex.</div><div class="line"> *</div><div class="line"> * @link https://codex.wordpress.org/Debugging_in_WordPress</div><div class="line"> */</div><div class="line">define(<span class="string">'WP_DEBUG'</span>, <span class="literal">false</span>);</div><div class="line"></div><div class="line">/* That<span class="string">'s all, stop editing! Happy blogging. */</span></div><div class="line"></div><div class="line">/** Absolute path to the WordPress directory. */</div><div class="line">if ( !defined('ABSPATH<span class="string">') )</span></div><div class="line">	define('ABSPATH<span class="string">', dirname(__FILE__) . '</span>/<span class="string">');</span></div><div class="line"></div><div class="line">/** Sets up WordPress vars and included files. */</div><div class="line">require_once(ABSPATH . 'wp-settings.php<span class="string">');</span></div></pre></td></tr></table></figure></p>
<p><img src="\images\nginx\lnmp10.png" alt="nginx"></p>
<p>7.我们已经在php-fpm的配置文件中开启了测试功能（ping/pong）和状态页status，之前我们在httpd中是通过添加单独的匹配条件代理至后端的，那在nginx中我们应该怎样设置呢？如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">location ~* ^/(pm_status|ping)$ &#123;</div><div class="line">       fastcgi_pass    127.0.0.1:9000;</div><div class="line">       fastcgi_param   SCRIPT_FILENAME  <span class="variable">$fastcgi_script_name</span>;</div><div class="line">       include         fastcgi_params;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>我们使用浏览器访问如下：<br><img src="\images\nginx\lnmp11.png" alt="nginx"><br><img src="\images\nginx\lnmp12.png" alt="nginx"><br>如上，就为简单部署成功了一个lnmp环境了</p>
<h4 id="fastcgi的缓存"><a href="#fastcgi的缓存" class="headerlink" title="fastcgi的缓存"></a>fastcgi的缓存</h4><p>★fastcgi_cache_path path<br>☉格式和适用位置：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Syntax: </span></div><div class="line">    fastcgi_cache_path path [levels=levels] [use_temp_path=on|off] keys_zone=name:size </div><div class="line">    [inactive=time] [max_size=size] [manager_files=number] [manager_sleep=time] </div><div class="line">    [manager_threshold=time] [loader_files=number] [loader_sleep=time] </div><div class="line">    [loader_threshold=time] [purger=on|off] [purger_files=number] [purger_sleep=time] </div><div class="line">    [purger_threshold=time];</div><div class="line">     </div><div class="line">  Default:—    </div><div class="line">  Context:http  <span class="comment"># 只能定义在http中</span></div></pre></td></tr></table></figure></p>
<p>☉作用：<br>&ensp;&ensp;&ensp;&ensp;定义fastcgi的缓存；缓存位置为磁盘上的文件系统，由path所指定路径来定义；<br>☉参数：<br>◆levels=levels：缓存目录的层级数量，以及每一级的目录数量；<br>&ensp;&ensp;&ensp;&ensp;levels=ONE:TWO:THREE    例如：leves=1:2:2（每一级为16进制数）<br>◆keys_zone=name:size<br>&ensp;&ensp;&ensp;&ensp;k/v映射的内存空间的名称及大小<br>&ensp;&ensp;&ensp;&ensp;缓存的组织方式：缓存是哈希值，而且对应的缓存文件名通常是文件内容的哈希内容，并且缓存层级是按照定义的多级结构去存放文件的；<br>◆inactive=time：非活动时长；<br>◆max_size=size：磁盘上用于缓存数据的缓存空间上限；<br>★fastcgi_cache zone | off;<br>&ensp;&ensp;&ensp;&ensp;作用：调用指定的缓存空间来缓存数据；<br>&ensp;&ensp;&ensp;&ensp;适用位置：http, server, location<br>★fastcgi_cache_key string;<br>&ensp;&ensp;&ensp;&ensp;作用：定义用作缓存项的key的字符串，通常为uri当变量；<br>★fastcgi_cache_methods GET | HEAD | POST …;<br>&ensp;&ensp;&ensp;&ensp;作用：为哪些请求方法使用缓存；<br>★fastcgi_cache_min_uses number;<br>&ensp;&ensp;&ensp;&ensp;作用：缓存空间中的缓存项在inactive定义的非活动时间内至少要被访问到此处所指定的次数方可被认作活动项；<br>★fastcgi_cache_valid [code …] time;<br>&ensp;&ensp;&ensp;&ensp;作用：不同的响应码各自的缓存时长；</p>
<h4 id="定义使用缓存："><a href="#定义使用缓存：" class="headerlink" title="定义使用缓存："></a>定义使用缓存：</h4><p>1.首先要创建一个缓存的文件目录，实际生产环境中可以放在固态磁盘上或者Raid0上，这样I/O能力很强；（注意文可能需要修改属主和属组为nginx）<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># ls /var/cache/nginx/</span></div><div class="line">client_temp  fastcgi_temp  proxy_temp  scgi_temp  uwsgi_temp</div><div class="line">[root@centos7 ~]<span class="comment"># mkdir /var/cache/nginx/fastcgi_cache</span></div></pre></td></tr></table></figure></p>
<p>2.因为缓存只能定义在http配置段，所以编辑主配置文件/etc/nginx/nginx.conf<br><img src="\images\nginx\fastcgi-cache.png" alt="nginx"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">    include       /etc/nginx/mime.types;</div><div class="line">    default_type  application/octet-stream;</div><div class="line"></div><div class="line">    log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></div><div class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></div><div class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</div><div class="line"></div><div class="line">    access_log  /var/<span class="built_in">log</span>/nginx/access.log  main;</div><div class="line">    </div><div class="line">    fastcgi_cache_path /var/cache/nginx/fastcgi_cache levels=1:2:1 keys_zone=fcgi:20m inactive=120s;</div><div class="line"></div><div class="line">    sendfile        on;</div></pre></td></tr></table></figure></p>
<p>3.如上，已经定义好了，但是要想调用，要定义在在server或者location中，因为我们这里针对的是fastcgi协议所以定义在php的location中，如下<br><img src="\images\nginx\fastcgi-cache1.png" alt="nginx"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span></div><div class="line">   <span class="comment">#</span></div><div class="line">   location ~* \.php$ &#123;</div><div class="line">       root           /usr/share/nginx/html;</div><div class="line">       fastcgi_pass   127.0.0.1:9000;</div><div class="line">       fastcgi_index  index.php;</div><div class="line">       fastcgi_param  SCRIPT_FILENAME  /usr/share/nginx/html/<span class="variable">$fastcgi_script_name</span>;</div><div class="line">       include        fastcgi_params;</div><div class="line">       fastcgi_cache fcgi;</div><div class="line">       fastcgi_cache_key <span class="variable">$request_uri</span>;</div><div class="line">       fastcgi_cache_valid 200 302 10m;</div><div class="line">       fastcgi_cache_valid 301 1h;</div><div class="line">       fastcgi_cache_valid any 1m;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>4.定义好之后保存退出，检测语法，重载；然后用浏览器访问wrokpress，查看缓存如下:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># nginx -t</span></div><div class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</div><div class="line">nginx: configuration file /etc/nginx/nginx.conf <span class="built_in">test</span> is successful</div><div class="line">[root@centos7 ~]<span class="comment"># nginx -s reload</span></div><div class="line">[root@centos7 ~]<span class="comment"># tree /var/cache/nginx/fastcgi_cache/</span></div><div class="line">/var/cache/nginx/fastcgi_cache/</div><div class="line">`-- 6</div><div class="line">    `-- da</div><div class="line">        `-- 4</div><div class="line">            `-- f7aa5e7d8164aa09aacfe1de7eb14da6</div><div class="line"></div><div class="line">3 directories, 1 file</div></pre></td></tr></table></figure></p>
<p>再访问<a href="http://172.16.3.67/phpinfo.php，查看缓存如下：" target="_blank" rel="external">http://172.16.3.67/phpinfo.php，查看缓存如下：</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># tree /var/cache/nginx/fastcgi_cache/</span></div><div class="line">/var/cache/nginx/fastcgi_cache/</div><div class="line">|-- 0</div><div class="line">|   `-- 15</div><div class="line">|       `-- 4</div><div class="line">|           `-- 918e9e96dec978b2ec01d531bef84150</div><div class="line">|-- 6</div><div class="line">|   `-- da</div><div class="line">|       `-- 4</div><div class="line">|           `-- f7aa5e7d8164aa09aacfe1de7eb14da6</div><div class="line">|-- c</div><div class="line">|   `-- ff</div><div class="line">|       `-- 5</div><div class="line">|           `-- fedd4be3b7248dae2180b5281a665ffc</div><div class="line">|-- e</div><div class="line">|   `-- fd</div><div class="line">|       `-- 5</div><div class="line">|           `-- 98413616be76ca2adb60d2de52405fde</div><div class="line">`-- f</div><div class="line">    `-- a6</div><div class="line">        `-- 5</div><div class="line">            `-- f507ec3769c639b6261e1eb529305a6f</div><div class="line"></div><div class="line">15 directories, 5 files</div></pre></td></tr></table></figure></p>
<h4 id="fastcgi-的保持连接"><a href="#fastcgi-的保持连接" class="headerlink" title="fastcgi 的保持连接"></a>fastcgi 的保持连接</h4><p>★fastcgi_keep_conn on | off;<br>&ensp;&ensp;&ensp;&ensp;By default, a FastCGI server will close a connection right after sending the response. However, when this directive is set to the value on, nginx will instruct a FastCGI server to keep connections open.<br>☉作用：<br>&ensp;&ensp;&ensp;&ensp;在并发压力较大的时候，向后端php-fpm开启保持连接是很有必要的，可以减轻nginx的压力；</p>
<h3 id="ngx-http-ssl-module模块"><a href="#ngx-http-ssl-module模块" class="headerlink" title="ngx_http_ssl_module模块"></a>ngx_http_ssl_module模块</h3><h4 id="支持nginx能够运行为https服务"><a href="#支持nginx能够运行为https服务" class="headerlink" title="支持nginx能够运行为https服务"></a>支持nginx能够运行为https服务</h4><p>★ssl on | off;<br>&ensp;&ensp;&ensp;&ensp;Enables the HTTPS protocol for the given virtual server.（是否在给定的虚拟主机上启用https协议）<br>★ssl_certificate file;<br>&ensp;&ensp;&ensp;&ensp;当前虚拟主机使用PEM格式的证书文件；<br>★ssl_certificate_key file;<br>&ensp;&ensp;&ensp;&ensp;当前虚拟主机上与其证书匹配的私钥文件；<br>★ssl_protocols [SSLv2] [SSLv3] [TLSv1] [TLSv1.1] [TLSv1.2];<br>&ensp;&ensp;&ensp;&ensp;支持ssl协议版本，默认为后三个；建议使用1.1版本<br>★ssl_session_cache off | none | [builtin[:size]] [shared:name:size];<br>&ensp;&ensp;&ensp;&ensp;builtin[:size]：使用OpenSSL内建的缓存，此缓存为每worker进程私有；<br>&ensp;&ensp;&ensp;&ensp;[shared:name:size]：在各worker进程之间使用一个共享的缓存；（性能更好一点，但是危险会更大一点）<br>★ssl_session_timeout time;<br>&ensp;&ensp;&ensp;&ensp;客户端一侧的连接可以复用ssl session cache中缓存 的ssl参数的有效时长；<br>配置示例：<br><img src="\images\nginx\https.png" alt="nginx"><br>把80端口重定向到443上，然后关闭80服务；<br><img src="\images\nginx\https1.png" alt="nginx"></p>
<h4 id="配置使ngins支持https协议"><a href="#配置使ngins支持https协议" class="headerlink" title="配置使ngins支持https协议"></a>配置使ngins支持https协议</h4><p>1.在rpm包安装的nginx的配置文件中没有对ssl的相关配置，所以这里我们在/etc/nginx/conf.d下新定义一个虚拟主机使其支持ssl，配置如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@centos7 conf.d]<span class="comment"># pwd</span></div><div class="line">/etc/nginx/conf.d</div><div class="line">[root@centos7 conf.d]<span class="comment"># vim ssl.conf</span></div><div class="line">server &#123;</div><div class="line">        listen 443 ssl;                                    <span class="comment"># 指明ssl监听的端口443，和ssl协议</span></div><div class="line">        server_name   www1.jack.com                        <span class="comment"># 主机名</span></div><div class="line">        root /vnhosts/ssl/htdocs;</div><div class="line">        ssl on;                                             <span class="comment"># ssl的路径</span></div><div class="line">        ssl_certificate /etc/nginx/ssl/nginx.crt;          <span class="comment"># 虚拟机使用的证书文件的路径</span></div><div class="line">        ssl_certificate_key /etc/nginx/ssl/nginx.key;      <span class="comment"># 与其证书匹配的私钥文件路径</span></div><div class="line">        ssl_session_cache shared:sslcache:20m;             <span class="comment"># 定义使用共享缓存，名字为sslcache，大小为20M</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>2.为了测试，首先在自己的主机上创建私有CA，但是在互联网上公开使用时，一定要找公共CA去签署<br>1）生成私钥文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># cd /etc/pki/CA</span></div><div class="line">[root@centos7 CA]<span class="comment"># ls</span></div><div class="line">certs  crl  newcerts  private</div><div class="line">[root@centos7 CA]<span class="comment"># ls private/</span></div><div class="line">[root@centos7 CA]<span class="comment"># (umask 077;openssl genrsa -out private/cakey.pem 4096)</span></div><div class="line">Generating RSA private key, 4096 bit long modulus</div><div class="line">.........................................................................................................................++</div><div class="line">........++</div><div class="line">e is 65537 (0x10001)</div><div class="line">[root@centos7 CA]<span class="comment"># ls private/</span></div><div class="line">cakey.pem</div></pre></td></tr></table></figure></p>
<p>2）生成自签证书<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[root@centos7 CA]<span class="comment"># openssl req -new -x509 -key private/cakey.pem -out cacert.pem</span></div><div class="line">You are about to be asked to enter information that will be incorporated</div><div class="line">into your certificate request.</div><div class="line">What you are about to enter is what is called a Distinguished Name or a DN.</div><div class="line">There are quite a few fields but you can leave some blank</div><div class="line">For some fields there will be a default value,</div><div class="line">If you enter <span class="string">'.'</span>, the field will be left blank.</div><div class="line">-----</div><div class="line">Country Name (2 letter code) [XX]:CN</div><div class="line">State or Province Name (full name) []:JS</div><div class="line">Locality Name (eg, city) [Default City]:SZ</div><div class="line">Organization Name (eg, company) [Default Company Ltd]:Magedu        </div><div class="line">Organizational Unit Name (eg, section) []:ops</div><div class="line">Common Name (eg, your name or your server<span class="string">'s hostname) []:ca.magedu.com</span></div><div class="line">Email Address []:</div><div class="line">[root@centos7 CA]# ll</div><div class="line">total 4</div><div class="line">-rw-r--r--  1 root root 1988 Sep 13 15:57 cacert.pem</div><div class="line">drwxr-xr-x. 2 root root    6 Jun 29  2015 certs</div><div class="line">drwxr-xr-x. 2 root root    6 Jun 29  2015 crl</div><div class="line">drwxr-xr-x. 2 root root    6 Jun 29  2015 newcerts</div><div class="line">drwx------. 2 root root   22 Sep 13 15:12 private</div></pre></td></tr></table></figure></p>
<p>3）为CA提供目录和文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@centos7 CA]<span class="comment"># touch index.txt</span></div><div class="line">[root@centos7 CA]<span class="comment"># echo 01 &gt; serial</span></div><div class="line">[root@centos7 CA]<span class="comment"># ls</span></div><div class="line">cacert.pem  certs  crl  index.txt  newcerts  private  serial</div></pre></td></tr></table></figure></p>
<p>3.如上，创建CA完成，接下来要为nginx服务器签署CA请求<br>1）创建用于httpd通信时的私钥<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@centos7 CA]<span class="comment"># cd /etc/nginx/</span></div><div class="line">[root@centos7 nginx]<span class="comment"># ls</span></div><div class="line">conf.d          koi-utf  mime.types  nginx.conf   uwsgi_params</div><div class="line">fastcgi_params  koi-win  modules     scgi_params  win-utf</div><div class="line">[root@centos7 nginx]<span class="comment"># mkdir ssl</span></div><div class="line">[root@centos7 nginx]<span class="comment"># cd ssl</span></div><div class="line">[root@centos7 ssl]<span class="comment"># (umask 077;openssl genrsa -out nginx.key 2048)</span></div><div class="line">Generating RSA private key, 2048 bit long modulus</div><div class="line">...........................................................+++</div><div class="line">..................................................................+++</div><div class="line">e is 65537 (0x10001)</div><div class="line">[root@centos7 ssl]<span class="comment"># ll</span></div><div class="line">total 4</div><div class="line">-rw------- 1 root root 1675 Sep 13 16:04 nginx.key</div></pre></td></tr></table></figure></p>
<p>2）利用生成的私钥生成证书签署请求：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ssl]<span class="comment"># openssl req -new -key nginx.key -out nginx.csr</span></div><div class="line">You are about to be asked to enter information that will be incorporated</div><div class="line">into your certificate request.</div><div class="line">What you are about to enter is what is called a Distinguished Name or a DN.</div><div class="line">There are quite a few fields but you can leave some blank</div><div class="line">For some fields there will be a default value,</div><div class="line">If you enter <span class="string">'.'</span>, the field will be left blank.</div><div class="line">-----</div><div class="line">Country Name (2 letter code) [XX]:CN</div><div class="line">State or Province Name (full name) []:JS</div><div class="line">Locality Name (eg, city) [Default City]:SZ</div><div class="line">Organization Name (eg, company) [Default Company Ltd]:Magedu</div><div class="line">Organizational Unit Name (eg, section) []:ops</div><div class="line">Common Name (eg, your name or your server<span class="string">'s hostname) []:www1.jack.com</span></div><div class="line">Email Address []:</div><div class="line"></div><div class="line">Please enter the following 'extra<span class="string">' attributes</span></div><div class="line">to be sent with your certificate request</div><div class="line">A challenge password []:</div><div class="line">An optional company name []:</div></pre></td></tr></table></figure></p>
<p>4.接下来CA要为nginx签发证书（因为这里都是在本地主机生成的CA和httpd服务，所以不需要传送）<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ssl]<span class="comment"># openssl ca -in nginx.csr -out nginx.crt</span></div><div class="line">Using configuration from /etc/pki/tls/openssl.cnf</div><div class="line">Check that the request matches the signature</div><div class="line">Signature ok</div><div class="line">Certificate Details:</div><div class="line">        Serial Number: 1 (0x1)</div><div class="line">        Validity</div><div class="line">            Not Before: Sep 13 08:17:43 2017 GMT</div><div class="line">            Not After : Sep 13 08:17:43 2018 GMT</div><div class="line">        Subject:</div><div class="line">            countryName               = CN</div><div class="line">            stateOrProvinceName       = JS</div><div class="line">            organizationName          = Magedu</div><div class="line">            organizationalUnitName    = ops</div><div class="line">            commonName                = www1.jack.com</div><div class="line">        X509v3 extensions:</div><div class="line">            X509v3 Basic Constraints: </div><div class="line">                CA:FALSE</div><div class="line">            Netscape Comment: </div><div class="line">                OpenSSL Generated Certificate</div><div class="line">            X509v3 Subject Key Identifier: </div><div class="line">                99:C6:37:F0:7E:0D:1C:49:B6:27:0B:FA:F5:84:D8:B4:AF:8F:5F:42</div><div class="line">            X509v3 Authority Key Identifier: </div><div class="line">                keyid:77:8B:87:A3:A6:41:A7:0F:BA:5F:58:93:45:10:17:CD:E3:F2:2D:75</div><div class="line"></div><div class="line">Certificate is to be certified until Sep 13 08:17:43 2018 GMT (365 days)</div><div class="line">Sign the certificate? [y/n]:y</div><div class="line"></div><div class="line"></div><div class="line">1 out of 1 certificate requests certified, commit? [y/n]y</div><div class="line">Write out database with 1 new entries</div><div class="line">Data Base Updated</div><div class="line">[root@centos7 ssl]<span class="comment"># ls</span></div><div class="line">nginx.crt <span class="comment"># 签署的证书 nginx.csr  nginx.key</span></div></pre></td></tr></table></figure></p>
<p>5.如上，证书签署完成我们只需把生成的证书nginx.crt发送给客户端即可，现在我们检测语法nginx的语法，重载,查看ssl的443端口是否监听；<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ssl]<span class="comment"># nginx -s reload</span></div><div class="line">[root@centos7 ssl]<span class="comment"># ss -tnl</span></div><div class="line">State       Recv-Q Send-Q Local Address:Port               Peer Address:Port              </div><div class="line">LISTEN      0      128      127.0.0.1:9000                         *:*                  </div><div class="line">LISTEN      0      128              *:80                           *:*                  </div><div class="line">LISTEN      0      128              *:22                           *:*                  </div><div class="line">LISTEN      0      100      127.0.0.1:25                           *:*                  </div><div class="line">LISTEN      0      128              *:443                          *:*                  </div><div class="line">LISTEN      0      128             :::22                          :::*                  </div><div class="line">LISTEN      0      100            ::1:25                          :::*</div></pre></td></tr></table></figure></p>
<p>6.接下来我们为在nginx中定义的虚拟主机创建root的路径，并提供测试页面<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ssl]<span class="comment"># mkdir /vnhosts/ssl/htdocs -pv</span></div><div class="line">mkdir: created directory <span class="string">'/vnhosts/ssl'</span></div><div class="line">mkdir: created directory <span class="string">'/vnhosts/ssl/htdocs'</span></div><div class="line">[root@centos7 ssl]<span class="comment"># vim /vnhosts/ssl/htdocs/index.html</span></div><div class="line">[root@centos7 ssl]<span class="comment"># cat /vnhosts/ssl/htdocs/index.html</span></div><div class="line">&lt;h1&gt;SSL&lt;/h1&gt;</div></pre></td></tr></table></figure></p>
<p>在浏览器中访问如下：<br><img src="\images\nginx\nginx-https.png" alt="nginx"><br>提示证书颁发机构不被信任，因为我们是自建的CA机构，所以需要在浏览器中导入自建CA的证书文件/etc/pki/CA/cacert.pem，让浏览器信任我们自己创建的CA即可；<br><img src="\images\nginx\nginx-https1.png" alt="nginx"><br><img src="\images\nginx\nginx-https2.png" alt="nginx"><br>再次访问，可以正常访问，如下：<br><img src="\images\nginx\nginx-https3.png" alt="nginx"><br>因为我们现在在配置文件中定义了多个server，所以，如果不基于https协议访问，而使用http访问，还是会访问默认的主页面，如下：<br>7.处于安全考虑，如果我想让用户访问网站都是通过https协议访问（即实现从80端口跳转到443端口）的话，就需要在另一个server添加rewritw重写uri，如下：<br><img src="\images\nginx\https1.png" alt="nginx"><br>这就是，为什么我们在平时访问网站时，明明使用的是http协议，但它会自动跳转使用到https协议，只不过是用到了rewrite重写罢了！！！</p>
<h3 id="ngx-http-referer-module模块"><a href="#ngx-http-referer-module模块" class="headerlink" title="ngx_http_referer_module模块"></a>ngx_http_referer_module模块</h3><h4 id="用于阻挡来源非法的域名请求-防盗链"><a href="#用于阻挡来源非法的域名请求-防盗链" class="headerlink" title="用于阻挡来源非法的域名请求(防盗链)"></a>用于阻挡来源非法的域名请求(防盗链)</h4><p>★valid_referers none | blocked | server_names | string …;<br>☉作用：<br>&ensp;&ensp;&ensp;&ensp;定义referer首部的合法可用值；<br>☉参数：<br>◆none：请求报文首部没有referer首部（也就是从浏览器中直接输入的）；<br>◆blocked：请求报文的referer首部没有值；<br>◆server_names：参数，其可以有值作为主机名或主机名模式；<br>&ensp;&ensp;&ensp;&ensp;arbitrary_string：直接字符串，但可使用 <em> 作通配符；<br>&ensp;&ensp;&ensp;&ensp;regular expression：被指定的正则表达式模式匹配到的字符串；要使用 ~ 打头，<br>&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;例如：~.</em>.magedu.com；<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">valid_referers none blocked server_names</div><div class="line">               *.example.com example.* www.example.org/galleries/</div><div class="line">               ~\.google\.;</div><div class="line"> </div><div class="line"><span class="keyword">if</span> (<span class="variable">$invalid_referer</span>) &#123;</div><div class="line">    <span class="built_in">return</span> 403;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>演示：<br><img src="\images\nginx\nginx-referer.png" alt="nginx"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">        listen 443 ssl;</div><div class="line">        server_name  www1.jack.com;</div><div class="line">        root /vnhosts/ssl/htdocs;</div><div class="line">        ssl on;</div><div class="line">        ssl_certificate /etc/nginx/ssl/nginx.crt;</div><div class="line">        ssl_certificate_key /etc/nginx/ssl/nginx.key;</div><div class="line">        ssl_session_cache shared:sslcache:20m;</div><div class="line"></div><div class="line">        valid_referers none block server_name *.jack.com ~\.magedu\. ~\.firefox\.;</div><div class="line">        <span class="keyword">if</span> (<span class="variable">$invalid_referer</span>) &#123;</div><div class="line">           <span class="built_in">return</span> 403;</div><div class="line">           <span class="comment">#rewrite ^/ https://www1.jack.com/</span></div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>解析：<br>&ensp;&ensp;&ensp;&ensp;以上所有符合none，blocked，jack.com域名和域名中包含mgedu和firefox的站点都可以访问到当前站点的内容,如果来源域名不在这个列表中，那么$invalid_referer等于1，在if语句中返回一个403给用户，这样用户便会看到一个403的页面,如果使用下面的rewrite，那么盗链的内容都会被重写到www1.jack.com的主页面。<br>测试：<br>&ensp;&ensp;&ensp;&ensp;使用curl命令模拟从jack.com magedu.com 和baidu.com跳转而来，结果发现前两个跳转都可以正常访问到内容，而从baidu跳转过来的则不能访问<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@centos7 vnhosts]<span class="comment"># curl -k -e "http://www.jack.com" "https://www1.jack.com/index.html"</span></div><div class="line">&lt;h1&gt;SSL Host&lt;/h1&gt;</div><div class="line">[root@centos7 vnhosts]<span class="comment"># curl -k -e "http://www.magedu.com" "https://www1.jack.com/index.html"</span></div><div class="line">&lt;h1&gt;SSL Host&lt;/h1&gt;</div><div class="line">[root@centos7 vnhosts]<span class="comment"># curl -k -e "http://www.firefox.com" "https://www1.jack.com/index.html"</span></div><div class="line">&lt;h1&gt;SSL Host&lt;/h1&gt;</div><div class="line">[root@centos7 vnhosts]<span class="comment"># curl -k -e "http://www.baidu.com" "https://www1.jack.com/index.html"</span></div><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;               <span class="comment"># 不能正常访问返回结果为403 Forbidden</span></div><div class="line">&lt;body bgcolor=<span class="string">"white"</span>&gt;</div><div class="line">&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;</div><div class="line">&lt;hr&gt;&lt;center&gt;nginx/1.12.1&lt;/center&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color1">Nginx</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2017/08/28/web services之nginx(三)/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>





  
    <article id="post-web services之nginx(二)" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/27/web services之nginx(二)/">Nginx进阶二</a>
    </h1>
  

        
        <a href="/2017/08/27/web services之nginx(二)/" class="archive-article-date">
  	<time datetime="2017-08-27T01:00:22.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2017-08-27</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Nginx相关配置"><a href="#Nginx相关配置" class="headerlink" title="Nginx相关配置"></a>Nginx相关配置</h3><p>◆Nginx基于rpm包的安装<br>◆定义路径相关的配置：<br>◆定义客户端请求的相关的配置<br>◆对客户端进行限制的相关配置<br>◆文件操作优化的配置<br>◆ngx_http_access_module模块<br>◆ngx_http_auth_basic_module模块<br>◆ngx_http_stub_status_module模块<br>◆ngx_http_log_module模块<br>◆ngx_http_rewrite_module模块：<br>◆ngx_http_gzip_module</p>
<h4 id="回顾："><a href="#回顾：" class="headerlink" title="回顾："></a>回顾：</h4><p><img src="\images\nginx\nginx7.png" alt="nginx"></p>
<h3 id="Nginx安装之rpm包"><a href="#Nginx安装之rpm包" class="headerlink" title="Nginx安装之rpm包"></a>Nginx安装之rpm包</h3><p>过程如下：<br>1.下载相应rpm包<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># ls -l nginx*</span></div><div class="line">-rw-r--r-- 1 root root 733472 Sep 11 14:53 nginx-1.12.1-1.el7.ngx.x86_64.rpm</div></pre></td></tr></table></figure></p>
<p>2.安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># yum install ./nginx-1.12.1-1.el7.ngx.x86_64.rpm -y</span></div></pre></td></tr></table></figure></p>
<p>3.安装完成之后查看文件及程序所在位置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># rpm -ql nginx</span></div><div class="line">/etc/logrotate.d/nginx </div><div class="line">/etc/nginx                                  <span class="comment"># 配置文件所在位置</span></div><div class="line">/etc/nginx/conf.d</div><div class="line">/etc/nginx/conf.d/default.conf              <span class="comment"># 配置文件片段</span></div><div class="line">/etc/nginx/fastcgi_params</div><div class="line">/etc/nginx/koi-utf</div><div class="line">/etc/nginx/koi-win</div><div class="line">/etc/nginx/mime.types</div><div class="line">/etc/nginx/modules</div><div class="line">/etc/nginx/nginx.conf                       <span class="comment"># nginx主配置文件</span></div><div class="line">/etc/nginx/scgi_params</div><div class="line">/etc/nginx/uwsgi_params</div><div class="line">/etc/nginx/win-utf</div><div class="line">/etc/sysconfig/nginx</div><div class="line">/etc/sysconfig/nginx-debug</div><div class="line">/usr/lib/systemd/system/nginx-debug.service</div><div class="line">/usr/lib/systemd/system/nginx.service       <span class="comment"># unit file 文件，使用nginx.service启动即可</span></div><div class="line">/usr/lib64/nginx</div><div class="line">/usr/lib64/nginx/modules</div><div class="line">/usr/libexec/initscripts/legacy-actions/nginx</div><div class="line">/usr/libexec/initscripts/legacy-actions/nginx/check-reload</div><div class="line">/usr/libexec/initscripts/legacy-actions/nginx/upgrade</div><div class="line">/usr/sbin/nginx                             <span class="comment"># 主程序文件</span></div><div class="line">/usr/sbin/nginx-debug</div><div class="line">/usr/share/doc/nginx-1.12.1</div><div class="line">/usr/share/doc/nginx-1.12.1/COPYRIGHT</div><div class="line">/usr/share/man/man8/nginx.8.gz</div><div class="line">/usr/share/nginx                            <span class="comment"># 默认root的指向位置</span></div><div class="line">/usr/share/nginx/html</div><div class="line">/usr/share/nginx/html/50x.html</div><div class="line">/usr/share/nginx/html/index.html            <span class="comment"># 默认提供的网页文件</span></div><div class="line">/var/cache/nginx</div><div class="line">/var/<span class="built_in">log</span>/nginx</div></pre></td></tr></table></figure></p>
<p>我们用rpm包安装的nginx的主配置文件和编译安装的主配置文件中的定义使用的区别，如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># cd /etc/nginx/</span></div><div class="line">[root@centos7 nginx]<span class="comment"># ls</span></div><div class="line">conf.d          koi-utf  mime.types  nginx.conf   uwsgi_params</div><div class="line">fastcgi_params  koi-win  modules     scgi_params  win-utf</div><div class="line"></div><div class="line"><span class="comment"># 查看主配置文件，如下</span></div><div class="line">[root@centos7 nginx]<span class="comment"># cat nginx.conf </span></div><div class="line"><span class="comment"># 主配置段</span></div><div class="line">user  nginx;</div><div class="line">worker_processes  1;</div><div class="line"></div><div class="line">error_log  /var/<span class="built_in">log</span>/nginx/error.log warn;</div><div class="line">pid        /var/run/nginx.pid;</div><div class="line"></div><div class="line"></div><div class="line">events &#123;</div><div class="line">    worker_connections  1024;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment"># 如下为http配置段</span></div><div class="line">http &#123;</div><div class="line">    include       /etc/nginx/mime.types;</div><div class="line">    default_type  application/octet-stream;</div><div class="line"></div><div class="line">    log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></div><div class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></div><div class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</div><div class="line"></div><div class="line">    access_log  /var/<span class="built_in">log</span>/nginx/access.log  main;</div><div class="line"></div><div class="line">    sendfile        on;</div><div class="line">    <span class="comment">#tcp_nopush     on;</span></div><div class="line"></div><div class="line">    keepalive_timeout  65;</div><div class="line"></div><div class="line">    <span class="comment">#gzip  on;</span></div><div class="line"></div><div class="line">    include /etc/nginx/conf.d/*.conf;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>由上可见这里只是定义了一些server的公共配置，没有定义server虚拟主机，而是定义在了/etc/nginx/conf.d/*.conf下</p>
<h3 id="Nginx中http协议的相关配置"><a href="#Nginx中http协议的相关配置" class="headerlink" title="Nginx中http协议的相关配置"></a>Nginx中http协议的相关配置</h3><h4 id="定义路径相关的配置"><a href="#定义路径相关的配置" class="headerlink" title="定义路径相关的配置"></a>定义路径相关的配置</h4><p>★root path;<br>&ensp;&ensp;&ensp;&ensp;设置web资源路径映射；用于指明用户请求的url所对应的本地文件系统上的文档所在目录路径；<br>&ensp;&ensp;&ensp;&ensp;使用位置：http, server, location, if in location；<br>★location<br>⊙使用格式：<br>&ensp;&ensp;&ensp;&ensp;location [ = | ~ | ~* | ^~ ] uri { … }<br>&ensp;&ensp;&ensp;&ensp;location @name { … }<br>⊙功能：<br>&ensp;&ensp;&ensp;&ensp;在一个server中location配置段可存在多个，用于实现从uri到文件系统的路径映射；<br>&ensp;&ensp;&ensp;&ensp;ngnix会根据用户请求的URI来检查定义的所有location，并找出一个最佳匹配，而后应用其配置；<br>⊙定义的路径映射<br><img src="\images\nginx\nginx-location1.png" alt="nginx"><br>⊙匹配的定义和优先级<br><img src="\images\nginx\nginx-location2.png" alt="nginx"><br>★alias path<br>&ensp;&ensp;&ensp;&ensp;定义路径别名，文档映射的另一种机制；<br>&ensp;&ensp;&ensp;&ensp;仅能用于location上下文；<br>注意：<br>location中使用root指令和alias指令的意义不同；<br>&ensp;&ensp;&ensp;&ensp;root，给定的路径对应于location中的/uri/右侧的 /；<br>&ensp;&ensp;&ensp;&ensp;alias，给定的路径对应于location中的/uri/左侧的 /；<br>★index file …;<br>&ensp;&ensp;&ensp;&ensp;定义默认资源；<br>&ensp;&ensp;&ensp;&ensp;定义的位置：http, server, location；<br>★error_page code … [=[response]] uri;<br>&ensp;&ensp;&ensp;&ensp;Defines the URI that will be shown for the specified errors. A uri value can contain variables.<br>&ensp;&ensp;&ensp;&ensp;（Defines URI，它将显示指定的错误。一个uri的值可以包含变量。）<br>&ensp;&ensp;&ensp;&ensp;可以自定义响应码</p>
<h4 id="演示："><a href="#演示：" class="headerlink" title="演示："></a>演示：</h4><p>1.location和alias<br>由上面可知，我们在http的配置段中要想编辑定义虚拟主机server，要在/etc/nginx/conf.d中定义，如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">[root@centos7 conf.d]<span class="comment"># vim default.conf</span></div><div class="line"></div><div class="line">server &#123;</div><div class="line">    listen       80;</div><div class="line">    server_name  localhost;</div><div class="line"></div><div class="line">    <span class="comment">#charset koi8-r;</span></div><div class="line">    <span class="comment">#access_log  /var/log/nginx/host.access.log  main;</span></div><div class="line"></div><div class="line">    location / &#123;</div><div class="line">        root   /usr/share/nginx/html;</div><div class="line">        index  index.html index.htm;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">#error_page  404              /404.html;</span></div><div class="line"></div><div class="line">    <span class="comment"># redirect server error pages to the static page /50x.html</span></div><div class="line">    <span class="comment">#</span></div><div class="line">    error_page   500 502 503 504  /50x.html;</div><div class="line">    location = /50x.html &#123;</div><div class="line">        root   /usr/share/nginx/html;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment"># proxy the PHP scripts to Apache listening on 127.0.0.1:80</span></div><div class="line">    <span class="comment">#</span></div><div class="line">    <span class="comment">#location ~ \.php$ &#123;</span></div><div class="line">    <span class="comment">#    proxy_pass   http://127.0.0.1;</span></div><div class="line">    <span class="comment">#&#125;</span></div><div class="line"></div><div class="line">    <span class="comment"># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span></div><div class="line">    <span class="comment">#</span></div><div class="line">    <span class="comment">#location ~ \.php$ &#123;</span></div><div class="line">    <span class="comment">#    root           html;</span></div><div class="line">    <span class="comment">#    fastcgi_pass   127.0.0.1:9000;</span></div><div class="line">    <span class="comment">#    fastcgi_index  index.php;</span></div><div class="line">    <span class="comment">#    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span></div><div class="line">    <span class="comment">#    include        fastcgi_params;</span></div><div class="line">    <span class="comment">#&#125;</span></div><div class="line"></div><div class="line">    <span class="comment"># deny access to .htaccess files, if Apache's document root</span></div><div class="line">    <span class="comment"># concurs with nginx's one</span></div><div class="line">    <span class="comment">#</span></div><div class="line">    <span class="comment">#location ~ /\.ht &#123;</span></div><div class="line">    <span class="comment">#    deny  all;</span></div><div class="line">    <span class="comment">#&#125;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>1.由上面的配置文件中可知，用rpm包安装的nginx中，http配置段中虚拟主机server的根并没有直接定义在server的公共配置段中，而是定义在了location的上下文中，表示把根映射到/usr/share/nginx/html/下；<br>所以如果我们要在浏览器中访问 <a href="http://172.16.3.67/admin" target="_blank" rel="external">http://172.16.3.67/admin</a> 则对应的文件系统映射路径为 /usr/share/nginx/html/admin，试验如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@centos7 conf.d]<span class="comment"># mkdir /usr/share/nginx/html/admin</span></div><div class="line">[root@centos7 conf.d]<span class="comment"># echo "jack_zhou" &gt; /usr/share/nginx/html/admin/index.html</span></div><div class="line">[root@centos7 conf.d]<span class="comment"># cat /usr/share/nginx/html/admin/index.html</span></div><div class="line">jack_zhou</div></pre></td></tr></table></figure></p>
<p>浏览器访问如下：<br><img src="\images\nginx\nginx-test3.png" alt="nginx"><br>2.假如我们要单独对admin目录做访问控制，也可以重新定义admin的目录映射关系，例如，这里我们把admin目录映射到/vnhosts/www1/data下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@centos7 conf.d]<span class="comment"># vim default.conf</span></div><div class="line">location / &#123;</div><div class="line">        root   /usr/share/nginx/html;</div><div class="line">        index  index.html index.htm;</div><div class="line">    &#125;</div><div class="line">location /admin/ &#123;</div><div class="line">        root   /vnhosts/www1/data/;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>保存退出后，检测语法重载nginx再次访问发现找不到该资源，如下：<br><img src="\images\nginx\nginx-test4.png" alt="nginx"><br>如上，可见我们单独对admin做路径定义后，原来admin的路径就不对了，所以，我们要在新定义的路径下再次创建admin目录才可以，如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@centos7 conf.d]<span class="comment"># mkdir -pv /vnhosts/www1/data/admin</span></div><div class="line">mkdir: created directory ?.vnhosts?</div><div class="line">mkdir: created directory ?.vnhosts/www1?</div><div class="line">mkdir: created directory ?.vnhosts/www1/data?</div><div class="line">mkdir: created directory ?.vnhosts/www1/data/admin?</div><div class="line">[root@centos7 conf.d]<span class="comment"># cp /usr/share/nginx/html/admin/index.html /vnhosts/www1/data/admin</span></div></pre></td></tr></table></figure></p>
<p>再次刷新网页，可以正常访问，如下：<br><img src="\images\nginx\nginx-test5.png" alt="nginx"><br>3.如果我们把admin在location中新定义的路径 root /vnhosts/www1/data 改为 alias /vnhosts/www1/data 会是怎样的效果呢，如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 为了对比效果，我们在/vnhosts/www1/data目录下再创建一个默认页面，内容不同admin中的默认页面</span></div><div class="line">[root@centos7 conf.d]<span class="comment"># cd /vnhosts/www1/data/</span></div><div class="line">[root@centos7 data]<span class="comment"># echo "vnhost/www1/data" &gt; index.html</span></div><div class="line">[root@centos7 data]<span class="comment"># ls</span></div><div class="line">admin  index.html</div><div class="line"></div><div class="line">[root@centos7 conf.d]<span class="comment"># vi default.conf</span></div><div class="line">location / &#123;</div><div class="line">        root   /usr/share/nginx/html;</div><div class="line">        index  index.html index.htm;</div><div class="line">    &#125;</div><div class="line">    location /admin/ &#123;</div><div class="line">        <span class="built_in">alias</span>   /vnhosts/www1/data/;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>保存退出后，检测语法重载nginx再次访问，如下：<br><img src="\images\nginx\nginx-test6.png" alt="nginx"></p>
<h4 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h4><p>在location上下文中<br>1.定义 alias /vnhosts/www1/data/ 为目录admin的路径别名,映射的是/admin/最左侧的/；<br>&ensp;&ensp;&ensp;&ensp;即： <a href="http://172.16.3.67/admin" target="_blank" rel="external">http://172.16.3.67/admin</a> —&gt; /vnhosts/www1/data<br>2.定义 root /vnhosts/www1/data/ 是/vnhosts/www1/data/最右侧根与/admin 最右侧根的映射，表示在data目录下还有一个目录为admin，而且必须要有，才能在浏览器中访问到admin。<br>&ensp;&ensp;&ensp;&ensp;即： <a href="http://172.16.3.67/admin" target="_blank" rel="external">http://172.16.3.67/admin</a>  —&gt; /vnhosts/www1/data/admin<br>一定要注意映射关系，不要搞混了！！！</p>
<h4 id="自定义错误页面："><a href="#自定义错误页面：" class="headerlink" title="自定义错误页面："></a>自定义错误页面：</h4><p>1)首先编辑配置文件，自己定义一个404的错误页面，并定义文件映射的位置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># vi /etc/nginx/conf.d/default.conf</span></div><div class="line">    error_page  404              /404.html;</div><div class="line">    location = /404.html &#123;</div><div class="line">        root /usr/share/nginx/html/error_pages/;               <span class="comment"># 自定义一个错误页信息的文件位置</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment"># redirect server error pages to the static page /50x.html</span></div><div class="line">    <span class="comment">#</span></div><div class="line">    error_page   500 502 503 504  /50x.html;</div><div class="line">    location = /50x.html &#123;</div><div class="line">        root   /usr/share/nginx/html;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>2)创建此文件，并编辑错误页面信息<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># ls /usr/share/nginx/html</span></div><div class="line">50x.html  admin  index.html</div><div class="line">[root@centos7 ~]<span class="comment"># mkdir /usr/share/nginx/html/error_pages</span></div><div class="line">[root@centos7 ~]<span class="comment"># vi /usr/share/nginx/html/error_pages/404.html</span></div><div class="line">&lt;h1&gt;---------------NOT FOUND-----------------&lt;/h1&gt;</div></pre></td></tr></table></figure></p>
<p>3)检查语法错误，重载后访问页面如下：<br><img src="\images\nginx\nginx-test7.png" alt="nginx"><br><img src="\images\nginx\nginx-test7-1.png" alt="nginx"><br>4)如上，调试页面显示为404错误，我们也可以改变状态码，让客户端以位访问的就是正确的资源<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># vi /etc/nginx/conf.d/default.conf</span></div><div class="line">    error_page  404 =200             /404.html;</div><div class="line">    location = /404.html &#123;</div><div class="line">        root /usr/share/nginx/html/error_pages/;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>保存，重载后再次刷新页面如下：<br><img src="\images\nginx\nginx-test7-2.png" alt="nginx"><br><img src="\images\nginx\nginx-test7-3.png" alt="nginx"></p>
<h4 id="定义客户端请求的相关的配置"><a href="#定义客户端请求的相关的配置" class="headerlink" title="定义客户端请求的相关的配置"></a>定义客户端请求的相关的配置</h4><p>★keepalive_timeout timeout [header_timeout];<br>&ensp;&ensp;&ensp;&ensp;设定保持连接的超时时长，0表示禁止长连接；默认为75s；<br>★keepalive_requests number;<br>&ensp;&ensp;&ensp;&ensp;在一次长连接上所允许请求的资源的最大数量，默认为100;<br>★keepalive_disable none | browser …;<br>&ensp;&ensp;&ensp;&ensp;对哪种浏览器禁用长连接；<br>★send_timeout time;<br>&ensp;&ensp;&ensp;&ensp;向客户端发送响应报文的超时时长，此处，是指两次写操作之间的间隔时长；<br>★client_body_buffer_size size;<br>&ensp;&ensp;&ensp;&ensp;用于接收客户端请求报文的body部分的缓冲区大小；默认为16k；超出此大小时，其将被暂存到磁盘上的由client_body_temp_path指令所定义的位置；<br>★client_body_temp_path path [level1 [level2 [level3]]];<br>&ensp;&ensp;&ensp;&ensp;设定用于存储客户端请求报文的body部分的临时存储路径及子目录结构和数量；<br>&ensp;&ensp;&ensp;&ensp;level为16进制的数字；<br>举例：<br>&ensp;&ensp;&ensp;&ensp;client_body_temp_path path  /var/tmp/client_body  1 2 2 表示：有16个一级子目录，一级子目录下有256（16*16）个二级子目录；每个二级子目录下又有256个三级子目录  </p>
<h4 id="对客户端进行限制的相关配置："><a href="#对客户端进行限制的相关配置：" class="headerlink" title="对客户端进行限制的相关配置："></a>对客户端进行限制的相关配置：</h4><p>★limit_rate rate;<br>&ensp;&ensp;&ensp;&ensp;限制响应给客户端的传输速率，单位是bytes/second，0表示无限制；<br>★limit_except method … { … }<br>&ensp;&ensp;&ensp;&ensp;限制对指定的请求方法之外的其它方法允许使用的客户端；<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">示例：  </div><div class="line">      limit_except GET &#123;         表示除了GET的请求方法之外的其他方法，仅允许192.168.1.0/32;可以使用，其他用户都拒绝</div><div class="line">         allow 192.168.1.0/32;</div><div class="line">         deny  all;</div><div class="line">      &#125;</div></pre></td></tr></table></figure></p>
<h4 id="文件操作优化的配置"><a href="#文件操作优化的配置" class="headerlink" title="文件操作优化的配置"></a>文件操作优化的配置</h4><p>★aio on | off | threads[=pool]；（aio表示异步I/O模型）；<br>&ensp;&ensp;&ensp;&ensp;是否启用aio功能；建议开启<br>★directio size | off; （直接I/O机制）<br>&ensp;&ensp;&ensp;&ensp;在Linux主机启用O_DIRECT标记，此处意味文件大于等于给定的大小时使用；例如directio 4m;<br>★open_file_cache off;<br>  open_file_cache max=N [inactive=time];<br>⊙nginx可以缓存以下三种信息：<br>&ensp;&ensp;&ensp;&ensp;文件的描述符、文件大小和最近一次的修改时间；<br>&ensp;&ensp;&ensp;&ensp;打开的目录结构；<br>&ensp;&ensp;&ensp;&ensp;没有找到的或者没有权限访问的文件的相关信息；<br>⊙max=N：<br>&ensp;&ensp;&ensp;&ensp;可缓存的缓存项上限；达到上限后会使用LRU算法（最近最少使用）实现缓存管理，删除最近最少使用的元素；<br>⊙inactive=time：<br>&ensp;&ensp;&ensp;&ensp;缓存项的非活动时长，在此处指定的时长内未被命中的或命中的次数少于open_file_cache_min_users指令所指定的次数的缓存项即为非活动项；<br>★open_file_cache_valid time;<br>&ensp;&ensp;&ensp;&ensp;缓存项有效性的检查频率；默认为60s;<br>★open_file_cache_min_uses number;<br>&ensp;&ensp;&ensp;&ensp;在open_file_cache指令的inactive参数指定的时长内，至少应该被命中多少次方可被归类为活动项；<br>★open_file_cache_errors on | off;<br>&ensp;&ensp;&ensp;&ensp;是否缓存查找时发生错误的文件一类的信息；<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Example:</div><div class="line">  open_file_cache          max=1000 inactive=20s;</div><div class="line">  open_file_cache_valid    30s;</div><div class="line">  open_file_cache_min_uses 2;</div><div class="line">  open_file_cache_errors   on;</div></pre></td></tr></table></figure></p>
<h3 id="ngx-http-access-module模块"><a href="#ngx-http-access-module模块" class="headerlink" title="ngx_http_access_module模块:"></a>ngx_http_access_module模块:</h3><p>★作用：实现基于ip的访问控制功能<br>&ensp;&ensp;&ensp;&ensp;allow address | CIDR | unix: | all;<br>&ensp;&ensp;&ensp;&ensp;deny address | CIDR | unix: | all;<br>★可用上下文：<br>&ensp;&ensp;&ensp;&ensp;http, server, location, limit_except<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Example Configuration</div><div class="line">location / &#123;</div><div class="line">    deny  192.168.1.1;</div><div class="line">    allow 192.168.1.0/24;</div><div class="line">    allow 10.1.1.0/16;</div><div class="line">    allow 2001:0db8::/32;</div><div class="line">    deny  all;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="ngx-http-auth-basic-module模块"><a href="#ngx-http-auth-basic-module模块" class="headerlink" title="ngx_http_auth_basic_module模块:"></a>ngx_http_auth_basic_module模块:</h3><p>★作用：实现基于用户的访问控制，使用basic机制进行用户认证；<br>&ensp;&ensp;&ensp;&ensp;auth_basic string | off;<br>&ensp;&ensp;&ensp;&ensp;auth_basic_user_file file;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">location / &#123;</div><div class="line">    auth_basic           <span class="string">"closed site"</span>;</div><div class="line">    auth_basic_user_file conf/htpasswd;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>注意：<br>&ensp;&ensp;&ensp;&ensp;htpasswd命令由httpd-tools所提供；</p>
<h4 id="演示"><a href="#演示" class="headerlink" title="演示"></a>演示</h4><p>1.编辑配置文件/etc/nainx/conf.d/default.conf，定义访问控制的字符串和用户文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># vi /etc/nginx/conf.d/default.conf</span></div><div class="line">location /admin/ &#123;</div><div class="line">        <span class="built_in">alias</span>   /vnhosts/www1/data/;</div><div class="line">        auth_basic <span class="string">"Admin Area"</span>;</div><div class="line">        auth_basic_user_file /etc/nginx/.ngxpasswd;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>2.创建/etc/nginx/.ngxpasswd文件，并添加用户<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># htpasswd -c -m /etc/nginx/.ngxpasswd jack      # 生成文件，并添加用户</span></div><div class="line">New password: </div><div class="line">Re-type new password: </div><div class="line">Adding password <span class="keyword">for</span> user jack</div><div class="line">[root@centos7 ~]<span class="comment"># htpasswd -m /etc/nginx/.ngxpasswd jackzhou</span></div><div class="line">New password: </div><div class="line">Re-type new password: </div><div class="line">Adding password <span class="keyword">for</span> user jackzhou</div><div class="line">[root@centos7 ~]<span class="comment"># cat /etc/nginx/.ngxpasswd </span></div><div class="line">jack:<span class="variable">$apr1</span><span class="variable">$LaA1TZiK</span><span class="variable">$7ZpOu0xWIbIjB</span>/DXQl3yN0</div><div class="line">jackzhou:<span class="variable">$apr1</span><span class="variable">$pCxLJ3Zc</span><span class="variable">$OBb0yEvqbN7lpaamApurO0</span></div><div class="line">[root@centos7 ~]<span class="comment"># systemctl reload nginx                   # 重载</span></div></pre></td></tr></table></figure></p>
<p>访问如下：<br><img src="\images\nginx\nginx-test8.png" alt="nginx"></p>
<h3 id="ngx-http-stub-status-module模块"><a href="#ngx-http-stub-status-module模块" class="headerlink" title="ngx_http_stub_status_module模块"></a>ngx_http_stub_status_module模块</h3><p>★作用：<br>&ensp;&ensp;&ensp;&ensp;用于输出nginx的基本状态信息；<br>★stub_status;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">示例：</div><div class="line">     location  /basic_status &#123;</div><div class="line">      stub_status;</div><div class="line">     &#125;</div></pre></td></tr></table></figure></p>
<p>★输出的状态信息：<br>&ensp;&ensp;&ensp;&ensp;Active connections: 活动状态的连接数；<br>&ensp;&ensp;&ensp;&ensp;accepts：已经接受的客户端请求的总数；<br>&ensp;&ensp;&ensp;&ensp;handled：已经处理完成的客户端请求的总数；<br>&ensp;&ensp;&ensp;&ensp;requests：客户端发来的总的请求数；<br>&ensp;&ensp;&ensp;&ensp;Reading：处于读取客户端请求报文首部的连接的连接数；<br>&ensp;&ensp;&ensp;&ensp;Writing：处于向客户端发送响应报文过程中的连接数<br>&ensp;&ensp;&ensp;&ensp;Waiting：处于等待客户端发出请求的空闲连接数；</p>
<h4 id="演示：-1"><a href="#演示：-1" class="headerlink" title="演示："></a>演示：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># vi /etc/nginx/conf.d/default.conf</span></div><div class="line">location /basic_status &#123;</div><div class="line">        stub_status;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>刷新网页如下：<br><img src="\images\nginx\nginx-test9.png" alt="nginx"></p>
<h3 id="ngx-http-log-module模块"><a href="#ngx-http-log-module模块" class="headerlink" title="ngx_http_log_module模块"></a>ngx_http_log_module模块</h3><p>★作用：<br>&ensp;&ensp;&ensp;&ensp;管理访问日志（已指定的格式来记录用户的访问请求）<br>★日志格式的定义：<br>&ensp;&ensp;&ensp;&ensp;log_format name string …;<br>&ensp;&ensp;&ensp;&ensp;string可以使用nginx核心模块及其它模块内嵌的变量；<br><img src="\images\nginx\nginx-var.png" alt="nginx"><br>★访问日志文件路径，格式及相关的缓冲的配置；<br>&ensp;&ensp;&ensp;&ensp;access_log path [format [buffer=size] [gzip[=level]] [flush=time] [if=condition]];<br>&ensp;&ensp;&ensp;&ensp;access_log off;<br>&ensp;&ensp;&ensp;&ensp;buffer=size 缓冲大小<br>&ensp;&ensp;&ensp;&ensp;flush=time  刷写时长（即多长时间把缓存中的日志写到磁盘）<br>★缓存各日志文件相关的元数据信息；<br>&ensp;&ensp;&ensp;&ensp;open_log_file_cache max=N [inactive=time] [min_uses=N] [valid=time];<br>&ensp;&ensp;&ensp;&ensp;open_log_file_cache off;<br>&ensp;&ensp;&ensp;&ensp;max：缓存的最大文件描述符数量；<br>&ensp;&ensp;&ensp;&ensp;min_users：在inactive指定的时长内访问大于等于此值方可被当作活动项；<br>&ensp;&ensp;&ensp;&ensp;inactive：非活动时长；<br>&ensp;&ensp;&ensp;&ensp;valid：验正缓存中各缓存项是否为活动项的时间间隔；<br>nginx中定义的访问日志路径和格式如下：在/etc/nginx/nginx.conf中<br><img src="\images\nginx\nginx-log.png" alt="nginx"></p>
<h3 id="ngx-http-rewrite-module模块：（重要）"><a href="#ngx-http-rewrite-module模块：（重要）" class="headerlink" title="ngx_http_rewrite_module模块：（重要）"></a>ngx_http_rewrite_module模块：（重要）</h3><p>★作用：<br>&ensp;&ensp;&ensp;&ensp;将用户请求的URI基于regex（正则表达式）所描述的模式进行检查，而后完成替换；<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Example:</div><div class="line">    server &#123;</div><div class="line">         ...</div><div class="line">         rewrite ^(/download/.*)/media/(.*)\..*$ <span class="variable">$1</span>/mp3/<span class="variable">$2</span>.mp3 last;</div><div class="line">         rewrite ^(/download/.*)/audio/(.*)\..*$ <span class="variable">$1</span>/mp3/<span class="variable">$2</span>.ra  last;</div><div class="line">         <span class="built_in">return</span>  403;</div><div class="line">         ...</div><div class="line">     &#125;</div></pre></td></tr></table></figure></p>
<p>★rewrite regex replacement [flag]<br>⊙作用：<br>&ensp;&ensp;&ensp;&ensp;用户请求的URI基于regex所描述的模式进行检查，匹配到时将其替换为replacement指定的新的URI；<br>注意：<br>&ensp;&ensp;&ensp;&ensp;如果在同一级别配置块中存在多个rewrite规则，那么会自上而下逐个检查；被某条件规则替换完成后，会重启新一轮的替换检查，因此，隐含有循环机制；[flag]所表示的标志位用于控制此循环机制；<br>&ensp;&ensp;&ensp;&ensp;如果replacement是以<a href="http://或https://开头，则替换结果会直接以重定向返回给客户端；" target="_blank" rel="external">http://或https://开头，则替换结果会直接以重定向返回给客户端；</a> 301：永久重定向；<br>⊙[flag]：<br>◆last：<br>&ensp;&ensp;&ensp;&ensp;重写完成后停止对当前URI在当前location中后续的其它重写操作，而后对新的URI启动新一轮重写检查；提前重启新一轮循环；<br>◆break：<br>&ensp;&ensp;&ensp;&ensp;重写完成后停止对当前URI在当前location中后续的其它重写操作，而后直接跳转至重写规则配置块之后的其它配置；结束循环；<br>◆redirect：<br>&ensp;&ensp;&ensp;&ensp;重写完成后以临时重定向方式直接返回重写后生成的新URI给客户端，由客户端重新发起请求；不能以<a href="http://或https://开头；" target="_blank" rel="external">http://或https://开头；</a><br>◆permanent:<br>&ensp;&ensp;&ensp;&ensp;重写完成后以永久重定向方式直接返回重写后生成的新URI给客户端，由客户端重新发起请求；<br>★return<br>⊙作用：<br>&ensp;&ensp;&ensp;&ensp;停止处理并返回指定的代码到客户端。<br>⊙格式：<br>&ensp;&ensp;&ensp;&ensp;return code [text];<br>&ensp;&ensp;&ensp;&ensp;return code URL;<br>&ensp;&ensp;&ensp;&ensp;return URL;<br>★rewrite_log on | off;<br>&ensp;&ensp;&ensp;&ensp;作用：是否开启重写日志；<br>★if (condition) { … }<br>⊙作用：<br>&ensp;&ensp;&ensp;&ensp;引入一个新的配置上下文 ；条件满足时，执行配置块中的配置指令；<br>⊙可用位置：server, location；<br>⊙测试条件： condition：<br>◆比较操作符：<br>&ensp;&ensp;&ensp;&ensp;==：等值比较；<br>&ensp;&ensp;&ensp;&ensp;!=：不等值比较；<br>&ensp;&ensp;&ensp;&ensp;~：模式匹配，区分字符大小写；<br>&ensp;&ensp;&ensp;&ensp;~<em>：模式匹配，不区分字符大小写；<br>&ensp;&ensp;&ensp;&ensp;!~：模式不匹配，区分字符大小写；<br>&ensp;&ensp;&ensp;&ensp;!~</em>：模式不匹配，不区分字符大小写；<br>◆文件及目录存在性判断：<br>&ensp;&ensp;&ensp;&ensp;-e, !-e ：文件存在和不存在；<br>&ensp;&ensp;&ensp;&ensp;-f, !-f ：文件存在且为普通文件<br>&ensp;&ensp;&ensp;&ensp;-d, !-d ：存在且为目录<br>&ensp;&ensp;&ensp;&ensp;-x, !-x ：存在可执行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">Examples:</div><div class="line"> </div><div class="line"><span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~ MSIE) &#123;</div><div class="line">    rewrite ^(.*)$ /msie/<span class="variable">$1</span> <span class="built_in">break</span>;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="keyword">if</span> (<span class="variable">$http_cookie</span> ~* <span class="string">"id=([^;]+)(?:;|$)"</span>) &#123;</div><div class="line">    <span class="built_in">set</span> <span class="variable">$id</span> <span class="variable">$1</span>;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="keyword">if</span> (<span class="variable">$request_method</span> = POST) &#123;</div><div class="line">    <span class="built_in">return</span> 405;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="keyword">if</span> (<span class="variable">$slow</span>) &#123;</div><div class="line">    limit_rate 10k;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="keyword">if</span> (<span class="variable">$invalid_referer</span>) &#123;</div><div class="line">    <span class="built_in">return</span> 403;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>★set $variable value;<br>&ensp;&ensp;&ensp;&ensp;作用：用户自定义变量 ；</p>
<h4 id="演示：-2"><a href="#演示：-2" class="headerlink" title="演示："></a>演示：</h4><p>假如之前有个uri为bbs的目录，后来由于种种原因，需要把这个目录更换名称，这样一来，对原来老的用户来说再访问bbs势必就找不到了，所以，这里我们就需要用到URI的重定向，如下：<br>1.现在新创建一个forum的目录，并创建默认测试页面，比作原来的bbs目录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># cd /usr/share/nginx/html/</span></div><div class="line">[root@centos7 html]<span class="comment"># ls</span></div><div class="line">50x.html  admin  error_pages  index.html</div><div class="line">[root@centos7 html]<span class="comment"># mkdir forum</span></div><div class="line">[root@centos7 html]<span class="comment"># ls</span></div><div class="line">50x.html  admin  error_pages  forum  index.html</div><div class="line">[root@centos7 html]<span class="comment"># cat &lt;&lt; EOF &gt;&gt; forum/index.html</span></div><div class="line">&gt; &lt;h1&gt;BBS Home Page&lt;/h1&gt;</div><div class="line">&gt; EOF</div><div class="line">[root@centos7 html]<span class="comment"># cat forum/index.html </span></div><div class="line">&lt;h1&gt;BBS Home Page&lt;/h1&gt;</div></pre></td></tr></table></figure></p>
<p>2.对于新增加的用户来说，可以使用新的目录名访问资源，如下：<br><img src="\images\nginx\nginx-test10.png" alt="nginx"><br>但是我们的网站之前不叫forum而叫bbs，所以，对于老用户来说，并不知道新的路径，是访问不到所需的资源的，如下：<br><img src="\images\nginx\nginx-test10-1.png" alt="nginx"><br>3.为了使老用户不受影响，就需要uri重定向了，如下，编辑/etc/nginx/conf.d/default.conf<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">location / &#123;</div><div class="line">        root   /usr/share/nginx/html;</div><div class="line">        index  index.html index.htm;</div><div class="line">        rewrite ^/bbs/(.*)$ /forum/<span class="variable">$1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>语法检测，重载后再次访问bbs，可以正常访问，如下：<br><img src="\images\nginx\nginx-test10-2.png" alt="nginx"><br>如上，实际上就是一个查找并替换而已，只不过查找的是用户在某一次请求的url当中的字符串是否能够被我们所指定的正则表达式模式所匹配，如果能就替换成新的uri（replacement的值）。<br>1.但是如果我们有多个rewrite的话，替换成为的结果会重启一轮再次被检查，而后有可能会被替换到别的位置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">location / &#123;</div><div class="line">        root   /usr/share/nginx/html;</div><div class="line">        index  index.html index.htm;</div><div class="line">        rewrite ^/bbs/(.*)$ /forum/<span class="variable">$1</span>;</div><div class="line">        rewrite ^/forum/(.*)$ /admin/<span class="variable">$1</span>;</div><div class="line">    &#125;</div><div class="line">    location /admin/ &#123;</div><div class="line">        <span class="built_in">alias</span>   /vnhosts/www1/data/;</div><div class="line">        auth_basic <span class="string">"Admin Area"</span>;</div><div class="line">        auth_basic_user_file /etc/nginx/.ngxpasswd;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>再次访问bbs，则重定向到了admin目录下（这里的admin又为路径别名）<br><img src="\images\nginx\nginx-test10-3.png" alt="nginx"><br>访问forum也会重定向到admin目录下：<br><img src="\images\nginx\nginx-test10-4.png" alt="nginx"><br>如上，访问bbs为两次检查匹配，然后两次重定向，访问forum仅一次重定向，这样一来forum就没有意义了。<br>3.还有可能有一种情况就是死循环，另个uri在不停地替换，如下定义：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">location / &#123;</div><div class="line">        root   /usr/share/nginx/html;</div><div class="line">        index  index.html index.htm;</div><div class="line">        rewrite ^/bbs/(.*)$ /forum/<span class="variable">$1</span>;</div><div class="line">        rewrite ^/forum/(.*)$ /bbs/<span class="variable">$1</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>访问bbs或者forum，提示500，服务器错误<br><img src="\images\nginx\nginx-test10-5.png" alt="nginx"><br><img src="\images\nginx\nginx-test10-6.png" alt="nginx"><br>4.如上，出现这种情况我们就需要让他们跳出循环，这里就要用到flag的break。<br>为了演示效果，我重新定义了一下，这两个目录，如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># cd /usr/share/nginx/html/</span></div><div class="line">[root@centos7 html]<span class="comment"># mv forum/ bbs</span></div><div class="line">[root@centos7 html]<span class="comment"># mkdir forum</span></div><div class="line">[root@centos7 html]<span class="comment"># cat &lt;&lt; EOF &gt;&gt; forum/index.html</span></div><div class="line">&gt; &lt;h1&gt;Forum Home Pages&lt;/h1&gt;</div><div class="line">&gt; EOF</div><div class="line">[root@centos7 html]<span class="comment"># cat forum/index.html bbs/index.html </span></div><div class="line">&lt;h1&gt;Forum Home Pages&lt;/h1&gt;</div><div class="line">&lt;h1&gt;BBS Home Page&lt;/h1&gt;</div></pre></td></tr></table></figure></p>
<p>然后编辑配置文件<br><img src="\images\nginx\nginx-test10-7.png" alt="nginx"><br>访问bbs和forum如下：<br><img src="\images\nginx\nginx-test10-8.png" alt="nginx"><br><img src="\images\nginx\nginx-test10-8-1.png" alt="nginx"><br>5.我们也可以跟上以<a href="http://或https://开头；实现跨站跳转，如下：" target="_blank" rel="external">http://或https://开头；实现跨站跳转，如下：</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">location / &#123;</div><div class="line">        root   /usr/share/nginx/html;</div><div class="line">        index  index.html index.htm;</div><div class="line">        rewrite ^/bbs/(.*)$ /forum/<span class="variable">$1</span> <span class="built_in">break</span>;</div><div class="line">        rewrite ^/forum/(.*)$ https://www.baidu.com;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>访问forum，跳转到了百度，这里默认是实现的是last如下：<br><img src="\images\nginx\nginx-test10-11.png" alt="nginx"><br>redirect效果演示<br>1）不添加redirect访问，响应码为200，是服务器自己的内部事务，客户端不参与<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">location / &#123;</div><div class="line">        root   /usr/share/nginx/html;</div><div class="line">        index  index.html index.htm;</div><div class="line">        rewrite ^/bbs/(.*)$ /forum/<span class="variable">$1</span>;</div><div class="line">       <span class="comment">#rewrite ^/forum/(.*)$ https://www.baidu.com;</span></div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>2)添加redirect，服务会把临时临时重定向的结果返回给客户端浏览器，由客户端再次发起请求，所以响应码为302—&gt;200访问效果如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">location / &#123;</div><div class="line">        root   /usr/share/nginx/html;</div><div class="line">        index  index.html index.htm;</div><div class="line">        rewrite ^/bbs/(.*)$ /forum/<span class="variable">$1</span> redirect;</div><div class="line">       <span class="comment">#rewrite ^/forum/(.*)$ https://www.baidu.com;</span></div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>3)添加permanent，为永久重定向<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">location / &#123;</div><div class="line">        root   /usr/share/nginx/html;</div><div class="line">        index  index.html index.htm;</div><div class="line">        rewrite ^/bbs/(.*)$ /forum/<span class="variable">$1</span> permanent;</div><div class="line">       <span class="comment">#rewrite ^/forum/(.*)$ https://www.baidu.com;</span></div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<h3 id="ngx-http-gzip-module：必须要启用的模块"><a href="#ngx-http-gzip-module：必须要启用的模块" class="headerlink" title="ngx_http_gzip_module：必须要启用的模块"></a>ngx_http_gzip_module：必须要启用的模块</h3><p>★作用：<br>&ensp;&ensp;&ensp;&ensp;ngx_http_gzip_module模块是一个过滤器，压缩响应使用”gzip”方法。这通常有助于减少传输数据的大小，可压缩一半甚至更多。<br>⊙gzip on | off;<br>&ensp;&ensp;&ensp;&ensp;Enables or disables gzipping of responses.<br>⊙gzip_comp_level level;<br>&ensp;&ensp;&ensp;&ensp;Sets a gzip compression level of a response. Acceptable values are in the range from 1 to 9.(响应的压缩级别。可接受的值范围为从1到9)。<br>⊙gzip_disable regex …;<br>&ensp;&ensp;&ensp;&ensp;Disables gzipping of responses for requests with “User-Agent” header fields matching any of the specified regular expressions.(基于正则表达式匹配浏览器，匹配到的将禁用压缩功能)<br>⊙gzip_min_length length;<br>&ensp;&ensp;&ensp;&ensp;启用压缩功能的响应报文大小阈值；<br>⊙gzip_buffers number size;<br>&ensp;&ensp;&ensp;&ensp;支持实现压缩功能时为其配置的缓冲区数量及每个缓存区的大小；<br>⊙gzip_proxied off | expired | no-cache | no-store | private | no_last_modified | no_etag | auth | any …;<br>&ensp;&ensp;&ensp;&ensp;nginx作为代理服务器接收到从被代理服务器发送的响应报文后，在何种条件下启用压缩功能的；<br>&ensp;&ensp;&ensp;&ensp;off：对代理的请求不启用<br>&ensp;&ensp;&ensp;&ensp;no-cache, no-store，private：表示从被代理服务器收到的响应报文首部的Cache-Control的值为此三者中任何一个，则启用压缩功能<br>⊙gzip_types mime-type …;<br>&ensp;&ensp;&ensp;&ensp;压缩过滤器，仅对此处设定的MIME类型的内容启用压缩功能；<br>⊙gzip_vary on|off<br>&ensp;&ensp;&ensp;&ensp;对gzip, gzip_static,或者 gunzip 压缩的，添加响应报文首部，Vary: Accept-Encoding</p>
<h4 id="演示：-3"><a href="#演示：-3" class="headerlink" title="演示："></a>演示：</h4><p>1.编辑配置文件/etc/nginx/nginx.conf在http的公共配置段启用压缩功能，并设置相关内容，如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># vi /etc/nginx/nginx.conf</span></div><div class="line">    gzip  on;</div><div class="line">    gzip_comp_level 7;</div><div class="line">    <span class="comment">#gzip_disable .*MSIE.*;</span></div><div class="line">    gzip_types text/html,text/css,text/xml,text/plain;</div><div class="line">    gzip_min_length 1K;</div><div class="line">    gzip_vary on;</div><div class="line">[root@centos7 ~]<span class="comment"># nginx -t</span></div><div class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</div><div class="line">nginx: configuration file /etc/nginx/nginx.conf <span class="built_in">test</span> is successful</div><div class="line">[root@centos7 ~]<span class="comment"># systemctl reload nginx</span></div></pre></td></tr></table></figure></p>
<p>2.复制一个文件，做测试<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># cp /var/log/messages /usr/share/nginx/html/messages.html</span></div><div class="line">[root@centos7 ~]<span class="comment"># ll /usr/share/nginx/html/messages.html</span></div><div class="line">-rw------- 1 root root 4351 Sep 12 16:15 /usr/share/nginx/html/messages.html</div><div class="line">[root@centos7 ~]<span class="comment"># chmod +r /usr/share/nginx/html/messages.html</span></div><div class="line">[root@centos7 ~]<span class="comment"># ll /usr/share/nginx/html/messages.html</span></div><div class="line">-rw-r--r-- 1 root root 4351 Sep 12 16:15 /usr/share/nginx/html/messages.html</div><div class="line"><span class="comment"># 使用curl测试如下</span></div><div class="line">[root@centos7 ~]<span class="comment"># curl -I http://172.16.3.67/messages.html</span></div><div class="line">HTTP/1.1 200 OK</div><div class="line">Server: nginx/1.12.1</div><div class="line">Date: Tue, 12 Sep 2017 08:16:23 GMT</div><div class="line">Content-Type: text/html</div><div class="line">Content-Length: 4351</div><div class="line">Last-Modified: Tue, 12 Sep 2017 08:15:31 GMT</div><div class="line">Connection: keep-alive</div><div class="line">Vary: Accept-Encoding</div><div class="line">ETag: <span class="string">"59b797a3-10ff"</span></div><div class="line">Accept-Ranges: bytes</div><div class="line"></div><div class="line">[root@centos7 ~]<span class="comment"># curl --compress -I  http://172.16.3.67/messages.html</span></div><div class="line">HTTP/1.1 200 OK</div><div class="line">Server: nginx/1.12.1</div><div class="line">Date: Tue, 12 Sep 2017 08:17:28 GMT</div><div class="line">Content-Type: text/html</div><div class="line">Last-Modified: Tue, 12 Sep 2017 08:15:31 GMT</div><div class="line">Connection: keep-alive</div><div class="line">Vary: Accept-Encoding</div><div class="line">ETag: W/<span class="string">"59b797a3-10ff"</span></div><div class="line">Content-Encoding: gzip</div></pre></td></tr></table></figure></p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color1">Nginx</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2017/08/27/web services之nginx(二)/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>





  
    <article id="post-web services之nginx(一)" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/26/web services之nginx(一)/">Nginx基础</a>
    </h1>
  

        
        <a href="/2017/08/26/web services之nginx(一)/" class="archive-article-date">
  	<time datetime="2017-08-26T02:50:22.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2017-08-26</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="概述："><a href="#概述：" class="headerlink" title="概述："></a>概述：</h3><p>&ensp;&ensp;本章我们将介绍Nginx，内容权重都很重量级，内容包括：<br>&ensp;&ensp;&ensp;&ensp;◆Nginx的相关概念，功能，解决的问题，官方站点；<br>&ensp;&ensp;&ensp;&ensp;◆5种I/O模型的介绍；<br>&ensp;&ensp;&ensp;&ensp;◆Nginx的程序架构概述；<br>&ensp;&ensp;&ensp;&ensp;◆Nginx的编译安装；<br>&ensp;&ensp;&ensp;&ensp;◆Nginx中配置文件的构成；<br>&ensp;&ensp;&ensp;&ensp;◆Nginx主配置段详解；<br>&ensp;&ensp;&ensp;&ensp;◆Nginx中http协议的核心模块配置</p>
<h3 id="Nginx介绍"><a href="#Nginx介绍" class="headerlink" title="Nginx介绍"></a>Nginx介绍</h3><p>★ engineX = Nginx<br>&ensp;&ensp;&ensp;&ensp;NGINX is a free, open-source,high-performance HTTP server and reverse proxy, as well as an IMAP/POP3 proxyserver.（NGINX是一个免费、开源、高性能的HTTP服务器和反向代理，以及IMAP/POP3代理服务器）。<br>⊙功能：<br>&ensp;&ensp;&ensp;&ensp;是http协议的实现：可作为web服务器（类似于httpd）；<br>&ensp;&ensp;&ensp;&ensp;http reverse proxy反向代理（类似于httpd）；<br>&ensp;&ensp;&ensp;&ensp;imap/pop3 reverse proxy（邮件服务器的反向代理）<br>⊙官方站点：nginx.org<br>⊙C10K（10K Connections）：解决C10K（一万个并发链接）的问题<br>★ 相关概念：<br>⊙并发连接数：<br>&ensp;&ensp;&ensp;&ensp;指的是客户端向服务器发起请求，并建立了TCP连接。每秒钟服务器链接的总TCP数量，就是并发连接数。<br>⊙C10K问题：<br>&ensp;&ensp;&ensp;&ensp;网络服务在处理数以万计的客户端连接时，往往出现效率低下甚至完全瘫痪，这被称为C10K问题。<br>★ 国内nginx的二次开发：<br>&ensp;&ensp;&ensp;&ensp;Tengine<br>&ensp;&ensp;&ensp;&ensp;OpenResty</p>
<h3 id="I-0模型介绍"><a href="#I-0模型介绍" class="headerlink" title="I/0模型介绍"></a>I/0模型介绍</h3><h4 id="阻塞型、非阻塞型、复用型、信号驱动型、异步"><a href="#阻塞型、非阻塞型、复用型、信号驱动型、异步" class="headerlink" title="阻塞型、非阻塞型、复用型、信号驱动型、异步"></a>阻塞型、非阻塞型、复用型、信号驱动型、异步</h4><p>★ 同步/异步：关注消息通知机制；<br>&ensp;&ensp;&ensp;&ensp;同步：等待对方返回消息；调用发出不会立即返回，但一旦返回就可以返回最终结果；<br>&ensp;&ensp;&ensp;&ensp;异步：调用发出之后，被调用方立即返回消息，但返回的非最终结果；被调用者通过状态、通知机制来通知调者，或通过回调函数来处理结果；<br>★ 阻塞/非阻塞：关注调用者在等待结果返回之前所处的状态；<br>&ensp;&ensp;&ensp;&ensp;阻塞：blocking，调用结果返回之前，调用者（调用线程）会被挂起；调用者只有在得到结果之后才会返回；<br>&ensp;&ensp;&ensp;&ensp;非阻塞：nonblocking，调用结果返回之前，调用者不会被挂起；调用不会阻塞当前线程；<br>★ 一次IO请求，都会由两阶段组成：<br>&ensp;&ensp;&ensp;&ensp;第一步：等待数据，即数据从磁盘到内核内存；<br>&ensp;&ensp;&ensp;&ensp;第二步：复制数据，即数据内核内存到进程内存；<br>★ 复用型IO调用：<br>&ensp;&ensp;&ensp;&ensp;select()：1024<br>&ensp;&ensp;&ensp;&ensp;poll()：<br>★ 5种I/O模型<br>&ensp;&ensp;&ensp;&ensp;blocking IO<br>&ensp;&ensp;&ensp;&ensp;nonblocking IO<br>&ensp;&ensp;&ensp;&ensp;IO multiplexing<br>&ensp;&ensp;&ensp;&ensp;signal driven IO<br>&ensp;&ensp;&ensp;&ensp;asyncrhonous IO</p>
<h4 id="⊙阻塞I-O模型-（bloking-I-O）"><a href="#⊙阻塞I-O模型-（bloking-I-O）" class="headerlink" title="⊙阻塞I/O模型 （bloking I/O）"></a>⊙阻塞I/O模型 （bloking I/O）</h4><p>&ensp;&ensp;&ensp;&ensp;阻塞I/O是最流行的I/O模型。它符合人们最常见的思考逻辑。阻塞就是进程 “被” 休息, CPU处理其它进程去了。在网络I/O的时候，进程发起recvform系统调用，然后进程就被阻塞了，什么也不干，直到数据准备好，并且将数据从内核复制到用户进程，最后进程再处理数据，在等待数据到处理数据的两个阶段，整个进程都被阻塞。不能处理别的网络I/O<br><img src="\images\nginx\blocking IO.jpg" alt="nginx"></p>
<h4 id="⊙非阻塞I-O模型（non-bloking-I-O）"><a href="#⊙非阻塞I-O模型（non-bloking-I-O）" class="headerlink" title="⊙非阻塞I/O模型（non-bloking I/O）"></a>⊙非阻塞I/O模型（non-bloking I/O）</h4><p>&ensp;&ensp;&ensp;&ensp;在网络I/O时候，非阻塞I/O也会进行recvform系统调用，检查数据是否准备好，与阻塞I/O不一样，”非阻塞将大的整片时间的阻塞分成N多的小的阻塞, 所以进程不断地有机会 ‘被’ CPU光顾”。<br>&ensp;&ensp;&ensp;&ensp;也就是说非阻塞的recvform系统调用调用之后，进程并没有被阻塞，内核马上返回给进程，如果数据还没准备好，此时会返回一个error。进程在返回之后，可以干点别的事情，然后再发起recvform系统调用。重复上面的过程，循环往复的进行recvform系统调用。这个过程通常被称之为轮询。轮询检查内核数据，直到数据准备好，再拷贝数据到进程，进行数据处理。需要注意，拷贝数据整个过程，进程仍然是属于阻塞的状态<br><img src="\images\nginx\non-blocking IO.jpg" alt="nginx"></p>
<h4 id="⊙I-O复用模型-（multiplexing-I-O）"><a href="#⊙I-O复用模型-（multiplexing-I-O）" class="headerlink" title="⊙I/O复用模型 （multiplexing I/O）"></a>⊙I/O复用模型 （multiplexing I/O）</h4><p>&ensp;&ensp;&ensp;&ensp;可以看出，由于非阻塞的调用，轮询占据了很大一部分过程，轮询会消耗大量的CPU时间。结合前面两种模式。如果轮询不是进程的用户态，而是有人帮忙就好了。多路复用正好处理这样的问题。<br>&ensp;&ensp;&ensp;&ensp;多路复用有两个特别的系统调用select或poll。select调用是内核级别的，select轮询相对非阻塞的轮询的区别在于—前者可以等待多个socket，当其中任何一个socket的数据准好了，就能返回进行可读，然后进程再进行recvform系统调用，将数据由内核拷贝到用户进程，当然这个过程是阻塞的。多路复用有两种阻塞，select或poll调用之后，会阻塞进程，与第一种阻塞不同在于，此时的select不是等到socket数据全部到达再处理, 而是有了一部分数据就会调用用户进程来处理。如何知道有一部分数据到达了呢？监视的事情交给了内核，内核负责数据到达的处理。也可以理解为”非阻塞”吧。<br><img src="\images\nginx\multiplexing IO.jpg" alt="nginx"></p>
<h4 id="⊙信号驱动I-O模型-signal-driven-IO"><a href="#⊙信号驱动I-O模型-signal-driven-IO" class="headerlink" title="⊙信号驱动I/O模型 (signal driven IO)"></a>⊙信号驱动I/O模型 (signal driven IO)</h4><p>&ensp;&ensp;&ensp;&ensp;首先我们允许套接口进行信号驱动I/O,并安装一个信号处理函数，进程继续运行并不阻塞。当数据准备好时，<br>进程会收到一个SIGIO信号，可以在信号处理函数中调用I/O操作函数处理数据。<br><img src="\images\nginx\signal driven IO.png" alt="nginx"></p>
<h4 id="⊙异步I-O模型-asyncrhonous-IO"><a href="#⊙异步I-O模型-asyncrhonous-IO" class="headerlink" title="⊙异步I/O模型 (asyncrhonous IO)"></a>⊙异步I/O模型 (asyncrhonous IO)</h4><p>&ensp;&ensp;&ensp;&ensp;相对于同步I/O，异步I/O不是顺序执行。用户进程进行aio_read系统调用之后，无论内核数据是否准备好，都会直接返回给用户进程，然后用户态进程可以去做别的事情。等到socket数据准备好了，内核直接复制数据给进程，然后从内核向进程发送通知。I/O两个阶段，进程都是非阻塞的。<br><img src="\images\nginx\asyncrhonous IO.jpg" alt="nginx"></p>
<h4 id="同步和异步的区别"><a href="#同步和异步的区别" class="headerlink" title="同步和异步的区别"></a>同步和异步的区别</h4><p>&ensp;&ensp;&ensp;&ensp;通过对上述几种模型的讨论，需要区分阻塞和非阻塞，同步和异步。他们其实是两组概念。区别前一组比较容易，后一种往往容易和前面混合。对于同步和异步而言，往往是一个函数调用之后，是否直接返回结果，如果函数挂起，直到获得结果，这是同步；如果函数马上返回，等数据到达再通知函数，那么这是异步的路程。</p>
<p>&ensp;&ensp;&ensp;&ensp;至于阻塞和非阻塞，则是函数是否让线程挂起不再往下执行。通常同步阻塞，异步非阻塞。什么情况下是异步阻塞呢？即函数调用之后并没有返回结果而注册了回调函数，非阻塞的情况下，函数也马上返回，可是如果此时函数不返回，那么此时就是阻塞的状态，等数据到达通知函数，依然是异步的过程。</p>
<p>&ensp;&ensp;&ensp;&ensp;区分阻塞和非阻塞只要区分函数调用之后是否挂起返回就可以了，区分异步和同步，则是函数调用之后，数据或条件满足之后如何通知函数。等待数据返回则是同步，通过回调则是异步。</p>
<h4 id="★5个I-O模型的比较"><a href="#★5个I-O模型的比较" class="headerlink" title="★5个I/O模型的比较"></a>★5个I/O模型的比较</h4><p><img src="\images\nginx\IO.png" alt="nginx"></p>
<h3 id="Nginx的程序架构："><a href="#Nginx的程序架构：" class="headerlink" title="Nginx的程序架构："></a>Nginx的程序架构：</h3><p>★master/worker（两级架构）<br>⊙一个master进程：<br>&ensp;&ensp;&ensp;&ensp;负载加载配置文件、管理worker进程、平滑升级；<br>⊙一个或多个worker进程<br>&ensp;&ensp;&ensp;&ensp;处理并响应用户请求；<br>⊙缓存相关的进程：<br>&ensp;&ensp;&ensp;&ensp;cache loader：载入缓存对象<br>&ensp;&ensp;&ensp;&ensp;cache manager：管理缓存对象<br>★特性：异步、事件驱动和非阻塞<br>&ensp;&ensp;&ensp;&ensp;并发请求处理：通过kevent/epoll/select<br>&ensp;&ensp;&ensp;&ensp;文件IO：高级IO sendfile，异步，mmap<br>★nginx高度模块块：<br>&ensp;&ensp;&ensp;&ensp;高度模块化，但其模块早期不支持DSO机制；近期版本支持动态装载和卸载；<br>⊙模块分类：<br>◆核心模块：core module<br>◆标准模块：<br>&ensp;&ensp;&ensp;&ensp;Standard HTTP modules（标准模块）<br>&ensp;&ensp;&ensp;&ensp;Optional HTTP modules（可选模块）<br>&ensp;&ensp;&ensp;&ensp;Mail modules<br>&ensp;&ensp;&ensp;&ensp;Stream modules<br>◆3rd party modules（第三方模块）<br>★nginx的功用：<br>&ensp;&ensp;&ensp;&ensp;静态的web资源服务器；<br>&ensp;&ensp;&ensp;&ensp;结合FastCGI/uwSGI/SCGI等协议反代动态资源请求；（也可以缓存动态资源）<br>&ensp;&ensp;&ensp;&ensp;http/https协议的反向代理；<br>&ensp;&ensp;&ensp;&ensp;imap4/pop3协议的反抽代理；<br>&ensp;&ensp;&ensp;&ensp;tcp/udp协议的反代；</p>
<h4 id="Ningx程序架构图"><a href="#Ningx程序架构图" class="headerlink" title="Ningx程序架构图"></a>Ningx程序架构图</h4><p><img src="\images\nginx\nginx.png" alt="nginx"></p>
<h3 id="Nginx的安装配置"><a href="#Nginx的安装配置" class="headerlink" title="Nginx的安装配置"></a>Nginx的安装配置</h3><p>★官方的预制包：<br>&ensp;&ensp;&ensp;&ensp;<a href="http://nginx.org/packages/centos/7/x86_64/RPMS/" target="_blank" rel="external">http://nginx.org/packages/centos/7/x86_64/RPMS/</a><br>★编译安装：<br>准备开发环境<br>yum groupinstall “Development tools”  “Server Platform Development” 准备开发环境<br>解决依赖关系<br>yum install pcre-devel openssl-devel zlib-devel 解决依赖关系<br>添加用户<br>useradd -r nginx<br>配置<br>./configure –prefix=/usr/local/nginx –conf-path=/etc/nginx/nginx.conf –error-log-path=/var/log/nginx/error.log –http-log-path=/var/log/nginx/access.log –pid-path=/var/run/nginx.pid –lock-path=/var/lock/nginx.lock –user=nginx –group=nginx –with-http_ssl_module –with-http_v2_module –with-http_dav_module –with-http_stub_status_module –with-threads –with-file-aio<br>安装<br>make &amp;&amp; make install</p>
<h4 id="编译安装："><a href="#编译安装：" class="headerlink" title="编译安装："></a>编译安装：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 准备源码包</span></div><div class="line">[root@centos7 ~]<span class="comment"># ls -l nginx-1.12.1.tar.gz </span></div><div class="line">-rw-r--r--. 1 root root 981093 Sep  9 09:59 nginx-1.12.1.tar.gz</div><div class="line"></div><div class="line"><span class="comment"># 解压源码包</span></div><div class="line">[root@centos7 ~]<span class="comment"># tar xf nginx-1.12.1.tar.gz</span></div><div class="line">[root@centos7 ~]<span class="comment"># cd nginx-1.12.1      # 进入目录</span></div><div class="line">[root@centos7 nginx-1.12.1]<span class="comment"># ls</span></div><div class="line">auto  CHANGES  CHANGES.ru  conf  configure  contrib  html  LICENSE  man  README  src</div><div class="line"></div><div class="line"><span class="comment"># 首先我们查看 ./configure --help 查看常用的选项</span></div><div class="line">[root@centos7 nginx-1.12.1]<span class="comment"># ./configure --help</span></div><div class="line"></div><div class="line">  --help                             <span class="built_in">print</span> this message</div><div class="line"></div><div class="line">  --prefix=PATH                      <span class="built_in">set</span> installation prefix</div><div class="line">  --sbin-path=PATH                   <span class="built_in">set</span> nginx binary pathname</div><div class="line">  --modules-path=PATH                <span class="built_in">set</span> modules path</div><div class="line">  --conf-path=PATH                   <span class="built_in">set</span> nginx.conf pathname</div><div class="line">  --error-log-path=PATH              <span class="built_in">set</span> error <span class="built_in">log</span> pathname</div><div class="line">  --pid-path=PATH                    <span class="built_in">set</span> nginx.pid pathname</div><div class="line">  --lock-path=PATH                   <span class="built_in">set</span> nginx.lock pathname</div><div class="line"></div><div class="line">  --user=USER                        <span class="built_in">set</span> non-privileged user <span class="keyword">for</span></div><div class="line">                                     worker processes</div><div class="line">  --group=GROUP                      <span class="built_in">set</span> non-privileged group <span class="keyword">for</span></div><div class="line">  ..........</div><div class="line">  ...................</div><div class="line">  ......................</div></pre></td></tr></table></figure>
<p>1.在执行之前我们还要创建一个nginx的系统用户<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># useradd -r nginx</span></div><div class="line">[root@centos7 ~]<span class="comment"># id nginx</span></div><div class="line">uid=996(nginx) gid=994(nginx) groups=994(nginx)</div></pre></td></tr></table></figure></p>
<p>2.执行./configure 指明要存放的程序位置，及配置文件，要添加的模块等等<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">[root@centos7 nginx-1.12.1]<span class="comment"># ./configure --prefix=/usr/local/nginx --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/lock/nginx.lock --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_dav_module --with-http_stub_status_module --with-threads --with-file-aio</span></div><div class="line"></div><div class="line">Configuration summary</div><div class="line">  + using threads</div><div class="line">  + using system PCRE library</div><div class="line">  + using system OpenSSL library</div><div class="line">  + using system zlib library</div><div class="line"></div><div class="line">  nginx path prefix: <span class="string">"/usr/local/nginx"</span></div><div class="line">  nginx binary file: <span class="string">"/usr/local/nginx/sbin/nginx"</span></div><div class="line">  nginx modules path: <span class="string">"/usr/local/nginx/modules"</span></div><div class="line">  nginx configuration prefix: <span class="string">"/etc/nginx"</span></div><div class="line">  nginx configuration file: <span class="string">"/etc/nginx/nginx.conf"</span></div><div class="line">  nginx pid file: <span class="string">"/var/run/nginx.pid"</span></div><div class="line">  nginx error <span class="built_in">log</span> file: <span class="string">"/var/log/nginx/error.log"</span></div><div class="line">  nginx http access <span class="built_in">log</span> file: <span class="string">"/var/log/nginx/access.log"</span></div><div class="line">  nginx http client request body temporary files: <span class="string">"client_body_temp"</span></div><div class="line">  nginx http proxy temporary files: <span class="string">"proxy_temp"</span></div><div class="line">  nginx http fastcgi temporary files: <span class="string">"fastcgi_temp"</span></div><div class="line">  nginx http uwsgi temporary files: <span class="string">"uwsgi_temp"</span></div><div class="line">  nginx http scgi temporary files: <span class="string">"scgi_temp"</span></div></pre></td></tr></table></figure></p>
<p>3.如上第一步已经完成，下面我们执行 make &amp;&amp; make install<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@centos7 nginx-1.12.1]<span class="comment"># make &amp;&amp; make install</span></div></pre></td></tr></table></figure></p>
<p>4.接下来，要把主程序文件添加至PATH环境变量<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 在/etc/profile.d/下创建一个脚本配置文件</span></div><div class="line">[root@centos7 nginx-1.12.1]<span class="comment"># vi /etc/profile.d/nginx.sh</span></div><div class="line"><span class="built_in">export</span> PATH=/usr/<span class="built_in">local</span>/nginx/sbin:<span class="variable">$PATH</span></div><div class="line"><span class="comment"># 然后保存退出，重读配置文件</span></div><div class="line">[root@centos7 nginx-1.12.1]<span class="comment"># . /etc/profile.d/nginx.sh</span></div><div class="line"><span class="comment"># 可以测试一下语法</span></div><div class="line">[root@centos7 ~]<span class="comment"># nginx -t</span></div><div class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</div><div class="line">nginx: configuration file /etc/nginx/nginx.conf <span class="built_in">test</span> is successful</div></pre></td></tr></table></figure></p>
<p>如上整个编译过程就已将完成，因为这里没有UNIT file文件或者service脚本所以直接nginx就可启动程序<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># nginx        # 启动程序</span></div><div class="line">[root@centos7 ~]<span class="comment"># ss -tnl      # 查看80端口</span></div><div class="line">State       Recv-Q Send-Q Local Address:Port               Peer Address:Port              </div><div class="line">LISTEN      0      128              *:80                           *:*                  </div><div class="line">LISTEN      0      128              *:22                           *:*                  </div><div class="line">LISTEN      0      100      127.0.0.1:25                           *:*                  </div><div class="line">LISTEN      0      128             :::22                          :::*                  </div><div class="line">LISTEN      0      100            ::1:25                          :::*</div></pre></td></tr></table></figure></p>
<p>nginx提供的网页文件在/usr/local/nginx/html<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># ls /usr/local/nginx/</span></div><div class="line">client_body_temp  fastcgi_temp  html  proxy_temp  sbin  scgi_temp  uwsgi_temp</div><div class="line">[root@centos7 ~]<span class="comment"># ls /usr/local/nginx/html/</span></div><div class="line">50x.html  index.html</div></pre></td></tr></table></figure></p>
<p>现在我们打开浏览器，访问服务如下：<br><img src="\images\nginx\nginx1.png" alt="nginx"><br>5.为nginx提供SysV init脚本：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 新建文件/etc/rc.d/init.d/nginx，内容如下：</span></div><div class="line">vim /etc/rc.d/init.d/nginx</div><div class="line"><span class="meta">#!/bin/sh</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># nginx - this script starts and stops the nginx daemon</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># chkconfig:   - 85 15 </span></div><div class="line"><span class="comment"># description:  Nginx is an HTTP(S) server, HTTP(S) reverse \</span></div><div class="line"><span class="comment">#               proxy and IMAP/POP3 proxy server</span></div><div class="line"><span class="comment"># processname: nginx</span></div><div class="line"><span class="comment"># config:      /etc/nginx/nginx.conf</span></div><div class="line"><span class="comment"># config:      /etc/sysconfig/nginx</span></div><div class="line"><span class="comment"># pidfile:     /var/run/nginx.pid</span></div><div class="line">  </div><div class="line"><span class="comment"># Source function library.</span></div><div class="line">. /etc/rc.d/init.d/<span class="built_in">functions</span></div><div class="line">   </div><div class="line"><span class="comment"># Source networking configuration.</span></div><div class="line">. /etc/sysconfig/network</div><div class="line">    </div><div class="line"><span class="comment"># Check that networking is up.</span></div><div class="line">[ <span class="string">"<span class="variable">$NETWORKING</span>"</span> = <span class="string">"no"</span> ] &amp;&amp; <span class="built_in">exit</span> 0</div><div class="line">     </div><div class="line">nginx=<span class="string">"/usr/local/nginx/sbin/nginx"</span></div><div class="line">prog=$(basename <span class="variable">$nginx</span>)</div><div class="line">      </div><div class="line">NGINX_CONF_FILE=<span class="string">"/etc/nginx/nginx.conf"</span></div><div class="line">       </div><div class="line">[ <span class="_">-f</span> /etc/sysconfig/nginx ] &amp;&amp; . /etc/sysconfig/nginx</div><div class="line">        </div><div class="line">lockfile=/var/lock/subsys/nginx</div><div class="line"> </div><div class="line"><span class="function"><span class="title">make_dirs</span></span>() &#123;</div><div class="line">   <span class="comment"># make required directories</span></div><div class="line">   user=`nginx -V 2&gt;&amp;1 | grep <span class="string">"configure arguments:"</span> | sed <span class="string">'s/[^*]*--user=\([^ ]*\).*/\1/g'</span> -`</div><div class="line">   options=`<span class="variable">$nginx</span> -V 2&gt;&amp;1 | grep <span class="string">'configure arguments:'</span>`</div><div class="line">   <span class="keyword">for</span> opt <span class="keyword">in</span> <span class="variable">$options</span>; <span class="keyword">do</span></div><div class="line">       <span class="keyword">if</span> [ `<span class="built_in">echo</span> <span class="variable">$opt</span> | grep <span class="string">'.*-temp-path'</span>` ]; <span class="keyword">then</span></div><div class="line">           value=`<span class="built_in">echo</span> <span class="variable">$opt</span> | cut <span class="_">-d</span> <span class="string">"="</span> <span class="_">-f</span> 2`</div><div class="line">           <span class="keyword">if</span> [ ! <span class="_">-d</span> <span class="string">"<span class="variable">$value</span>"</span> ]; <span class="keyword">then</span></div><div class="line">               <span class="comment"># echo "creating" $value</span></div><div class="line">               mkdir -p <span class="variable">$value</span> &amp;&amp; chown -R <span class="variable">$user</span> <span class="variable">$value</span></div><div class="line">           <span class="keyword">fi</span></div><div class="line">       <span class="keyword">fi</span></div><div class="line">   <span class="keyword">done</span></div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="title">start</span></span>() &#123;</div><div class="line">    [ -x <span class="variable">$nginx</span> ] || <span class="built_in">exit</span> 5</div><div class="line">    [ <span class="_">-f</span> <span class="variable">$NGINX_CONF_FILE</span> ] || <span class="built_in">exit</span> 6</div><div class="line">    make_dirs</div><div class="line">    <span class="built_in">echo</span> -n $<span class="string">"Starting <span class="variable">$prog</span>: "</span></div><div class="line">    daemon <span class="variable">$nginx</span> -c <span class="variable">$NGINX_CONF_FILE</span></div><div class="line">    retval=$?</div><div class="line">    <span class="built_in">echo</span></div><div class="line">    [ <span class="variable">$retval</span> <span class="_">-eq</span> 0 ] &amp;&amp; touch <span class="variable">$lockfile</span></div><div class="line">    <span class="built_in">return</span> <span class="variable">$retval</span></div><div class="line">&#125;</div><div class="line">  </div><div class="line"><span class="function"><span class="title">stop</span></span>() &#123;</div><div class="line">    <span class="built_in">echo</span> -n $<span class="string">"Stopping <span class="variable">$prog</span>: "</span></div><div class="line">    killproc <span class="variable">$prog</span> -QUIT</div><div class="line">    retval=$?</div><div class="line">    <span class="built_in">echo</span></div><div class="line">    [ <span class="variable">$retval</span> <span class="_">-eq</span> 0 ] &amp;&amp; rm <span class="_">-f</span> <span class="variable">$lockfile</span></div><div class="line">    <span class="built_in">return</span> <span class="variable">$retval</span></div><div class="line">&#125;</div><div class="line">  </div><div class="line"><span class="function"><span class="title">restart</span></span>() &#123;</div><div class="line">    configtest || <span class="built_in">return</span> $?</div><div class="line">    stop</div><div class="line">    sleep 1</div><div class="line">    start</div><div class="line">&#125;</div><div class="line">  </div><div class="line"><span class="function"><span class="title">reload</span></span>() &#123;</div><div class="line">    configtest || <span class="built_in">return</span> $?</div><div class="line">    <span class="built_in">echo</span> -n $<span class="string">"Reloading <span class="variable">$prog</span>: "</span></div><div class="line">    killproc <span class="variable">$nginx</span> -HUP</div><div class="line">    RETVAL=$?</div><div class="line">    <span class="built_in">echo</span></div><div class="line">&#125;</div><div class="line">  </div><div class="line"><span class="function"><span class="title">force_reload</span></span>() &#123;</div><div class="line">    restart</div><div class="line">&#125;</div><div class="line">  </div><div class="line"><span class="function"><span class="title">configtest</span></span>() &#123;</div><div class="line">  <span class="variable">$nginx</span> -t -c <span class="variable">$NGINX_CONF_FILE</span></div><div class="line">&#125;</div><div class="line">  </div><div class="line"><span class="function"><span class="title">rh_status</span></span>() &#123;</div><div class="line">    status <span class="variable">$prog</span></div><div class="line">&#125;</div><div class="line">  </div><div class="line"><span class="function"><span class="title">rh_status_q</span></span>() &#123;</div><div class="line">    rh_status &gt;/dev/null 2&gt;&amp;1</div><div class="line">&#125;</div><div class="line">  </div><div class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></div><div class="line">    start)</div><div class="line">        rh_status_q &amp;&amp; <span class="built_in">exit</span> 0</div><div class="line">        <span class="variable">$1</span></div><div class="line">        ;;</div><div class="line">    stop)</div><div class="line">        rh_status_q || <span class="built_in">exit</span> 0</div><div class="line">        <span class="variable">$1</span></div><div class="line">        ;;</div><div class="line">    restart|configtest)</div><div class="line">        <span class="variable">$1</span></div><div class="line">        ;;</div><div class="line">    reload)</div><div class="line">        rh_status_q || <span class="built_in">exit</span> 7</div><div class="line">        <span class="variable">$1</span></div><div class="line">        ;;</div><div class="line">    force-reload)</div><div class="line">        force_reload</div><div class="line">        ;;</div><div class="line">    status)</div><div class="line">        rh_status</div><div class="line">        ;;</div><div class="line">    condrestart|try-restart)</div><div class="line">        rh_status_q || <span class="built_in">exit</span> 0</div><div class="line">            ;;</div><div class="line">    *)</div><div class="line">        <span class="built_in">echo</span> $<span class="string">"Usage: <span class="variable">$0</span> &#123;start|stop|status|restart|condrestart|try-restart|reload|force-reload|configtest&#125;"</span></div><div class="line">        <span class="built_in">exit</span> 2</div><div class="line"><span class="keyword">esac</span></div><div class="line"></div><div class="line"><span class="comment">#===========================================================================================================</span></div><div class="line"><span class="comment"># 为此脚本赋予执行权限：</span></div><div class="line">[root@centos7 ~]<span class="comment"># chmod +x /etc/rc.d/init.d/nginx </span></div><div class="line"><span class="comment"># 添加至服务管理列表，并让其开机自动启动：</span></div><div class="line">[root@centos7 ~]<span class="comment"># chkconfig --add nginx</span></div><div class="line">[root@centos7 ~]<span class="comment"># chkconfig nginx on</span></div><div class="line"><span class="comment"># 而后就可以启动服务并测试了：</span></div><div class="line">[root@centos7 ~]<span class="comment"># service nginx start</span></div><div class="line">Starting nginx (via systemctl):  Warning: nginx.service changed on disk. Run <span class="string">'systemctl daemon-reload'</span> to reload units.</div><div class="line">                                                           [  OK  ]</div><div class="line">[root@centos7 ~]<span class="comment"># ss -tnl</span></div><div class="line">State      Recv-Q Send-Q                      Local Address:Port                                     Peer Address:Port            </div><div class="line">LISTEN     0      128                                     *:80                                                  *:                </div><div class="line">LISTEN     0      128                                     *:22                                                  *:                </div><div class="line">LISTEN     0      100                             127.0.0.1:25                                                  *:                </div><div class="line">LISTEN     0      128                                    :::22                                                 :::                </div><div class="line">LISTEN     0      100                                   ::1:25                                                 :::*</div></pre></td></tr></table></figure></p>
<h3 id="Nginx的相关配置"><a href="#Nginx的相关配置" class="headerlink" title="Nginx的相关配置"></a>Nginx的相关配置</h3><p>★配置文件的组成部分：<br>⊙主配置文件：<br>&ensp;&ensp;&ensp;&ensp;nginx.conf<br>&ensp;&ensp;&ensp;&ensp;include conf.d/*.conf （这里没有指明）<br>⊙fastcgi，uwsgi，scgi等协议相关的配置文件<br>⊙mime.types：支持的mime类型<br>★主配置文件的配置指令：<br>⊙格式：<br>&ensp;&ensp;&ensp;&ensp;directive value [value2 …];<br>注意：<br>◆指令必须以分号结尾；<br>◆支持使用配置变量；<br>内建变量：由Nginx模块引入，可直接引用；<br>自定义变量：由用户使用set命令定义；<br>&ensp;&ensp;&ensp;&ensp;set variable_name value;<br>&ensp;&ensp;&ensp;&ensp;引用变量：$variable_name<br>★主配置文件结构：<br><img src="\images\nginx\nginx2.png" alt="nginx"><br>☉http协议相关的配置结构（所有和web相关的都要在这里配置）<br><img src="\images\nginx\nginx-http.png" alt="nginx"></p>
<h4 id="演示："><a href="#演示：" class="headerlink" title="演示："></a>演示：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># cd /etc/nginx/</span></div><div class="line">[root@centos7 nginx]<span class="comment"># ls</span></div><div class="line">fastcgi.conf            koi-utf             nginx.conf           uwsgi_params</div><div class="line">fastcgi.conf.default    koi-win             nginx.conf.default   uwsgi_params.default</div><div class="line">fastcgi_params          mime.types          scgi_params          win-utf</div><div class="line">fastcgi_params.default  mime.types.default  scgi_params.default</div><div class="line">[root@centos7 nginx]<span class="comment"># cp nginx.conf&#123;,.bak&#125;</span></div><div class="line">[root@centos7 nginx]<span class="comment"># vi nginx.conf</span></div><div class="line"><span class="comment"># 主配置段如下：</span></div><div class="line"><span class="comment">#user  nobody;</span></div><div class="line">worker_processes  1;</div><div class="line"></div><div class="line"><span class="comment">#error_log  logs/error.log;</span></div><div class="line"><span class="comment">#error_log  logs/error.log  notice;</span></div><div class="line"><span class="comment">#error_log  logs/error.log  info;</span></div><div class="line"></div><div class="line"><span class="comment">#pid        logs/nginx.pid;</span></div><div class="line"></div><div class="line"></div><div class="line">events &#123;</div><div class="line">    worker_connections  1024;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment"># http配置段</span></div><div class="line">http &#123;</div><div class="line">    include       mime.types;</div><div class="line">    default_type  application/octet-stream;</div><div class="line"></div><div class="line">    <span class="comment">#log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span></div><div class="line">    <span class="comment">#                  '$status $body_bytes_sent "$http_referer" '</span></div><div class="line">    <span class="comment">#                  '"$http_user_agent" "$http_x_forwarded_for"';</span></div><div class="line"></div><div class="line">    <span class="comment">#access_log  logs/access.log  main;</span></div><div class="line"></div><div class="line">    sendfile        on;</div><div class="line">    <span class="comment">#tcp_nopush     on;</span></div><div class="line"></div><div class="line">    <span class="comment">#keepalive_timeout  0;</span></div><div class="line">    keepalive_timeout  65;</div><div class="line"></div><div class="line">    <span class="comment">#gzip  on;</span></div><div class="line"></div><div class="line">    server &#123;</div><div class="line">        listen       80;</div><div class="line">        server_name  localhost;</div><div class="line"></div><div class="line">        <span class="comment">#charset koi8-r;</span></div><div class="line"></div><div class="line">        <span class="comment">#access_log  logs/host.access.log  main;</span></div><div class="line"></div><div class="line">        location / &#123;</div><div class="line">            root   html;</div><div class="line">            index  index.html index.htm;</div><div class="line">        &#125;</div><div class="line">    .....</div></pre></td></tr></table></figure>
<h3 id="Nginx主配置段详述"><a href="#Nginx主配置段详述" class="headerlink" title="Nginx主配置段详述"></a>Nginx主配置段详述</h3><h4 id="主配置段（main-block）"><a href="#主配置段（main-block）" class="headerlink" title="主配置段（main block）"></a>主配置段（main block）</h4><p>★分类：<br>&ensp;&ensp;&ensp;&ensp;正常运行必备的配置<br>&ensp;&ensp;&ensp;&ensp;优化性能相关的配置<br>&ensp;&ensp;&ensp;&ensp;用于调试及定位问题相关的配置<br>&ensp;&ensp;&ensp;&ensp;事件驱动相关的配置<br>⊙正常运行必备的配置：<br><img src="\images\nginx\nginx3.png" alt="nginx"><br>⊙性能优化相关的配置：<br><img src="\images\nginx\nginx4.png" alt="nginx"></p>
<h4 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h4><p>1.worker_cpu_affinity auto [cpumask] …;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># vim /etc/nginx/nginx.conf</span></div><div class="line"><span class="comment">#user  nobody;</span></div><div class="line">worker_processes  2;</div><div class="line">worker_cpu_affinity 00000001 00000010;          （<span class="comment"># 表示仅用0号和1号cpu）</span></div><div class="line"></div><div class="line"><span class="comment"># 测试语法并重载nginx</span></div><div class="line">[root@centos7 ~]<span class="comment"># vim /etc/nginx/nginx.conf</span></div><div class="line">[root@centos7 ~]<span class="comment"># nginx -t</span></div><div class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</div><div class="line">nginx: configuration file /etc/nginx/nginx.conf <span class="built_in">test</span> is successful</div><div class="line">[root@centos7 ~]<span class="comment"># nginx -s reload</span></div><div class="line"></div><div class="line"><span class="comment"># 查看进程,可见只有两个worker</span></div><div class="line">[root@centos7 ~]<span class="comment"># ps aux|grep nginx|grep -v grep</span></div><div class="line">root       1346  0.0  0.1  47632  1944 ?        Ss   12:45   0:00 nginx: master process /usr/<span class="built_in">local</span>/nginx/sbin/nginx -c /etc/nginx/nginx.conf</div><div class="line">nginx      1499  0.0  0.1  48100  1996 ?        S    13:00   0:00 nginx: worker process</div><div class="line">nginx      1500  0.0  0.1  48100  1992 ?        S    13:00   0:00 nginx: worker process</div><div class="line">[root@centos7 ~]<span class="comment"># ps axo pid,comm,psr</span></div><div class="line">   PID COMMAND         PSR</div><div class="line">   1499 nginx           0</div><div class="line">   1500 nginx           1</div><div class="line"></div><div class="line"><span class="comment"># worker_cpu_affinity auto 表示nginx启动自己选择好一颗cpu绑定</span></div><div class="line">[root@centos7 ~]<span class="comment"># vim /etc/nginx/nginx.conf</span></div><div class="line"><span class="comment">#user  nobody;</span></div><div class="line">worker_processes  auto;</div><div class="line">worker_cpu_affinity auto;</div></pre></td></tr></table></figure></p>
<p>2.worker_priority number;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># ps axo pid,comm,psr,nice|grep nginx</span></div><div class="line">  1538 nginx             0   0</div><div class="line">  1539 nginx             1   0</div><div class="line">[root@centos7 ~]<span class="comment"># vim /etc/nginx/nginx.conf</span></div><div class="line"><span class="comment">#user  nobody;</span></div><div class="line">worker_processes  auto;</div><div class="line">worker_cpu_affinity auto;</div><div class="line">worker_priority -5;          <span class="comment"># 修改nice为-5</span></div><div class="line"></div><div class="line">[root@centos7 ~]<span class="comment"># nginx -s reload</span></div><div class="line">[root@centos7 ~]<span class="comment"># ps axo pid,comm,psr,nice|grep nginx</span></div><div class="line">  1558 nginx             0  -5</div><div class="line">  1559 nginx             1  -5</div></pre></td></tr></table></figure></p>
<p>⊙调试、定位问题：<br><img src="\images\nginx\nginx5.png" alt="nginx"><br>⊙事件驱动相关的配置：引入了新的上下文，定义在events{…}zhong<br><img src="\images\nginx\nginx6.png" alt="nginx"></p>
<h3 id="http协议配置详述"><a href="#http协议配置详述" class="headerlink" title="http协议配置详述"></a>http协议配置详述</h3><h3 id="ngx-http-core-module（核心模块）"><a href="#ngx-http-core-module（核心模块）" class="headerlink" title="ngx_http_core_module（核心模块）"></a>ngx_http_core_module（核心模块）</h3><p>★配置结构：<br><img src="\images\nginx\nginx-http-module.png" alt="nginx"><br>★与套接字相关的配置<br>⊙server { … }，配置一个虚拟主机<br><img src="\images\nginx\nginx-http-module1.png" alt="nginx"><br>⊙listen PORT|address[:port]|unix:/PATH/TO/SOCKET_FILE<br><img src="\images\nginx\nginx-http-module2.png" alt="nginx"><br>⊙server_name name …;<br><img src="\images\nginx\nginx-http-module3.png" alt="nginx"><br>⊙tcp_nodelay on | off; 无延迟<br>&ensp;&ensp;&ensp;&ensp;在keepalived模式下的连接是否启用TCP_NODELAY选项；<br>&ensp;&ensp;&ensp;&ensp;建议为on（表示不启用打包多个小包为一个打包发送，无延迟，用户请求即相应）<br>⊙sendfile on | off；<br>&ensp;&ensp;&ensp;&ensp;表示是否启用sendfile功能；<br>&ensp;&ensp;&ensp;&ensp;sendfile 表示直接在内核级别封装资源传送给客户端，在效率上要高很多。<br>&ensp;&ensp;&ensp;&ensp;优化nginx：建议启用 on</p>
<h4 id="演示：-1"><a href="#演示：-1" class="headerlink" title="演示："></a>演示：</h4><p>配置基于端口的虚拟主机<br>1.首先创建虚拟主机的根目录，并提供页面文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># mkdir -pv /vnhosts/www&#123;1,2&#125;</span></div><div class="line">mkdir: created directory ‘/vnhosts’</div><div class="line">mkdir: created directory ‘/vnhosts/www1’</div><div class="line">mkdir: created directory ‘/vnhosts/www2’</div><div class="line">[root@centos7 ~]<span class="comment"># echo "www1.jack.com" &gt; /vnhosts/www1/index.html</span></div><div class="line">[root@centos7 ~]<span class="comment"># echo "www2.jack.com" &gt; /vnhosts/www2/index.html</span></div><div class="line">[root@centos7 ~]<span class="comment"># cat /vnhosts/www1/index.html </span></div><div class="line">www1.jack.com</div><div class="line">[root@centos7 ~]<span class="comment"># cat /vnhosts/www2/index.html</span></div><div class="line">www2.jack.com</div></pre></td></tr></table></figure></p>
<p>2.编辑配置文件/etc/nginx/nginx.conf<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 定义两个基于端口的虚拟主机 </span></div><div class="line">server &#123;</div><div class="line">        listen       8080;</div><div class="line">        server_name  www1.jack.com;</div><div class="line">        root /vnhosts/www1;</div><div class="line">&#125;</div><div class="line">server &#123;</div><div class="line">        listen       8088;</div><div class="line">        server_name  www2.jack.com;</div><div class="line">        root /vnhosts/www2;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>3.定义好之后保存退出，测试语法，重载，并查看端口8080和8088<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># nginx -t</span></div><div class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</div><div class="line">nginx: configuration file /etc/nginx/nginx.conf <span class="built_in">test</span> is successful</div><div class="line">[root@centos7 ~]<span class="comment"># nginx -s reload</span></div><div class="line">[root@centos7 ~]<span class="comment"># ss -tnl          # 查看端口8080和8088</span></div><div class="line">State       Recv-Q Send-Q Local Address:Port               Peer Address:Port              </div><div class="line">LISTEN      0      128              *:8080                         *:*                  </div><div class="line">LISTEN      0      128              *:22                           *:*                  </div><div class="line">LISTEN      0      128              *:8088                         *:*                  </div><div class="line">LISTEN      0      100      127.0.0.1:25                           *:*                  </div><div class="line">LISTEN      0      128             :::22                          :::*                  </div><div class="line">LISTEN      0      100            ::1:25                          :::*</div></pre></td></tr></table></figure></p>
<p>浏览器访问如下：<br><img src="\images\nginx\nginx-test1.png" alt="nginx"><br><img src="\images\nginx\nginx-test2.png" alt="nginx"></p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color1">Nginx</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2017/08/26/web services之nginx(一)/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>





  
    <article id="post-linux服务之iptables三" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/24/linux服务之iptables三/">linux服务之iptables-NAT</a>
    </h1>
  

        
        <a href="/2017/08/24/linux服务之iptables三/" class="archive-article-date">
  	<time datetime="2017-08-24T02:00:22.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2017-08-24</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="概述："><a href="#概述：" class="headerlink" title="概述："></a>概述：</h3><p>NAT：SNAT和DNAT</p>
<h4 id="源地址转换（SNAT）"><a href="#源地址转换（SNAT）" class="headerlink" title="源地址转换（SNAT）"></a>源地址转换（SNAT）</h4><p>★ 源地址转换（SNAT）：POSTROUTING<br>⊙使用场景：<br>&ensp;&ensp;&ensp;&ensp;主要用于实现让内网客户端访问外部主机地址时使用，要定义在POSTROUTING链或INPUT链；<br>⊙静态转换：外网地址是固定的；<br>⊙动态转换：外网地址不固定；<br>★ 定义方法：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">iptables -t nat A POSTROUTING <span class="_">-s</span> 内网网络主机或地址 -j SNAT --to-source NAT服务器上的某外网地址</div><div class="line">★ PAT：Port Address Translati：端口映射（了解即可）</div></pre></td></tr></table></figure></p>
<p>图解如下：<br><img src="\images\iptables\nat\snat.png" alt="iptables"></p>
<h4 id="SNAT实验测试如下："><a href="#SNAT实验测试如下：" class="headerlink" title="SNAT实验测试如下："></a>SNAT实验测试如下：</h4><h4 id="实验环境："><a href="#实验环境：" class="headerlink" title="实验环境："></a>实验环境：</h4><p>&ensp;&ensp;&ensp;&ensp;1）三台虚拟主机（CentOS 7，CentOS 7 ,CentOS 6），模拟两台物理机，其中两台CentOS 7的主机在内网之中，一台作为网关主机，一台作为内网主机；CentOS 6主机为外网主机；<br>&ensp;&ensp;&ensp;&ensp;IP分配为:<br>&ensp;&ensp;&ensp;&ensp;内网主机CentOS7:192.168.2.88<br>&ensp;&ensp;&ensp;&ensp;网关主机CentOS7:<br>&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;内网网卡IP:192.168.2.1<br>&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;外网网卡IP:10.0.0.100<br>&ensp;&ensp;&ensp;&ensp;外网主机CentOS6:10.0.0.125<br>&ensp;&ensp;&ensp;&ensp;2）内网网关主机要有两块网卡，一块网卡负责与内网主机进行通信；一块网卡负责与外网主机进行通信；<br>&ensp;&ensp;&ensp;&ensp;3）内网网关主机与外网主机的网卡都要设置为桥接模式，内网网关主机的另一块网卡与内网主机通信的连接模式为仅主机模式（VMnet1）；<br>&ensp;&ensp;&ensp;&ensp;4）内网主机ip为192.168.2.88且网关必须要指向网关主机的内网网卡；<br>1.实验操作之前，内网主机是可以访问外网主机，也可以ping通，如下：<br><img src="\images\iptables\nat\snat1.png" alt="iptables"><br>通过外网的日志查看和请求ping报文清楚的知道源地址是内网主机，内网主机没有做任何的转换<br><img src="\images\iptables\nat\snat2.png" alt="iptables"><br>2.接下来我们要把内网地址转换成网关主机的外网地址，已达到伪装隐藏之源地址的目的。<br>1）定义规则源地址转换为网关主机的外网地址10.0.0.100，允许内网的所有主机访问外网的所有服务<br><img src="\images\iptables\nat\snat3.png" alt="iptables"><br>接下来，内网主机再次访问外网的web服务和ping操作，外网抓包和访问日志已经伪装成网关主机的外网地址，如下：<br><img src="\images\iptables\nat\snat4.png" alt="iptables"><br>为了验证是在哪个环节发生的地址转换，我们在网关主机的内网网卡和外网网卡分别抓包，如下：<br><img src="\images\iptables\nat\snat5.png" alt="iptables"></p>
<h4 id="MASQUERADE：地址伪装"><a href="#MASQUERADE：地址伪装" class="headerlink" title="MASQUERADE：地址伪装"></a>MASQUERADE：地址伪装</h4><p>★ 地址伪装，能自行判断该转换为哪个源地址<br>This target is only valid in the nat table, in the POSTROUTING chain.  It  should  only  be  used  with  dynamically assigned  IP (dialup) connections: if you have a static IP address, you should use the SNAT target.（这一目标只能在nat表的POSTROUTING链上定义。它适用于动态分配的地址，IP(拨号)连接，会自动去寻找可用的ip地址：如果你有一个静态IP地址，应该使用SNAT目标。）</p>
<h4 id="目标地址转换（DNAT）"><a href="#目标地址转换（DNAT）" class="headerlink" title="目标地址转换（DNAT）"></a>目标地址转换（DNAT）</h4><p>★ 目标地址转换（DNAT）：PREROUTING<br>⊙使用场景：<br>&ensp;&ensp;&ensp;&ensp;主要用于发布内部服务器，让内网中的服务器在外网中可以被访问到，要定义在PREROUTING链；<br>★ 定义方法：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -t nat -A PREROUTING <span class="_">-d</span> NAT服务器的某外网地址 -p 某协议 --dport 某端口 -j DNAT --to-destination 内网某服务器地址[:PORT]</div></pre></td></tr></table></figure></p>
<p>★ 图解过程如下：<br><img src="\images\iptables\nat\dnat.png" alt="iptables"></p>
<h4 id="DNAT目标地址转换实验如下："><a href="#DNAT目标地址转换实验如下：" class="headerlink" title="DNAT目标地址转换实验如下："></a>DNAT目标地址转换实验如下：</h4><h4 id="实验前环境准备"><a href="#实验前环境准备" class="headerlink" title="实验前环境准备"></a>实验前环境准备</h4><p>1.因为DNAT为目标地址转换，即让内网中的服务器在外网中可以被访问到，所以，为了增加实验的说服力，我这里在内网的同一块网卡上再添加一个ip地址，让每一个ip地址对应一个服务，如下：<br><img src="\images\iptables\nat\dnat1.png" alt="iptables"><br>2.如上，地址已经添加成功，假设88地址对应的是web服务，89的地址对应的是ssh服务（这里可以想象成两个主机，但实际上是一个主机，为了演示效果）；为了不影响实验效果这里我先把上例中定义的SNAT规则清空，如下：<br><img src="\images\iptables\nat\dnat2.png" alt="iptables"></p>
<h4 id="实验如下："><a href="#实验如下：" class="headerlink" title="实验如下："></a>实验如下：</h4><p>1.假设内网地址192.168.2.88上提供了web服务，我们希望外网用户把对网关主机外网网卡请求的web服务的80端口全都转化到内网的192.168.2.88上，设置如下：<br>&ensp;&ensp;&ensp;&ensp;分析：这里一定是在nat表的PREROUTING链上定义，指明目标IP为网关主机的外网地址10.0.0.100，指明协议为tcp协议（如果不指明的话所有的服务会统统转到一台内网主机之上），指明目标端口为网关主机外网地址的80端口（实际上根本没有，因为网关主机跟本就没有提供服务），指明转换的目标地址为提供服务的内网主机地址192.168.2.88，这里没指明端口，默认就是网关主机的端口80，也可以不相同，也就是端口映射；<br><img src="\images\iptables\nat\dnat3.png" alt="iptables"><br>查看网关主机确认是没有开通web服务的80端口<br><img src="\images\iptables\nat\dnat4.png" alt="iptables"><br>使用外网主机请求网关主机的web服务，如下：<br><img src="\images\iptables\nat\dnat5.png" alt="iptables"><br>2.如上，我们只是把web服务转发到了一个内网服务上，是有选择性的。如果我们现在用外网去ping网关主机的外网地址，是不通的，要想通定义如下：<br><img src="\images\iptables\nat\dnat6.png" alt="iptables"><br>外网主机去ping网关主机的10.1.252.161，在内网主机上抓包如下：<br><img src="\images\iptables\nat\dnat7.png" alt="iptables"><br>3.如果我们现在想把外网访问网关主机的外网地址的80端口（web服务）通过目标地址转换为内网地址的8080端口，那就需要做端口映射了（PAT）<br>首先修改内网服务器httpd服务的配置文件修改监听端口（LISTEN）为8080，重启httpd服务即可<br><img src="\images\iptables\nat\dnat8.png" alt="iptables"><br>然后重新在网关主机上添加规则使网关主机的80端口映射为内网主机的8080端口即可，如下：<br><img src="\images\iptables\nat\dnat9.png" alt="iptables"><br>测试外网主机访问内网主机的web服务如下：<br><img src="\images\iptables\nat\dnat10.png" alt="iptables"></p>
<h4 id="REDIRECT-重定向"><a href="#REDIRECT-重定向" class="headerlink" title="REDIRECT:重定向"></a>REDIRECT:重定向</h4><p>★ 定义：<br>&ensp;&ensp;&ensp;&ensp;This  target  is only valid in the nat table, in the PREROUTING and OUTPUT chains, and user-defined chains which are only called from those chains. 仅在当前主机上完成端口映射<br>★ 用法：<br>&ensp;&ensp;&ensp;&ensp;- -to-ports port[-port]</p>
<h4 id="注意："><a href="#注意：" class="headerlink" title="注意："></a>注意：</h4><p>&ensp;&ensp;&ensp;&ensp;在应用当中，我们可以综合nat表和filter表来完成控制访问，比如，我们可以通过定义nat表来完成地址转换，通过filter表来完成过滤功能。因为nat表仅负责完成地址转换，转换完成之后，这个报文到底能不能出去就要靠filter表的定义了。<br>&ensp;&ensp;&ensp;&ensp;还有一种场景，假如我们发布的内部服务器是一个web服务，允许外网用户通过DNAT来访问我们的内网web服务器，但是有一个外网用户经常对我们的主机发起攻击的操作，我们要拒绝这个外网用户的访问，可以有两种方法来控制其访问，一种是在内网主机上添加防火墙起到控制作用，另一种也可以在网关主机添加防火墙规则控制其访问。</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color4">iptables</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2017/08/24/linux服务之iptables三/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>





  
    <article id="post-linux服务之iptables二" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/23/linux服务之iptables二/">linux服务之iptables网络防火墙</a>
    </h1>
  

        
        <a href="/2017/08/23/linux服务之iptables二/" class="archive-article-date">
  	<time datetime="2017-08-23T02:00:22.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2017-08-23</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="实验："><a href="#实验：" class="headerlink" title="实验："></a>实验：</h3><p>&ensp;&ensp;&ensp;&ensp;实现内网主机与外网主机之间的通信，并在网关主机的FORWARD链上添加规则，控制访问<br>实验模型：<br><img src="\images\iptables\forward.png" alt="iptables"></p>
<h4 id="实验环境准备"><a href="#实验环境准备" class="headerlink" title="实验环境准备"></a>实验环境准备</h4><p>&ensp;&ensp;&ensp;&ensp;1）三台虚拟主机（CentOS 7，CentOS 7 ,CentOS 6），模拟两台物理机，其中两台CentOS 7的主机在内网之中，一台作为网关主机，一台作为内网主机；CentOS 6主机为外网主机；<br>&ensp;&ensp;&ensp;&ensp;IP分配为:<br>&ensp;&ensp;&ensp;&ensp;内网主机CentOS7:192.168.2.88<br>&ensp;&ensp;&ensp;&ensp;网关主机CentOS7:<br>&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;内网网卡IP:192.168.2.1<br>&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;外网网卡IP:10.0.0.100<br>&ensp;&ensp;&ensp;&ensp;外网主机CentOS6:10.0.0.125<br>&ensp;&ensp;&ensp;&ensp;2）内网网关主机要有两块网卡，一块网卡负责与内网主机进行通信；一块网卡负责与外网主机进行通信；<br>&ensp;&ensp;&ensp;&ensp;3）内网网关主机与外网主机的网卡都要设置为桥接模式，内网网关主机的另一块网卡与内网主机通信的连接模式为仅主机模式（VMnet1）；<br>&ensp;&ensp;&ensp;&ensp;4）内网主机ip为192.168.2.88且网关必须要指向网关主机的内网网卡；</p>
<h4 id="准备如下图："><a href="#准备如下图：" class="headerlink" title="准备如下图："></a>准备如下图：</h4><p>网关主机（CentOS 7）的两块网卡及各自的ip如下图：<br><img src="\images\iptables\forward\firewall.png" alt="iptables"><br>内网主机（CenoOS 7）的网卡ip如下图：<br><img src="\images\iptables\forward\innet.png" alt="iptables"><br>外网主机（CenoOS 6）的网卡ip如下图：<br><img src="\images\iptables\forward\outnet.png" alt="iptables"></p>
<h4 id="测试："><a href="#测试：" class="headerlink" title="测试："></a>测试：</h4><p><img src="\images\iptables\forward\innet-ping.png" alt="iptables"><br>说明：<br>&ensp;&ensp;&ensp;&ensp;内网主机ping网关主机的内网网卡ip可以ping通,ping外网网卡ip发现也可以ping通，这是因为网卡默认是属于内核的，ping网关主机的外网卡ip为网关主机上的地址,而网关主机的内网网卡能够与内网主机的ip:192.168.2.88通信,所以这里不是转发,还是在本机上,虽然网关主机两个网卡的地址不在一个网段。只有到另外一台主机（外网主机）才是转发。</p>
<h3 id="具体实验如下："><a href="#具体实验如下：" class="headerlink" title="具体实验如下："></a>具体实验如下：</h3><p>1.在未打开网关主机的核心转发功能之前，内网主机（CentoS 7）访问外网主机（CentOS 6）,看能否ping通，过程如下：<br>1）首先查看网关主机（CentOS 7）的核心转发功能确认是关闭的<br><img src="\images\iptables\forward\ip-forward.png" alt="iptables"><br>2）现在我们用内网主机ping外网主机（CentOS 6）的ip 10.1.252.153,发现是ping不通的<br><img src="\images\iptables\forward\innet-outnet.png" alt="iptables"><br>3）我们在网关主机的内网网卡上抓包，是可以成功抓包的，如下：<br><img src="\images\iptables\forward\tcpdump-innet.png" alt="iptables"><br>在网关主机的外网网卡上抓包不成功<br><img src="\images\iptables\forward\tcpdump-outnet.png" alt="iptables"><br> 外网主机抓包不成功；<br><img src="\images\iptables\forward\outnet1.png" alt="iptables"></p>
<h4 id="结论："><a href="#结论：" class="headerlink" title="结论："></a>结论：</h4><p>&ensp;&ensp;&ensp;&ensp;说明内网主机的报文在到达网关主机的外网网卡时，由于网关主机没有开启核心转发功能，所以不能到达，只能和网关主机的内网网卡进行通信，因为没有到达网关主机的外网网卡，所以无法通过网关主机的外网网卡与外网主机之间进行通信</p>
<p>2.现在我们开启网关主机的核心转发功能，再用内网虚拟主机（localhost）去请求外网主机看能否ping通<br>1）网关主机开启核心转发功能，如下：<br><img src="\images\iptables\forward\ip-forward1.png" alt="iptables"><br>2）使用内网主机ping外网主机（CentOS 6）,如下：<br><img src="\images\iptables\forward\innet-outnet1.png" alt="iptables"><br>3）在外网主机(CentOS 6)上抓包，可以正常抓包，并且有响应报文<br><img src="\images\iptables\forward\outnet2.png" alt="iptables"><br>4）在网关主机的外网网卡上抓包，如下，可以正常抓到包也有响应报文<br><img src="\images\iptables\forward\tcpdump-outnet1.png" alt="iptables"><br>5）那为什么内网主机收不到响应报文呢？原因是外网主机收到报文后会把响应报文首先提交给网关，而外网的网关现在为10.0.0.1，没有指向网关主机外网的ip，所以，网关主机的外网接受不到响应报文，现在修改如下：<br><img src="\images\iptables\forward\outnet3.png" alt="iptables"><br>6）修改之后发现，内网中的虚拟主机马上就收到响应报文了<br><img src="\images\iptables\forward\innet-outnet2.png" alt="iptables"></p>
<p>3.因为网关主机有核心转发功能，所以现在我们在网关主机上的FORWARD链上添加规则，实验如下：<br>1）现在我们首先用外网主机去请求内网主机的web服务，如下<br><img src="\images\iptables\forward\outnet-curl-innet.png" alt="iptables"><br>2）用内网主机访问外网的web服务，也可以正常访问，如下：<br><img src="\images\iptables\forward\innet-curl-outnet.png" alt="iptables"><br>3）以上均为正常的，现在我们在网关主机上添加规则DROP<br>添加规则，所有的协议，目标源地址策略都为DROP<br><img src="\images\iptables\forward\ip-forward2.png" alt="iptables"><br>现在我们再去用外网请求内网和内网请求外网发现都请求不到了，如下：<br><img src="\images\iptables\forward\outnet-curl-innet1.png" alt="iptables"><br><img src="\images\iptables\forward\innet-curl-outnet1.png" alt="iptables"><br>4）现在设定，放行由内网外访问外网的服务，也就是只允许内网主机可以访问外网任意主机的web服务；<br>添加规则如下：目标地址为外网的所有地址，端口固定为80<br><img src="\images\iptables\forward\ip-forward3.png" alt="iptables"><br>现在内网再去请求外网的web服务，可以正常访问<br><img src="\images\iptables\forward\innet-curl-outnet3.png" alt="iptables"><br>5）我们知道这只是一个web服务，同样还会有很多的服务，这样的话规则的添加会越来越多，所以，这里我们可以做状态追踪，因为，任何请求进来的报文都是安全的报文。设定规则如下：<br><img src="\images\iptables\forward\ip-forward4.png" alt="iptables"><br>如此一来，无论是由内而外，还是由外而内，只要是响应报文统统放行，这样只需要去匹配请求报文，规则即可</p>
<p>6）现在我们修改第二条规则，添加多个端口，ftp/21,ssh/22,http/80,telnet/23,sanba/445,139，并只允许新建立的连接来访问<br><img src="\images\iptables\forward\ip-forward5.png" alt="iptables"><br>访问如下：<br><img src="\images\iptables\forward\innet-ssh-outnet.png" alt="iptables"><br>7）现在我们通过内网的主机访问外网的ftp服务，访问不了<br>我们要开放RELATED的状态连接<br>a.要想被追踪，要首先添加追踪ftp状态的nf_conntrack_ftp模块<br><img src="\images\iptables\forward\ftp-mod.png" alt="iptables"><br>b. 接下来添加RELATED的状态规则<br><img src="\images\iptables\forward\ip-forware-ftp.png" alt="iptables"></p>
<h4 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h4><p>★ iptables/netfilter网络防火墙：<br>添加规则于FORWARD链，注意几个问题：<br>⊙请求和响应报文均会经由FORWARD链，要注意规则的方向性；<br>&ensp;&ensp;&ensp;&ensp;第一条： iptables -I FORWARD  -m state –state ESTABLISHED,RELATED -j ACCEPT<br>⊙如果可以启用conntrack机制，注意网关主机所能够追踪的连接数的最大数量要符合需要；</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color4">iptables</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2017/08/23/linux服务之iptables二/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>





  
    <article id="post-linux服务之iptables" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/22/linux服务之iptables/">linux服务之iptables基础</a>
    </h1>
  

        
        <a href="/2017/08/22/linux服务之iptables/" class="archive-article-date">
  	<time datetime="2017-08-22T02:00:22.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2017-08-22</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="概述："><a href="#概述：" class="headerlink" title="概述："></a>概述：</h3><p>Linux中有关防火墙的相关基础知识，内容包括：<br>&ensp;&ensp;&ensp;&ensp;◆iptables/netfilter：<br>&ensp;&ensp;&ensp;&ensp;◆netfilter上的5个钩子函数；<br>&ensp;&ensp;&ensp;&ensp;◆iptables上的5链；<br>&ensp;&ensp;&ensp;&ensp;◆四表：raw，mangle，nat，filter以及各表的功能和链的对应关系；<br>&ensp;&ensp;&ensp;&ensp;◆iptables的安装和命令规则的组成和使用格式；<br>&ensp;&ensp;&ensp;&ensp;◆iptables的匹配规则，包括基本匹配条件和扩展匹配条件；<br>&ensp;&ensp;&ensp;&ensp;◆扩展匹配条件中的隐性匹配和显性匹配</p>
<h3 id="iptables介绍"><a href="#iptables介绍" class="headerlink" title="iptables介绍"></a>iptables介绍</h3><h4 id="Firewall"><a href="#Firewall" class="headerlink" title="Firewall"></a>Firewall</h4><p>★ Firewall：防火墙系统<br>&ensp;&ensp;&ensp;&ensp;是一种隔离工具，Packets Filter Firewall （包过滤型防火墙）；<br>☉定义：<br>&ensp;&ensp;&ensp;&ensp;工作于主机或网络的边缘，对经由的报文根据预先定义的规则（匹配条件）进行检测，对于能够被规则匹配到的报文实行某预定义的处理机制的一套组件；<br>☉硬件防火墙：<br>&ensp;&ensp;&ensp;&ensp;在硬件级别实现部分功能的防火墙；另一个部分功能基于软件实现；<br>☉软件防火墙：<br>&ensp;&ensp;&ensp;&ensp;应用软件处理逻辑运行于通用硬件平台之上的防火墙；<br>★ 防火墙范围分类：<br>&ensp;&ensp;&ensp;&ensp;主机防火墙：服务范围为当前主机；<br>&ensp;&ensp;&ensp;&ensp;网络防火墙：服务范围为防火墙背后的局域网；</p>
<h4 id="iptables-netfilter："><a href="#iptables-netfilter：" class="headerlink" title="iptables/netfilter："></a>iptables/netfilter：</h4><p>★ netfilter：防火墙框架，framework；位于内核空间；<br>⊙hooks function（钩子函数）<br>&ensp;&ensp;&ensp;&ensp;prerouting：路由前<br>&ensp;&ensp;&ensp;&ensp;input ：   入栈<br>&ensp;&ensp;&ensp;&ensp;forward ： 转发<br>&ensp;&ensp;&ensp;&ensp;output ：  出栈<br>&ensp;&ensp;&ensp;&ensp;postrouting：路由后<br>注意：<br>&ensp;&ensp;&ensp;&ensp;钩子函数都是在内核中的TCP/IP协议栈上定义的。<br>★ iptables：<br>&ensp;&ensp;&ensp;&ensp;命令行工具程序，位于用户空间；规则管理工具；<br>⊙CHAINS：链，在钩子上定义规则<br>&ensp;&ensp;&ensp;&ensp;PREROUTING<br>&ensp;&ensp;&ensp;&ensp;INPUT<br>&ensp;&ensp;&ensp;&ensp;FORWARD<br>&ensp;&ensp;&ensp;&ensp;OUTPUT<br>&ensp;&ensp;&ensp;&ensp;POSTROUTING<br>注意：<br>&ensp;&ensp;&ensp;&ensp;iptables 是用户空间的规则管理工具，通过iptables编写好规则后，然后送往在对应的CHAINS（链）之上来管理报文；<br>★ 报文流向：<br>&ensp;&ensp;&ensp;&ensp;到本机某进程的报文：PREROUTING –&gt; INPUT<br>&ensp;&ensp;&ensp;&ensp;由本机转发的报文：PREROUTING –&gt; FORWARD –&gt; POSTROUTING<br>&ensp;&ensp;&ensp;&ensp;由本机的某进程发出报文：OUTPUT –&gt; POSTROUTING</p>
<h4 id="tables-表"><a href="#tables-表" class="headerlink" title="tables 表"></a>tables 表</h4><p>★ 功能：<br>&ensp;&ensp;&ensp;&ensp;filter：过滤，防火墙；<br>&ensp;&ensp;&ensp;&ensp;nat：network address translation，网络地址转换；<br>&ensp;&ensp;&ensp;&ensp;mangle：拆解报文，做出修改，并重新封装；<br>&ensp;&ensp;&ensp;&ensp;raw：关闭nat表上启用的连接追踪机制；<br>附录：<br>filter表和nat表：<br><img src="\images\iptables\filter.png" alt="iptables"><br><img src="\images\iptables\nat.png" alt="iptables"><br>★ 优先级次序（由高而低）：<br>&ensp;&ensp;&ensp;&ensp;raw –&gt; mangle –&gt; nat –&gt; filter<br>★ 功能&lt;–&gt;钩子对应关系：很重要<br>&ensp;&ensp;&ensp;&ensp;raw：PREROUTING，OUTPUT<br>&ensp;&ensp;&ensp;&ensp;mangle：PREROUTING，INPUT，FORWARD，OUTPUT，POSTROUTING<br>&ensp;&ensp;&ensp;&ensp;nat：PREROUTING，INPUT，OUTPUT，POSTROUTING<br>&ensp;&ensp;&ensp;&ensp;filter：INPUT，FORWARD，OUTPUT<br>★数据包过滤匹配流程：<br><img src="\images\iptables\数据包过程匹配流程.png" alt="iptables"></p>
<h4 id="iptables规则的组成及工作原理："><a href="#iptables规则的组成及工作原理：" class="headerlink" title="iptables规则的组成及工作原理："></a>iptables规则的组成及工作原理：</h4><p>★ 匹配条件：<br>&ensp;&ensp;&ensp;&ensp;网络层首部：Source IP（源IP）, Destination IP（目标IP）<br>&ensp;&ensp;&ensp;&ensp;传输层首部：Source Port(源端口), Destination Port（目标端口）<br>&ensp;&ensp;&ensp;&ensp;扩展检查机制：<br>★ 处理动作：target 目标<br>&ensp;&ensp;&ensp;&ensp;ACCEPT：接受<br>&ensp;&ensp;&ensp;&ensp;DROP：丢弃<br>&ensp;&ensp;&ensp;&ensp;REJECT：驳回，拒绝<br>★ iptables工作流程<br>&ensp;&ensp;&ensp;&ensp;iptables是采用数据包过滤机制工作的，所以它会对请求的数据包的包头数据进行分析，并根据我们预先设定的规则进行匹配来确定是否可以进入主机。<br>&ensp;&ensp;&ensp;&ensp;工作流程如下图所示：<br>（数据报的流向是从左向右）<br><img src="\images\iptables\数据报流向.png" alt="iptables"><br>★ 总结：<br>&ensp;&ensp;&ensp;&ensp;1.防火墙是层层过滤的，实际是按照配置规则的顺序从上到下，从前到后进行过滤的。<br>&ensp;&ensp;&ensp;&ensp;2.如果匹配上规则，即明确表明是阻止还是通过，数据包就不在向下进行匹配新规则了。<br>&ensp;&ensp;&ensp;&ensp;3.如果所有规则中没有明确表明是阻止还是通过，也就是没有匹配规则，向下进行匹配，直到匹配默认规则得到明确的阻止还是通过。<br>&ensp;&ensp;&ensp;&ensp;4.防火墙默认规则是所有的规则执行完才会执行的。<br>&ensp;&ensp;&ensp;&ensp;5.匹配上了拒绝规则也是匹配，这点要多注意</p>
<h3 id="iptables命令使用基础"><a href="#iptables命令使用基础" class="headerlink" title="iptables命令使用基础"></a>iptables命令使用基础</h3><h4 id="安装："><a href="#安装：" class="headerlink" title="安装："></a>安装：</h4><p>★ netfilter：位于内核中的tcp/ip协议栈报文处理框架；<br>★ iptables：<br>☉CentOS 5/6：iptables命令编写规则；<br> 初始化安装命令：<br>&ensp;&ensp;&ensp;&ensp;iptables -t filter -F<br>&ensp;&ensp;&ensp;&ensp;service iptables save<br>☉CentOS 7：firewalld，firewall-cmd, firewall-config<br> 初始化安装命令：<br>&ensp;&ensp;&ensp;&ensp;systemctl disable firewalld<br>★ 程序包：<br>&ensp;&ensp;&ensp;&ensp;iptables，iptstate</p>
<h4 id="iptables命令的规则"><a href="#iptables命令的规则" class="headerlink" title="iptables命令的规则:"></a>iptables命令的规则:</h4><p>规则：<br>&ensp;&ensp;&ensp;&ensp;根据指定的匹配条件来尝试匹配每个流经此处的报文，一旦匹配成功，则由规则后面指定的处理动作进行处理；<br>⊙匹配条件：<br>◆基本匹配条件：主要是ip层（源地址，目标地址），传输层协议；<br>◆扩展匹配条件：需要借助于扩展模块进行指定的匹配条件；<br>&ensp;&ensp;&ensp;&ensp;隐式扩展：已经在基本匹配条件中指明的协议相关的扩展；<br>&ensp;&ensp;&ensp;&ensp;显式扩展：隐式扩展之外的其它扩展匹配条件；<br>⊙处理动作：<br>&ensp;&ensp;&ensp;&ensp;基本动作：ACCEPT，DROP，…<br>&ensp;&ensp;&ensp;&ensp;扩展动作：需要借助于扩展模块进行，但无须显式指定，仅需指明动作；<br>★ 添加规则时需要考量的问题：<br>&ensp;&ensp;&ensp;&ensp;报文流经的位置：用于判断将规则添加至哪个链；<br>&ensp;&ensp;&ensp;&ensp;实现的功能：用于判断将规则添加至哪个表；<br>&ensp;&ensp;&ensp;&ensp;报文的方向：用于判断哪个为“源”，哪个为“目标”；<br>&ensp;&ensp;&ensp;&ensp;匹配条件：用于编写能够正确匹配目标报文的规则；</p>
<h4 id="iptables命令的使用格式"><a href="#iptables命令的使用格式" class="headerlink" title="iptables命令的使用格式"></a>iptables命令的使用格式</h4><p>★ 规则使用格式：<br>&ensp;&ensp;&ensp;&ensp;iptables [-t table] {-A|-C|-D} chain rule-specification<br>&ensp;&ensp;&ensp;&ensp;iptables [-t table] -I chain [rulenum] rule-specification<br>&ensp;&ensp;&ensp;&ensp;iptables [-t table] -R chain rulenum rule-specification<br>&ensp;&ensp;&ensp;&ensp;iptables [-t table] -D chain rulenum<br>&ensp;&ensp;&ensp;&ensp;iptables [-t table] -S [chain [rulenum]]<br>&ensp;&ensp;&ensp;&ensp;iptables [-t table] {-F|-L|-Z} [chain [rulenum]] [options…]<br>&ensp;&ensp;&ensp;&ensp;iptables [-t table] -N chain<br>&ensp;&ensp;&ensp;&ensp;iptables [-t table] -P chain target<br>&ensp;&ensp;&ensp;&ensp;iptables [-t table] -E old-chain-name new-chain-name<br>&ensp;&ensp;&ensp;&ensp;rule-specification = [matches…] [target]<br>&ensp;&ensp;&ensp;&ensp;match = -m matchname [per-match-options] 扩展条件<br>&ensp;&ensp;&ensp;&ensp;target = -j targetname [per-target-options] 处理动作<br>★ 规则管理格式：<br>&ensp;&ensp;&ensp;&ensp;iptables [-t table] COMMAND chain cretieria [-m -m matchname [per-match-options]]  [-j targetname [per-target-options]]<br>⊙-t table：<br>&ensp;&ensp;&ensp;&ensp;指明要管理的表； 默认为filter；<br>⊙COMMANDS：<br>◆链管理：<br>&ensp;&ensp;&ensp;&ensp;-P：iptables [-t table] -P chain target<br>&ensp;&ensp;&ensp;&ensp;              定义链的默认策略；其target一般可使用ACCEPT或DROP；<br>&ensp;&ensp;&ensp;&ensp;-N：iptables [-t table] -N chain<br>&ensp;&ensp;&ensp;&ensp;              自定义规则链；仅在默认链通过某规则进行调用方可生效；因此，每个自定义链都有其引用记数；<br>&ensp;&ensp;&ensp;&ensp;-X：iptables [-t table] -X [chain]<br>&ensp;&ensp;&ensp;&ensp;              删除自定义的空的引用计数为0的链；<br>&ensp;&ensp;&ensp;&ensp;-F：iptables [-t table] -F [chain [rulenum]] [options…]，<br>&ensp;&ensp;&ensp;&ensp;              清空指定的链，或删除指定链上的规则 ；<br>&ensp;&ensp;&ensp;&ensp;-E：iptables [-t table] -E old-chain-name new-chain-name，<br>&ensp;&ensp;&ensp;&ensp;              重命名自定义的引用计数为0的链；<br>&ensp;&ensp;&ensp;&ensp;-Z：iptables [-t table] -Z  [chain [rulenum]] [options…]<br>&ensp;&ensp;&ensp;&ensp;              规则置零，置零计数器<br>◆规则：<br>&ensp;&ensp;&ensp;&ensp;-A：append, iptables [-t table] -A chain rule-specification，<br>&ensp;&ensp;&ensp;&ensp;              追加规则到指定的链尾部；<br>&ensp;&ensp;&ensp;&ensp;-I：insert, iptables [-t table] -I chain [rulenum] rule-specification，<br>&ensp;&ensp;&ensp;&ensp;       插入规则到指定的链中的指定位置，默认为链首；<br>&ensp;&ensp;&ensp;&ensp;-D：delete，iptables [-t table] -D chain rule-specification或iptables [-t table] -D chain rulenum，<br>&ensp;&ensp;&ensp;&ensp;              删除指定的链上的指定规则；<br>&ensp;&ensp;&ensp;&ensp;-R：replace，iptables [-t table] -R chain rulenum rule-specification，<br>&ensp;&ensp;&ensp;&ensp;              将指定的链上的指定规则替换为新的规则；<br>◆查看：<br>&ensp;&ensp;&ensp;&ensp;-L：list, iptables [-t table] -L [chain [rulenum]] [options…]<br>&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;-n：数字格式，不要做反解；<br>&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;-v：verbose，详细格式信息；<br>&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;-vv, -vvv<br>&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;- -line-numbers：显示链上的规则的编号；<br>&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;-x：exactly，显示计数器的精确值；<br>★计数器：<br>每条规则以及链的默认策略分别有各自的两个计数器：<br>&ensp;&ensp;&ensp;&ensp;匹配到的报文的个数：pkts<br>&ensp;&ensp;&ensp;&ensp;匹配到的所有报文的大小之和：bytes</p>
<h4 id="演示：链管理"><a href="#演示：链管理" class="headerlink" title="演示：链管理"></a>演示：链管理</h4><p>1.-L 查看iptables的表和链<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 查看表，默认指的是filter表，有三个链</span></div><div class="line">[root@centos7 ~]<span class="comment"># iptables -vnL</span></div><div class="line">Chain INPUT (policy ACCEPT 55 packets, 3796 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain OUTPUT (policy ACCEPT 35 packets, 4652 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination </div><div class="line"></div><div class="line"><span class="comment"># 查看nat表，有四个链</span></div><div class="line">[root@centos7 ~]<span class="comment"># iptables -t nat -vnL</span></div><div class="line">Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination</div></pre></td></tr></table></figure></p>
<p>2.-P 定义链的默认策略为DROP<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">[root@CentOS6 ~]<span class="comment"># ping 192.168.2.139             # 定义之前是能ping同</span></div><div class="line">PING 192.168.2.139 (192.168.2.139) 56(84) bytes of data.</div><div class="line">64 bytes from 192.168.2.139: icmp_seq=1 ttl=64 time=0.345 ms</div><div class="line">64 bytes from 192.168.2.139: icmp_seq=2 ttl=64 time=0.770 ms</div><div class="line">64 bytes from 192.168.2.139: icmp_seq=3 ttl=64 time=0.208 ms</div><div class="line"><span class="comment"># 定义默认策略为DROP</span></div><div class="line">[root@centos7 ~]<span class="comment"># iptables -t filter -P INPUT DROP </span></div><div class="line"> </div><div class="line">[root@centos7 ~]<span class="comment"># iptables -nL</span></div><div class="line">Chain INPUT (policy DROP) <span class="comment"># INPUT 链默认由 ACCEPT 链转为DROP</span></div><div class="line">target     prot opt <span class="built_in">source</span>               destination         </div><div class="line"> </div><div class="line">Chain FORWARD (policy ACCEPT)</div><div class="line">target     prot opt <span class="built_in">source</span>               destination         </div><div class="line"> </div><div class="line">Chain OUTPUT (policy ACCEPT)</div><div class="line">target     prot opt <span class="built_in">source</span>               destination         </div><div class="line"> </div><div class="line"><span class="comment"># 定义之后ping不通了，链ssh远程登录都掉了</span></div><div class="line">[root@CentOS6 ~]<span class="comment">#  ping 192.168.2.139</span></div><div class="line">PING 192.168.1.12 (192.168.1.12) 56(84) bytes of data.</div></pre></td></tr></table></figure></p>
<p>3.-N 自定义链<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># iptables -nvL</span></div><div class="line">Chain INPUT (policy ACCEPT 62 packets, 5612 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain OUTPUT (policy ACCEPT 46 packets, 6417 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination     </div><div class="line"></div><div class="line"> <span class="comment"># 定义一个in_web的链    </span></div><div class="line">[root@centos7 ~]<span class="comment"># iptables -N in_web</span></div><div class="line">[root@centos7 ~]<span class="comment"># iptables -nvL</span></div><div class="line">Chain INPUT (policy ACCEPT 29 packets, 1924 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain OUTPUT (policy ACCEPT 17 packets, 1492 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain in_web (0 references)         <span class="comment"># 自定义的链，0次引用</span></div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination</div></pre></td></tr></table></figure></p>
<p> 4.-X 删除自定义链<br> <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"> [root@centos7 ~]<span class="comment"># iptables -X</span></div><div class="line">[root@centos7 ~]<span class="comment"># iptables -nvL</span></div><div class="line">Chain INPUT (policy ACCEPT 8 packets, 528 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain OUTPUT (policy ACCEPT 5 packets, 524 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination</div></pre></td></tr></table></figure></p>
<p>5.-E 重命名自定义的链<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># iptables -N in_web</span></div><div class="line">[root@centos7 ~]<span class="comment"># iptables -nvL</span></div><div class="line">Chain INPUT (policy ACCEPT 28 packets, 1848 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain OUTPUT (policy ACCEPT 15 packets, 1412 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain in_web (0 references)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line">[root@centos7 ~]<span class="comment"># iptables -t filter -E in_web web_input_packet        # 重命名自定义链</span></div><div class="line">[root@centos7 ~]<span class="comment"># iptables -nvL</span></div><div class="line">Chain INPUT (policy ACCEPT 6 packets, 396 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain OUTPUT (policy ACCEPT 4 packets, 512 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain web_input_packet (0 references)          <span class="comment"># 重新定义完成</span></div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination</div></pre></td></tr></table></figure></p>
<p>6.-Z 置零计数器，即规则置零<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># iptables -nvL</span></div><div class="line">Chain INPUT (policy ACCEPT 64 packets, 4400 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain OUTPUT (policy ACCEPT 41 packets, 4516 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain web_input_packet (0 references)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line">[root@centos7 ~]<span class="comment"># iptables -Z INPUT              # 置零</span></div><div class="line">[root@centos7 ~]<span class="comment"># iptables -nvL</span></div><div class="line">Chain INPUT (policy ACCEPT 6 packets, 396 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain OUTPUT (policy ACCEPT 4 packets, 416 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain web_input_packet (0 references)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination</div></pre></td></tr></table></figure></p>
<h3 id="iptables的匹配条件"><a href="#iptables的匹配条件" class="headerlink" title="iptables的匹配条件"></a>iptables的匹配条件</h3><h4 id="匹配条件及规则"><a href="#匹配条件及规则" class="headerlink" title="匹配条件及规则"></a>匹配条件及规则</h4><p>★ 匹配条件：<br>⊙基本匹配条件：<br>&ensp;&ensp;&ensp;&ensp;主要是ip层（源地址，目标地址），传输层协议；<br>⊙扩展匹配条件：需要借助于扩展模块进行指定的匹配条件；<br>&ensp;&ensp;&ensp;&ensp;隐式扩展：已经在基本匹配条件中指明的协议相关的扩展；<br>&ensp;&ensp;&ensp;&ensp;显式扩展：隐式扩展之外的其它扩展匹配条件；<br>注意：<br>&ensp;&ensp;&ensp;&ensp;多重条件之间的隐含逻辑为“与”操作；<br>★ 匹配规则的原则：<br>&ensp;&ensp;&ensp;&ensp;如果被第一条规则所匹配到，就会做处理，处理完之后就到达不了第二条规则了；<br>&ensp;&ensp;&ensp;&ensp;不同类别服务的规则（比如控制web服务的，SSH服务的等），应该把访问比较频繁的服务所对应的规则放到前面，即：匹配机会更大的规则放到前面；<br>&ensp;&ensp;&ensp;&ensp;同一类别的规则，要把匹配条件苛刻的，范围较小的放到前面，而范围较大的放到后面。</p>
<h4 id="基本匹配条件"><a href="#基本匹配条件" class="headerlink" title="基本匹配条件"></a>基本匹配条件</h4><p>★ 参数：<br>⊙[!]-s, - -source address[/mask][,…]：<br>&ensp;&ensp;&ensp;&ensp;检查报文中的源IP地址是否符合此处指定的地址或地址范围；<br>⊙[!]-d, - -destination address[/mask][,…]：<br>&ensp;&ensp;&ensp;&ensp;检查报文中的目标IP地址是否符合此处指定的地址或地址范围；<br>⊙[!] -p, - -protocol protocol：<br>&ensp;&ensp;&ensp;&ensp;检查报文中传输层的协议类型，支持tcp, udp,  udplite, icmp,icmpv6,esp, ah, sctp, mh，或者 “all”表示所有协议；<br>⊙[!] -i, - -in-interface name：<br>&ensp;&ensp;&ensp;&ensp;检查报文进入本机时的接口是否符合本处指定的接口；只适应 INPUT, FORWARD  and  PREROUTING ；<br>⊙[!] -o, - -out-interface name：<br>&ensp;&ensp;&ensp;&ensp;检查报文即将离开本机时经由的接口是否符合本处指定的接口；FORWARD, OUTPUT and POSTROUTING；<br>注意：这里的[!]为取反<br>⊙-m, - -match match：显式指明要使用的扩展模块；<br>⊙-j, - -jump target：跳转目标；<br>注意：<br>&ensp;&ensp;&ensp;&ensp;对于本地主机上的大多数的访问控制，如果只是本地作为服务器，那我们只需把INPUT链改为DROP，只放行合法的请求进来就可以；<br>&ensp;&ensp;&ensp;&ensp;而对于控制本机请求别人的服务时，我们应该把OUTPUT链设为DROP，只放行认为合法的请求出去就可以；<br>&ensp;&ensp;&ensp;&ensp;为了安全起见，建议INPUT和OUTUT链的默认策略应该均为DROP。</p>
<h4 id="演示："><a href="#演示：" class="headerlink" title="演示："></a>演示：</h4><p>添加一条规则，仅使192.168.2.0/24网络中的主机可以访问本机服务，使用-A和-s即可，如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">因为是控制访问服务，所以，请求报文会首先经过INPUT链，所以，要把INPUT链的默认策略设置为DROP，然后只针对符合源地址要求的报文放行；</div><div class="line">[root@centos7 ~]<span class="comment"># iptables -t filter -P INPUT DROP </span></div><div class="line">[root@CentOS6 ~]<span class="comment"># ping 192.168.2.139</span></div><div class="line">PING 192.168.1.14 (192.168.2.129) 56(84) bytes of data. <span class="comment"># 发现ping不同</span></div><div class="line"> </div><div class="line">添加规则，凡是来自于192.168.1.2/24网络的地址，统统放行</div><div class="line">[root@centos7 ~]<span class="comment"># iptables -t filter -A INPUT -s 192.168.1.0/24 -j ACCEPT</span></div><div class="line"> </div><div class="line">[root@CentOS6 ~]<span class="comment"># ping 192.168.2.139 # 马上就可以ping 通了</span></div><div class="line">64 bytes from 192.168.2.139: icmp_seq=42 ttl=64 time=0.250 ms</div><div class="line">64 bytes from 192.168.2.139: icmp_seq=43 ttl=64 time=0.397 ms</div><div class="line">64 bytes from 192.168.2.139: icmp_seq=44 ttl=64 time=0.277 ms</div><div class="line">64 bytes from 192.168.2.139: icmp_seq=45 ttl=64 time=0.190 ms</div><div class="line"> </div><div class="line">[root@centos7 ~]<span class="comment"># iptables -vnL</span></div><div class="line">Chain INPUT (policy DROP 16 packets, 1098 bytes)</div><div class="line"><span class="comment"># 报文  大小  处理动作    协议   选项               源地址                目标地址</span></div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line">   74  7383 ACCEPT     all  --  *      *       192.168.2.0/24       0.0.0.0/0           </div><div class="line"> </div><div class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"> </div><div class="line">Chain OUTPUT (policy ACCEPT 83 packets, 9411 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination</div></pre></td></tr></table></figure></p>
<p>我想禁止192.168.2.0/24 网络中ip为192.168.2.129这台主机的访问，那就需要在上题定义的规则中添加规则了，使用 -I 选项 如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># iptables -I INPUT -s 192.168.2.129 -j REJECT</span></div><div class="line">[root@centos7 ~]<span class="comment"># iptables -nvL          # 可以看到先后次序，同一类规则，范围小的放到前面</span></div><div class="line">Chain INPUT (policy DROP 0 packets, 0 bytes)    </div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line">    0     0 REJECT     all  --  *      *       192.168.2.129        0.0.0.0/0            reject-with icmp-port-unreachable</div><div class="line">  223 16610 ACCEPT     all  --  *      *       192.168.2.0/24       0.0.0.0/0           </div><div class="line"></div><div class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain OUTPUT (policy ACCEPT 4 packets, 512 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination           </div><div class="line"></div><div class="line">每次ping,都给你驳回了,这是REJECT</div><div class="line">[root@CentOS6 ~]<span class="comment"># ping 192.168.2.139</span></div><div class="line">PING 192.168.2.139 (192.168.2.139) 56(84) bytes of data.</div><div class="line">From 192.168.2.139 icmp_seq=1 Destination Port Unreachable</div><div class="line">From 192.168.2.139 icmp_seq=2 Destination Port Unreachable</div><div class="line">From 192.168.2.139 icmp_seq=3 Destination Port Unreachable</div></pre></td></tr></table></figure></p>
<p>把规则上处理动作的REJECT换为DROP,使用-R 如下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># iptables -nvL --line-numbers</span></div><div class="line">Chain INPUT (policy DROP 0 packets, 0 bytes)</div><div class="line">num   pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line">1        3   252 REJECT     all  --  *      *       192.168.2.129        0.0.0.0/0            reject-with icmp-port-unreachable</div><div class="line">2      435 31382 ACCEPT     all  --  *      *       192.168.2.0/24       0.0.0.0/0           </div><div class="line"></div><div class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</div><div class="line">num   pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain OUTPUT (policy ACCEPT 126 packets, 12764 bytes)</div><div class="line">num   pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">[root@centos7 ~]<span class="comment"># iptables -R INPUT 1 -s 192.168.2.129 -j DROP</span></div><div class="line">[root@centos7 ~]<span class="comment"># iptables -nvL --line-numbers</span></div><div class="line">Chain INPUT (policy DROP 0 packets, 0 bytes)</div><div class="line">num   pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line">1        0     0 DROP       all  --  *      *       192.168.2.129        0.0.0.0/0 <span class="comment"># 新替换的规则      </span></div><div class="line">2      632 45028 ACCEPT     all  --  *      *       192.168.2.0/24       0.0.0.0/0           </div><div class="line"></div><div class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</div><div class="line">num   pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain OUTPUT (policy ACCEPT 6 packets, 728 bytes)</div><div class="line">num   pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line">这是发现卡在这了,ping不通</div><div class="line">[root@CentOS6 ~]<span class="comment"># ping 192.168.2.139</span></div><div class="line">PING 192.168.2.139 (192.168.2.139) 56(84) bytes of data.</div></pre></td></tr></table></figure></p>
<p>删除对ip为192.168.1.13主机的限制，使用-D选项<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">首先查看要删除规则的规则号</div><div class="line">[root@centos7 ~]<span class="comment"># iptables -nvL --line-numbers</span></div><div class="line">Chain INPUT (policy DROP 0 packets, 0 bytes)</div><div class="line">num   pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line">1     8318  699K DROP       all  --  *      *       192.168.2.129        0.0.0.0/0           </div><div class="line">2     1204 93808 ACCEPT     all  --  *      *       192.168.2.0/24       0.0.0.0/0           </div><div class="line"></div><div class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</div><div class="line">num   pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain OUTPUT (policy ACCEPT 236 packets, 18072 bytes)</div><div class="line">num   pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line">删除指定规则的规则号码即可        </div><div class="line">[root@centos7 ~]<span class="comment"># iptables -D INPUT 1</span></div><div class="line">注意：也可使用iptables -D INPUT 192.168.1.13 -j DROP 来指明确切的匹配条件，一定要写target</div><div class="line">[root@centos7 ~]<span class="comment"># iptables -nvL  # 查看规则已经被删除</span></div><div class="line">Chain INPUT (policy DROP 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"> 1257 97388 ACCEPT     all  --  *      *       192.168.2.0/24       0.0.0.0/0           </div><div class="line"></div><div class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain OUTPUT (policy ACCEPT 9 packets, 876 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination</div></pre></td></tr></table></figure></p>
<p>只允许指定网络192.168.1.0/24内的主机，对本机（目标地址为本机）上所有TCP协议的服务请求放行，添加一条规则，指明三重条件-s，-d，-p<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># iptables -A INPUT -s 192.168.2.0/24 -d 192.168.2.139 -p tcp -j ACCEPT</span></div><div class="line">[root@centos7 ~]<span class="comment"># iptables -nvL</span></div><div class="line">Chain INPUT (policy DROP 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line">   33  2224 ACCEPT     tcp  --  *      *       192.168.2.0/24       192.168.2.139       </div><div class="line"></div><div class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain OUTPUT (policy ACCEPT 4 packets, 264 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">访问web服务，可以</div><div class="line">[root@CentOS6 ~]<span class="comment"># curl 192.168.2.139</span></div><div class="line">192.168.2.139</div><div class="line">但是ping不通，因为只限制tcp协议可以访问</div><div class="line">[root@CentOS6 ~]<span class="comment"># ping 192.168.2.139</span></div><div class="line">PING 192.168.2.139 (192.168.2.139) 56(84) bytes of data.</div><div class="line">^C</div><div class="line">--- 192.168.2.139 ping statistics ---</div><div class="line">4 packets transmitted, 0 received, 100% packet loss, time 3875ms</div></pre></td></tr></table></figure></p>
<h3 id="扩展匹配条件"><a href="#扩展匹配条件" class="headerlink" title="扩展匹配条件"></a>扩展匹配条件</h3><h4 id="隐式扩展条件"><a href="#隐式扩展条件" class="headerlink" title="隐式扩展条件"></a>隐式扩展条件</h4><p>★ 定义：<br>&ensp;&ensp;&ensp;&ensp;不用 -m 选项明确给出要使用的扩展机制的扩展；此处主要指使用-p {tcp|udp|icmp}给定协议后可直接对给定的协议所进行的扩展；<br>★ -p tcp：可直接使用tcp协议对应的扩展选项；<br>&ensp;&ensp;&ensp;&ensp;⊙[!] - -source-port，- -sport port[:port]：<br>&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;匹配报文中的传输层的源端口；可给出多个连接的端口；<br>&ensp;&ensp;&ensp;&ensp;⊙[!] - -destination-port，- -dport port[:port]：<br>&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;匹配报文中的传输层的目标端口；可给出多个连接的端口；<br>&ensp;&ensp;&ensp;&ensp;⊙[!] - -tcp-flags mask comp 标志位的检查机制<br>&ensp;&ensp;&ensp;&ensp;◆标志位：SYN，ACK，FIN，RST，URG，PSH；<br>&ensp;&ensp;&ensp;&ensp;◆mask：要检查的标志位列表，以逗号分隔；例如SYN,ACK,FIN,RST<br>&ensp;&ensp;&ensp;&ensp;◆comp：mask给定的众标志位中，其值必须为1的标志位列表，余下的必须为0；<br>&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;例如： - -tcp-flags SYN,ACK,FIN,RST SYN &ensp;&ensp;&ensp;&ensp;表示，要求只匹配tcp协议给定的这些标志位（SY&ensp;&ensp;&ensp;&ensp;N,ACK,FIN,RST）中SYN为1，而其余都为0的，这也就是tcp的第一次握手阶段。<br>&ensp;&ensp;&ensp;&ensp;⊙[!] - -syn：相当于- -tcp-flags SYN,ACK,FIN,RST SYN  上面的简写格式<br>★ -p udp：可直接使用udp协议对应的扩展选项；<br>&ensp;&ensp;&ensp;&ensp;⊙[!] - -source-port,- -sport port[:port]：<br>&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;匹配报文中的传输层的源端口；可给出多个连接的端口；<br>&ensp;&ensp;&ensp;&ensp;⊙[!] - -destination-port,- -dport port[:port]：<br>&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;匹配报文中的传输层的目标端口；可给出多个连接的端口；<br>★ -p icmp（互联网控制报文协议）：可直接使用icmp协议对应的扩展选项；<br>&ensp;&ensp;&ensp;&ensp;⊙[!] - -icmp-type {type[/code]|typename}<br>&ensp;&ensp;&ensp;&ensp;例如：<br>&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;- -icmp-type  0/0：匹配对ping请求的响应报文<br>&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;- -icmp-type 8/0：匹配ping请求报文</p>
<h4 id="演示：-1"><a href="#演示：-1" class="headerlink" title="演示："></a>演示：</h4><h4 id="TCP协议扩展"><a href="#TCP协议扩展" class="headerlink" title="TCP协议扩展"></a>TCP协议扩展</h4><p>只开放本地的SSH服务的22号端口给本地网络(192.168.2.0/24)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">分析：请求报文入栈（INPUT）时源IP和port为192.168.2.0/24网络中的任意主机ip和端口，不确定，但是</div><div class="line">目标IP和port是确定的，都是本地服务器的ip和ssh服务tcp协议的22号端口，所以为如下规则：</div><div class="line"> </div><div class="line">[root@centos7 ~]<span class="comment"># iptables -A INPUT -s 192.168.2.0/24 -d 192.168.2.139 -p tcp --dport 22 -j ACCEPT</span></div><div class="line"> </div><div class="line">分析：请求报文出栈(OUTPUT)时源IP和port为本地服务器的ip（192.168.2.139）和ssh服务的22号端口，是确定，但是</div><div class="line">目标IP和port是192.168.2.0/24网络中的任意主机ip和端口，是不确定的，所以为如下规则：</div><div class="line"> </div><div class="line">[root@centos7 ~]<span class="comment"># iptables -A OUTPUT -d 192.168.2.0/24 -s 192.168.2.139 -p tcp --sport 22 -j ACCEPT</span></div><div class="line"> </div><div class="line">然后修改本地服务器的INPUT和OUTPUT的默认策略为DROP</div><div class="line">[root@centos7 ~]<span class="comment"># iptables -P INPUT DROP</span></div><div class="line">[root@centos7 ~]<span class="comment"># iptables -P OUTPUT DROP</span></div><div class="line">查看所有规则如下：</div><div class="line">[root@centos7 ~]<span class="comment"># iptables -nvL</span></div><div class="line">Chain INPUT (policy DROP 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line">   93  7341 ACCEPT     tcp  --  *      *       192.168.2.0/24       192.168.2.139     tcp dpt:22</div><div class="line"></div><div class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain OUTPUT (policy DROP 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line">   63  8719 ACCEPT     tcp  --  *      *       192.168.2.139        192.168.2.0/24    tcp spt:22</div></pre></td></tr></table></figure></p>
<h4 id="ICMP协议扩展"><a href="#ICMP协议扩展" class="headerlink" title="ICMP协议扩展"></a>ICMP协议扩展</h4><p>开放本机的ping请求，即允许其他人ping本机<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">要想能够被别人ping到，即ping请求入栈，源ip是不确定的，目标ip是本地服务器确定，协议为icmp，其类型为8</div><div class="line">[root@centos7 ~]<span class="comment"># iptables -A INPUT -s 192.168.2.0/24 -d 192.168.2.139 -p icmp --icmp-type 8 -j ACCEPT</span></div><div class="line">此时虽然，ping请求可以接受，但是只能入栈却不能出栈，通过抓包可以看出，有来自192.168.1.13的请求，但本机却未作出回应</div><div class="line">[root@centos7 ~]<span class="comment"># tcpdump -i eno16777736 -nn icmp</span></div><div class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</div><div class="line">listening on eno16777736, link-type EN10MB (Ethernet), capture size 65535 bytes</div><div class="line">17:46:00.836256 IP 192.168.2.129 &gt; 192.168.2.139: ICMP <span class="built_in">echo</span> request, id 54027, seq 1, length 64</div><div class="line">17:46:01.837188 IP 192.168.2.129 &gt; 192.168.2.139: ICMP <span class="built_in">echo</span> request, id 54027, seq 2, length 64</div><div class="line">17:46:02.837630 IP 192.168.2.129 &gt; 192.168.2.139: ICMP <span class="built_in">echo</span> request, id 54027, seq 3, length 64</div><div class="line">17:46:03.837336 IP 192.168.2.129 &gt; 192.168.2.139: ICMP <span class="built_in">echo</span> request, id 54027, seq 4, length 64</div><div class="line">17:46:04.837999 IP 192.168.2.129 &gt; 192.168.2.139: ICMP <span class="built_in">echo</span> request, id 54027, seq 5, length 64</div><div class="line">开放本机的ping响应报文</div><div class="line">[root@centos7 ~]<span class="comment"># iptables -A OUTPUT -d 192.168.2.0/24 -s 192.168.2.139 -p icmp --icmp-type 0 -j ACCEPT</span></div><div class="line">[root@CentOS6 ~]<span class="comment"># ping 192.168.2.139     # 客户端已经可以ping通</span></div><div class="line">PING 192.168.2.139 (192.168.2.139) 56(84) bytes of data.</div><div class="line">64 bytes from 192.168.2.139: icmp_seq=1 ttl=64 time=0.324 ms</div><div class="line">64 bytes from 192.168.2.139: icmp_seq=2 ttl=64 time=0.284 ms</div><div class="line">64 bytes from 192.168.2.139: icmp_seq=3 ttl=64 time=0.239 ms</div><div class="line">此时请求和回应都有了</div><div class="line">[root@centos7 ~]<span class="comment"># tcpdump -i eno16777736 -nn icmp</span></div><div class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</div><div class="line">listening on eno16777736, link-type EN10MB (Ethernet), capture size 65535 bytes</div><div class="line">17:49:36.501339 IP 192.168.2.129 &gt; 192.168.2.139: ICMP <span class="built_in">echo</span> request, id 61963, seq 1, length 64</div><div class="line">17:49:36.501395 IP 192.168.2.139 &gt; 192.168.2.129: ICMP <span class="built_in">echo</span> reply, id 61963, seq 1, length 64</div><div class="line">17:49:37.501887 IP 192.168.2.129 &gt; 192.168.2.139: ICMP <span class="built_in">echo</span> request, id 61963, seq 2, length 64</div><div class="line">17:49:37.501945 IP 192.168.2.139 &gt; 192.168.2.129: ICMP <span class="built_in">echo</span> reply, id 61963, seq 2, length 64</div><div class="line">17:49:38.502187 IP 192.168.2.129 &gt; 192.168.2.139: ICMP <span class="built_in">echo</span> request, id 61963, seq 3, length 64</div><div class="line">查看规则：</div><div class="line">[root@centos7 ~]<span class="comment"># iptables -nvL</span></div><div class="line">Chain INPUT (policy DROP 7 packets, 697 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>    out    <span class="built_in">source</span>            destination         </div><div class="line">  987 69948 ACCEPT     tcp  --  *     *      192.168.2.0/24    192.168.2.139    tcp dpt:22</div><div class="line">   18  1512 ACCEPT     icmp --  *     *      192.168.2.0/24    192.168.2.139    icmptype 8</div><div class="line"></div><div class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>    out    <span class="built_in">source</span>            destination         </div><div class="line"></div><div class="line">Chain OUTPUT (policy DROP 5 packets, 1640 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>    out    <span class="built_in">source</span>            destination         </div><div class="line">  470 47932 ACCEPT     tcp  --  *     *      192.168.2.139     192.168.2.0/24    tcp spt:22</div><div class="line">   10   840 ACCEPT     icmp --  *     *      192.168.2.139     192.168.2.0/24    icmptype 0</div></pre></td></tr></table></figure></p>
<p>如果想让本地主机可以ping互联网上的任意主机，规则如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">现在本地主机是ping不了其他主机的，因为本地主机发送不了ping的请求报文</div><div class="line">[root@centos7 ~]<span class="comment"># ping 192.168.2.129</span></div><div class="line">PING 192.168.2.129 (192.168.2.129) 56(84) bytes of data.</div><div class="line">ping: sendmsg: Operation not permitted</div><div class="line">ping: sendmsg: Operation not permitted</div><div class="line">ping: sendmsg: Operation not permitted</div><div class="line">要想能够ping其他主机要在OUTPUT上定义出栈的请求报文，如下：</div><div class="line">[root@centos7 ~]<span class="comment"># iptables -A OUTPUT -s 192.168.2.139 -d 192.168.2.0/24 -p icmp --icmp-type 8 -j ACCEPT</span></div><div class="line">本地主机ping ip为192.168.1.13 的其他主机</div><div class="line">[root@centos7 ~]<span class="comment"># ping 192.168.2.129</span></div><div class="line">PING 192.168.2.129 (192.168.2.129) 56(84) bytes of data.</div><div class="line">^C</div><div class="line">--- 192.168.2.129 ping statistics ---</div><div class="line">2 packets transmitted, 0 received, 100% packet loss, time 1000ms</div><div class="line">虽然本地主机的ping请求发送出去了，但是ping的其他主机的响应报文不能入栈，所以要定义其他主机</div><div class="line">的响应报文入栈，如下：</div><div class="line">[root@centos7 ~]<span class="comment"># iptables -A INPUT -d 192.168.2.139 -s 192.168.2.0/24 -p icmp --icmp-type 0 -j ACCEPT</span></div><div class="line">[root@centos7 ~]<span class="comment"># ping 192.168.2.129</span></div><div class="line">PING 192.168.2.129 (192.168.2.129) 56(84) bytes of data.</div><div class="line">64 bytes from 192.168.2.129: icmp_seq=1 ttl=64 time=0.261 ms</div><div class="line">64 bytes from 192.168.2.129: icmp_seq=2 ttl=64 time=0.222 ms</div><div class="line">64 bytes from 192.168.2.129: icmp_seq=3 ttl=64 time=0.186 ms</div><div class="line">查看规则</div><div class="line">[root@centos7 ~]<span class="comment"># iptables -nvL</span></div><div class="line">Chain INPUT (policy DROP 1 packets, 229 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>   out   <span class="built_in">source</span>            destination         </div><div class="line"> 1564  111K ACCEPT     tcp  --  *    *     192.168.2.0/24    192.168.2.139     tcp dpt:22</div><div class="line">   18  1512 ACCEPT     icmp --  *    *     192.168.2.0/24    192.168.2.139     icmptype 8</div><div class="line">   15  1260 ACCEPT     icmp --  *    *     192.168.2.0/24    192.168.2.139     icmptype 0</div><div class="line"></div><div class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>   out   <span class="built_in">source</span>             destination         </div><div class="line"></div><div class="line">Chain OUTPUT (policy DROP 10 packets, 3280 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>   out   <span class="built_in">source</span>             destination         </div><div class="line">  865 87324 ACCEPT     tcp  --  *    *     192.168.2.139      192.168.2.0/24    tcp spt:22</div><div class="line">   10   840 ACCEPT     icmp --  *    *     192.168.2.139      192.168.2.0/24    icmptype 0</div><div class="line">   64  5376 ACCEPT     icmp --  *    *     192.168.2.139      192.168.2.0/24    icmptype 8</div></pre></td></tr></table></figure></p>
<h4 id="显式扩展条件"><a href="#显式扩展条件" class="headerlink" title="显式扩展条件"></a>显式扩展条件</h4><p>★ 定义：<br>&ensp;&ensp;&ensp;&ensp;必须使用-m选项给出matchname的扩展，而且有些扩展都还存在专用选项；<br>★ multiport<br>&ensp;&ensp;&ensp;&ensp;以离散或连续的方式定义的多端口匹配条件； (最多不超过15个）.<br>⊙[!] - -source-ports,- -sports port[,port|,port:port]…：指定多个源端口；<br>⊙[!] - -destination-ports,- -dports port[,port|,port:port]…：指定多个目标端口；<br>⊙[!] - -ports port[,port|,port:port]…：匹配此处指定的源或目标端口；</p>
<h4 id="演示：-2"><a href="#演示：-2" class="headerlink" title="演示："></a>演示：</h4><p>使用一条规则开放本机的22,80和23号端口<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># iptables -F     # 首先清空所有的规则</span></div><div class="line">定义入栈的规则，这里不指明源ip和端口，默认为网络中所有的主机</div><div class="line">[root@centos7 ~]<span class="comment"># iptables -A INPUT -d 192.168.2.139 -p tcp -m multiport --dports 22,23,80 -j ACCEPT</span></div><div class="line">定义出栈规则，同样这里不指明目标ip和端口，默认为网络中所有的主机</div><div class="line">[root@centos7 ~]<span class="comment"># iptables -A OUTPUT -s 192.168.2.139 -p tcp -m multiport --sports 22,23,80 -j ACCEPT</span></div><div class="line">定义入栈，出栈的默认策略为DROP</div><div class="line">[root@centos7 ~]<span class="comment"># iptables -P INPUT DROP</span></div><div class="line">[root@centos7 ~]<span class="comment"># iptables -P OUTPUT DROP</span></div><div class="line">查看规则如下：</div><div class="line">[root@centos7 ~]<span class="comment"># iptables -nvL</span></div><div class="line">Chain INPUT (policy DROP 1 packets, 78 bytes)</div><div class="line"> pkts bytes target   prot opt <span class="keyword">in</span>  out  <span class="built_in">source</span>        destination         </div><div class="line">  277 21152 ACCEPT   tcp  --  *   *    0.0.0.0/0     192.168.2.139  multiport dports 22,23,80</div><div class="line"></div><div class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target   prot opt <span class="keyword">in</span>  out  <span class="built_in">source</span>        destination         </div><div class="line"></div><div class="line">Chain OUTPUT (policy DROP 0 packets, 0 bytes)</div><div class="line"> pkts bytes target   prot opt <span class="keyword">in</span>  out  <span class="built_in">source</span>        destination         </div><div class="line">   50  5024 ACCEPT   tcp  --  *   *    192.168.2.139 0.0.0.0/0      multiport sports 22,23,80</div><div class="line">测试如下：</div><div class="line">[root@CentOS6 ~]<span class="comment"># curl 192.168.2.139       # 测试httpd 的80端口成功</span></div><div class="line">192.168.2.139</div><div class="line">[root@CentOS6 ~]<span class="comment"># ssh 192.168.2.139        # ssh服务的22号端口正常</span></div><div class="line">The authenticity of host <span class="string">'192.168.2.139 (192.168.2.139)'</span> can<span class="string">'t be established.</span></div><div class="line">RSA key fingerprint is 2c:c7:3a:51:f6:2f:f4:57:c3:a2:14:ad:0f:34:e3:01.</div><div class="line">Are you sure you want to continue connecting (yes/no)? yes</div><div class="line">Warning: Permanently added '192.168.2.139<span class="string">' (RSA) to the list of known hosts.</span></div><div class="line">root@192.168.2.139's password: </div><div class="line">Last login: Sun Aug 27 18:20:35 2017 from 192.168.2.1</div><div class="line">[root@centos7 ~]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>★ iprange<br>以连续的ip地址范围指明多地址匹配条件；<br>&ensp;&ensp;&ensp;&ensp;[!] - -src-range from[-to] ：指明匹配多个源地址；<br>&ensp;&ensp;&ensp;&ensp;[!] - -dst-range from[-to] ：指明匹配多个目标地址；<br>★ string<br>对报文中的应用层数据做字符串匹配检测；<br>&ensp;&ensp;&ensp;&ensp;[!] - -string pattern：字符串匹配模式检测<br>&ensp;&ensp;&ensp;&ensp;[!] - -hex-string pattern：把字符串转换成16进制的字符格式，效率更高<br>&ensp;&ensp;&ensp;&ensp;- -algo {bm|kmp}：字符串匹配检查算法；<br>&ensp;&ensp;&ensp;&ensp;- -from offset： 从最开始出偏移多少个字节开始检查；<br>&ensp;&ensp;&ensp;&ensp;- -to offset  ：设置我们要检查匹配到何处结束；<br>注意：<br>&ensp;&ensp;&ensp;&ensp;前二者选其一，是必须要给定的，算法也是必须要给定的；<br>&ensp;&ensp;&ensp;&ensp;–from和–to 如果二者不给定的话，就是检查整个报文</p>
<h4 id="演示：-3"><a href="#演示：-3" class="headerlink" title="演示："></a>演示：</h4><p>对互联网中的敏感词汇sex做规则匹配<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">没有设定规则前，含敏感词汇的和不含的文件，都可以正常访问，如下：</div><div class="line"><span class="comment">#不含敏感词汇</span></div><div class="line">[root@CentOS6 ~]<span class="comment"># curl 192.168.2.139/index.html</span></div><div class="line">&lt;html&gt;</div><div class="line">      &lt;head&gt;</div><div class="line">           &lt;title&gt;Test Page&lt;/title&gt;</div><div class="line">      &lt;/head&gt;</div><div class="line">      &lt;body&gt;</div><div class="line">           &lt;h1&gt;My Test Page&lt;/h1&gt;</div><div class="line">      &lt;/body&gt;</div><div class="line">&lt;/html&gt;</div><div class="line"><span class="comment"># 含敏感词汇sex</span></div><div class="line">[root@CentOS6 ~]<span class="comment"># curl 192.168.2.139/test.html</span></div><div class="line">&lt;html&gt;</div><div class="line">      &lt;head&gt;</div><div class="line">           &lt;title&gt;Test Page&lt;/title&gt;</div><div class="line">      &lt;/head&gt;</div><div class="line">      &lt;body&gt;</div><div class="line">           &lt;h1&gt;My Sex Test Page&lt;/h1&gt;</div><div class="line">      &lt;/body&gt;</div><div class="line">&lt;/html&gt;</div><div class="line">分析：本题是在web服务上做了更加严格的规则，同类规则中匹配严格的要放到前面，优先检查；</div><div class="line">因为响应报文中包含敏感词汇，所以，我们要在出栈上做定义，源ip为本主机，这里只限定web服务</div><div class="line">所以源端口为80，如果所有的服务都限定，不用指明端口即可，然后匹配sex，匹配到后执行REJECT</div><div class="line">[root@centos7 ~]<span class="comment"># iptables -I OUTPUT -s 192.168.2.139 -p tcp --sport 80 -m string --string "sex" --algo bm -j REJECT</span></div><div class="line">[root@centos7 ~]<span class="comment"># iptables -nvL</span></div><div class="line">Chain INPUT (policy DROP 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"> 1189 87006 ACCEPT     tcp  --  *      *       0.0.0.0/0            192.168.2.139        multiport dports 22,23,80</div><div class="line"></div><div class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain OUTPUT (policy DROP 1 packets, 328 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line">    0     0 REJECT     tcp  --  *      *       192.168.2.139        0.0.0.0/0            tcp spt:80 STRING match  <span class="string">"sex"</span> ALGO name bm TO 65535 reject-with icmp-port-unreachable</div><div class="line">  609 69485 ACCEPT     tcp  --  *      *       192.168.2.139        0.0.0.0/0            multiport sports 22,23,80</div><div class="line">设定规则后，再次访问，可以发现，不含敏感词汇的可以正常访问，含有敏感词汇sex的，不能正常访问</div><div class="line">[root@CentOS6 ~]<span class="comment"># curl 192.168.2.139/index.html</span></div><div class="line">&lt;html&gt;</div><div class="line">      &lt;head&gt;</div><div class="line">           &lt;title&gt;Test Page&lt;/title&gt;</div><div class="line">      &lt;/head&gt;</div><div class="line">      &lt;body&gt;</div><div class="line">           &lt;h1&gt;My Test Page&lt;/h1&gt;</div><div class="line">      &lt;/body&gt;</div><div class="line">&lt;/html&gt;</div><div class="line">[root@CentOS6 ~]<span class="comment"># curl 192.168.2.139/test.html     # 卡着不动了，说明访问不了</span></div><div class="line">^C</div></pre></td></tr></table></figure></p>
<p>★ time<br>  根据报文到达的时间与指定的时间范围进行匹配度检测；<br>&ensp;&ensp;&ensp;&ensp;- -datestart YYYY[-MM[-DD[Thh[:mm[:ss]]]]]：哪一年什么具体时间开始到;<br>&ensp;&ensp;&ensp;&ensp;- -datestop YYYY[-MM[-DD[Thh[:mm[:ss]]]]]：哪一年的具体时间结束；<br>&ensp;&ensp;&ensp;&ensp;- -timestart hh:mm[:ss]：没有日期只有时间，表示每天的什么时间开始；<br>&ensp;&ensp;&ensp;&ensp;- -timestop hh:mm[:ss] ：什么时间结束<br>&ensp;&ensp;&ensp;&ensp;[!] –monthdays day[,day…]：限定每月的哪几天有效；<br>&ensp;&ensp;&ensp;&ensp;[!] –weekdays day[,day…]：限定每周的周几有效；<br>注意：<br>&ensp;&ensp;&ensp;&ensp;设置访问时间规则时，一定要校正系统时间</p>
<h4 id="演示：-4"><a href="#演示：-4" class="headerlink" title="演示："></a>演示：</h4><p>为了演示效果，这里禁止web服务在每周日访问，定义规则如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">规则设定之前可以正常访问web服务</div><div class="line">[root@CentOS6 ~]<span class="comment"># curl 192.168.2.139/index.html</span></div><div class="line">&lt;html&gt;</div><div class="line">      &lt;head&gt;</div><div class="line">           &lt;title&gt;Test Page&lt;/title&gt;</div><div class="line">      &lt;/head&gt;</div><div class="line">      &lt;body&gt;</div><div class="line">           &lt;h1&gt;My Test Page&lt;/h1&gt;</div><div class="line">      &lt;/body&gt;</div><div class="line">&lt;/html&gt;</div><div class="line">[root@centos7 ~]<span class="comment"># date            # 当前时间</span></div><div class="line">Sun Aug 27 19:00:50 CST 2017</div><div class="line">设定规则，如下：</div><div class="line">[root@centos7 ~]<span class="comment"># iptables -I INPUT -d 192.168.2.139 -p tcp --dport 80 -m time --weekdays 7 -j REJECT</span></div><div class="line">查看规则</div><div class="line">[root@centos7 ~]<span class="comment"># iptables -nvL</span></div><div class="line">Chain INPUT (policy DROP 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line">    0     0 REJECT     tcp  --  *      *       0.0.0.0/0            192.168.2.139        tcp dpt:80 TIME on Sun UTC reject-with icmp-port-unreachable</div><div class="line"> 1635  118K ACCEPT     tcp  --  *      *       0.0.0.0/0            192.168.2.139        multiport dports 22,23,80</div><div class="line"></div><div class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain OUTPUT (policy DROP 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line">   53 23204 REJECT     tcp  --  *      *       192.168.2.139        0.0.0.0/0            tcp spt:80 STRING match  <span class="string">"sex"</span> ALGO name bm TO 65535 reject-with icmp-port-unreachable</div><div class="line">  871 97781 ACCEPT     tcp  --  *      *       192.168.2.139        0.0.0.0/0            multiport sports 22,23,80</div><div class="line"> 客户端测试</div><div class="line"> [root@CentOS6 ~]<span class="comment"># curl 192.168.2.139/index.html      # 卡在这里不动了，规则设定之前是可以访问的</span></div><div class="line">^C</div></pre></td></tr></table></figure></p>
<p>★ connlimit<br>根据每客户端IP做并发连接数限制，即限制单IP可同时发起的连接请求数；<br>&ensp;&ensp;&ensp;&ensp;- -connlimit-upto n：连接数小于等于阈值（上限）；<br>&ensp;&ensp;&ensp;&ensp;- -connlimit-above n：连接数超出阈值；</p>
<h4 id="演示：-5"><a href="#演示：-5" class="headerlink" title="演示："></a>演示：</h4><p>对于ssh服务，每客户端发起的单ip不能超过2个，规则如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># iptables -I INPUT -d 192.168.2.139 -p tcp --dport 22 -m connlimit --connlimit-above 2 -j REJECT</span></div><div class="line">[root@centos7 ~]<span class="comment"># iptables -nvL</span></div><div class="line">Chain INPUT (policy DROP 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line">    0     0 REJECT     tcp  --  *      *       0.0.0.0/0            192.168.2.139        tcp dpt:22 <span class="comment">#conn src/32 &gt; 2 reject-with icmp-port-unreachable</span></div><div class="line">    2   120 REJECT     tcp  --  *      *       0.0.0.0/0            192.168.2.139        tcp dpt:80 TIME on Sun UTC reject-with icmp-port-unreachable</div><div class="line"> 1861  133K ACCEPT     tcp  --  *      *       0.0.0.0/0            192.168.2.139        multiport dports 22,23,80</div><div class="line"></div><div class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain OUTPUT (policy DROP 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line">   53 23204 REJECT     tcp  --  *      *       192.168.2.139        0.0.0.0/0            tcp spt:80 STRING match  <span class="string">"sex"</span> ALGO name bm TO 65535 reject-with icmp-port-unreachable</div><div class="line">  991  110K ACCEPT     tcp  --  *      *       192.168.2.139        0.0.0.0/0            multiport sports 22,23,80</div><div class="line">客户端测试</div><div class="line">[root@centos7 ~]<span class="comment"># who         # 从服务器端看192.168.2.129已经连接两ssh</span></div><div class="line">root     tty1         2017-08-27 13:28</div><div class="line">root     pts/0        2017-08-27 17:22 (192.168.2.1)</div><div class="line">root     pts/1        2017-08-27 18:20 (192.168.2.1)</div><div class="line">root     pts/2        2017-08-27 19:10 (192.168.2.129)</div><div class="line">root     pts/3        2017-08-27 19:11 (192.168.2.129)</div><div class="line">[root@CentOS6 ~]<span class="comment"># ssh 192.168.2.139    #当192.168.2.129发起第三个连接时超时</span></div><div class="line">ssh: connect to host 192.168.2.139 port 22: Connection timed out</div></pre></td></tr></table></figure></p>
<p>★ limit<br>基于收发报文的速率进行匹配；<br>&ensp;&ensp;&ensp;&ensp;- -limit rate[/second|/minute|/hour|/day]：每秒/分/小时/天 限制多少个<br>&ensp;&ensp;&ensp;&ensp;- -limit-burst number：指定令牌桶，默认为5个</p>
<h4 id="演示"><a href="#演示" class="headerlink" title="演示"></a>演示</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">定义规则，指定令牌通为3个，每分钟20个ping报文到达</div><div class="line">[root@centos7 ~]<span class="comment"># iptables -A INPUT -d 192.168.2.139 -p icmp --icmp-type 8 -m limit --limit-burst 3 --limit 20/minute -j ACCEPT</span></div><div class="line">[root@centos7 ~]<span class="comment"># iptables -A OUTPUT -s 192.168.2.139 -p icmp --icmp-type 0 -j ACCEPT</span></div><div class="line">[root@centos7 ~]<span class="comment"># iptables -nvL</span></div><div class="line">Chain INPUT (policy DROP 34 packets, 2516 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line">    0     0 ACCEPT     icmp --  *      *       0.0.0.0/0            192.168.2.139        icmptype 8 <span class="built_in">limit</span>: avg 20/min burst 3</div><div class="line"></div><div class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain OUTPUT (policy DROP 20 packets, 2004 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line">    0     0 ACCEPT     icmp --  *      *       192.168.2.139        0.0.0.0/0            icmptype 0</div><div class="line">客户端测试：前三个一次放行，后面的都是3秒钟一个</div><div class="line">[root@CentOS6 ~]<span class="comment"># ping 192.168.2.139</span></div><div class="line">PING 192.168.2.139 (192.168.2.139) 56(84) bytes of data.</div><div class="line">64 bytes from 192.168.2.139: icmp_seq=1 ttl=64 time=0.597 ms</div><div class="line">64 bytes from 192.168.2.139: icmp_seq=2 ttl=64 time=0.247 ms</div><div class="line">64 bytes from 192.168.2.139: icmp_seq=3 ttl=64 time=1.18 ms</div><div class="line">64 bytes from 192.168.2.139: icmp_seq=4 ttl=64 time=0.714 ms</div><div class="line">64 bytes from 192.168.2.139: icmp_seq=7 ttl=64 time=0.258 ms</div><div class="line">64 bytes from 192.168.2.139: icmp_seq=10 ttl=64 time=0.235 ms</div></pre></td></tr></table></figure>
<p>★ state （重要）<br>状态检测：连接追踪机制（conntrack）<br>☉连接状态<br>&ensp;&ensp;&ensp;&ensp;NEW：新连接<br>&ensp;&ensp;&ensp;&ensp;ESTABLISHED：已建立的连接<br>&ensp;&ensp;&ensp;&ensp;RELATED：相关联的连接<br>&ensp;&ensp;&ensp;&ensp;INVALID：无法识别的连接<br>&ensp;&ensp;&ensp;&ensp;UNTRACKED：未被追踪连接；<br>&ensp;&ensp;&ensp;&ensp;☉相关的内核模块：<br>&ensp;&ensp;&ensp;&ensp;nf_conntrack<br>&ensp;&ensp;&ensp;&ensp;nf_conntrack_ipv4<br>&ensp;&ensp;&ensp;&ensp;nf_conntrack_ftp<br>☉定义的文件<br>&ensp;&ensp;&ensp;&ensp;追踪到的连接定义在：/proc/net/nf_conntrack 文件中；<br>&ensp;&ensp;&ensp;&ensp;能追踪的最大连接数量定义在：/proc/sys/net/nf_conntrack_max，建议调整至足够大；<br>&ensp;&ensp;&ensp;&ensp;不同协议的连接追踪时长定义在：/proc/sys/net/netfilter/<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># modprobe nf_conntrack</span></div><div class="line">[root@centos7 ~]<span class="comment"># lsmod |grep nf_</span></div><div class="line">nf_conntrack          105745  0 </div><div class="line">[root@centos7 ~]<span class="comment"># cat /proc/net/nf_conntrack</span></div><div class="line"><span class="comment"># 能追踪的最大连接数量，达到之后再有请求就会拒绝</span></div><div class="line">[root@centos7 ~]<span class="comment"># cat /proc/sys/net/nf_conntrack_max </span></div><div class="line">31288</div></pre></td></tr></table></figure></p>
<p>☉选项：<br>&ensp;&ensp;&ensp;&ensp;[!] - -state state  定义什么状态<br>注意：<br>&ensp;&ensp;&ensp;&ensp;如果主机为一个负载均衡器（前端调度器），状态连接追踪机制最好不要开启，因为其已经承载了非常大的并发连接数量，如果开启可能会拒绝很多请求服务，这对于一个线上服务器来说几乎是致命的！至于其他主机（单台服务器）是可以开启的；</p>
<h4 id="演示：-6"><a href="#演示：-6" class="headerlink" title="演示："></a>演示：</h4><p>使用状态连接追踪机制<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">添加规则如下：只允许其他主机新链接和已建立的连接，访问本地主机的22,23和80端口</div><div class="line">[root@centos7 ~]<span class="comment"># iptables -A INPUT -d 192.168.2.139 -p tcp -m multiport --dports 22,23,80 -m state --state NEW,ESTABLISHED -j ACCEPT</span></div><div class="line">新定义新出栈规则，只放行已建立的连接</div><div class="line">[root@centos7 ~]<span class="comment"># iptables -A OUTPUT -m state --state ESTABLISHED -j ACCEPT</span></div><div class="line">现在的规则如下：</div><div class="line">[root@centos7 ~]<span class="comment"># iptables -nvL --line-numbers</span></div><div class="line">Chain INPUT (policy DROP 0 packets, 0 bytes)</div><div class="line">num   pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line">1      898 61656 ACCEPT     tcp  --  *      *       0.0.0.0/0            192.168.2.139        multiport dports 22,23,80 state NEW,ESTABLISHED</div><div class="line"></div><div class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</div><div class="line">num   pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain OUTPUT (policy DROP 0 packets, 0 bytes)</div><div class="line">num   pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line">1      361 35252 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            state ESTABLISHED</div><div class="line"></div><div class="line">测试访问，没有问题，因为我们定义了只放行从22,23,80端口出去的已建立的连接</div><div class="line">[root@CentOS6 ~]<span class="comment"># curl 192.168.2.139/index.html</span></div><div class="line">&lt;html&gt;</div><div class="line">      &lt;head&gt;</div><div class="line">           &lt;title&gt;Test Page&lt;/title&gt;</div><div class="line">      &lt;/head&gt;</div><div class="line">      &lt;body&gt;</div><div class="line">           &lt;h1&gt;My Test Page&lt;/h1&gt;</div><div class="line">      &lt;/body&gt;</div><div class="line">&lt;/html&gt;</div><div class="line">[root@CentOS6 ~]<span class="comment"># curl 192.168.2.139/test.html</span></div><div class="line">&lt;html&gt;</div><div class="line">      &lt;head&gt;</div><div class="line">           &lt;title&gt;Test Page&lt;/title&gt;</div><div class="line">      &lt;/head&gt;</div><div class="line">      &lt;body&gt;</div><div class="line">           &lt;h1&gt;My sex Test Page&lt;/h1&gt;</div><div class="line">      &lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p>
<p>现在如果允许任何主机都可以ping本机<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># iptables -A INPUT -d 192.168.2.139 -p icmp --icmp-type 8 -m state --state NEW,ESTABLISHED -j ACCEPT</span></div><div class="line">测试能否ping通</div><div class="line">[root@CentOS6 ~]<span class="comment"># ping 192.168.2.139</span></div><div class="line">PING 192.168.2.139 (192.168.2.139) 56(84) bytes of data.</div><div class="line">64 bytes from 192.168.2.139: icmp_seq=1 ttl=64 time=0.267 ms</div><div class="line">64 bytes from 192.168.2.139: icmp_seq=2 ttl=64 time=0.265 ms</div><div class="line">64 bytes from 192.168.2.139: icmp_seq=3 ttl=64 time=0.792 ms</div><div class="line"><span class="comment"># 发现是可以ping通的，因为我们出栈定义的是放行任何已建立的所有协议的连接，即，不管其他，只要状态为ESTABLISHED的统统放行；</span></div><div class="line">[root@centos7 ~]<span class="comment"># iptables -nvL</span></div><div class="line">Chain INPUT (policy DROP 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"> 1587  111K ACCEPT     tcp  --  *      *       0.0.0.0/0            192.168.2.139        multiport dports 22,23,80 state NEW,ESTABLISHED</div><div class="line">    3   252 ACCEPT     icmp --  *      *       0.0.0.0/0            192.168.2.139        icmptype 8 state NEW,ESTABLISHED</div><div class="line"></div><div class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain OUTPUT (policy DROP 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line">  818 72847 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            state ESTABLISHED</div></pre></td></tr></table></figure></p>
<p>如何开放本机的ftp服务呢<br>分析：要想开放本机的ftp服务，就要开放本机的21号端口，和所有的随机端口；但是我们考虑做连接<br>追踪的话，要开放21号端口，状态为NEW和RELATED(相关联的连接)，出栈为RELATED就可以出去，但是入栈<br>的随机端口要放行状态为ESTABLISHED和RELATED；既然所有的连接第一次都为NEW，后面的都是RELATED<br>那么我们把所有服务的RELATED放在一起，定义一条规则即可。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">定义入栈规则，所有相关联的和第二次访问的报文统统放行</div><div class="line">[root@centos7 ~]<span class="comment"># iptables -I INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT</span></div><div class="line">[root@centos7 ~]<span class="comment"># iptables -nvL --line-numbers;</span></div><div class="line">Chain INPUT (policy DROP 0 packets, 0 bytes)</div><div class="line">num   pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line">1        9   604 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            state RELATED,ESTABLISHED</div><div class="line">2     1862  129K ACCEPT     tcp  --  *      *       0.0.0.0/0            192.168.2.139        multiport dports 22,23,80 state NEW,ESTABLISHED</div><div class="line">3        3   252 ACCEPT     icmp --  *      *       0.0.0.0/0            192.168.2.139        icmptype 8 state NEW,ESTABLISHED</div><div class="line"></div><div class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</div><div class="line">num   pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain OUTPUT (policy DROP 1 packets, 328 bytes)</div><div class="line">num   pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line">1      974 89355 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            state ESTABLISHED</div><div class="line">修改第2条规则，因为入栈的第一条规则已经定义状态为ESTABLISHED的放行，所以此处只需定义第一次访问</div><div class="line">21,22,23,80端口的服务，即NEW状态的放行即可</div><div class="line">[root@centos7 ~]<span class="comment"># iptables -R INPUT 2 -d 192.168.2.139 -p tcp -m multiport --dports 21,22,23,80 -m state --state NEW -j ACCEPT</span></div><div class="line">[root@centos7 ~]<span class="comment"># iptables -nvL --line-numbers;</span></div><div class="line">Chain INPUT (policy DROP 0 packets, 0 bytes)</div><div class="line">num   pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line">1      306 20236 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            state RELATED,ESTABLISHED</div><div class="line">2        0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            192.168.2.139        multiport dports 21,22,23,80 state NEW</div><div class="line">3        3   252 ACCEPT     icmp --  *      *       0.0.0.0/0            192.168.2.139        icmptype 8 state NEW,ESTABLISHED</div><div class="line"></div><div class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</div><div class="line">num   pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain OUTPUT (policy DROP 0 packets, 0 bytes)</div><div class="line">num   pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line">1     1132  106K ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            state ESTABLISHED</div><div class="line"></div><div class="line">启动本地vsftpd服务，测试，看能否连接</div><div class="line">[root@CentOS6 ~]<span class="comment"># lftp 192.168.2.139</span></div><div class="line">lftp 10.1.252.161:~&gt; ls              </div><div class="line">`ls<span class="string">' at 0 [Making data connection...]</span></div><div class="line"> </div><div class="line">这时我们发现仍然无法连接，这是因为追踪ftp的模块没有被指定</div><div class="line">[root@centos7 ~]# lsmod |grep ftp</div><div class="line"> </div><div class="line"># 启动追踪 ftp 的模块</div><div class="line">[root@centos7 ~]# modprobe nf_conntrack_ftp</div><div class="line">[root@centos7 ~]# lsmod |grep ftp</div><div class="line">nf_conntrack_ftp       18638  0 </div><div class="line">nf_conntrack          105107  4 xt_connlimit,xt_conntrack,nf_conntrack_ftp,nf_conntrack_ipv4</div><div class="line"> </div><div class="line">再次连接ftp服务，可以正常连接</div><div class="line">[root@CentOS6 ~]# lftp 192.168.2.139</div><div class="line">lftp 10.1.252.161:~&gt; ls</div><div class="line">drwxr-xr-x    2 0        0               6 Nov 20  2015 pub</div><div class="line">drwxrwxr-x    2 0        0              22 Oct 18 03:06 upload</div></pre></td></tr></table></figure></p>
<p><img src="\images\iptables\ftp.png" alt="iptables"></p>
<h3 id="处理动作（跳转目标）"><a href="#处理动作（跳转目标）" class="headerlink" title="处理动作（跳转目标）"></a>处理动作（跳转目标）</h3><p>★ 语法：<br>&ensp;&ensp;&ensp;&ensp;-j tagetname [per-target-options]<br>★ 简单target：<br>&ensp;&ensp;&ensp;&ensp;ACCEPT<br>&ensp;&ensp;&ensp;&ensp;DROP<br>★ 扩展target：<br>☉REJECT：</p>
<ul>
<li>-reject-with type<br>&ensp;&ensp;&ensp;&ensp;icmp-net-unreachable, icmp-host-unreachable, icmp-port-unreachable, icmp-proto-unreach‐able, icmp-net-prohibited, icmp-host-prohibited, or icmp-admin-prohibited，默认为icmp-port-unreachable；<br>☉LOG：记录日志<br>run  on  kernel  logging of matching packets.<br>&ensp;&ensp;&ensp;&ensp;- -log-level level<br>&ensp;&ensp;&ensp;&ensp;- -log-prefix prefix：日志信息的前导信息；<h4 id="演示-1"><a href="#演示-1" class="headerlink" title="演示"></a>演示</h4>添加对连接本机的ssh服务的日志记录<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 添加规则前查看规则记录</span></div><div class="line">[root@centos7 ~]<span class="comment"># iptables -nvL</span></div><div class="line">Chain INPUT (policy DROP 3 packets, 801 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line">  565 35412 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            state RELATED,ESTABLISHED</div><div class="line">    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            192.168.2.139        multiport dports 21,22,23,80 state NEW</div><div class="line">    3   252 ACCEPT     icmp --  *      *       0.0.0.0/0            192.168.2.139        icmptype 8 state NEW,ESTABLISHED</div><div class="line"></div><div class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain OUTPUT (policy DROP 160 packets, 11204 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"> 1385  784K ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            state ESTABLISHED</div><div class="line"></div><div class="line"><span class="comment"># 添加日志记录规则，这里在第2条规则前插入，因为只对新链接的ssh服务记录日志</span></div><div class="line">[root@centos7 ~]<span class="comment"># iptables -I INPUT 2 -d 192.168.2.139 -p tcp --dport 22 -j LOG --log-prefix "openssh from kernel:"</span></div><div class="line">[root@centos7 ~]<span class="comment"># iptables -nvL</span></div><div class="line">Chain INPUT (policy DROP 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line">  833 53124 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            state RELATED,ESTABLISHED</div><div class="line">    0     0 LOG        tcp  --  *      *       0.0.0.0/0            192.168.2.139        tcp dpt:22 LOG flags 0 level 4 prefix <span class="string">"openssh from kernel:"</span></div><div class="line">    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            192.168.2.139        multiport dports 21,22,23,80 state NEW</div><div class="line">    3   252 ACCEPT     icmp --  *      *       0.0.0.0/0            192.168.2.139        icmptype 8 state NEW,ESTABLISHED</div><div class="line"></div><div class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"></div><div class="line">Chain OUTPUT (policy DROP 1 packets, 328 bytes)</div><div class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </div><div class="line"> 1530  798K ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            state ESTABLISHED</div><div class="line"></div><div class="line"><span class="comment"># 查看日志文件</span></div><div class="line">Aug 28 15:43:30 centos7 kernel: openssh from kernel:IN=eno16777736 OUT= MAC=00:0c:29:7c:c9:87:00:0c:29:9e:cf:05:08:00 SRC=192.168.2.129 DST=192.168.2.139 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=41423 DF PROTO=TCP SPT=32978 DPT=22 WINDOW=14600 RES=0x00 SYN URGP=0</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="保存和载入规则"><a href="#保存和载入规则" class="headerlink" title="保存和载入规则"></a>保存和载入规则</h3><p>★ 保存：<br>&ensp;&ensp;&ensp;&ensp;iptables-save &gt; /PATH/TO/SOME_RULE_FILE<br>★ 重载：<br>&ensp;&ensp;&ensp;&ensp;iptables-restore &lt; /PATH/FROM/SOME_RULE_FILE<br>☉选项：<br>&ensp;&ensp;&ensp;&ensp;-n, - -noflush：不清除原有规则<br>&ensp;&ensp;&ensp;&ensp;-t, - -test：仅分析生成规则集，但不予提交；</p>
<h4 id="演示-2"><a href="#演示-2" class="headerlink" title="演示"></a>演示</h4><p>iptables-save保存规则<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># iptables-save </span></div><div class="line"><span class="comment"># Generated by iptables-save v1.4.21 on Mon Aug 28 15:47:53 2017</span></div><div class="line">*filter</div><div class="line">:INPUT DROP [0:0]</div><div class="line">:FORWARD ACCEPT [0:0]</div><div class="line">:OUTPUT DROP [27:8344]</div><div class="line">-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT</div><div class="line">-A INPUT <span class="_">-d</span> 192.168.2.139/32 -p tcp -m tcp --dport 22 -j LOG --log-prefix <span class="string">"openssh from kernel:"</span></div><div class="line">-A INPUT <span class="_">-d</span> 192.168.2.139/32 -p tcp -m multiport --dports 21,22,23,80 -m state --state NEW -j ACCEPT</div><div class="line">-A INPUT <span class="_">-d</span> 192.168.2.139/32 -p icmp -m icmp --icmp-type 8 -m state --state NEW,ESTABLISHED -j ACCEPT</div><div class="line">-A OUTPUT -m state --state ESTABLISHED -j ACCEPT</div><div class="line">COMMIT</div><div class="line"><span class="comment"># Completed on Mon Aug 28 15:47:53 2017</span></div><div class="line"><span class="comment"># 保存至/etc/sysconfig/iptables</span></div><div class="line">[root@centos7 ~]<span class="comment"># iptables-save &gt; /etc/sysconfig/iptables</span></div><div class="line">[root@centos7 ~]<span class="comment"># cat /etc/sysconfig/iptables</span></div><div class="line"><span class="comment"># Generated by iptables-save v1.4.21 on Mon Aug 28 15:50:12 2017</span></div><div class="line">*filter</div><div class="line">:INPUT DROP [0:0]</div><div class="line">:FORWARD ACCEPT [0:0]</div><div class="line">:OUTPUT DROP [38:11952]</div><div class="line">-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT</div><div class="line">-A INPUT <span class="_">-d</span> 192.168.2.139/32 -p tcp -m tcp --dport 22 -j LOG --log-prefix <span class="string">"openssh from kernel:"</span></div><div class="line">-A INPUT <span class="_">-d</span> 192.168.2.139/32 -p tcp -m multiport --dports 21,22,23,80 -m state --state NEW -j ACCEPT</div><div class="line">-A INPUT <span class="_">-d</span> 192.168.2.139/32 -p icmp -m icmp --icmp-type 8 -m state --state NEW,ESTABLISHED -j ACCEPT</div><div class="line">-A OUTPUT -m state --state ESTABLISHED -j ACCEPT</div><div class="line">COMMIT</div><div class="line"><span class="comment"># Completed on Mon Aug 28 15:50:12 2017</span></div></pre></td></tr></table></figure></p>
<p>iptables-restore重载规则<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># iptables -F</span></div><div class="line">[root@centos7 ~]<span class="comment"># iptables-restore &lt; /etc/sysconfig/iptables</span></div></pre></td></tr></table></figure></p>
<h3 id="【CentOS-6】"><a href="#【CentOS-6】" class="headerlink" title="【CentOS 6】"></a>【CentOS 6】</h3><p>★ 保存规则：service iptables save<br>&ensp;&ensp;&ensp;&ensp;保存规则于 /etc/sysconfig/iptables，保存操作会清除文件中原有的内容；<br>★ 重载规则：server iptables restart<br>&ensp;&ensp;&ensp;&ensp;默认重载 /etc/sysconfig/iptables文件中的规则<br>★ 脚本配置文件：/etc/sysconfig/iptables-config<br>&ensp;&ensp;&ensp;&ensp;用于指明要装载的模块；</p>
<h4 id="演示-3"><a href="#演示-3" class="headerlink" title="演示"></a>演示</h4><p>[root@CentOS6 ~]# vim  /etc/sysconfig/iptables-config<br><img src="\images\iptables\iptables-config.png" alt="iptables"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 要首先创建一个/etc/sysconfig/iptables 空文件</span></div><div class="line">[root@CentOS6 ~]<span class="comment">#  touch /etc/sysconfig/iptables </span></div><div class="line"> </div><div class="line">[root@CentOS6 ~]<span class="comment"># service iptables save # 保存</span></div><div class="line">iptables: Nothing to save.                                 [WARNING]</div><div class="line"> </div><div class="line">[root@CentOS6 ~]<span class="comment"># service iptables restart #重载</span></div><div class="line">iptables: Applying firewall rules:                         [  OK  ]</div><div class="line">iptables: Loading additional modules: nf_conntrack_ftp     [  OK  ]</div><div class="line"> </div><div class="line">[root@CentOS6 ~]<span class="comment"># lsmod |grep ftp</span></div><div class="line">nf_conntrack_ftp       12049  0 </div><div class="line">nf_conntrack           79537  1 nf_conntrack_ftp</div></pre></td></tr></table></figure></p>
<p>★ CentOS 7开机自动生效规则：<br>&ensp;&ensp;&ensp;&ensp;firewalld服务；<br>&ensp;&ensp;&ensp;&ensp;shell脚本，直接记录iptables命令<br>&ensp;&ensp;&ensp;&ensp;自定义unit file或init script；</p>
<h3 id="规则优化思路"><a href="#规则优化思路" class="headerlink" title="规则优化思路"></a>规则优化思路</h3><p>★ 优化思路：<br>☉优先放行双方向状态为ESTABLISHED的报文；<br>☉服务于不同类别的功能的规则，匹配到报文可能性更大的放前面；<br>☉服务于同一类别的功能的规则，匹配条件较为严格的放前面；<br>☉设置默认策略：白名单机制<br>&ensp;&ensp;&ensp;&ensp;可使用iptables -P设定默认策略；<br>&ensp;&ensp;&ensp;&ensp;建议在规则链的最后定义规则做为默认策略；</p>
<h3 id="回顾"><a href="#回顾" class="headerlink" title="回顾"></a>回顾</h3><p><img src="\images\iptables\iptables-review.png" alt="iptables"></p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color4">iptables</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2017/08/22/linux服务之iptables/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>





  
    <article id="post-linux服务之nfs" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/20/linux服务之nfs/">linux文件共享服务之nfs</a>
    </h1>
  

        
        <a href="/2017/08/20/linux服务之nfs/" class="archive-article-date">
  	<time datetime="2017-08-20T05:50:22.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2017-08-20</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="NFS介绍"><a href="#NFS介绍" class="headerlink" title="NFS介绍"></a>NFS介绍</h3><p>★ nfs：Network File System<br>★ RPC：Remote Procedure Call 远程过程调用<br>★ NFS: 属于sun公司, 是一种协议；<br>★ 版本：<br>&ensp;&ensp;&ensp;&ensp;NFSv1，<br>&ensp;&ensp;&ensp;&ensp;NFSv2, NFSv3,<br>&ensp;&ensp;&ensp;&ensp;NIS：Network Information Service（网络信息服务）<br>★ nfsd：借助nfsd监听在 tcp的2049端口，2049/tcp<br>★ 辅助类的服务：rpc (portmap)<br>&ensp;&ensp;&ensp;&ensp;rpc.mountd：认证；<br>&ensp;&ensp;&ensp;&ensp;rpc.lockd：加锁<br>&ensp;&ensp;&ensp;&ensp;rpc.statd：状态</p>
<h3 id="NFS安装与配置管理"><a href="#NFS安装与配置管理" class="headerlink" title="NFS安装与配置管理"></a>NFS安装与配置管理</h3><p>★ nfs server：<br>安装：<br>&ensp;&ensp;&ensp;&ensp;确保内核空间有内核模块nfsd，一般都会提供；<br>&ensp;&ensp;&ensp;&ensp;只需安装用户空间的工具程序：nfs-utils（# yum install nfs-utils）<br>主程序文件：<br>&ensp;&ensp;&ensp;&ensp;Unit File：/usr/lib/systemd/system/nfs.service<br>主配置文件：<br>&ensp;&ensp;&ensp;&ensp;/etc/exports, /etc/exports.d/<em><br>★ 管理共享的nfs文件系统：<br>&ensp;&ensp;&ensp;&ensp;在/etc/exports文件，或者/etc/exports.d/</em>目录下任何文件中新创建一个导出文件即可；<br>&ensp;&ensp;&ensp;&ensp;配置文件每一行定义一个共享文件系统<br>定义格式：<br>/PATH/TO/SOME_DIR   CLIENTS_1(export_options,…)  CLIENTS_2(export_options,…)<br>CLIENTS：<br>&ensp;&ensp;&ensp;&ensp;single host: IPv4, IPv6, FQDN<br>&ensp;&ensp;&ensp;&ensp;IP networks：network/netmask，支持两种格式的掩码；<br>&ensp;&ensp;&ensp;&ensp;wildcards：在主机名字符串中使用通，<em>.magedu.com，<br>&ensp;&ensp;&ensp;&ensp;anonymous（匿名）：</em>，表示所有的客户端主机；<br>General Options<br>&ensp;&ensp;&ensp;&ensp;ro：只读；<br>&ensp;&ensp;&ensp;&ensp;rw：读写；<br>&ensp;&ensp;&ensp;&ensp;sync：同步<br>&ensp;&ensp;&ensp;&ensp;async：异步 大多数的写操作都是异步的<br>User ID Mapping：主要是做id映射的<br>&ensp;&ensp;&ensp;&ensp;root_squash：压缩root用户的权限，默认行为；nfsnobody<br>&ensp;&ensp;&ensp;&ensp;no_root_squash：不压缩root用户的权限；<br>&ensp;&ensp;&ensp;&ensp;all_squash：压缩所有用户的权限;<br>&ensp;&ensp;&ensp;&ensp;anonuid and anongid：将压缩的用户映射为此处指定的用户<br>★ NFS Client：<br>挂载格式：<br>mount -t nfs NFS_SERVER:/PATH/TO/EXPORTED_DIR  /MOUNT_POINT  [-rvVwfnsh] [-o OPTIONS]</p>
<h3 id="演示："><a href="#演示：" class="headerlink" title="演示："></a>演示：</h3><p>安装相关nfs-utils和rpcbind软件包<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># yum install nfs-utils rpcbind -y</span></div></pre></td></tr></table></figure></p>
<p>启动nfs服务,并查看端口2049<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># systemctl start nfs</span></div><div class="line">[root@centos7 ~]<span class="comment"># ss -tnl</span></div><div class="line">State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              </div><div class="line">LISTEN     0      128            *:111                        *:*                  </div><div class="line">LISTEN     0      128            *:20048                      *:*                  </div><div class="line">LISTEN     0      128            *:22                         *:*                  </div><div class="line">LISTEN     0      100    127.0.0.1:25                         *:*                  </div><div class="line">LISTEN     0      128            *:40891                      *:*                  </div><div class="line">LISTEN     0      64             *:54780                      *:*                  </div><div class="line">LISTEN     0      64             *:2049                       *:*                  </div><div class="line">LISTEN     0      128           :::111                       :::*                  </div><div class="line">LISTEN     0      128           :::20048                     :::*                  </div><div class="line">LISTEN     0      128           :::60469                     :::*                  </div><div class="line">LISTEN     0      64            :::50166                     :::*                  </div><div class="line">LISTEN     0      128           :::22                        :::*                  </div><div class="line">LISTEN     0      100          ::1:25                        :::*                  </div><div class="line">LISTEN     0      64            :::2049                      :::*</div></pre></td></tr></table></figure></p>
<p>首先创建一个要共享的目录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># mkdir /nfs/data -pv</span></div><div class="line">mkdir: created directory ?.nfs?</div><div class="line">mkdir: created directory ?.nfs/data?</div></pre></td></tr></table></figure></p>
<p>编辑主配置文件/etc/exports<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 定义导出/nfs/data文件至192.168.2.0/24这个网络，但仅192.168.2.149有rw权限，其余的都为只读（ro）权限</span></div><div class="line">[root@centos7 ~]<span class="comment"># vi /etc/exports</span></div><div class="line">/nfs/data       192.168.2.149(rw)       192.168.2.0/24(ro)</div><div class="line"><span class="comment"># 重启nfs服务</span></div><div class="line">[root@centos7 ~]<span class="comment"># systemctl restart nfs</span></div><div class="line">[root@centos7 ~]<span class="comment"># showmount -e localhost</span></div><div class="line">Export list <span class="keyword">for</span> localhost:</div><div class="line">/nfs/data 192.168.2.0/24</div></pre></td></tr></table></figure></p>
<p>客户端挂载nfs服务的/nfs/data到本地的/mnt目录上<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># mount -t nfs 192.168.2.139:/nfs/data /mnt</span></div><div class="line">[root@centos7 ~]<span class="comment"># df -h</span></div><div class="line">Filesystem               Size  Used Avail Use% Mounted on</div><div class="line">/dev/mapper/vgos-root     20G  1.8G   19G   9% /</div><div class="line">devtmpfs                 479M     0  479M   0% /dev</div><div class="line">tmpfs                    489M     0  489M   0% /dev/shm</div><div class="line">tmpfs                    489M   13M  477M   3% /run</div><div class="line">tmpfs                    489M     0  489M   0% /sys/fs/cgroup</div><div class="line">/dev/sda1                497M  108M  390M  22% /boot</div><div class="line">tmpfs                     98M     0   98M   0% /run/user/0</div><div class="line">192.168.2.139:/nfs/data   20G  2.1G   18G  11% /mnt</div><div class="line">进到挂载点/mnt中，执行写操作</div><div class="line">[root@centos7 ~]<span class="comment"># cd /mnt</span></div><div class="line">[root@centos7 mnt]<span class="comment"># ls</span></div><div class="line">[root@centos7 mnt]<span class="comment"># cp /etc/fstab ./</span></div><div class="line">cp: cannot create regular file ?./fstab?. Permission denied</div></pre></td></tr></table></figure></p>
<p>发现管理员是没有权限的，这是因为管理员被映射为nfsnobody，没有写权限,这时我们把NFS服务器端共享目录属主和属组改为nfsnobody<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># nfs服务器端</span></div><div class="line">[root@centos7 ~]<span class="comment"># id nfsnobody</span></div><div class="line">uid=65534(nfsnobody) gid=65534(nfsnobody) groups=65534(nfsnobody)</div><div class="line">[root@centos7 ~]<span class="comment"># ll -d /nfs/data</span></div><div class="line">drwxr-xr-x 2 root root 6 Aug 26 17:16 /nfs/data</div><div class="line">[root@centos7 ~]<span class="comment"># chown -R nfsnobody.nfsnobody /nfs/data</span></div><div class="line">[root@centos7 ~]<span class="comment"># ll -d /nfs/data</span></div><div class="line">drwxr-xr-x 2 nfsnobody nfsnobody 6 Aug 26 17:16 /nfs/data</div><div class="line"><span class="comment"># nfs客户端</span></div><div class="line">[root@centos7 mnt]<span class="comment"># id nfsnobody</span></div><div class="line">uid=65534(nfsnobody) gid=65534(nfsnobody) groups=65534(nfsnobody)</div><div class="line">[root@centos7 ~]<span class="comment"># ll -d /mnt</span></div><div class="line">drwxr-xr-x 2 nfsnobody nfsnobody 6 Aug 26 17:16 /mnt</div><div class="line">[root@centos7 ~]<span class="comment"># cd /mnt</span></div><div class="line">[root@centos7 mnt]<span class="comment"># mkdir a</span></div><div class="line">[root@centos7 mnt]<span class="comment"># ls</span></div><div class="line">a</div></pre></td></tr></table></figure></p>
<p>我们可以在nfs服务端有新建一个jack用户，赋予jack用户对/nfs/data的rwx权限，然后在客户端，同样创建一个和jack用户id号相同的用户，<br>看能否完成id映射<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># nfs服务器端新建jack用户</span></div><div class="line">[root@centos7 ~]<span class="comment"># id jack</span></div><div class="line">uid=1041(jack) gid=1041(jack) groups=1041(jack)</div><div class="line">[root@centos7 ~]<span class="comment"># setfacl -m u:jack:rwx /nfs/data</span></div><div class="line">[root@centos7 ~]<span class="comment"># getfacl /nfs/data</span></div><div class="line">getfacl: Removing leading <span class="string">'/'</span> from absolute path names</div><div class="line"><span class="comment"># file: nfs/data</span></div><div class="line"><span class="comment"># owner: root</span></div><div class="line"><span class="comment"># group: root</span></div><div class="line">user::rwx</div><div class="line">user:jack:rwx</div><div class="line">group::r-x</div><div class="line">mask::rwx</div><div class="line">other::r-x</div><div class="line"><span class="comment"># nfs客户端同样i新建一个id的jack用户</span></div><div class="line">[root@centos7 ~]<span class="comment"># id jack</span></div><div class="line">uid=1041(jack) gid=1041(jack) groups=1041(jack)</div><div class="line">[root@centos7 ~]<span class="comment"># mount -t nfs 192.168.2.139:/nfs/data /mnt</span></div><div class="line">[root@centos7 ~]<span class="comment"># df -h</span></div><div class="line">Filesystem               Size  Used Avail Use% Mounted on</div><div class="line">/dev/mapper/vgos-root     20G  1.8G   19G   9% /</div><div class="line">devtmpfs                 479M     0  479M   0% /dev</div><div class="line">tmpfs                    489M     0  489M   0% /dev/shm</div><div class="line">tmpfs                    489M   13M  477M   3% /run</div><div class="line">tmpfs                    489M     0  489M   0% /sys/fs/cgroup</div><div class="line">/dev/sda1                497M  108M  390M  22% /boot</div><div class="line">tmpfs                     98M     0   98M   0% /run/user/0</div><div class="line">192.168.2.139:/nfs/data   20G  2.1G   18G  11% /mnt</div><div class="line">[root@centos7 ~]<span class="comment"># cd /mnt</span></div><div class="line">[root@centos7 mnt]<span class="comment"># ls -l</span></div><div class="line">total 4</div><div class="line">-rw-rw-r-- 1 jack jack 19 Aug 26 18:39 test.txt       <span class="comment"># 因为id相同，所以这里已经映射成为jack用户</span></div><div class="line">[root@centos7 mnt]<span class="comment"># echo "123456789" &gt;&gt; test.txt     </span></div><div class="line">-bash: test.txt: Permission denied                    <span class="comment"># 管理员没有权限，原因是被映射为nfsnobody</span></div><div class="line">[root@centos7 mnt]<span class="comment"># su - jack             # 切换到jack用户</span></div><div class="line">[jack@centos7 ~]$ <span class="built_in">cd</span> /mnt</div><div class="line">[jack@centos7 mnt]$ ls</div><div class="line">test.txt</div><div class="line">[jack@centos7 mnt]$ <span class="built_in">echo</span> <span class="string">"123456789"</span> &gt;&gt; test.txt</div><div class="line">[jack@centos7 mnt]$ cat test.txt </div><div class="line">jackjack</div><div class="line">123456789</div><div class="line">[jack@centos7 mnt]$ cp /etc/issue ./</div><div class="line">[jack@centos7 mnt]$ ls <span class="_">-l</span></div><div class="line">total 8</div><div class="line">-rw-r--r-- 1 jack jack 23 Aug 26 18:44 issue</div><div class="line">-rw-rw-r-- 1 jack jack 19 Aug 26 18:39 test.txt</div><div class="line"><span class="comment"># 再切换到服务端</span></div><div class="line">[root@centos7 ~]<span class="comment"># ls -l /nfs/data</span></div><div class="line">total 8</div><div class="line">-rw-r--r-- 1 jack jack 23 Aug 26 18:44 issue</div><div class="line">-rw-rw-r-- 1 jack jack 19 Aug 26 18:39 test.txt</div><div class="line"><span class="comment">#在客户端属主为tom的在服务端为jack，可见他们仅通过id进行映射</span></div></pre></td></tr></table></figure></p>
<h4 id="showmount命令"><a href="#showmount命令" class="headerlink" title="showmount命令:"></a>showmount命令:</h4><p>★ show mount information for an NFS server<br>&ensp;&ensp;&ensp;&ensp;查看指定的nfs服务相关的挂载信息<br>★ 选项：<br> -e or –exports<br>&ensp;&ensp;&ensp;&ensp;Show the NFS server’s export list.<br>&ensp;&ensp;&ensp;&ensp;查看NFSserver共享了哪些可挂载的信息<br> -d or –directories<br>&ensp;&ensp;&ensp;&ensp;List only the directories mounted by some client.<br>&ensp;&ensp;&ensp;&ensp;仅列出被某些客户端挂载上的文件系统</p>
<h4 id="命令演示"><a href="#命令演示" class="headerlink" title="命令演示:"></a>命令演示:</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[jack@centos7 ~]$ showmount <span class="_">-e</span> 192.168.2.139</div><div class="line">Export list <span class="keyword">for</span> 192.168.2.139:</div><div class="line">/nfs/data 192.168.2.0/24</div><div class="line">[jack@centos7 ~]$ showmount <span class="_">-d</span> 192.168.2.139</div><div class="line">Directories on 192.168.2.139:</div></pre></td></tr></table></figure>
<h4 id="exportfs命令"><a href="#exportfs命令" class="headerlink" title="exportfs命令"></a>exportfs命令</h4><p>★ maintain table of exported NFS file systems<br>★ 选项：<br>-a：Exportor unexport all directories.<br>&ensp;&ensp;&ensp;&ensp;导出或取消导出所有文件系统，取决于操作选项<br> -r: Reexport all  directories, synchronizing/var/lib/nfs/etab with /etc/exports and files under /etc/exports.d.<br>&ensp;&ensp;&ensp;&ensp;重新导出文件系统<br>-u: Unexportone or more directories.<br>&ensp;&ensp;&ensp;&ensp;关闭导出文件系统</p>
<h4 id="演示：-1"><a href="#演示：-1" class="headerlink" title="演示："></a>演示：</h4><p>&ensp;&ensp;&ensp;&ensp;假如我在/nfs/下又创建了一个mydata的目录，想共享给192.168.2.0/24整个网络并且都有rw权限，我们修改完配置文件/etc/exports后，要想生效就要重启服务，但远程其他的文件还在挂载共享，重启服务的话显然是不合适的，这时就要用到exports命令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># mkdir -pv /nfs/mydata</span></div><div class="line">mkdir: created directory ?.nfs/mydata?</div><div class="line">[root@centos7 ~]<span class="comment"># vi /etc/exports</span></div><div class="line">/nfs/data       192.168.2.149(rw)       192.168.2.0/24(ro)</div><div class="line">/nfs/mydata     192.168.2.0(rw)       <span class="comment"># 新添加的共享文件系统</span></div><div class="line"><span class="comment"># 如上，保存退出后，在客户端查看共享的文件系统</span></div><div class="line">[root@centos7 ~]<span class="comment"># showmount -e 192.168.2.139</span></div><div class="line">Export list <span class="keyword">for</span> 192.168.2.139:</div><div class="line">/nfs/data 192.168.2.0/24</div></pre></td></tr></table></figure></p>
<p>要想不用重启NFS服务，又在客户端显示出来使用exports -ra 命令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 在服务端执行命令</span></div><div class="line">[root@centos7 ~]<span class="comment"># exportfs -ra</span></div><div class="line">[root@centos7 ~]<span class="comment"># showmount -e localhost</span></div><div class="line">Export list <span class="keyword">for</span> localhost:</div><div class="line">/nfs/mydata 192.168.2.0</div><div class="line">/nfs/data   192.168.2.0/24</div><div class="line"><span class="comment"># 在客户端再次执行</span></div><div class="line">[root@centos7 ~]<span class="comment"># showmount -e 192.168.2.139</span></div><div class="line">Export list <span class="keyword">for</span> 192.168.2.139:</div><div class="line">/nfs/mydata 192.168.2.0           <span class="comment"># 新创建的共享</span></div><div class="line">/nfs/data   192.168.2.0/24 </div><div class="line"><span class="comment"># 服务端关闭导出所有文件系统</span></div><div class="line">[root@centos7 ~]<span class="comment"># exportfs -ua</span></div><div class="line">[root@centos7 ~]<span class="comment"># showmount -e localhost</span></div><div class="line">Export list <span class="keyword">for</span> localhost:</div></pre></td></tr></table></figure></p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color2">liunx文件共享服务</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2017/08/20/linux服务之nfs/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>





  
    <article id="post-linux服务之ssh" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/20/linux服务之ssh/">linux服务之SSH</a>
    </h1>
  

        
        <a href="/2017/08/20/linux服务之ssh/" class="archive-article-date">
  	<time datetime="2017-08-20T05:50:22.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2017-08-20</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>&ensp;&ensp;&ensp;&ensp;SSH是安全的加密协议，用于远程连接linux服务器<br>&ensp;&ensp;&ensp;&ensp;SSH默认端口是22，安全协议版本SSH2,比SSH1安全<br>&ensp;&ensp;&ensp;&ensp;SSH服务器主要包含两个服务功能SSH远程连接，SFTP服务<br>&ensp;&ensp;&ensp;&ensp;Linux SSH客户端包含ssh远程连接命令，以及远程拷贝SCP命令等</p>
<h3 id="ssh附带相关功能ssh-scp-sftp"><a href="#ssh附带相关功能ssh-scp-sftp" class="headerlink" title="ssh附带相关功能ssh,scp,sftp"></a>ssh附带相关功能ssh,scp,sftp</h3><h4 id="ssh命令"><a href="#ssh命令" class="headerlink" title="ssh命令"></a>ssh命令</h4><p>ssh连接远程主机基本语法格式：</p>
<table>
<thead>
<tr>
<th style="text-align:left">命令</th>
<th style="text-align:left">选项</th>
<th style="text-align:left">用户名@主机名或IP</th>
<th style="text-align:left">要执行的命令</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">ssh</td>
<td style="text-align:left">[options]</td>
<td style="text-align:left">[user@]hostname</td>
<td style="text-align:left">[command]</td>
</tr>
</tbody>
</table>
<p>常用选项：<br>&ensp;&ensp;&ensp;&ensp;-p （小写）接端口，默认22端口时可以省略-p22<br>连接到远程主机上：<br>&ensp;&ensp;&ensp;&ensp;ssh –p22 root@10.0.0.10               #使用默认端口<br>&ensp;&ensp;&ensp;&ensp;ssh –p52113  root@10.0.0.10      #使用指定端口<br>连接远程主机（并不会登录到远程主机上）执行命令：<br>&ensp;&ensp;&ensp;&ensp;ssh –p22 root@10.0.0.10  /sbin/ifconfig eth0           #连接远程主机查看远程主机IP</p>
<h4 id="scp-命令"><a href="#scp-命令" class="headerlink" title="scp 命令"></a>scp 命令</h4><table>
<thead>
<tr>
<th style="text-align:left">命令</th>
<th style="text-align:left">选项</th>
<th style="text-align:left">主机1</th>
<th style="text-align:left">主机2</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">scp</td>
<td style="text-align:left">[options]</td>
<td style="text-align:left">[user@]host1:]file1</td>
<td style="text-align:left">[user@]host2:]file2</td>
</tr>
</tbody>
</table>
<p>常用选项：<br>&ensp;&ensp;&ensp;&ensp;-P    （大写）接端口，默认22端口可以省略-P22<br>&ensp;&ensp;&ensp;&ensp;-r    递归，表示拷贝目录<br>&ensp;&ensp;&ensp;&ensp;-p    表示在拷贝前后保持文件或目录属性<br>&ensp;&ensp;&ensp;&ensp;-l    限制速度<br>scp可以把数据从一台机器推送到另一个机器，也可以从其它服务器把数据拉回本地执行命令服务器。具体用法如：<br>拷贝文件或目录到远程服务器（推）<br>&ensp;&ensp;&ensp;&ensp;scp  -P22  -r  -p  /data root@10.0.0.10 :/tmp<br>从远程服务器拷文件或目录到本地（拉）<br>&ensp;&ensp;&ensp;&ensp;scp  -P22  -r  -p  root@10.0.0.10:/tmp    /data</p>
<h3 id="ssh服务主机信任配置及批量分发管理"><a href="#ssh服务主机信任配置及批量分发管理" class="headerlink" title="ssh服务主机信任配置及批量分发管理"></a>ssh服务主机信任配置及批量分发管理</h3><h4 id="ssh服务端默认配置文件"><a href="#ssh服务端默认配置文件" class="headerlink" title="ssh服务端默认配置文件"></a>ssh服务端默认配置文件</h4><p>SSH默认配置文件：/etc/ssh/sshd_config<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span>  /etc/ssh</div><div class="line">cp sshd_config&#123;,.bak&#125; (备份的好处：1.错了能还原。2.改后可以对比)</div><div class="line">vim sshd_config   ---&gt;&gt;:<span class="built_in">set</span> nu (显示行号)</div><div class="line">主要修改以下：</div><div class="line"><span class="comment">#Port 22</span></div><div class="line">Port  52113                           <span class="comment">######修改默认端口</span></div><div class="line"><span class="comment">#ListenAddress 0.0.0.0</span></div><div class="line">ListenAddress 192.168.2.129 <span class="comment">#####指定sshd监听的网络地址默认监听所有，可以指定一个IP 监听(内网IP)</span></div><div class="line"><span class="comment">#UseDNS yes                     ######不使用DNS解析   </span></div><div class="line">UseDNS no                           </div><div class="line"><span class="comment">#PermitRootLogin yes        </span></div><div class="line">PermitRootLogin no           <span class="comment">######禁止root用户远程登录</span></div><div class="line"><span class="comment">#PermitEmptyPasswords yes</span></div><div class="line">PermitEmptyPasswords no       <span class="comment">######禁止空密码</span></div><div class="line"><span class="comment">#GSSAPIAuthentication yes</span></div><div class="line">GSSAPIAuthentication no     <span class="comment">###关闭GSSAPI身份验证当这个参数开启（GSSAPIAuthentication  yes）的时候，通过SSH登陆服务器时候会有时候很慢， 建议关闭</span></div></pre></td></tr></table></figure></p>
<p>或直接添加这几行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">vim sshd_config</div><div class="line"><span class="comment">#####by jack#20170825##</span></div><div class="line">Port  52113</div><div class="line">UseDNS no</div><div class="line">PermitRootLogin no</div><div class="line">PermitEmptyPasswords no</div><div class="line">GSSAPIAuthentication no</div><div class="line">ListenAddress 192.168.2.129 (内网IP)</div><div class="line"><span class="comment">#####by jack#20170825##</span></div><div class="line">对比更改前后</div><div class="line">diff   sshd_config.bak  sshd_config</div><div class="line">vimdiff   sshd_config.bak  sshd_config</div><div class="line">重启sshd服务：systemctl sshd restart</div><div class="line">ss -lntup |grep sshd</div></pre></td></tr></table></figure></p>
<h3 id="主机之间ssh服务认证配置"><a href="#主机之间ssh服务认证配置" class="headerlink" title="主机之间ssh服务认证配置"></a>主机之间ssh服务认证配置</h3><h4 id="主机A——————》主机B和主机C"><a href="#主机A——————》主机B和主机C" class="headerlink" title="主机A——————》主机B和主机C"></a>主机A——————》主机B和主机C</h4><p>主机A，主机B，主机C上同时建一个相同的用户专门用着分发（用root也可以）<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">建立用户：</div><div class="line">useradd jack888</div><div class="line"><span class="built_in">echo</span>  123456|passwd  --stdin  jack888</div><div class="line">su – jack888</div><div class="line">在主机A上生成密钥对：</div><div class="line">[jack888@nfs-server ~]$ ssh-keygen -t dsa</div><div class="line">Generating public/private dsa key pair.</div><div class="line">Enter file <span class="keyword">in</span> <span class="built_in">which</span> to save the key (/home/jack888/.ssh/id_dsa): </div><div class="line">Created directory <span class="string">'/home/jack888/.ssh'</span>.</div><div class="line">Enter passphrase (empty <span class="keyword">for</span> no passphrase): </div><div class="line">Enter same passphrase again: </div><div class="line">Your identification has been saved <span class="keyword">in</span> /home/jack888/.ssh/id_dsa.</div><div class="line">Your public key has been saved <span class="keyword">in</span> /home/jack888/.ssh/id_dsa.pub.</div><div class="line">The key fingerprint is:</div><div class="line">f4:54:08:e6:84:91:14:0a:72:5e:06:fa:18:b0:60:e5 jack888@nfs-server</div><div class="line">The key<span class="string">'s randomart image is:</span></div><div class="line">+--[ DSA 1024]----+</div><div class="line">|+.=oo.+=+. ..    |</div><div class="line">|+*.+ .o+  ..     |</div><div class="line">|+ .E.   o .      |</div><div class="line">| +     . o       |</div><div class="line">|. .     S .      |</div><div class="line">|                 |</div><div class="line">|                 |</div><div class="line">|                 |</div><div class="line">|                 |</div><div class="line">+-----------------+</div><div class="line">[jack888@nfs-server ~]$ </div><div class="line">[jack888@nfs-server ~]$ ls -l .ssh/</div><div class="line">total 8</div><div class="line">-rw-------. 1 jack888 jack888 668 Jan  8 15:15 id_dsa</div><div class="line">-rw-r--r--. 1 jack888 jack888 608 Jan  8 15:15 id_dsa.pub</div><div class="line"># 主机 A上分发公钥到主机B和主机C</div><div class="line">[jack888@nfs-server ~]$ ssh-copy-id -i .ssh/id_dsa.pub jack888@10.0.0.8</div><div class="line">The authenticity of host '10.0.0.8 (10.0.0.8)<span class="string">' can'</span>t be established.</div><div class="line">RSA key fingerprint is 24:7b:fa:1a:50:d4:44:31:61:98:66:1c:aa:d4:1c:8e.</div><div class="line">Are you sure you want to <span class="built_in">continue</span> connecting (yes/no)? yes</div><div class="line">Warning: Permanently added <span class="string">'10.0.0.8'</span> (RSA) to the list of known hosts.</div><div class="line">jack888@10.0.0.8<span class="string">'s password: </span></div><div class="line">Now try logging into the machine, with "ssh 'jack888@10.0.0.8<span class="string">'", and check in:</span></div><div class="line">  .ssh/authorized_keys</div><div class="line">to make sure we haven't added extra keys that you weren<span class="string">'t expecting.</span></div><div class="line"></div><div class="line">[jack888@nfs-server ~]$ ssh-copy-id -i .ssh/id_dsa.pub jack888@10.0.0.9</div><div class="line">The authenticity of host '10.0.0.9 (10.0.0.9)<span class="string">' can'</span>t be established.</div><div class="line">RSA key fingerprint is 24:7b:fa:1a:50:d4:44:31:61:98:66:1c:aa:d4:1c:8e.</div><div class="line">Are you sure you want to <span class="built_in">continue</span> connecting (yes/no)? yes</div><div class="line">Warning: Permanently added <span class="string">'10.0.0.9'</span> (RSA) to the list of known hosts.</div><div class="line">jack888@10.0.0.9<span class="string">'s password: </span></div><div class="line">Now try logging into the machine, with "ssh 'jack888@10.0.0.9<span class="string">'", and check in:</span></div><div class="line">  .ssh/authorized_keys</div><div class="line">to make sure we haven't added extra keys that you weren<span class="string">'t expecting.</span></div><div class="line"></div><div class="line">[jack888@nfs-server ~]$ ls -l .ssh/</div><div class="line">total 12</div><div class="line">-rw-------. 1 jack888 jack888 668 Jan  8 15:15 id_dsa</div><div class="line">-rw-r--r--. 1 jack888 jack888 608 Jan  8 15:15 id_dsa.pub</div><div class="line">-rw-r--r--. 1 jack888 jack888 780 Jan  8 15:17 known_hosts</div></pre></td></tr></table></figure></p>
<p>远程查看主机B和主机C的IP地址<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[jack888@nfs-server ~]$ ssh -p22 jack888@10.0.0.8 /sbin/ifconfig eth0</div><div class="line">eth0      Link encap:Ethernet  HWaddr 00:0C:29:ED:E3:A3  </div><div class="line">          inet addr:10.0.0.8  Bcast:10.0.0.255  Mask:255.255.255.0</div><div class="line">          inet6 addr: fe80::20c:29ff:feed:e3a3/64 Scope:Link</div><div class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</div><div class="line">          RX packets:6577 errors:0 dropped:0 overruns:0 frame:0</div><div class="line">          TX packets:3158 errors:0 dropped:0 overruns:0 carrier:0</div><div class="line">          collisions:0 txqueuelen:1000 </div><div class="line">          RX bytes:642875 (627.8 KiB)  TX bytes:468139 (457.1 KiB)</div><div class="line"></div><div class="line">[jack888@nfs-server ~]$ ssh -p22 jack888@10.0.0.9 /sbin/ifconfig eth0 </div><div class="line">eth0      Link encap:Ethernet  HWaddr 00:0C:29:9B:2F:7B  </div><div class="line">          inet addr:10.0.0.9  Bcast:10.0.0.255  Mask:255.255.255.0</div><div class="line">          inet6 addr: fe80::20c:29ff:fe9b:2f7b/64 Scope:Link</div><div class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</div><div class="line">          RX packets:4216 errors:0 dropped:0 overruns:0 frame:0</div><div class="line">          TX packets:1052 errors:0 dropped:0 overruns:0 carrier:0</div><div class="line">          collisions:0 txqueuelen:1000 </div><div class="line">          RX bytes:397922 (388.5 KiB)  TX bytes:159312 (155.5 KiB)</div></pre></td></tr></table></figure></p>
<h4 id="反过来实现主机B和主机C-——————》主机A"><a href="#反过来实现主机B和主机C-——————》主机A" class="headerlink" title="反过来实现主机B和主机C ——————》主机A"></a>反过来实现主机B和主机C ——————》主机A</h4><p>在主机A上分别拷贝私钥到主机B和主机C<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[jack888@nfs-server ~]$ scp -P22 -p .ssh/id_dsa jack888@10.0.0.8:~/.ssh</div><div class="line">id_dsa                                                            100%  668     0.7KB/s   00:00    </div><div class="line">[jack888@nfs-server ~]$ scp -P22 -p .ssh/id_dsa jack888@10.0.0.9:~/.ssh</div><div class="line">id_dsa                                                            100%  668     0.7KB/s   00:00</div></pre></td></tr></table></figure></p>
<p>在主机A上重新用分发公钥ssh-copy-id给自己<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[jack888@nfs-server ~]$ ssh-copy-id -i .ssh/id_dsa.pub jack888@10.0.0.7</div><div class="line">The authenticity of host <span class="string">'10.0.0.7 (10.0.0.7)'</span> can<span class="string">'t be established.</span></div><div class="line">RSA key fingerprint is 24:7b:fa:1a:50:d4:44:31:61:98:66:1c:aa:d4:1c:8e.</div><div class="line">Are you sure you want to continue connecting (yes/no)? yes</div><div class="line">Warning: Permanently added '10.0.0.7<span class="string">' (RSA) to the list of known hosts.</span></div><div class="line">jack888@10.0.0.7's password: </div><div class="line">Now try logging into the machine, with <span class="string">"ssh 'jack888@10.0.0.7'"</span>, and check <span class="keyword">in</span>:</div><div class="line">  .ssh/authorized_keys</div><div class="line">to make sure we haven<span class="string">'t added extra keys that you weren'</span>t expecting.</div><div class="line"></div><div class="line">[jack888@nfs-server ~]$ ls <span class="_">-l</span> .ssh/</div><div class="line">total 16</div><div class="line">-rw-------. 1 jack888 jack888  608 Jan  8 15:22 authorized_keys</div><div class="line">-rw-------. 1 jack888 jack888  668 Jan  8 15:15 id_dsa</div><div class="line">-rw-r--r--. 1 jack888 jack888  608 Jan  8 15:15 id_dsa.pub</div><div class="line">-rw-r--r--. 1 jack888 jack888 1170 Jan  8 15:22 known_hosts</div></pre></td></tr></table></figure></p>
<p>如果SSH修改了默认端口为52113，直接用ssh-copy-id命令就无法进行分发公钥了。解决方式为：ssh-copy-id  -i  id_dsa.pub “-p 52113 jack888@10.0.0.7” 特殊端口分发</p>
<h3 id="实现主机间互信方法三（只在一个节点上操作）"><a href="#实现主机间互信方法三（只在一个节点上操作）" class="headerlink" title="实现主机间互信方法三（只在一个节点上操作）"></a>实现主机间互信方法三（只在一个节点上操作）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 在node1上生成秘钥对</span></div><div class="line">[root@node1 ~]<span class="comment"># ssh-keygen -t rsa -P ''</span></div><div class="line">Generating public/private rsa key pair.</div><div class="line">Enter file <span class="keyword">in</span> <span class="built_in">which</span> to save the key (/root/.ssh/id_rsa): </div><div class="line">Created directory <span class="string">'/root/.ssh'</span>.</div><div class="line">Your identification has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.</div><div class="line">Your public key has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.pub.</div><div class="line">The key fingerprint is:</div><div class="line">bd:83:c0:77:2f:83:56:a3:ad:0b:8e:ea:a8:4f:f6:6e root@node1</div><div class="line">The key<span class="string">'s randomart image is:</span></div><div class="line">+--[ RSA 2048]----+</div><div class="line">|                 |</div><div class="line">|                 |</div><div class="line">|                 |</div><div class="line">|     .   .       |</div><div class="line">|      o S =      |</div><div class="line">|       o B +     |</div><div class="line">|  o   . = * .    |</div><div class="line">| + .Eo o . +     |</div><div class="line">|+o+++ . o.       |</div><div class="line">+-----------------+</div><div class="line"># 输出自己生成的公钥到authorized_keys中，并修改600权限</div><div class="line">[root@node1 ~]# cat .ssh/id_rsa.pub &gt;&gt; .ssh/authorized_keys</div><div class="line">[root@node1 ~]# ll .ssh/authorized_keys </div><div class="line">-rw-r--r-- 1 root root 392 Oct 25 19:45 .ssh/authorized_keys</div><div class="line">[root@node1 ~]# chmod go= .ssh/authorized_keys </div><div class="line">[root@node1 ~]# ll .ssh/authorized_keys </div><div class="line">-rw------- 1 root root 392 Oct 25 19:45 .ssh/authorized_keys</div><div class="line"></div><div class="line"># 如果node2中没有.ssh目录，需要创建目录</div><div class="line">[root@node2 ~]# mkdir .ssh</div><div class="line"></div><div class="line"># 拷贝node1上的私钥和生成的authorized_keys文件到其它要互信息的节点，此处为node2</div><div class="line">[root@node1 ~]# scp .ssh/id_rsa .ssh/authorized_keys node2:/root/.ssh</div><div class="line">The authenticity of host 'node2 (172.16.3.148)<span class="string">' can'</span>t be established.</div><div class="line">ECDSA key fingerprint is 34:ee:5f:60:28:b6:0e:79:70:a3:8d:e7:f2:f3:bc:b9.</div><div class="line">Are you sure you want to <span class="built_in">continue</span> connecting (yes/no)? yes</div><div class="line">Warning: Permanently added <span class="string">'node2,172.16.3.148'</span> (ECDSA) to the list of known hosts.</div><div class="line">root@node2<span class="string">'s password: </span></div><div class="line">id_rsa                                                            100% 1675     1.6KB/s   00:00    </div><div class="line">authorized_keys                                                   100%  392     0.4KB/s   00:00 </div><div class="line"></div><div class="line"># 在node1上测试 </div><div class="line">[root@node1 ~]# ssh node2</div><div class="line">Last login: Wed Oct 25 19:31:35 2017 from 172.16.3.1</div><div class="line">[root@node2 ~]# </div><div class="line"></div><div class="line"># 在node2上测试</div><div class="line">[root@node2 ~]# ssh node1</div><div class="line">The authenticity of host 'node1 (172.16.3.141)<span class="string">' can'</span>t be established.</div><div class="line">ECDSA key fingerprint is 34:ee:5f:60:28:b6:0e:79:70:a3:8d:e7:f2:f3:bc:b9.</div><div class="line">Are you sure you want to <span class="built_in">continue</span> connecting (yes/no)? yes</div><div class="line">Warning: Permanently added <span class="string">'node1,172.16.3.141'</span> (ECDSA) to the list of known hosts.</div><div class="line">Last login: Wed Oct 25 19:31:22 2017 from 172.16.3.1</div><div class="line">[root@node1 ~]<span class="comment"># exit</span></div><div class="line"><span class="built_in">logout</span></div><div class="line">Connection to node1 closed.</div><div class="line">[root@node2 ~]<span class="comment"># ssh node1</span></div><div class="line">Last login: Wed Oct 25 19:46:33 2017 from 172.16.3.148</div></pre></td></tr></table></figure>
<h3 id="批量分发管理"><a href="#批量分发管理" class="headerlink" title="批量分发管理"></a>批量分发管理</h3><h4 id="演示："><a href="#演示：" class="headerlink" title="演示："></a>演示：</h4><p>1.分发hosts文件分别到3台主机（10.0.0.8，10.0.9，10.0.10）的jack888/home目录下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">su – jack888</div><div class="line">cp  /etc/hosts    ~                   <span class="comment">######拷贝/etc/hosts文件到jack888用户家目录下</span></div><div class="line">vim  fengfa_hosts</div><div class="line"><span class="meta">#!/bin/sh</span></div><div class="line"><span class="keyword">for</span> n <span class="keyword">in</span> 8 9 10                        <span class="comment">######定义变量n的取值范围</span></div><div class="line"><span class="keyword">do</span></div><div class="line">          scp  -P22 hosts jack888@10.0.0.<span class="variable">$n</span>:~         <span class="comment">######$n会依次读取8、9、10三个值</span></div><div class="line"><span class="keyword">done</span></div><div class="line">[jack888@nfs-server ~]$ /bin/sh /server/scripts/fenfa.sh </div><div class="line">hosts                                                             100%  178     0.2KB/s   00:00    </div><div class="line">hosts                                                             100%  178     0.2KB/s   00:00    </div><div class="line">hosts                                                             100%  178     0.2KB/s   00:00</div></pre></td></tr></table></figure></p>
<p>2.分发hosts文件分别到2台主机（10.0.0.8，10.0.0.9）的jack888/home目录下<br>要分面的hosts文件通过传参的方式分发<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[root@nfs-server scripts]<span class="comment"># vim fenfachuancan.sh </span></div><div class="line"><span class="meta">#!/bin/sh</span></div><div class="line">. /etc/init.d/<span class="built_in">functions</span>                   <span class="comment">#####定义功能函数</span></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> 8 9                             <span class="comment">####定义变量i的取值范围</span></div><div class="line"><span class="keyword">do</span></div><div class="line">   scp -P22 <span class="variable">$1</span> jack888@10.0.0.<span class="variable">$i</span>:~ &amp;&gt;/dev/null       <span class="comment">#####$1为执行脚本时要传递的参数，$i会依次读取8、9两个值######</span></div><div class="line">  <span class="keyword">if</span> [ $? <span class="_">-eq</span> 0 ]           <span class="comment">#####如果上述scp命令执行成功$?会返回一个值0，不成功会返回1，此处做判断使用######</span></div><div class="line">     <span class="keyword">then</span></div><div class="line">        action <span class="string">"fenfa <span class="variable">$1</span> ok"</span> /bin/<span class="literal">true</span>              <span class="comment">#####$1表示执行脚本时手动输入的参数</span></div><div class="line">      <span class="keyword">else</span></div><div class="line">        action <span class="string">"fenfa <span class="variable">$1</span> Failed"</span> /bin/<span class="literal">false</span></div><div class="line">  <span class="keyword">fi</span></div><div class="line"><span class="keyword">done</span></div><div class="line">[jack888@nfs-server scripts]$ /bin/sh fenfachuancan.sh  ~/hosts      </div><div class="line">fenfa /home/jack888/hosts ok                               [  OK  ]</div><div class="line">fenfa /home/jack888/hosts ok                               [  OK  ]</div></pre></td></tr></table></figure></p>
<p>3.分发hosts文件分别到2台主机（10.0.0.8，10.0.0.9）的jack888/home目录下<br>要分面的hosts文件通过传参的方式分发，不指定要分发主机的分发目录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">[root@nfs-server scripts]<span class="comment"># vim fenfachuancan1.sh</span></div><div class="line"><span class="meta">#!/bin/sh</span></div><div class="line">. /etc/init.d/<span class="built_in">functions</span></div><div class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> <span class="_">-ne</span> 1 ]                        <span class="comment">######$#表示参数个数</span></div><div class="line">   <span class="keyword">then</span></div><div class="line">       <span class="built_in">echo</span> <span class="string">"USAGE:<span class="variable">$0</span> &#123;filename|dirname&#125;"</span>       <span class="comment">######$0表示脚本名字</span></div><div class="line">       <span class="built_in">exit</span> 1                             <span class="comment">#####表示退出</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="keyword">for</span> n <span class="keyword">in</span> 8 9</div><div class="line"><span class="keyword">do</span></div><div class="line">   scp -P22 -pr <span class="variable">$1</span> jack888@10.0.0.<span class="variable">$n</span>:~ &amp;&gt;/dev/null     <span class="comment">#####$1为执行脚本时要传递的参数，$n会依次读取8、9两个值######</span></div><div class="line">   <span class="keyword">if</span> [ $? <span class="_">-eq</span> 0 ]</div><div class="line">      <span class="keyword">then</span></div><div class="line">         action <span class="string">"<span class="variable">$1</span> 10.0.0.<span class="variable">$n</span> is ok"</span> /bin/<span class="literal">true</span></div><div class="line">   <span class="keyword">else</span></div><div class="line">         action <span class="string">"<span class="variable">$1</span> 10.0.0.<span class="variable">$n</span> is fail"</span> /bin/<span class="literal">true</span></div><div class="line">   <span class="keyword">fi</span></div><div class="line"><span class="keyword">done</span></div><div class="line">[jack888@nfs-server scripts]$ /bin/sh fenfachuancan1.sh </div><div class="line">USAGE:fenfachuancan1.sh &#123;filename|dirname&#125;</div><div class="line">[jack888@nfs-server scripts]$ /bin/sh fenfachuancan1.sh ~/hosts </div><div class="line">/home/jack888/hosts 10.0.0.8 is ok                         [  OK  ]</div><div class="line">/home/jack888/hosts 10.0.0.9 is ok                         [  OK  ]</div></pre></td></tr></table></figure></p>
<p>4.分发hosts文件分别到2台主机（10.0.0.8，10.0.0.9）指定目录下<br>要分面的hosts文件通过传参的方式分发，且指定要分发主机的分发目录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">[jack888@nfs-server ~]$ vi /server/scripts/fenfachuancan2.sh</div><div class="line"><span class="meta">#!/bin/sh</span></div><div class="line">. /etc/init.d/<span class="built_in">functions</span></div><div class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> <span class="_">-ne</span> 2 ]</div><div class="line">   <span class="keyword">then</span></div><div class="line">       <span class="built_in">echo</span> <span class="string">"USAGE:<span class="variable">$0</span> &#123;FileName RemoteDirName&#125;"</span></div><div class="line">   <span class="built_in">exit</span> 1</div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="keyword">for</span> n <span class="keyword">in</span> 8 9</div><div class="line"><span class="keyword">do</span></div><div class="line">   scp -P22 -rp <span class="variable">$1</span> jack888@10.0.0.<span class="variable">$n</span>:<span class="variable">$2</span> &amp;&gt;/dev/null</div><div class="line">   <span class="keyword">if</span> [ $? <span class="_">-eq</span> 0 ]</div><div class="line">      <span class="keyword">then</span></div><div class="line">         action <span class="string">"<span class="variable">$1</span> to <span class="variable">$2</span> 10.0.0.<span class="variable">$n</span> is ok"</span> /bin/<span class="literal">true</span></div><div class="line">      <span class="keyword">else</span></div><div class="line">         action <span class="string">"<span class="variable">$1</span> to <span class="variable">$2</span> 10.0.0.<span class="variable">$n</span> is fail"</span> /bin/<span class="literal">false</span></div><div class="line">   <span class="keyword">fi</span></div><div class="line"><span class="keyword">done</span></div><div class="line">[jack888@nfs-server ~]$ /bin/sh /server/scripts/fenfachuancan2.sh ./hosts /tmp</div><div class="line">./hosts to /tmp 10.0.0.8 is ok                             [  OK  ]</div><div class="line">./hosts to /tmp 10.0.0.9 is ok                             [  OK  ]</div></pre></td></tr></table></figure></p>
<p>5.sudo提权方式分发<br>分发hosts文件分别到2台主机（10.0.0.8，10.0.0.9）指定目录下<br>要分发的hosts文件通过传参的方式分发，且指定要分发主机的分发目录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">1.首先在分发机和要分发的服务器上建同一个用户jack888</div><div class="line">useradd jack888</div><div class="line"><span class="built_in">echo</span> “123456” |passwd –stdin jack888</div><div class="line">2.给jack888用户提权，编辑sudoer文件</div><div class="line">直接输入visudo或vim /etc/sudoers文件</div><div class="line">加入：</div><div class="line">jack888 ALL=(ALL)   NOPASSWD:/usr/bin/rsync</div><div class="line">或直接：</div><div class="line"><span class="built_in">echo</span> ‘jack888 ALL=(ALL)   NOPASSWD:/usr/bin/rsync’  &gt;&gt;/etc/sudoers</div><div class="line">visudo -c  检查语法</div><div class="line">grep jack888 /etc/sudoers            <span class="comment">#####再次确认</span></div><div class="line">3．写脚本</div><div class="line">[root@nfs-server scripts]<span class="comment"># vim fenfa_sudo.sh</span></div><div class="line"><span class="meta">#!/bin/sh</span></div><div class="line">. /etc/init.d/<span class="built_in">functions</span></div><div class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> <span class="_">-ne</span> 2 ]</div><div class="line">   <span class="keyword">then</span></div><div class="line">      <span class="built_in">echo</span> <span class="string">"USAGE:<span class="variable">$0</span> &#123;FileName RemoteDirName&#125;"</span></div><div class="line">   <span class="built_in">exit</span> 1</div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="keyword">for</span> n <span class="keyword">in</span> 8 9</div><div class="line"><span class="keyword">do</span></div><div class="line">   scp -P22 -rp <span class="variable">$1</span> jack888@10.0.0.<span class="variable">$n</span>:~ &amp;&gt;/dev/null</div><div class="line">   ssh -t jack888@10.0.0.<span class="variable">$n</span> sudo rsync <span class="variable">$1</span> <span class="variable">$2</span> &amp;&gt;/dev/null</div><div class="line">   <span class="keyword">if</span> [ $? <span class="_">-eq</span> 0 ]</div><div class="line">      <span class="keyword">then</span></div><div class="line">        action <span class="string">"<span class="variable">$1</span> to <span class="variable">$2</span> 10.0.0.<span class="variable">$n</span> is ok"</span> /bin/<span class="literal">true</span></div><div class="line">   <span class="keyword">else</span></div><div class="line">        action <span class="string">"<span class="variable">$1</span> to <span class="variable">$2</span> 10.0.0.<span class="variable">$n</span> is fail"</span> /bin/<span class="literal">false</span></div><div class="line">   <span class="keyword">fi</span></div><div class="line"><span class="keyword">done</span></div><div class="line">[jack888@nfs-server scripts]$ sh fenfa_sudo.sh /etc/hosts /tmp</div><div class="line">/etc/hosts to /tmp 10.0.0.8 is ok                          [  OK  ]</div><div class="line">/etc/hosts to /tmp 10.0.0.9 is ok                          [  OK  ]</div></pre></td></tr></table></figure></p>
<p>6.批量查看主机IP信息<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">[jack888@nfs-server scripts]$ vim viewinfo.sh </div><div class="line"><span class="meta">#!/bin/sh</span></div><div class="line">. /etc/init.d/<span class="built_in">functions</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> <span class="_">-ne</span> 1 ]</div><div class="line">   <span class="keyword">then</span></div><div class="line">      <span class="built_in">echo</span> <span class="string">"USAGE:<span class="variable">$0</span> &#123;commond&#125;"</span></div><div class="line">   <span class="built_in">exit</span> 1</div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="keyword">for</span> n <span class="keyword">in</span> 8 9</div><div class="line"><span class="keyword">do</span></div><div class="line">  <span class="built_in">echo</span> <span class="string">"*********10.0.0.<span class="variable">$n</span>***************"</span></div><div class="line">  ssh -p22 jack888@10.0.0.<span class="variable">$n</span> <span class="variable">$1</span></div><div class="line"><span class="keyword">done</span></div><div class="line"></div><div class="line">[jack888@nfs-server scripts]$ /bin/sh viewinfo.sh <span class="string">"/sbin/ifconfig eth0"</span></div><div class="line">*********10.0.0.8***************</div><div class="line">eth0      Link encap:Ethernet  HWaddr 00:0C:29:ED:E3:A3  </div><div class="line">          inet addr:10.0.0.8  Bcast:10.0.0.255  Mask:255.255.255.0</div><div class="line">          inet6 addr: fe80::20c:29ff:feed:e3a3/64 Scope:Link</div><div class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</div><div class="line">          RX packets:1006 errors:0 dropped:0 overruns:0 frame:0</div><div class="line">          TX packets:732 errors:0 dropped:0 overruns:0 carrier:0</div><div class="line">          collisions:0 txqueuelen:1000 </div><div class="line">          RX bytes:120560 (117.7 KiB)  TX bytes:134961 (131.7 KiB)</div><div class="line"></div><div class="line">*********10.0.0.9***************</div><div class="line">eth0      Link encap:Ethernet  HWaddr 00:0C:29:9B:2F:7B  </div><div class="line">          inet addr:10.0.0.9  Bcast:10.0.0.255  Mask:255.255.255.0</div><div class="line">          inet6 addr: fe80::20c:29ff:fe9b:2f7b/64 Scope:Link</div><div class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</div><div class="line">          RX packets:625 errors:0 dropped:0 overruns:0 frame:0</div><div class="line">          TX packets:502 errors:0 dropped:0 overruns:0 carrier:0</div><div class="line">          collisions:0 txqueuelen:1000 </div><div class="line">          RX bytes:82828 (80.8 KiB)  TX bytes:80435 (78.5 KiB)</div></pre></td></tr></table></figure></p>
<h4 id="批量分发总结"><a href="#批量分发总结" class="headerlink" title="批量分发总结"></a>批量分发总结</h4><p>a. 利用root作ssh key验证<br>&ensp;&ensp;&ensp;&ensp; 优点：简单，易用<br>&ensp;&ensp;&ensp;&ensp; 缺点：安全关，同时无法禁止root远程连接这个功能<br>&ensp;&ensp;&ensp;&ensp; 企业应用：80%的中小企业<br>b. 利用普通用户如jack888来做<br>思路是先把要分发的文件拷贝不对劲服务器的用户家目录，然后sudo提权拷贝分发文件到对应的权限目录<br>&ensp;&ensp;&ensp;&ensp;优点：安全<br>&ensp;&ensp;&ensp;&ensp;缺点：配置比较复杂<br>企业级生产场景批量管理，自动化管理方案：<br>&ensp;&ensp;&ensp;&ensp;最简单最常用ssh key，功能最强大，一般中小企业会用，50-100以下。<br>&ensp;&ensp;&ensp;&ensp;1.    sina cfengine较早的批量管理工具。现在基本没有企业用。<br>&ensp;&ensp;&ensp;&ensp;2.    门户级别比较流行的，puppet批量管理工具复杂，笨重。<br>&ensp;&ensp;&ensp;&ensp;3.    saltstack批量管理工具，特点：简单，功能强大（配置复杂），赶集网，小米<br>&ensp;&ensp;&ensp;&ensp;4.    http-cron<br>&ensp;&ensp;&ensp;&ensp;批量管理路线：sshkdycfenginepuppetsaltstack/ansible</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">linux服务</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2017/08/20/linux服务之ssh/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>





  
    <article id="post-linux服务之samba" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/18/linux服务之samba/">linux文件共享服务之samba</a>
    </h1>
  

        
        <a href="/2017/08/18/linux服务之samba/" class="archive-article-date">
  	<time datetime="2017-08-18T05:50:22.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2017-08-18</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Samba介绍"><a href="#Samba介绍" class="headerlink" title="Samba介绍"></a>Samba介绍</h3><p>★ smb：Service Message Block；服务信息块<br>★ cifs：Common Internet File System，<br>★ samba：作者：Andrew Tridgell；<br>&ensp;&ensp;&ensp;&ensp;实事上是smb功能的实现，核心当中所实现的主要协议是cifs协议<br>★ 功能：<br>&ensp;&ensp;&ensp;&ensp;文件系统共享；<br>&ensp;&ensp;&ensp;&ensp;NetBIOS协议（进行Windows网络上的主机名解析）；<br>&ensp;&ensp;&ensp;&ensp;打印服务；</p>
<h3 id="Samba安装配置"><a href="#Samba安装配置" class="headerlink" title="Samba安装配置"></a>Samba安装配置</h3><h4 id="程序环境"><a href="#程序环境" class="headerlink" title="程序环境"></a>程序环境</h4><p>★ samba安装<br>&ensp;&ensp;&ensp;&ensp;yum install samba -y<br>★ 主配置文件<br>&ensp;&ensp;&ensp;&ensp;/etc/samba/smb.conf<br>★ 主程序：<br>/usr/sbin/nmbd：<br>&ensp;&ensp;&ensp;&ensp;Network Naming Service，主要是完成NetBIOS名称解析；<br>/usr/sbin/smbd：<br>&ensp;&ensp;&ensp;&ensp;SMB/CIFS Service；核心主程序，完成SMB/CIFS服务<br>★ Unit File<br>&ensp;&ensp;&ensp;&ensp;/usr/lib/systemd/system/nmb.service<br>&ensp;&ensp;&ensp;&ensp;/usr/lib/systemd/system/smb.service<br>★ 监听的端口：<br>&ensp;&ensp;&ensp;&ensp;UDP：137/udp, 138/udp<br>&ensp;&ensp;&ensp;&ensp;TCP:139/tcp, 445/tcp<br>★ 客户端程序：<br>&ensp;&ensp;&ensp;&ensp;mount -t cifs = mount.cifs<br>&ensp;&ensp;&ensp;&ensp;smbclient：交互式命令行客户端工具；</p>
<h4 id="samba的配置"><a href="#samba的配置" class="headerlink" title="samba的配置"></a>samba的配置</h4><p>★ 主配置文件：/etc/samba/smb.conf<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># cd /etc/samba/</span></div><div class="line">[root@centos7 samba]<span class="comment"># ls</span></div><div class="line">lmhosts  smb.conf  smb.conf.example</div></pre></td></tr></table></figure></p>
<p>★ 两类配置段：<br>◎全局配置<br>[global]<br>workgroup = MYGROUP 工作组模型 用来定义工作组<br>server string = Samba Server Version %v  定义提示信息<br>interfaces = lo eth0 192.168.12.2/24 192.168.13.2/24  指明要监听的地址或网络接口；<br>hosts allow = 127. 192.168.12. 192.168.13. 访问控制，相当于白名单<br>log file = /var/log/samba/log.%m 每个客户端将使用自己专用的日志文件；<br>max log size = 50 指明日志文件大小，默认为KB<br>security = user 定义安全级别，user提供账号和密码<br>&ensp;&ensp;&ensp;&ensp;share (depricated) 匿名共享<br>&ensp;&ensp;&ensp;&ensp;server (depricated) 实现集中式身份认证<br>&ensp;&ensp;&ensp;&ensp;domain<br>passdb backend = tdbsam 账号密码的存储格式<br>load printers = yes samba 服务启动时是否装载打印机驱动<br>cups options = raw 通用的打印机的服务方式<br>◎共享文件系统：<br>[shared_ID]<br>有三类：<br>[homes]：每个samba用户是否能够通过samba服务访问其家目录；<br>[printers]：打印服务；<br>[shared_FS]：用户自定义的共享目录；</p>
<p>★ 常用指令：<br>comment：注释信息；<br>path：本地文件系统路径；<br>browseable：是否可浏览，是否为用户可见；<br>guest ok：是否允许来宾账号（匿名用户）访问；<br>public：是否公开给所有来宾；<br>writable：是否可写；<br>&ensp;&ensp;&ensp;&ensp;writable=YES和read only = no是一样的<br>write list：拥有写权限的用户或组列表；<br>&ensp;&ensp;&ensp;&ensp;用户名<br>&ensp;&ensp;&ensp;&ensp;@组名 = +组名 </p>
<h3 id="samba用户管理"><a href="#samba用户管理" class="headerlink" title="samba用户管理"></a>samba用户管理</h3><p>★ 命令：<br>&ensp;&ensp;&ensp;&ensp;smbpasswd, pdbedit<br>1）smbpasswd<br>语法：<br>&ensp;&ensp;&ensp;&ensp;smbpasswd [OPTIONS] USERNAME(系统用户)<br>选项：<br>&ensp;&ensp;&ensp;&ensp;-a：添加；<br>&ensp;&ensp;&ensp;&ensp;-x：删除；<br>&ensp;&ensp;&ensp;&ensp;-d：禁用；<br>&ensp;&ensp;&ensp;&ensp;-e：启用<br>2）pdbedit：<br>&ensp;&ensp;&ensp;&ensp;-L：列出samba服务中的所有用户；<br>&ensp;&ensp;&ensp;&ensp;-a：添加用户为samba用户；<br>&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;-u USERNAME：<br>&ensp;&ensp;&ensp;&ensp;-x：删除<br>&ensp;&ensp;&ensp;&ensp;-t：从标准输出接收密码；<br>★ 访问服务：<br>☉smbclient交互式客户端程序：<br>查看目标服务上的共享<br>&ensp;&ensp;&ensp;&ensp;smbclient -L SMB_SERVER [-U USERNAME]<br>访问共享服务<br>&ensp;&ensp;&ensp;&ensp;smbclient //SMB_SERVER[/SHARE_NAME] [-U USERNAME]<br>☉mount.cifs<br>&ensp;&ensp;&ensp;&ensp;mount -t cifs //SMB_SERVER/SHARED_ID  /MOUNT_POINT  -o username=USER,password=PASS（指明用户身份和密码）<br>注意：<br>&ensp;&ensp;&ensp;&ensp;挂载操作中的用户，与-o选项中指定的用户直接产生映射关系；访问挂载，是以-o选项指定的用户身份运行，与本地用户以ID产生映射；<br>★自定义共享的方式：<br>[shared_ID]<br>&ensp;&ensp;&ensp;&ensp;comment =<br>&ensp;&ensp;&ensp;&ensp;path =<br>&ensp;&ensp;&ensp;&ensp;guest ok =<br>&ensp;&ensp;&ensp;&ensp;read only =<br>&ensp;&ensp;&ensp;&ensp;public =<br>&ensp;&ensp;&ensp;&ensp;browseable =<br>&ensp;&ensp;&ensp;&ensp;write list =<br>☉注意：<br>&ensp;&ensp;&ensp;&ensp;定义所有用户在服务级的写权限write = yes (read only = no）不建议与write list同时使用；</p>
<h4 id="演示："><a href="#演示：" class="headerlink" title="演示："></a>演示：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># useradd jack</span></div><div class="line">[root@centos7 ~]<span class="comment"># pdbedit -a -u jack       # 添加samba用户</span></div><div class="line">new password:</div><div class="line">retype new password:</div><div class="line">Unix username:        jack</div><div class="line">NT username:          </div><div class="line">Account Flags:        [U          ]</div><div class="line">User SID:             S-1-5-21-4042538109-569489151-1643692055-1000</div><div class="line">Primary Group SID:    S-1-5-21-4042538109-569489151-1643692055-513</div><div class="line">Full Name:            </div><div class="line">Home Directory:       \\centos7\jack</div><div class="line">HomeDir Drive:        </div><div class="line">Logon Script:         </div><div class="line">Profile Path:         \\centos7\jack\profile</div><div class="line">Domain:               CENTOS7</div><div class="line">Account desc:         </div><div class="line">Workstations:         </div><div class="line">Munged dial:          </div><div class="line">Logon time:           0</div><div class="line">Logoff time:          Wed, 06 Feb 2036 23:06:39 CST</div><div class="line">Kickoff time:         Wed, 06 Feb 2036 23:06:39 CST</div><div class="line">Password last <span class="built_in">set</span>:    Sat, 26 Aug 2017 13:58:14 CST</div><div class="line">Password can change:  Sat, 26 Aug 2017 13:58:14 CST</div><div class="line">Password must change: never</div><div class="line">Last bad password   : 0</div><div class="line">Bad password count  : 0</div><div class="line">Logon hours         : FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF</div><div class="line">[root@centos7 ~]<span class="comment"># pdbedit -L          # 列出samba用户</span></div><div class="line">jack:1001:</div></pre></td></tr></table></figure>
<p>启动samba服务，并查看端口号<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># systemctl start nmb.service smb.service</span></div><div class="line">[root@centos7 ~]<span class="comment"># ss -tnl        # 查看tcp协议端口 139,445</span></div><div class="line">State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              </div><div class="line">LISTEN     0      50             *:139                        *:*                  </div><div class="line">LISTEN     0      128            *:22                         *:*                  </div><div class="line">LISTEN     0      100    127.0.0.1:25                         *:*                  </div><div class="line">LISTEN     0      50             *:445                        *:*                  </div><div class="line">LISTEN     0      50            :::139                       :::*                  </div><div class="line">LISTEN     0      128           :::22                        :::*                  </div><div class="line">LISTEN     0      100          ::1:25                        :::*                  </div><div class="line">LISTEN     0      50            :::445                       :::*     </div><div class="line">[root@centos7 ~]<span class="comment"># ss -unl          # 查看udp端口 137,138</span></div><div class="line">State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              </div><div class="line">UNCONN     0      0      192.168.2.255:137                        *:*                  </div><div class="line">UNCONN     0      0      192.168.2.152:137                        *:*                  </div><div class="line">UNCONN     0      0              *:137                        *:*                  </div><div class="line">UNCONN     0      0      192.168.2.255:138                        *:*                  </div><div class="line">UNCONN     0      0      192.168.2.152:138                        *:*                  </div><div class="line">UNCONN     0      0              *:138                        *:*                  </div><div class="line">UNCONN     0      0              *:5396                       *:*                  </div><div class="line">UNCONN     0      0              *:68                         *:*                  </div><div class="line">UNCONN     0      0             :::5475                      :::*</div></pre></td></tr></table></figure></p>
<p>smbclient命令查看目标主机上的共享<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 如果出现以下报错</span></div><div class="line">[root@centos7 yum.repos.d]<span class="comment"># smbclient -L 192.168.2.152</span></div><div class="line">Enter root<span class="string">'s password: </span></div><div class="line">protocol negotiation failed: NT_STATUS_IO_TIMEOUT</div><div class="line">[root@centos7 ~]# vim /etc/hosts         # 添加主机名和IP解析</div><div class="line">192.168.2.152 samba</div><div class="line"># 匿名访问，不输入密码，如下</div><div class="line">[root@centos7 ~]# smbclient -L 192.168.2.152</div><div class="line">Enter root's password: </div><div class="line">Anonymous login successful</div><div class="line">Domain=[SAMBA] OS=[Windows 6.1] Server=[Samba 4.4.4]</div><div class="line"></div><div class="line">	Sharename       Type      Comment</div><div class="line">	---------       ----      -------</div><div class="line">	<span class="built_in">print</span>$          Disk      Printer Drivers</div><div class="line">	IPC$            IPC       IPC Service (Samba 4.4.4)</div><div class="line">Anonymous login successful</div><div class="line">Domain=[SAMBA] OS=[Windows 6.1] Server=[Samba 4.4.4]</div><div class="line"></div><div class="line">	Server               Comment</div><div class="line">	---------            -------</div><div class="line">	CENTOS7              Samba 4.4.4</div><div class="line"></div><div class="line">	Workgroup            Master</div><div class="line">	---------            -------</div><div class="line">	SAMBA                CENTOS7</div><div class="line">	WORKGROUP            DESKTOP-80P3796</div><div class="line"><span class="comment"># 已创建的系统用户账号来访问，如下：</span></div><div class="line">[root@centos7 ~]<span class="comment"># smbclient -L 192.168.2.152 -U jack</span></div><div class="line">Enter jack<span class="string">'s password: </span></div><div class="line">Domain=[SAMBA] OS=[Windows 6.1] Server=[Samba 4.4.4]</div><div class="line"></div><div class="line">	Sharename       Type      Comment</div><div class="line">	---------       ----      -------</div><div class="line">	print$          Disk      Printer Drivers</div><div class="line">	IPC$            IPC       IPC Service (Samba 4.4.4)</div><div class="line">	jack            Disk      Home Directories</div><div class="line">Domain=[SAMBA] OS=[Windows 6.1] Server=[Samba 4.4.4]</div><div class="line"></div><div class="line">	Server               Comment</div><div class="line">	---------            -------</div><div class="line">	CENTOS7              Samba 4.4.4</div><div class="line"></div><div class="line">	Workgroup            Master</div><div class="line">	---------            -------</div><div class="line">	SAMBA                CENTOS7</div><div class="line">	WORKGROUP            DESKTOP-80P3796</div></pre></td></tr></table></figure></p>
<p>smbclient命令访问目标主机上的共享服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># smbclient //192.168.2.152/jack -U jack</span></div><div class="line">Enter jack<span class="string">'s password: </span></div><div class="line">Domain=[SAMBA] OS=[Windows 6.1] Server=[Samba 4.4.4]</div><div class="line">smb: \&gt; ls</div><div class="line">  .                                   D        0  Sat Aug 26 13:57:56 2017</div><div class="line">  ..                                  D        0  Sat Aug 26 13:57:56 2017</div><div class="line">  .bash_logout                        H       18  Fri Nov 20 13:02:30 2015</div><div class="line">  .bash_profile                       H      193  Fri Nov 20 13:02:30 2015</div><div class="line">  .bashrc                             H      231  Fri Nov 20 13:02:30 2015</div><div class="line"></div><div class="line">		20961280 blocks of size 1024. 18788264 blocks available</div><div class="line"># 显示的是samba服务器上系统用户tao的共享目录，配置中家目录是允许共享的</div><div class="line">smb: \&gt; pwd</div><div class="line">Current directory is \\192.168.2.152\jack\</div><div class="line"># 上传客户端中的文件发现不能上传，这里要使用当前路径</div><div class="line">smb: \&gt; put /etc/fstab</div><div class="line">NT_STATUS_OBJECT_PATH_NOT_FOUND opening remote file \/etc/fstab</div><div class="line"># 切换到要上传文件的当前目录中</div><div class="line">smb: \&gt; lcd /etc</div><div class="line"># 上传文件,发现可以上传，这是因为系统文件中定义的writable=YES，有写权限，并且tao用户对自己的家目录也有写权限</div><div class="line">smb: \&gt; put fstab</div><div class="line">putting file fstab as \fstab (235.8 kb/s) (average 235.8 kb/s)</div><div class="line">smb: \&gt;</div></pre></td></tr></table></figure></p>
<h3 id="自定义共享服务"><a href="#自定义共享服务" class="headerlink" title="自定义共享服务"></a>自定义共享服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 创建共享目录</span></div><div class="line">[root@centos7 samba]<span class="comment"># mkdir -pv /samba/data</span></div><div class="line">mkdir: created directory ?.samba?</div><div class="line">mkdir: created directory ?.samba/data?</div><div class="line"><span class="comment"># 在主配置文件中添加共享块</span></div><div class="line">[root@centos7 samba]<span class="comment"># vim /etc/samba/smb.conf</span></div><div class="line">[data]</div><div class="line">        comment = share data       <span class="comment"># 说明</span></div><div class="line">        path = /samba/data         <span class="comment"># 本地文件共享系统路径</span></div><div class="line">        browseable = yes           <span class="comment"># 允许非属主，属组浏览</span></div><div class="line">        guest ok = yes             <span class="comment"># 允许来宾访问，即匿名用户</span></div><div class="line">        writeable = yes            <span class="comment"># 允许写操作（如：上传和删除等）</span></div><div class="line"><span class="comment"># 配置好之后保存退出，并测试语法</span></div><div class="line">[root@centos7 samba]<span class="comment"># testparm </span></div><div class="line">Load smb config files from /etc/samba/smb.conf</div><div class="line">rlimit_max: increasing rlimit_max (1024) to minimum Windows <span class="built_in">limit</span> (16384)</div><div class="line">Processing section <span class="string">"[homes]"</span></div><div class="line">Processing section <span class="string">"[printers]"</span></div><div class="line">Processing section <span class="string">"[print$]"</span></div><div class="line">Processing section <span class="string">"[data]"</span></div><div class="line">Loaded services file OK.</div><div class="line">Server role: ROLE_STANDALONE</div><div class="line"></div><div class="line">Press enter to see a dump of your service definitions</div><div class="line"></div><div class="line"><span class="comment"># Global parameters</span></div><div class="line">[global]</div><div class="line">	workgroup = MYGROUP</div><div class="line">	printcap name = cups</div><div class="line">	security = USER</div><div class="line">	idmap config * : backend = tdb</div><div class="line">	cups options = raw</div><div class="line"></div><div class="line"></div><div class="line">[homes]</div><div class="line">	comment = Home Directories</div><div class="line">	browseable = No</div><div class="line">	inherit acls = Yes</div><div class="line">	<span class="built_in">read</span> only = No</div><div class="line">	valid users = %S %D%w%S</div><div class="line"></div><div class="line"></div><div class="line">[printers]</div><div class="line">	comment = All Printers</div><div class="line">	path = /var/tmp</div><div class="line">	browseable = No</div><div class="line">	printable = Yes</div><div class="line">	create mask = 0600</div><div class="line"></div><div class="line"></div><div class="line">[<span class="built_in">print</span>$]</div><div class="line">	comment = Printer Drivers</div><div class="line">	path = /var/lib/samba/drivers</div><div class="line">	create mask = 0664</div><div class="line">	directory mask = 0775</div><div class="line">	write list = root</div><div class="line"></div><div class="line"></div><div class="line">[data]</div><div class="line">	comment = share data</div><div class="line">	path = /samba/data</div><div class="line">	guest ok = Yes</div><div class="line">	<span class="built_in">read</span> only = No</div><div class="line"></div><div class="line"><span class="comment"># 重启服务</span></div><div class="line">[root@centos7 samba]<span class="comment"># systemctl restart smb.service</span></div></pre></td></tr></table></figure>
<p>查看共享服务，并访问<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># smbclient -L 192.168.2.152 -U jack</span></div><div class="line">Enter jack<span class="string">'s password: </span></div><div class="line">Domain=[MYGROUP] OS=[Windows 6.1] Server=[Samba 4.4.4]</div><div class="line"></div><div class="line">	Sharename       Type      Comment</div><div class="line">	---------       ----      -------</div><div class="line">	print$          Disk      Printer Drivers</div><div class="line">	data            Disk      share data</div><div class="line">	IPC$            IPC       IPC Service (Samba 4.4.4)</div><div class="line">	jack            Disk      Home Directories</div><div class="line">Domain=[MYGROUP] OS=[Windows 6.1] Server=[Samba 4.4.4]</div><div class="line"></div><div class="line">	Server               Comment</div><div class="line">	---------            -------</div><div class="line"></div><div class="line">	Workgroup            Master</div><div class="line">	---------            -------</div><div class="line">	SAMBA                CENTOS7</div><div class="line">	WORKGROUP            DESKTOP-80P3796</div></pre></td></tr></table></figure></p>
<p>访问共享服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 匿名用户（来宾账号）可以登录，但是不能上传文件</span></div><div class="line">[root@centos7 ~]<span class="comment"># smbclient //192.168.2.152/data</span></div><div class="line">Enter root<span class="string">'s password: </span></div><div class="line">Anonymous login successful</div><div class="line">Domain=[MYGROUP] OS=[Windows 6.1] Server=[Samba 4.4.4]</div><div class="line">smb: \&gt; ls</div><div class="line">  .                                   D        0  Sat Aug 26 15:01:13 2017</div><div class="line">  ..                                  D        0  Sat Aug 26 15:01:13 2017</div><div class="line"></div><div class="line">		20961280 blocks of size 1024. 18788260 blocks available</div><div class="line">smb: \&gt; lcd /etc</div><div class="line">smb: \&gt; !pwd</div><div class="line">/etc</div><div class="line">smb: \&gt; put fstab</div><div class="line">NT_STATUS_ACCESS_DENIED opening remote file \fstab</div><div class="line"></div><div class="line"># samba账号登录，访问共享服务</div><div class="line">[root@centos7 ~]# smbclient //192.168.2.152/data -U jack</div><div class="line">Enter jack's password: </div><div class="line">Domain=[MYGROUP] OS=[Windows 6.1] Server=[Samba 4.4.4]</div><div class="line">smb: \&gt; ls</div><div class="line">  .                                   D        0  Sat Aug 26 15:01:13 2017</div><div class="line">  ..                                  D        0  Sat Aug 26 15:01:13 2017</div><div class="line"></div><div class="line">		20961280 blocks of size 1024. 18788260 blocks available</div><div class="line">smb: \&gt; <span class="built_in">pwd</span></div><div class="line">Current directory is \\192.168.2.152\data\</div><div class="line">smb: \&gt; lcd /etc</div><div class="line">smb: \&gt; put fstab         <span class="comment"># 不能上传，虽然服务有写权限，但是对目录对文件系统没有写权限</span></div><div class="line">NT_STATUS_ACCESS_DENIED opening remote file \fstab</div><div class="line">[root@centos7 jack]<span class="comment"># ll -d /samba/data</span></div><div class="line">drwxr-xr-x 2 root root 6 Aug 26 15:01 /samba/data</div></pre></td></tr></table></figure></p>
<p>要想使jack用户可以上传和删除文件，除了系统当中的定义的允许写操作外，目录文件系统也要有写权限才可以，仅对jack用户定义如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># setfacl -m u:jack:rwx /samba/data</span></div><div class="line">[root@centos7 ~]<span class="comment"># getfacl /samba/data</span></div><div class="line">getfacl: Removing leading <span class="string">'/'</span> from absolute path names</div><div class="line"><span class="comment"># file: samba/data</span></div><div class="line"><span class="comment"># owner: root</span></div><div class="line"><span class="comment"># group: root</span></div><div class="line">user::rwx</div><div class="line">user:jack:rwx</div><div class="line">group::r-x</div><div class="line">mask::rwx</div><div class="line">other::r-x</div><div class="line"><span class="comment"># 再次访问上传如下</span></div><div class="line">[root@centos7 ~]<span class="comment"># smbclient //192.168.2.152/data -U jack</span></div><div class="line">Enter jack<span class="string">'s password: </span></div><div class="line">Domain=[MYGROUP] OS=[Windows 6.1] Server=[Samba 4.4.4]</div><div class="line">smb: \&gt; ls</div><div class="line">  .                                   D        0  Sat Aug 26 15:01:13 2017</div><div class="line">  ..                                  D        0  Sat Aug 26 15:01:13 2017</div><div class="line"></div><div class="line">		20961280 blocks of size 1024. 18788252 blocks available</div><div class="line">smb: \&gt; lcd /etc</div><div class="line">smb: \&gt; put fstab</div><div class="line">putting file fstab as \fstab (235.8 kb/s) (average 235.8 kb/s)</div><div class="line">smb: \&gt; ls</div><div class="line">  .                                   D        0  Sat Aug 26 15:21:31 2017</div><div class="line">  ..                                  D        0  Sat Aug 26 15:01:13 2017</div><div class="line">  fstab                               A      483  Sat Aug 26 15:21:31 2017</div><div class="line"></div><div class="line">		20961280 blocks of size 1024. 18788244 blocks available</div><div class="line">smb: \&gt; rm fstab</div><div class="line">smb: \&gt; ls</div><div class="line">  .                                   D        0  Sat Aug 26 15:22:11 2017</div><div class="line">  ..                                  D        0  Sat Aug 26 15:01:13 2017</div><div class="line"></div><div class="line">		20961280 blocks of size 1024. 18788288 blocks available</div></pre></td></tr></table></figure></p>
<p>假设现在jack用户和zmj用户都有写操作，即可以向/samba/data上传文件,但是我只想允许让jack有上传权限，zmj用户不可以传，该如何设置呢？<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># setfacl -m u:zmj:rwx /samba/data</span></div><div class="line">[root@centos7 ~]<span class="comment"># getfacl /samba/data</span></div><div class="line">getfacl: Removing leading <span class="string">'/'</span> from absolute path names</div><div class="line"><span class="comment"># file: samba/data</span></div><div class="line"><span class="comment"># owner: root</span></div><div class="line"><span class="comment"># group: root</span></div><div class="line">user::rwx</div><div class="line">user:jack:rwx</div><div class="line">user:zmj:rwx</div><div class="line">group::r-x</div><div class="line">mask::rwx</div><div class="line">other::r-x</div><div class="line">[root@centos7 ~]<span class="comment"># smbclient //192.168.2.152/data -U zmj</span></div><div class="line">Enter zmj<span class="string">'s password: </span></div><div class="line">Domain=[MYGROUP] OS=[Windows 6.1] Server=[Samba 4.4.4]</div><div class="line">smb: \&gt; ls</div><div class="line">  .                                   D        0  Sat Aug 26 15:22:11 2017</div><div class="line">  ..                                  D        0  Sat Aug 26 15:01:13 2017</div><div class="line"></div><div class="line">		20961280 blocks of size 1024. 18788212 blocks available</div><div class="line">smb: \&gt; lcd /etc</div><div class="line">smb: \&gt; put issue</div><div class="line">putting file issue as \issue (22.5 kb/s) (average 22.5 kb/s)</div><div class="line">smb: \&gt; ls</div><div class="line">  .                                   D        0  Sat Aug 26 15:27:29 2017</div><div class="line">  ..                                  D        0  Sat Aug 26 15:01:13 2017</div><div class="line">  issue                               A       23  Sat Aug 26 15:27:29 2017</div><div class="line"></div><div class="line">		20961280 blocks of size 1024. 18788188 blocks available</div><div class="line"></div><div class="line">编辑配置文件/etc/samba/smb.conf</div><div class="line">[data]</div><div class="line">        comment = share data</div><div class="line">        path = /samba/data</div><div class="line">        browseable = yes</div><div class="line">        guest ok = yes</div><div class="line">        write list = jack</div><div class="line"># 把writeable = yes 改成 write list = jack</div><div class="line"></div><div class="line">重启服务：</div><div class="line">[root@centos7 ~]# systemctl restart smb.service</div><div class="line">[root@centos7 ~]# smbclient //192.168.2.152/data -U zmj</div><div class="line">Enter zmj's password: </div><div class="line">Domain=[MYGROUP] OS=[Windows 6.1] Server=[Samba 4.4.4]</div><div class="line">smb: \&gt; ls</div><div class="line">  .                                   D        0  Sat Aug 26 15:27:29 2017</div><div class="line">  ..                                  D        0  Sat Aug 26 15:01:13 2017</div><div class="line">  issue                               A       23  Sat Aug 26 15:27:29 2017</div><div class="line"></div><div class="line">		20961280 blocks of size 1024. 18787936 blocks available</div><div class="line">smb: \&gt; lcd /etc</div><div class="line">smb: \&gt; put fstab        <span class="comment"># 上传失败</span></div><div class="line">NT_STATUS_ACCESS_DENIED opening remote file \fstab</div><div class="line">[root@centos7 ~]<span class="comment"># smbclient //192.168.2.152/data -U jack</span></div><div class="line">Enter jack<span class="string">'s password: </span></div><div class="line">Domain=[MYGROUP] OS=[Windows 6.1] Server=[Samba 4.4.4]</div><div class="line">smb: \&gt; ls</div><div class="line">  .                                   D        0  Sat Aug 26 15:27:29 2017</div><div class="line">  ..                                  D        0  Sat Aug 26 15:01:13 2017</div><div class="line">  issue                               A       23  Sat Aug 26 15:27:29 2017</div><div class="line"></div><div class="line">		20961280 blocks of size 1024. 18788004 blocks available</div><div class="line">smb: \&gt; lcd /etc</div><div class="line">smb: \&gt; put fstab         # 上传成功</div><div class="line">putting file fstab as \fstab (157.2 kb/s) (average 157.2 kb/s)</div></pre></td></tr></table></figure></p>
<h4 id="定义属组，是属组中的用户都有写权限"><a href="#定义属组，是属组中的用户都有写权限" class="headerlink" title="定义属组，是属组中的用户都有写权限"></a>定义属组，是属组中的用户都有写权限</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># groupadd smbgroup</span></div><div class="line">[root@centos7 ~]<span class="comment"># ll -d /samba/data</span></div><div class="line">drwxrwxr-x+ 2 root root 30 Aug 26 15:33 /samba/data</div><div class="line">[root@centos7 ~]<span class="comment"># chgrp smbgroup /samba/data</span></div><div class="line">[root@centos7 ~]<span class="comment"># ll -d /samba/data</span></div><div class="line">drwxrwxr-x+ 2 root smbgroup 30 Aug 26 15:33 /samba/data</div><div class="line">[root@centos7 ~]<span class="comment"># setfacl -b /samba/data</span></div><div class="line">[root@centos7 ~]<span class="comment"># getfacl /samba/data</span></div><div class="line">getfacl: Removing leading <span class="string">'/'</span> from absolute path names</div><div class="line"><span class="comment"># file: samba/data</span></div><div class="line"><span class="comment"># owner: root</span></div><div class="line"><span class="comment"># group: smbgroup</span></div><div class="line">user::rwx</div><div class="line">group::r-x</div><div class="line">other::r-x</div><div class="line">[root@centos7 ~]<span class="comment"># chmod 775 /samba/data</span></div><div class="line">[root@centos7 ~]<span class="comment"># ll -d /samba/data</span></div><div class="line">drwxrwxr-x 2 root smbgroup 30 Aug 26 15:33 /samba/data</div><div class="line">[root@centos7 ~]<span class="comment"># usermod -a -G smbgroup jack</span></div><div class="line">[root@centos7 ~]<span class="comment"># usermod -a -G smbgroup zmj</span></div><div class="line">[root@centos7 ~]<span class="comment"># id jack</span></div><div class="line">uid=1001(jack) gid=1001(jack) groups=1001(jack),1003(smbgroup)</div><div class="line">[root@centos7 ~]<span class="comment"># id zmj</span></div><div class="line">uid=1002(zmj) gid=1002(zmj) groups=1002(zmj),1003(smbgroup)</div></pre></td></tr></table></figure>
<p>编辑配置文件/etc/samba/smb.conf<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># vim /etc/samba/smb.conf</span></div><div class="line">[data]</div><div class="line">        comment = share data</div><div class="line">        path = /samba/data</div><div class="line">        browseable = yes</div><div class="line">        guest ok = yes</div><div class="line">        write list = +smbgroup</div><div class="line"><span class="comment"># 这里的+smbgroup也可以写成@smbgroup</span></div><div class="line"><span class="comment"># 重启samba服务</span></div><div class="line">[root@centos7 ~]<span class="comment"># systemctl restart smb</span></div><div class="line"><span class="comment"># 测试</span></div><div class="line">[root@centos7 ~]<span class="comment"># smbclient //192.168.2.152/data -U zmj</span></div><div class="line">Enter zmj<span class="string">'s password: </span></div><div class="line">Domain=[MYGROUP] OS=[Windows 6.1] Server=[Samba 4.4.4]</div><div class="line">smb: \&gt; ls</div><div class="line">  .                                   D        0  Sat Aug 26 15:33:45 2017</div><div class="line">  ..                                  D        0  Sat Aug 26 15:01:13 2017</div><div class="line">  issue                               A       23  Sat Aug 26 15:27:29 2017</div><div class="line">  fstab                               A      483  Sat Aug 26 15:33:45 2017</div><div class="line"></div><div class="line">		20961280 blocks of size 1024. 18788116 blocks available</div><div class="line">smb: \&gt; rm issue         # 可以删除</div><div class="line">smb: \&gt; ls</div><div class="line">  .                                   D        0  Sat Aug 26 15:51:38 2017</div><div class="line">  ..                                  D        0  Sat Aug 26 15:01:13 2017</div><div class="line">  fstab                               A      483  Sat Aug 26 15:33:45 2017</div><div class="line"></div><div class="line">		20961280 blocks of size 1024. 18788172 blocks available</div><div class="line">smb: \&gt; lcd /etc</div><div class="line">smb: \&gt; put issue        # 可以上传</div><div class="line">putting file issue as \issue (22.5 kb/s) (average 22.5 kb/s)</div></pre></td></tr></table></figure></p>
<h4 id="使用mount-cifs访问"><a href="#使用mount-cifs访问" class="headerlink" title="使用mount.cifs访问"></a>使用mount.cifs访问</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 使用mount -t cifs(mount.cifs)方式指明smb服务器，共享目录，以及使用登陆的系统用户和密码</span></div><div class="line">[root@centos7 ~]<span class="comment"># mount -t cifs //192.168.2.152/data/ /mnt -o username=zmj,password=zmj</span></div><div class="line">[root@centos7 ~]<span class="comment"># df -h</span></div><div class="line">Filesystem             Size  Used Avail Use% Mounted on</div><div class="line">/dev/mapper/vgos-root   20G  1.8G   19G   9% /</div><div class="line">devtmpfs               479M     0  479M   0% /dev</div><div class="line">tmpfs                  489M     0  489M   0% /dev/shm</div><div class="line">tmpfs                  489M  6.7M  483M   2% /run</div><div class="line">tmpfs                  489M     0  489M   0% /sys/fs/cgroup</div><div class="line">/dev/sda1              497M  108M  390M  22% /boot</div><div class="line">tmpfs                   98M     0   98M   0% /run/user/0</div><div class="line">//192.168.2.152/data/   20G  2.1G   18G  11% /mnt</div><div class="line">[root@centos7 ~]<span class="comment"># cd /mnt</span></div><div class="line">[root@centos7 mnt]<span class="comment"># ls</span></div><div class="line">fstab  issue</div><div class="line">[root@centos7 mnt]<span class="comment"># echo "zmjzmj" &gt; test.txt        # 可见客户端的root用户对挂载点/mnt有写权限</span></div><div class="line">[root@centos7 mnt]<span class="comment"># ls</span></div><div class="line">fstab  issue  test.txt</div><div class="line">[root@centos7 mnt]<span class="comment"># cat test.txt </span></div><div class="line">zmjzmj</div><div class="line">[root@centos7 mnt]<span class="comment"># su - jack         # 切换到一个普通用户</span></div><div class="line">jack@centos7 ~]$ <span class="built_in">cd</span> /mnt</div><div class="line">[jack@centos7 mnt]$ ls</div><div class="line">fstab  issue  test.txt</div><div class="line">[jack@centos7 mnt]$ cat test.txt </div><div class="line">zmjzmj</div><div class="line">[jack@centos7 mnt]$ <span class="built_in">echo</span> <span class="string">"123"</span> &gt;&gt; test.txt   <span class="comment"># 虽然在服务端系统用户有写权限（包括文件系统），但客户单普通用户对挂载点没有写权限</span></div><div class="line">-bash: test.txt: Permission denied</div></pre></td></tr></table></figure>
<p>既然如此，我们就在本地创建一个目录/data/专门作为挂载点，并赋予本地jack用户rwx权限，看能否写进去，如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># mkdir -pv /data</span></div><div class="line"><span class="comment"># 使jack用户对此目录有rwx权限</span></div><div class="line">[root@centos7 ~]<span class="comment"># setfacl -m u:jack:rwx /data</span></div><div class="line">[root@centos7 ~]<span class="comment"># getfacl /data</span></div><div class="line">getfacl: Removing leading <span class="string">'/'</span> from absolute path names</div><div class="line"><span class="comment"># file: data</span></div><div class="line"><span class="comment"># owner: root</span></div><div class="line"><span class="comment"># group: root</span></div><div class="line">user::rwx</div><div class="line">user:jack:rwx</div><div class="line">group::r-x</div><div class="line">mask::rwx</div><div class="line">other::r-x</div><div class="line"><span class="comment"># 挂载到/data/apps，切换到jack用户，看能否写</span></div><div class="line">[root@centos7 ~]<span class="comment"># mount -t cifs //192.168.2.152/data/ /data -o username=zmj,password=zmj</span></div><div class="line">[root@centos7 ~]<span class="comment"># df -h</span></div><div class="line">Filesystem             Size  Used Avail Use% Mounted on</div><div class="line">/dev/mapper/vgos-root   20G  1.8G   19G   9% /</div><div class="line">devtmpfs               479M     0  479M   0% /dev</div><div class="line">tmpfs                  489M     0  489M   0% /dev/shm</div><div class="line">tmpfs                  489M  6.7M  483M   2% /run</div><div class="line">tmpfs                  489M     0  489M   0% /sys/fs/cgroup</div><div class="line">/dev/sda1              497M  108M  390M  22% /boot</div><div class="line">tmpfs                   98M     0   98M   0% /run/user/0</div><div class="line">/dev/sr0               7.3G  7.3G     0 100% /mnt/cdrom</div><div class="line">//192.168.2.152/data/   20G  2.1G   18G  11% /data</div><div class="line">[root@centos7 ~]<span class="comment"># cd /data</span></div><div class="line">[root@centos7 data]<span class="comment"># ls</span></div><div class="line">fstab  issue  test.txt</div><div class="line">[root@centos7 data]<span class="comment"># ll</span></div><div class="line">total 12</div><div class="line">-rwxr--r-- 1 1001 1001 483 Aug 26 15:33 fstab</div><div class="line">-rwxr--r-- 1 1002 1002  23 Aug 26 15:52 issue</div><div class="line">-rw-r--r-- 1 1002 1002   7 Aug 26 15:55 test.txt</div><div class="line">[root@centos7 data]<span class="comment"># su - jack</span></div><div class="line">[jack@centos7 ~]$ <span class="built_in">cd</span> /data</div><div class="line">[jack@centos7 data]$ ll</div><div class="line">total 12</div><div class="line">-rwxr--r-- 1 1001 1001 483 Aug 26 15:33 fstab</div><div class="line">-rwxr--r-- 1 1002 1002  23 Aug 26 15:52 issue</div><div class="line">-rw-r--r-- 1 1002 1002   7 Aug 26 15:55 test.txt</div><div class="line">[jack@centos7 data]$ <span class="built_in">echo</span> 456 &gt;&gt; test.txt </div><div class="line">-bash: test.txt: Permission denied          <span class="comment"># 权限被拒绝</span></div></pre></td></tr></table></figure></p>
<p>如上，我们发现还是被拒绝，这到底是为什么呢？这是因为远程和客户端用的是id映射，和用户名无关，只和id号有关<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 客户端查看samba共享文件的属主</span></div><div class="line">[root@centos7 data]<span class="comment"># ll</span></div><div class="line">total 12</div><div class="line">-rwxr--r-- 1 1001 1001 483 Aug 26 15:33 fstab</div><div class="line">-rwxr--r-- 1 1002 1002  23 Aug 26 15:52 issue</div><div class="line">-rw-r--r-- 1 1002 1002   7 Aug 26 15:55 test.txt</div><div class="line"><span class="comment"># 再查看jack的id号</span></div><div class="line">[root@centos7 data]<span class="comment"># id jack</span></div><div class="line">uid=1041(jack) gid=1041(jack) groups=1041(jack)</div><div class="line"><span class="comment"># 查看samba端用户和其共享的文件</span></div><div class="line">[root@centos7 ~]<span class="comment"># id zmj</span></div><div class="line">uid=1002(zmj) gid=1002(zmj) groups=1002(zmj),1003(smbgroup)</div><div class="line">[root@centos7 ~]<span class="comment"># ll /samba/data</span></div><div class="line">total 12</div><div class="line">-rwxr--r-- 1 jack jack 483 Aug 26 15:33 fstab</div><div class="line">-rwxr--r-- 1 zmj  zmj   23 Aug 26 15:52 issue</div><div class="line">-rw-r--r-- 1 zmj  zmj    7 Aug 26 15:55 test.txt</div><div class="line"><span class="comment"># 客户端建一个和共享用户一样的ID号的用户</span></div><div class="line">[root@centos7 data]<span class="comment"># useradd -u 1002 zhou    # 创建一个同服务端属主id号相同的用户</span></div><div class="line">[root@centos7 data]<span class="comment"># id zhou</span></div><div class="line">uid=1002(zhou) gid=1002(zhou) groups=1002(zhou)</div><div class="line">[root@centos7 data]<span class="comment"># su - zhou</span></div><div class="line">[zhou@centos7 ~]$ <span class="built_in">cd</span> /data</div><div class="line">[zhou@centos7 data]$ ll</div><div class="line">total 12</div><div class="line">-rwxr--r-- 1 1001 1001 483 Aug 26 15:33 fstab</div><div class="line">-rwxr--r-- 1 zhou zhou  23 Aug 26 15:52 issue</div><div class="line">-rw-r--r-- 1 zhou zhou   7 Aug 26 15:55 test.txt</div><div class="line">[zhou@centos7 data]$ <span class="built_in">echo</span> 456 &gt;&gt; test.txt   <span class="comment"># 写操作成功</span></div><div class="line">[zhou@centos7 data]$ cat test.txt </div><div class="line">zmjzmj</div><div class="line">456</div></pre></td></tr></table></figure></p>
<p>总结：<br>&ensp;&ensp;&ensp;&ensp;1.用户要想对共享的文件有写权限，受限于两个方面的因素：一是，共享文件服务器（ftp，samba）是否允许匿名用户或者系统账号有写权限；另一个方面用户对共享文件的文件系统是否有写权限；只有二者同时满足，用户才有写权限，才可以在共享文件目录中上传删除文件；<br>&ensp;&ensp;&ensp;&ensp;2.对于smaba服务中，使用mount.cifs 挂载操作中的用户，-o选项中指定的用户直接产生映射关系；访问挂载，是以-o选项指定的用户身份运行，与本地用户以ID产生映射,即必须使本地用户的id号和-o选项指定用户的id号相同才可以执行写操作（上面的第一点也要满足）。</p>
<h4 id="smbstatus命令："><a href="#smbstatus命令：" class="headerlink" title="smbstatus命令："></a>smbstatus命令：</h4><p>★显示samba服务的相关共享的访问状态信息；<br>&ensp;&ensp;&ensp;&ensp;-b：显示简要格式信息；<br>&ensp;&ensp;&ensp;&ensp;-v：显示详细格式信息；<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># smbstatus </span></div><div class="line"></div><div class="line">Samba version 4.4.4</div><div class="line">PID     Username     Group        Machine                                   Protocol Version  Encryption           Signing              </div><div class="line">----------------------------------------------------------------------------------------------------------------------------------------                             </div><div class="line">3307    zmj          zmj          192.168.2.149 (ipv4:192.168.2.149:58691)  NT1               -                    -                    </div><div class="line"></div><div class="line">Service      pid     Machine       Connected at                     Encryption   Signing     </div><div class="line">---------------------------------------------------------------------------------------------</div><div class="line">data         3307    192.168.2.149 Sat Aug 26 04:07:54 PM 2017 CST  -            -           </div><div class="line">IPC$         3307    192.168.2.149 Sat Aug 26 04:07:54 PM 2017 CST  -            -           </div><div class="line"></div><div class="line">No locked files</div></pre></td></tr></table></figure></p>
<p>简要显示 -b，和详细显示-v<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment"># smbstatus -b</span></div><div class="line"></div><div class="line">Samba version 4.4.4</div><div class="line">PID     Username     Group        Machine                                   Protocol Version  Encryption           Signing              </div><div class="line">----------------------------------------------------------------------------------------------------------------------------------------</div><div class="line">3307    zmj          zmj          192.168.2.149 (ipv4:192.168.2.149:58691)  NT1               -                    -                    </div><div class="line">[root@centos7 ~]<span class="comment"># smbstatus -v</span></div><div class="line">using configfile = /etc/samba/smb.conf</div><div class="line"></div><div class="line">Samba version 4.4.4</div><div class="line">PID     Username     Group        Machine                                   Protocol Version  Encryption           Signing              </div><div class="line">----------------------------------------------------------------------------------------------------------------------------------------</div><div class="line">3307    zmj          zmj          192.168.2.149 (ipv4:192.168.2.149:58691)  NT1               -                    -                    </div><div class="line"></div><div class="line">Service      pid     Machine       Connected at                     Encryption   Signing     </div><div class="line">---------------------------------------------------------------------------------------------</div><div class="line">data         3307    192.168.2.149 Sat Aug 26 04:07:54 PM 2017 CST  -            -           </div><div class="line">IPC$         3307    192.168.2.149 Sat Aug 26 04:07:54 PM 2017 CST  -            -           </div><div class="line"></div><div class="line">No locked files</div></pre></td></tr></table></figure></p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color2">liunx文件共享服务</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2017/08/18/linux服务之samba/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>





  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/6/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><a class="page-number" href="/page/9/">9</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/8/">Next &raquo;</a>
    </nav>
  


          </div>
        </div>
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2018 Jack_zhou
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		mathjax: false,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/",
		innerArchive: true,
		showTags: false
	}
</script>

<script>!function(t){function n(r){if(e[r])return e[r].exports;var o=e[r]={exports:{},id:r,loaded:!1};return t[r].call(o.exports,o,o.exports,n),o.loaded=!0,o.exports}var e={};return n.m=t,n.c=e,n.p="./",n(0)}([function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,n){var e=/\/|index.html/g;return t.replace(e,"")===n.replace(e,"")}function i(){for(var t=document.querySelectorAll(".js-header-menu li a"),n=window.location.pathname,e=0,r=t.length;e<r;e++){var i=t[e];o(n,i.getAttribute("href"))&&(0,d.default)(i,"active")}}function u(t){for(var n=t.offsetLeft,e=t.offsetParent;null!==e;)n+=e.offsetLeft,e=e.offsetParent;return n}function f(t){for(var n=t.offsetTop,e=t.offsetParent;null!==e;)n+=e.offsetTop,e=e.offsetParent;return n}function c(t,n,e,r,o){var i=u(t),c=f(t)-n;if(c-e<=o){var a=t.$newDom;a||(a=t.cloneNode(!0),(0,h.default)(t,a),t.$newDom=a,a.style.position="fixed",a.style.top=(e||c)+"px",a.style.left=i+"px",a.style.zIndex=r||2,a.style.width="100%",a.style.color="#fff"),a.style.visibility="visible",t.style.visibility="hidden"}else{t.style.visibility="visible";var s=t.$newDom;s&&(s.style.visibility="hidden")}}function a(){var t=document.querySelector(".js-overlay"),n=document.querySelector(".js-header-menu");c(t,document.body.scrollTop,-63,2,0),c(n,document.body.scrollTop,1,3,0)}function s(){document.querySelector("#container").addEventListener("scroll",function(t){a()}),window.addEventListener("scroll",function(t){a()}),a()}function l(){x.default.versions.mobile&&window.screen.width<800&&(i(),s())}var p=e(71),d=r(p),v=e(72),y=(r(v),e(84)),h=r(y),b=e(69),x=r(b),g=e(75),m=r(g),w=e(70);l(),(0,w.addLoadEvent)(function(){m.default.init()}),t.exports={}},function(t,n){var e=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=e)},function(t,n){var e={}.hasOwnProperty;t.exports=function(t,n){return e.call(t,n)}},function(t,n,e){var r=e(49),o=e(15);t.exports=function(t){return r(o(t))}},function(t,n,e){t.exports=!e(8)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,e){var r=e(6),o=e(12);t.exports=e(4)?function(t,n,e){return r.f(t,n,o(1,e))}:function(t,n,e){return t[n]=e,t}},function(t,n,e){var r=e(10),o=e(30),i=e(24),u=Object.defineProperty;n.f=e(4)?Object.defineProperty:function(t,n,e){if(r(t),n=i(n,!0),r(e),o)try{return u(t,n,e)}catch(t){}if("get"in e||"set"in e)throw TypeError("Accessors not supported!");return"value"in e&&(t[n]=e.value),t}},function(t,n,e){var r=e(22)("wks"),o=e(13),i=e(1).Symbol,u="function"==typeof i,f=t.exports=function(t){return r[t]||(r[t]=u&&i[t]||(u?i:o)("Symbol."+t))};f.store=r},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n,e){var r=e(35),o=e(16);t.exports=Object.keys||function(t){return r(t,o)}},function(t,n,e){var r=e(11);t.exports=function(t){if(!r(t))throw TypeError(t+" is not an object!");return t}},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var e=0,r=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++e+r).toString(36))}},function(t,n){var e=t.exports={version:"2.4.0"};"number"==typeof __e&&(__e=e)},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n){t.exports={}},function(t,n){t.exports=!0},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,e){var r=e(6).f,o=e(2),i=e(7)("toStringTag");t.exports=function(t,n,e){t&&!o(t=e?t:t.prototype,i)&&r(t,i,{configurable:!0,value:n})}},function(t,n,e){var r=e(22)("keys"),o=e(13);t.exports=function(t){return r[t]||(r[t]=o(t))}},function(t,n,e){var r=e(1),o="__core-js_shared__",i=r[o]||(r[o]={});t.exports=function(t){return i[t]||(i[t]={})}},function(t,n){var e=Math.ceil,r=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?r:e)(t)}},function(t,n,e){var r=e(11);t.exports=function(t,n){if(!r(t))return t;var e,o;if(n&&"function"==typeof(e=t.toString)&&!r(o=e.call(t)))return o;if("function"==typeof(e=t.valueOf)&&!r(o=e.call(t)))return o;if(!n&&"function"==typeof(e=t.toString)&&!r(o=e.call(t)))return o;throw TypeError("Can't convert object to primitive value")}},function(t,n,e){var r=e(1),o=e(14),i=e(18),u=e(26),f=e(6).f;t.exports=function(t){var n=o.Symbol||(o.Symbol=i?{}:r.Symbol||{});"_"==t.charAt(0)||t in n||f(n,t,{value:u.f(t)})}},function(t,n,e){n.f=e(7)},function(t,n,e){var r=e(1),o=e(14),i=e(46),u=e(5),f="prototype",c=function(t,n,e){var a,s,l,p=t&c.F,d=t&c.G,v=t&c.S,y=t&c.P,h=t&c.B,b=t&c.W,x=d?o:o[n]||(o[n]={}),g=x[f],m=d?r:v?r[n]:(r[n]||{})[f];d&&(e=n);for(a in e)s=!p&&m&&void 0!==m[a],s&&a in x||(l=s?m[a]:e[a],x[a]=d&&"function"!=typeof m[a]?e[a]:h&&s?i(l,r):b&&m[a]==l?function(t){var n=function(n,e,r){if(this instanceof t){switch(arguments.length){case 0:return new t;case 1:return new t(n);case 2:return new t(n,e)}return new t(n,e,r)}return t.apply(this,arguments)};return n[f]=t[f],n}(l):y&&"function"==typeof l?i(Function.call,l):l,y&&((x.virtual||(x.virtual={}))[a]=l,t&c.R&&g&&!g[a]&&u(g,a,l)))};c.F=1,c.G=2,c.S=4,c.P=8,c.B=16,c.W=32,c.U=64,c.R=128,t.exports=c},function(t,n){var e={}.toString;t.exports=function(t){return e.call(t).slice(8,-1)}},function(t,n,e){var r=e(11),o=e(1).document,i=r(o)&&r(o.createElement);t.exports=function(t){return i?o.createElement(t):{}}},function(t,n,e){t.exports=!e(4)&&!e(8)(function(){return 7!=Object.defineProperty(e(29)("div"),"a",{get:function(){return 7}}).a})},function(t,n,e){"use strict";var r=e(18),o=e(27),i=e(36),u=e(5),f=e(2),c=e(17),a=e(51),s=e(20),l=e(58),p=e(7)("iterator"),d=!([].keys&&"next"in[].keys()),v="@@iterator",y="keys",h="values",b=function(){return this};t.exports=function(t,n,e,x,g,m,w){a(e,n,x);var O,S,_,j=function(t){if(!d&&t in A)return A[t];switch(t){case y:return function(){return new e(this,t)};case h:return function(){return new e(this,t)}}return function(){return new e(this,t)}},P=n+" Iterator",E=g==h,M=!1,A=t.prototype,T=A[p]||A[v]||g&&A[g],L=T||j(g),N=g?E?j("entries"):L:void 0,C="Array"==n?A.entries||T:T;if(C&&(_=l(C.call(new t)),_!==Object.prototype&&(s(_,P,!0),r||f(_,p)||u(_,p,b))),E&&T&&T.name!==h&&(M=!0,L=function(){return T.call(this)}),r&&!w||!d&&!M&&A[p]||u(A,p,L),c[n]=L,c[P]=b,g)if(O={values:E?L:j(h),keys:m?L:j(y),entries:N},w)for(S in O)S in A||i(A,S,O[S]);else o(o.P+o.F*(d||M),n,O);return O}},function(t,n,e){var r=e(10),o=e(55),i=e(16),u=e(21)("IE_PROTO"),f=function(){},c="prototype",a=function(){var t,n=e(29)("iframe"),r=i.length,o="<",u=">";for(n.style.display="none",e(48).appendChild(n),n.src="javascript:",t=n.contentWindow.document,t.open(),t.write(o+"script"+u+"document.F=Object"+o+"/script"+u),t.close(),a=t.F;r--;)delete a[c][i[r]];return a()};t.exports=Object.create||function(t,n){var e;return null!==t?(f[c]=r(t),e=new f,f[c]=null,e[u]=t):e=a(),void 0===n?e:o(e,n)}},function(t,n,e){var r=e(35),o=e(16).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return r(t,o)}},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,e){var r=e(2),o=e(3),i=e(45)(!1),u=e(21)("IE_PROTO");t.exports=function(t,n){var e,f=o(t),c=0,a=[];for(e in f)e!=u&&r(f,e)&&a.push(e);for(;n.length>c;)r(f,e=n[c++])&&(~i(a,e)||a.push(e));return a}},function(t,n,e){t.exports=e(5)},function(t,n,e){var r=e(15);t.exports=function(t){return Object(r(t))}},function(t,n,e){t.exports={default:e(41),__esModule:!0}},function(t,n,e){t.exports={default:e(42),__esModule:!0}},function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}n.__esModule=!0;var o=e(39),i=r(o),u=e(38),f=r(u),c="function"==typeof f.default&&"symbol"==typeof i.default?function(t){return typeof t}:function(t){return t&&"function"==typeof f.default&&t.constructor===f.default&&t!==f.default.prototype?"symbol":typeof t};n.default="function"==typeof f.default&&"symbol"===c(i.default)?function(t){return"undefined"==typeof t?"undefined":c(t)}:function(t){return t&&"function"==typeof f.default&&t.constructor===f.default&&t!==f.default.prototype?"symbol":"undefined"==typeof t?"undefined":c(t)}},function(t,n,e){e(65),e(63),e(66),e(67),t.exports=e(14).Symbol},function(t,n,e){e(64),e(68),t.exports=e(26).f("iterator")},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n){t.exports=function(){}},function(t,n,e){var r=e(3),o=e(61),i=e(60);t.exports=function(t){return function(n,e,u){var f,c=r(n),a=o(c.length),s=i(u,a);if(t&&e!=e){for(;a>s;)if(f=c[s++],f!=f)return!0}else for(;a>s;s++)if((t||s in c)&&c[s]===e)return t||s||0;return!t&&-1}}},function(t,n,e){var r=e(43);t.exports=function(t,n,e){if(r(t),void 0===n)return t;switch(e){case 1:return function(e){return t.call(n,e)};case 2:return function(e,r){return t.call(n,e,r)};case 3:return function(e,r,o){return t.call(n,e,r,o)}}return function(){return t.apply(n,arguments)}}},function(t,n,e){var r=e(9),o=e(34),i=e(19);t.exports=function(t){var n=r(t),e=o.f;if(e)for(var u,f=e(t),c=i.f,a=0;f.length>a;)c.call(t,u=f[a++])&&n.push(u);return n}},function(t,n,e){t.exports=e(1).document&&document.documentElement},function(t,n,e){var r=e(28);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==r(t)?t.split(""):Object(t)}},function(t,n,e){var r=e(28);t.exports=Array.isArray||function(t){return"Array"==r(t)}},function(t,n,e){"use strict";var r=e(32),o=e(12),i=e(20),u={};e(5)(u,e(7)("iterator"),function(){return this}),t.exports=function(t,n,e){t.prototype=r(u,{next:o(1,e)}),i(t,n+" Iterator")}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n,e){var r=e(9),o=e(3);t.exports=function(t,n){for(var e,i=o(t),u=r(i),f=u.length,c=0;f>c;)if(i[e=u[c++]]===n)return e}},function(t,n,e){var r=e(13)("meta"),o=e(11),i=e(2),u=e(6).f,f=0,c=Object.isExtensible||function(){return!0},a=!e(8)(function(){return c(Object.preventExtensions({}))}),s=function(t){u(t,r,{value:{i:"O"+ ++f,w:{}}})},l=function(t,n){if(!o(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!i(t,r)){if(!c(t))return"F";if(!n)return"E";s(t)}return t[r].i},p=function(t,n){if(!i(t,r)){if(!c(t))return!0;if(!n)return!1;s(t)}return t[r].w},d=function(t){return a&&v.NEED&&c(t)&&!i(t,r)&&s(t),t},v=t.exports={KEY:r,NEED:!1,fastKey:l,getWeak:p,onFreeze:d}},function(t,n,e){var r=e(6),o=e(10),i=e(9);t.exports=e(4)?Object.defineProperties:function(t,n){o(t);for(var e,u=i(n),f=u.length,c=0;f>c;)r.f(t,e=u[c++],n[e]);return t}},function(t,n,e){var r=e(19),o=e(12),i=e(3),u=e(24),f=e(2),c=e(30),a=Object.getOwnPropertyDescriptor;n.f=e(4)?a:function(t,n){if(t=i(t),n=u(n,!0),c)try{return a(t,n)}catch(t){}if(f(t,n))return o(!r.f.call(t,n),t[n])}},function(t,n,e){var r=e(3),o=e(33).f,i={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],f=function(t){try{return o(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==i.call(t)?f(t):o(r(t))}},function(t,n,e){var r=e(2),o=e(37),i=e(21)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=o(t),r(t,i)?t[i]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n,e){var r=e(23),o=e(15);t.exports=function(t){return function(n,e){var i,u,f=String(o(n)),c=r(e),a=f.length;return c<0||c>=a?t?"":void 0:(i=f.charCodeAt(c),i<55296||i>56319||c+1===a||(u=f.charCodeAt(c+1))<56320||u>57343?t?f.charAt(c):i:t?f.slice(c,c+2):(i-55296<<10)+(u-56320)+65536)}}},function(t,n,e){var r=e(23),o=Math.max,i=Math.min;t.exports=function(t,n){return t=r(t),t<0?o(t+n,0):i(t,n)}},function(t,n,e){var r=e(23),o=Math.min;t.exports=function(t){return t>0?o(r(t),9007199254740991):0}},function(t,n,e){"use strict";var r=e(44),o=e(52),i=e(17),u=e(3);t.exports=e(31)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,e=this._i++;return!t||e>=t.length?(this._t=void 0,o(1)):"keys"==n?o(0,e):"values"==n?o(0,t[e]):o(0,[e,t[e]])},"values"),i.Arguments=i.Array,r("keys"),r("values"),r("entries")},function(t,n){},function(t,n,e){"use strict";var r=e(59)(!0);e(31)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,e=this._i;return e>=n.length?{value:void 0,done:!0}:(t=r(n,e),this._i+=t.length,{value:t,done:!1})})},function(t,n,e){"use strict";var r=e(1),o=e(2),i=e(4),u=e(27),f=e(36),c=e(54).KEY,a=e(8),s=e(22),l=e(20),p=e(13),d=e(7),v=e(26),y=e(25),h=e(53),b=e(47),x=e(50),g=e(10),m=e(3),w=e(24),O=e(12),S=e(32),_=e(57),j=e(56),P=e(6),E=e(9),M=j.f,A=P.f,T=_.f,L=r.Symbol,N=r.JSON,C=N&&N.stringify,k="prototype",F=d("_hidden"),q=d("toPrimitive"),I={}.propertyIsEnumerable,B=s("symbol-registry"),D=s("symbols"),W=s("op-symbols"),H=Object[k],K="function"==typeof L,R=r.QObject,J=!R||!R[k]||!R[k].findChild,U=i&&a(function(){return 7!=S(A({},"a",{get:function(){return A(this,"a",{value:7}).a}})).a})?function(t,n,e){var r=M(H,n);r&&delete H[n],A(t,n,e),r&&t!==H&&A(H,n,r)}:A,G=function(t){var n=D[t]=S(L[k]);return n._k=t,n},$=K&&"symbol"==typeof L.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof L},z=function(t,n,e){return t===H&&z(W,n,e),g(t),n=w(n,!0),g(e),o(D,n)?(e.enumerable?(o(t,F)&&t[F][n]&&(t[F][n]=!1),e=S(e,{enumerable:O(0,!1)})):(o(t,F)||A(t,F,O(1,{})),t[F][n]=!0),U(t,n,e)):A(t,n,e)},Y=function(t,n){g(t);for(var e,r=b(n=m(n)),o=0,i=r.length;i>o;)z(t,e=r[o++],n[e]);return t},Q=function(t,n){return void 0===n?S(t):Y(S(t),n)},X=function(t){var n=I.call(this,t=w(t,!0));return!(this===H&&o(D,t)&&!o(W,t))&&(!(n||!o(this,t)||!o(D,t)||o(this,F)&&this[F][t])||n)},V=function(t,n){if(t=m(t),n=w(n,!0),t!==H||!o(D,n)||o(W,n)){var e=M(t,n);return!e||!o(D,n)||o(t,F)&&t[F][n]||(e.enumerable=!0),e}},Z=function(t){for(var n,e=T(m(t)),r=[],i=0;e.length>i;)o(D,n=e[i++])||n==F||n==c||r.push(n);return r},tt=function(t){for(var n,e=t===H,r=T(e?W:m(t)),i=[],u=0;r.length>u;)!o(D,n=r[u++])||e&&!o(H,n)||i.push(D[n]);return i};K||(L=function(){if(this instanceof L)throw TypeError("Symbol is not a constructor!");var t=p(arguments.length>0?arguments[0]:void 0),n=function(e){this===H&&n.call(W,e),o(this,F)&&o(this[F],t)&&(this[F][t]=!1),U(this,t,O(1,e))};return i&&J&&U(H,t,{configurable:!0,set:n}),G(t)},f(L[k],"toString",function(){return this._k}),j.f=V,P.f=z,e(33).f=_.f=Z,e(19).f=X,e(34).f=tt,i&&!e(18)&&f(H,"propertyIsEnumerable",X,!0),v.f=function(t){return G(d(t))}),u(u.G+u.W+u.F*!K,{Symbol:L});for(var nt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),et=0;nt.length>et;)d(nt[et++]);for(var nt=E(d.store),et=0;nt.length>et;)y(nt[et++]);u(u.S+u.F*!K,"Symbol",{for:function(t){return o(B,t+="")?B[t]:B[t]=L(t)},keyFor:function(t){if($(t))return h(B,t);throw TypeError(t+" is not a symbol!")},useSetter:function(){J=!0},useSimple:function(){J=!1}}),u(u.S+u.F*!K,"Object",{create:Q,defineProperty:z,defineProperties:Y,getOwnPropertyDescriptor:V,getOwnPropertyNames:Z,getOwnPropertySymbols:tt}),N&&u(u.S+u.F*(!K||a(function(){var t=L();return"[null]"!=C([t])||"{}"!=C({a:t})||"{}"!=C(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!$(t)){for(var n,e,r=[t],o=1;arguments.length>o;)r.push(arguments[o++]);return n=r[1],"function"==typeof n&&(e=n),!e&&x(n)||(n=function(t,n){if(e&&(n=e.call(this,t,n)),!$(n))return n}),r[1]=n,C.apply(N,r)}}}),L[k][q]||e(5)(L[k],q,L[k].valueOf),l(L,"Symbol"),l(Math,"Math",!0),l(r.JSON,"JSON",!0)},function(t,n,e){e(25)("asyncIterator")},function(t,n,e){e(25)("observable")},function(t,n,e){e(62);for(var r=e(1),o=e(5),i=e(17),u=e(7)("toStringTag"),f=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],c=0;c<5;c++){var a=f[c],s=r[a],l=s&&s.prototype;l&&!l[u]&&o(l,u,a),i[a]=i.Array}},function(t,n){"use strict";var e={versions:function(){var t=window.navigator.userAgent;return{trident:t.indexOf("Trident")>-1,presto:t.indexOf("Presto")>-1,webKit:t.indexOf("AppleWebKit")>-1,gecko:t.indexOf("Gecko")>-1&&t.indexOf("KHTML")==-1,mobile:!!t.match(/AppleWebKit.*Mobile.*/),ios:!!t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:t.indexOf("Android")>-1||t.indexOf("Linux")>-1,iPhone:t.indexOf("iPhone")>-1||t.indexOf("Mac")>-1,iPad:t.indexOf("iPad")>-1,webApp:t.indexOf("Safari")==-1,weixin:t.indexOf("MicroMessenger")==-1}}()};t.exports=e},function(t,n,e){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}var o=e(40),i=r(o),u=function(){function t(t,n,e){return n||e?String.fromCharCode(n||e):o[t]||t}function n(t){return l[t]}var e=/&quot;|&lt;|&gt;|&amp;|&nbsp;|&apos;|&#(\d+);|&#(\d+)/g,r=/['<> "&]/g,o={"&quot;":'"',"&lt;":"<","&gt;":">","&amp;":"&","&nbsp;":" "},f=/\u00a0/g,c=/<br\s*\/?>/gi,a=/\r?\n/g,s=/\s/g,l={};for(var p in o)l[o[p]]=p;return o["&apos;"]="'",l["'"]="&#39;",{encode:function(t){return t?(""+t).replace(r,n).replace(a,"<br/>").replace(s,"&nbsp;"):""},decode:function(n){return n?(""+n).replace(c,"\n").replace(e,t).replace(f," "):""},encodeBase16:function(t){if(!t)return t;t+="";for(var n=[],e=0,r=t.length;r>e;e++)n.push(t.charCodeAt(e).toString(16).toUpperCase());return n.join("")},encodeBase16forJSON:function(t){if(!t)return t;t=t.replace(/[\u4E00-\u9FBF]/gi,function(t){return escape(t).replace("%u","\\u")});for(var n=[],e=0,r=t.length;r>e;e++)n.push(t.charCodeAt(e).toString(16).toUpperCase());return n.join("")},decodeBase16:function(t){if(!t)return t;t+="";for(var n=[],e=0,r=t.length;r>e;e+=2)n.push(String.fromCharCode("0x"+t.slice(e,e+2)));return n.join("")},encodeObject:function(t){if(t instanceof Array)for(var n=0,e=t.length;e>n;n++)t[n]=u.encodeObject(t[n]);else if("object"==("undefined"==typeof t?"undefined":(0,i.default)(t)))for(var r in t)t[r]=u.encodeObject(t[r]);else if("string"==typeof t)return u.encode(t);return t},loadScript:function(t){var n=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(n),n.setAttribute("src",t)},addLoadEvent:function(t){var n=window.onload;"function"!=typeof window.onload?window.onload=t:window.onload=function(){n(),t()}}}}();t.exports=u},function(t,n){function e(t,n){t.classList?t.classList.add(n):t.className+=" "+n}t.exports=e},function(t,n){function e(t,n){if(t.classList)t.classList.remove(n);else{var e=new RegExp("(^|\\b)"+n.split(" ").join("|")+"(\\b|$)","gi");t.className=t.className.replace(e," ")}}t.exports=e},,,function(t,n){"use strict";function e(){var t=document.querySelector("#page-nav");if(t&&!document.querySelector("#page-nav .extend.prev")&&(t.innerHTML='<a class="extend prev disabled" rel="prev">&laquo; Prev</a>'+t.innerHTML),t&&!document.querySelector("#page-nav .extend.next")&&(t.innerHTML=t.innerHTML+'<a class="extend next disabled" rel="next">Next &raquo;</a>'),yiliaConfig&&yiliaConfig.open_in_new){var n=document.querySelectorAll(".article-entry a:not(.article-more-a)");n.forEach(function(t){var n=t.getAttribute("target");n&&""!==n||t.setAttribute("target","_blank")})}var e=document.querySelector("#js-aboutme");e&&0!==e.length&&(e.innerHTML=e.innerText)}t.exports={init:e}},,,,,,,,,function(t,n){function e(t,n){if("string"==typeof n)return t.insertAdjacentHTML("afterend",n);var e=t.nextSibling;return e?t.parentNode.insertBefore(n,e):t.parentNode.appendChild(n)}t.exports=e}])</script><script src="/./main.f6a68c.js"></script><script>!function(){var e=function(e){var t=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(t),t.setAttribute("src",e)};e("/slider.885efe.js")}()</script>


    
<div class="tools-col" q-class="show:isShow,hide:isShow|isFalse" q-on="click:stop(e)">
  <div class="tools-nav header-menu">
    
    
      
      
      
    
      
      
      
    
      
      
      
    
    

    <ul style="width: 70%">
    
    
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'innerArchive')"><a href="javascript:void(0)" q-class="active:innerArchive">所有文章</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'friends')"><a href="javascript:void(0)" q-class="active:friends">友链</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'aboutme')"><a href="javascript:void(0)" q-class="active:aboutme">关于我</a></li>
      
        
    </ul>
  </div>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all" q-show="innerArchive">
        <div class="search-wrap">
          <input class="search-ipt" q-model="search" type="text" placeholder="find something…">
          <i class="icon-search icon" q-show="search|isEmptyStr"></i>
          <i class="icon-close icon" q-show="search|isNotEmptyStr" q-on="click:clearChose(e)"></i>
        </div>
        <div class="widget tagcloud search-tag">
          <p class="search-tag-wording">tag:</p>
          <label class="search-switch">
            <input type="checkbox" q-on="click:toggleTag(e)" q-attr="checked:showTags">
          </label>
          <ul class="article-tag-list" q-show="showTags">
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">linux启动流程</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">Docker</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">HAProxy</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">Cluster</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">MariaDB(MySQL)</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">NoSQL-MongoDB</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">linux安装</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">Python3</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">NoSQL</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">TCPIP</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">web services</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">varnish</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">linux服务</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">LAMP</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">command</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">kernel</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">shell脚本编程</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">压缩和归档</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">vim</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">linux中文本处理工具</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">liunx文件共享服务</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">iptables</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">system用户管理</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">zabbix</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">system系统管理</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">软件包管理</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">网络管理</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">计划任务</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">运维工具</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">进程管理</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">tomcat</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">MemCached</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">Nginx</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">分布式存储</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">加密解密、数字签名、SSL、CA</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">Virtulization</a>
              </li>
            
            <div class="clearfix"></div>
          </ul>
        </div>
        <ul class="search-ul">
          <p q-show="jsonFail" style="padding: 20px; font-size: 12px;">
            缺失模块。<br/>1、请确保node版本大于6.2<br/>2、在博客根目录（注意不是yilia根目录）执行以下命令：<br/> npm i hexo-generator-json-content --save<br/><br/>
            3、在根目录_config.yml里添加配置：
<pre style="font-size: 12px;" q-show="jsonFail">
  jsonContent:
    meta: false
    pages: false
    posts:
      title: true
      date: true
      path: true
      text: false
      raw: false
      content: false
      slug: false
      updated: false
      comments: false
      link: false
      permalink: false
      excerpt: false
      categories: false
      tags: true
</pre>
          </p>
          <li class="search-li" q-repeat="items" q-show="isShow">
            <a q-attr="href:path|urlformat" class="search-title"><i class="icon-quo-left icon"></i><span q-text="title"></span></a>
            <p class="search-time">
              <i class="icon-calendar icon"></i>
              <span q-text="date|dateformat"></span>
            </p>
            <p class="search-tag">
              <i class="icon-price-tags icon"></i>
              <span q-repeat="tags" q-on="click:choseTag(e, name)" q-text="name|tagformat"></span>
            </p>
          </li>
        </ul>
    	</section>
    

    
    	<section class="tools-section tools-section-friends" q-show="friends">
  		
        <ul class="search-ul">
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接1</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接2</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接3</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接4</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接5</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接6</a>
            </li>
          
        </ul>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me" q-show="aboutme">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">很惭愧&lt;br&gt;&lt;br&gt;只做了一点微小的工作&lt;br&gt;谢谢大家</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>